name: Optimize and Generate Thumbnails

on:
  # Запускаем при пуше в основную ветку (обычно main или master)
  push:
    branches: [ main, master ]
  # Также можно запускать при создании PR, чтобы видеть изменения до мержа
  pull_request:
    branches: [ main, master ]

jobs:
  optimize:
    runs-on: ubuntu-latest

    steps:
      # 1. Получаем код из репозитория
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          # Нам нужны все файлы истории для корректной работы с бинарными файлами
          fetch-depth: 0

      # 2. Устанавливаем зависимости
      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y jpegoptim optipng
        
      # 3. Оптимизируем существующие изображения (JPG, PNG)
      - name: Optimize existing images
        run: |
          # Оптимизируем все JPEG
          find . -type f \( -iname "*.jpg" -o -iname "*.jpeg" \) -exec jpegoptim --strip-all --all-progressive {} \;
          # Оптимизируем все PNG
          find . -type f -iname "*.png" -exec optipng -o7 -strip all {} \;
          
      # Устанавливаем ImageMagick для создания превью
      - name: Install ImageMagick
        run: |
          sudo apt-get update
          sudo apt-get install -y imagemagick
    
      # 4. Генерируем WebP версии для всех изображений в галереях
      - name: Generate WebP images
        run: |
          # Устанавливаем cwebp для конвертации в WebP
          sudo apt-get install -y webp
          # Проходим по всем изображениям в папках галерей
          find albums/gallery -type f \( -iname "*.jpg" -o -iname "*.jpeg" -o -iname "*.png" \) | while read img; do
            # Формируем путь для WebP-версии (заменяем расширение)
            webp_path="${img%.*}.webp"
            # Конвертируем в WebP (качество 85)
            cwebp -q 85 "$img" -o "$webp_path"
          done
          
      # 5. Создаем папки и генерируем превью (thumbnails)
      - name: Generate thumbnails
        run: |
          # Проходим по всем папкам альбомов внутри albums/gallery
          for album_dir in albums/gallery/*/; do
            if [ -d "$album_dir" ]; then
              # Создаем папку thumbs, если её нет
              mkdir -p "${album_dir}thumbs"
              # Проходим по всем изображениям в папке альбома
              for img in "${album_dir}"*.jpg "${album_dir}"*.jpeg "${album_dir}"*.png; do
                if [ -f "$img" ]; then
                  # Получаем имя файла без пути и расширения
                  filename=$(basename "$img")
                  name="${filename%.*}"
                  extension="${filename##*.}"
                  # Формируем путь для превью
                  thumb_path="${album_dir}thumbs/${name}-thumb.jpg"
                  # Генерируем превью 300x300px
                  convert -resize 300x300 -quality 85 "$img" "$thumb_path"
                fi
              done
            fi
          done

      # 6. Коммитим изменения обратно в репозиторий
      - name: Commit optimized files
        run: |
          git config --global user.name 'github-actions[bot]'
          git config --global user.email 'github-actions[bot]@users.noreply.github.com'
          git add -A
          # Коммитим только если есть изменения
          git diff-index --quiet HEAD || git commit -m "CI: Optimize images and generate thumbnails/webp"
        # Продолжаем даже если коммит не удался (например, нет изменений)
        continue-on-error: true

      - name: Push changes
        uses: ad-m/github-push-action@master
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          branch: ${{ github.ref }}
