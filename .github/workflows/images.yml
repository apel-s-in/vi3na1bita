name: Optimize Images and Build Gallery Index

on:
  push:
    branches: [ main, master ]
    # Запускаемся только при изменении изображений/галереи/скриптов генерации
    paths:
      - 'albums/gallery/**.jpg'
      - 'albums/gallery/**.jpeg'
      - 'albums/gallery/**.png'
      - 'albums/gallery/**.webp'
      - 'albums/gallery/**.avif'
      - 'albums/gallery/**/thumbs/**'
      - 'scripts/build-gallery-index.mjs'
      - 'generate-context.js'
      - '.github/workflows/images.yml'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build-optimize-and-meta:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Ensure .nojekyll
        run: |
          touch .nojekyll

      - name: Detect changed images
        id: diff
        run: |
          set -e
          git fetch --no-tags --prune --depth=2 origin +${GITHUB_REF}:${GITHUB_REF} || true
          FROM=$(git rev-parse HEAD~1 || echo "")
          if [ -z "$FROM" ]; then
            echo "has_images=false" >> $GITHUB_OUTPUT
            exit 0
          fi
          CHANGED=$(git diff --name-only "$FROM"...HEAD -- 'albums/gallery/**/*.jpg' 'albums/gallery/**/*.jpeg' 'albums/gallery/**/*.png' 'albums/gallery/**/*.webp' 'albums/gallery/**/*.avif' || true)
          if [ -n "$CHANGED" ]; then
            echo "has_images=true" >> $GITHUB_OUTPUT
            printf "%s\n" $CHANGED > .changed-images.txt
            echo "changed_count=$(wc -l < .changed-images.txt)" >> $GITHUB_OUTPUT
          else
            echo "has_images=false" >> $GITHUB_OUTPUT
          fi

      - name: Install tools (jpegoptim, optipng, webp, ImageMagick, Node)
        run: |
          sudo apt-get update
          sudo apt-get install -y jpegoptim optipng webp imagemagick
          curl -fsSL https://deb.nodesource.com/setup_20.x | sudo -E bash -
          sudo apt-get install -y nodejs
          node --version
          npm --version

      - name: Optimize JPEG & PNG (changed only)
        if: steps.diff.outputs.has_images == 'true'
        run: |
          set -e
          while read -r file; do
            case "$file" in
              *.jpg|*.jpeg) jpegoptim --strip-all --all-progressive "$file" || true ;;
              *.png) optipng -o7 -strip all "$file" || true ;;
            esac
          done < .changed-images.txt

      - name: Generate WebP (changed only)
        if: steps.diff.outputs.has_images == 'true'
        run: |
          set -e
          while read -r img; do
            case "$img" in
              *.jpg|*.jpeg|*.png)
                webp="${img%.*}.webp"
                if [ ! -f "$webp" ]; then cwebp -q 85 "$img" -o "$webp" || true; fi
                ;;
            esac
          done < .changed-images.txt

      - name: Generate thumbnails (changed only, 300x300)
        if: steps.diff.outputs.has_images == 'true'
        run: |
          set -e
          while read -r img; do
            case "$img" in
              albums/gallery/*/*.jpg|albums/gallery/*/*.jpeg|albums/gallery/*/*.png)
                album_dir="$(dirname "$img")/"
                filename="$(basename "$img")"
                name="${filename%.*}"
                mkdir -p "${album_dir}thumbs"
                thumb_path="${album_dir}thumbs/${name}-thumb.jpg"
                if [ ! -f "$thumb_path" ]; then
                  convert "$img" -resize 300x300 -quality 85 "$thumb_path" || true
                fi
                ;;
            esac
          done < .changed-images.txt

      - name: Build gallery index (skip; используем scripts/build-gallery-index.mjs в pages.yml)
        run: echo "skip local generate-index.js to avoid duplicates"

      - name: Generate .meta context
        run: |
          if [ -f generate-context.js ]; then
            node generate-context.js --mode=both --max-lines=20000 || true
          else
            echo "generate-context.js not found, skip"
          fi

      - name: Auto commit all changes (assets + gallery index + .meta + .nojekyll)
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "CI: optimize images, build gallery index and generate .meta"
          branch: ${{ github.ref_name }}
          commit_user_name: github-actions[bot]
          commit_user_email: github-actions[bot]@users.noreply.github.com
          # Специально не указываем file_pattern — коммитим все изменения, проще сопровождать
