<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <title>–í–∏—Ç—Ä–∏–Ω–∞ –†–∞–∑–±–∏—Ç–∞ ‚Äî –ú—É–∑—ã–∫–∞</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
  <meta name="description" content="–û—Ñ–∏—Ü–∏–∞–ª—å–Ω—ã–µ –∞–ª—å–±–æ–º—ã –≥—Ä—É–ø–ø—ã –í–∏—Ç—Ä–∏–Ω–∞ –†–∞–∑–±–∏—Ç–∞. –°–ª—É—à–∞–π—Ç–µ –æ–Ω–ª–∞–π–Ω –∏ –æ—Ñ–ª–∞–π–Ω.">

  <!-- PWA -->
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#181818" />

  <!-- iOS -->
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="–í–∏—Ç—Ä–∏–Ω–∞">
  <link rel="apple-touch-icon" href="icons/apple-touch-icon.png">

  <!-- Preload -->
  <link rel="preload" href="img/logo.png" as="image">

  <style>
    :root {
      --primary-bg: #181818;
      --primary-color: #E80100;
      --secondary-color: #4daaff;
      --text-color: #f2f2f2;
      --modal-bg: #252d39;
      --border-color: #394866;
    }
    * { box-sizing: border-box; }
    html, body { height: 100%; }
    body {
      min-height: 100vh;
      background: var(--primary-bg);
      color: var(--text-color);
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      margin: 0; padding: 0; display: flex; flex-direction: column; min-width: 100vw;
      padding-top: env(safe-area-inset-top);
    }

    /* –ü—Ä–æ–º–æ–∫–æ–¥ */
    #promocode-block {
      position: fixed; inset: 0; display: flex; align-items: center; justify-content: center;
      background: var(--primary-bg); z-index: 100;
    }
    .promo-inner {
      display: flex; flex-direction: column; align-items: center;
      background: rgba(15,18,24,0.98); border-radius: 16px; box-shadow: 0 6px 24px #0008;
      padding: 36px 26px 32px 26px; min-width: 260px; min-height: 170px;
    }
    .promo-cover {
      width: 256px; height: 256px; object-fit: cover; border-radius: 12px; box-shadow: 0 4px 24px #000c;
      margin-bottom: 19px; display: block; background: var(--primary-bg);
    }
    #promo-inp {
      padding: 10px; border-radius: 8px; border: 1px solid var(--border-color);
      background: rgba(255,255,255,0.1); color: var(--text-color); margin: 10px 0; width: 100%; font-size: 16px;
    }
    #promo-btn {
      padding: 10px 20px; background: var(--primary-color); color: white; border: none; border-radius: 8px;
      cursor: pointer; font-weight: bold; transition: opacity 0.2s;
    }
    #promo-btn:hover:not(:disabled) { opacity: .8; }
    #promo-btn:disabled { opacity: .5; cursor: not-allowed; }
    #promo-error { color: #ff6b6b; margin-top: 10px; font-size: 14px; }

    .hidden { display: none !important; }

    /* –û—Å–Ω–æ–≤–Ω–æ–π –±–ª–æ–∫ */
    #main-block { max-width: 420px; margin: 0 auto; flex: 1 0 auto; display: flex; flex-direction: column; align-items: center; width: 100%; padding: 0 10px; }
    header { width: 100%; text-align: center; margin: 0 auto; }

    /* –í—ã–±–æ—Ä –∞–ª—å–±–æ–º–∞ */
    .album-picker {
      width: 100%; max-width: 400px; margin: 18px auto 0 auto; display:flex; gap:8px; align-items:center; justify-content:center;
    }
    .album-picker select {
      width: 100%; max-width: 400px; background: #1f2533; color:#cfe3ff; border:1px solid var(--border-color);
      padding:10px 12px; border-radius:10px; font-weight:700; letter-spacing:.02em; cursor:pointer;
    }

    /* –û–±–ª–æ–∂–∫–∞/–≥–∞–ª–µ—Ä–µ—è */
    #cover-wrap { width: 100%; max-width: 400px; margin: 14px auto 0 auto; aspect-ratio: 1/1; display: flex; align-items: center; justify-content: center; position: relative; }
    .cover-gallery-arrow {
      position: absolute; top: 50%; transform: translateY(-50%); z-index: 2; border: none; cursor: pointer; background: none; padding: 0; width: 44px; height: 44px; display: flex; align-items: center; justify-content: center; transition: opacity 0.2s;
    }
    .cover-gallery-arrow:hover { opacity: 0.8; }
    #cover-gallery-arrow-left { left: 7px; }
    #cover-gallery-arrow-right { right: 7px; }
    #cover { width: 100%; max-width: 100%; border-radius: 12px; aspect-ratio: 1/1; object-fit: cover; display: block; margin: 0; box-shadow: 0 4px 24px rgba(0,0,0,0.3); }

    /* –õ–æ–≥–æ */
    .logo-bottom {
      max-width: 112px; width: 23vw; min-width: 66px; height: auto; display: block; margin: 0 auto 15px auto !important;
      cursor: pointer; transition: transform 0.1s ease-out; will-change: transform; transform: translateZ(0); transform-origin: center center; isolation: isolate; z-index: 10; position: relative;
    }
    #logo-bottom { will-change: transform; backface-visibility: hidden; transform: translateZ(0); }

    .socials-under-cover { margin: 14px auto 0 auto; width: 100%; max-width: 398px; text-align: center; font-size: 1.03em; display: flex; flex-wrap: wrap; justify-content: center; gap: 12px; }
    .socials-under-cover a { color: var(--secondary-color); text-decoration: none; transition: color 0.2s; }
    .socials-under-cover a:hover { color: var(--text-color); }

    /* –¢—Ä–µ–∫–∏ */
    .track-list { margin: 0 auto; max-width: 370px; width: 100%; font-size: 1.05em; color: #eee; background: none; padding: 0; }
    .track-list.filtered .track:not(.is-favorite) { display: none !important; }
    .track { display: flex; align-items: center; padding: 7px 8px; border-bottom: 1px solid var(--border-color); cursor: pointer; transition: background 0.13s; background: none; }
    .track:hover { background: rgba(255,255,255,0.05); }
    .track.current { background: #232b38; }
    .tnum { min-width: 27px; color: #8ab8fd; }
    .track-title { margin-left: 7px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; flex: 1; }
    .like-star { margin-left: auto; width: 19px; height: 19px; cursor: pointer; opacity: 0.97; border: none; background: none; padding: 0; appearance: none; display: inline-block; transition: transform 0.2s, filter 0.13s, opacity 0.13s; }
    .like-star:hover { filter: brightness(1.13); opacity: 1; transform: scale(1.1); }
    .like-star.animating { animation: starPulse 0.3s; }
    @keyframes starPulse { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.3); } }

    /* –õ–∏—Ä–∏–∫–∞ + –ü–ª–µ–µ—Ä */
    .lyrics-player-block { width: 100%; margin: 8px 0 3px 0; }
    #lyrics-window { width: 100%; background: rgba(34,34,34,0.98); border-radius: 12px; box-shadow: 0 8px 24px #0007; overflow: hidden; height: 8.5em; position: relative; display: flex; flex-direction: column; align-items: stretch; justify-content: center; margin-bottom: 7px; transition: height 0.2s ease, opacity 0.2s ease, margin 0.2s ease; will-change: height, opacity; }
    #lyrics-window.lyrics-hidden { height: 0 !important; opacity: 0; margin: 0; overflow: hidden; pointer-events: none; }
    #lyrics-window.lyrics-normal { height: 8.7em; }      /* 5 * 1.7em + –∑–∞–ø–∞—Å */
    #lyrics-window.lyrics-expanded { height: 15.6em; }   /* 9 * 1.7em + –∑–∞–ø–∞—Å */
    .lyrics-scroll { position: relative; z-index: 1; }
    .lyrics-window-line { opacity: 0.57; font-size: 1.13em; transition: all 0.2s; line-height: 1.7em; text-align: center; min-height: 1.7em; max-width: 97%; margin: 0 auto; color: #eee; white-space: pre-line; user-select: none; word-break: break-word; position: relative; z-index: 1; }
    .lyrics-window-line.active { color: var(--primary-color); font-weight: bold; opacity: 1; text-shadow: 0 1px 7px #73161644; background: rgba(0,0,0,0.07); border-radius: 8px; font-size: 1.19em; }

    .lyrics-animated-bg { position: absolute; inset:0; opacity:0; background: linear-gradient(45deg, rgba(232,1,0,0.15), rgba(77,170,255,0.15), rgba(232,1,0,0.15)); background-size: 400% 400%; animation: none; z-index:0; pointer-events:none; transition: opacity .5s; }
    .lyrics-animated-bg.active { opacity: 1; animation: lyricsGradient 10s ease infinite; }
    @keyframes lyricsGradient { 0%{background-position:0% 50%} 50%{background-position:100% 50%} 100%{background-position:0% 50%} }
    #lyrics-window.animation-active .lyrics-window-line { transition: opacity .3s ease; }
    #lyrics-window.animation-active .lyrics-window-line.active { animation: lyricsGlow 2s ease-in-out infinite; }
    @keyframes lyricsGlow { 0%,50%,100% { opacity:1 } }

    .audio-wrapper { width: 100%; max-width: 395px; margin: 0 auto; }
    #audio { position:absolute; width:1px; height:1px; opacity:0; pointer-events:none; }

    .player-controls { display:flex; flex-direction:column; gap:5px; margin:5px 0; padding:8px 10px; background:rgba(0,0,0,0.3); border-radius:12px; }
    .player-controls-row { display:flex; align-items:center; justify-content:center; gap:12px; }
    .player-control-btn {
      background:none; border:none; color:var(--secondary-color); cursor:pointer; padding:4px; border-radius:50%;
      transition:all .2s; display:flex; align-items:center; justify-content:center;
      width:32px; height:32px; font-weight:bold; font-size:16px; position:relative;
      /* –í–ê–ñ–ù–û: –Ω–µ –¥–∞—ë–º –∫–æ–Ω—Ç–µ–Ω—Ç—É –≤—ã–ª–µ–∑–∞—Ç—å –∑–∞ –≥—Ä–∞–Ω–∏—Ü—ã –∫–Ω–æ–ø–∫–∏ */
      overflow: hidden;
    }
    .player-controls-row:first-child .player-control-btn { width:48px; height:48px; padding:8px; }
    .player-controls-row:first-child .player-control-btn svg { width:28px; height:28px; }

    .player-control-btn:hover { background: rgba(77,170,255,.2); transform: scale(1.1); }
    .player-control-btn:active { transform: scale(.95); }

    .player-control-btn.active,
    .player-control-btn.repeat-active { color:var(--primary-color); background: rgba(232,1,0,.2); }

    .player-control-btn.favorites-active { background: rgba(255,215,0,.3); }

    .player-control-btn.animation-btn,
    .player-control-btn.bit-btn { font-size:22px; font-weight:bold; }

    .player-control-btn.animation-active,
    .player-control-btn.bit-active { color: var(--primary-color); background: rgba(232,1,0,.2); }

    /* –ò–∫–æ–Ω–∫–∏ SVG –≤ –∫–Ω–æ–ø–∫–∞—Ö */
    .player-control-btn svg { width:24px; height:24px; }

    /* –î–û–ë–ê–í–õ–ï–ù–û: —Ñ–∏–∫—Å–∏—Ä—É–µ–º —Ä–∞–∑–º–µ—Ä—ã –∫–∞—Ä—Ç–∏–Ω–æ–∫ –≤–Ω—É—Ç—Ä–∏ –∫–Ω–æ–ø–æ–∫ (–≤ —Ç.—á. –∑–≤–µ–∑–¥—ã –∏–∑–±—Ä–∞–Ω–Ω–æ–≥–æ) */
    .player-control-btn img {
      width: 22px;
      height: 22px;
      display: block;
      object-fit: contain;
      pointer-events: none; /* –∫–ª–∏–∫–∏ –æ—Å—Ç–∞—é—Ç—Å—è –Ω–∞ –∫–Ω–æ–ø–∫–µ */
    }

    /* –ù–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ: –ø–æ–¥—Å–≤–µ—Ç –∏ –ª—ë–≥–∫–∞—è –ø—É–ª—å—Å–∞—Ü–∏—è –∞–∫—Ç–∏–≤–Ω–æ–π –∑–≤–µ–∑–¥—ã */
    .player-control-btn.favorites-active img { filter: drop-shadow(0 0 4px gold); }

    @keyframes pulseFav {
      0%,100% { transform: scale(1); }
      50%     { transform: scale(1.1); }
    }
    .player-control-btn.favorites-active img { animation: pulseFav 2s infinite; }

    /* –ì–ª–∞–≤–Ω–∞—è —Ü–µ–Ω—Ç—Ä–∞–ª—å–Ω–∞—è –∫–Ω–æ–ø–∫–∞ –ø–æ–±–æ–ª—å—à–µ */
    .player-control-btn.main { width:54px; height:54px; }
    .player-control-btn.main svg { width:30px; height:30px; }

    .player-progress-wrapper { width:100%; margin:3px 0 5px 0; position:relative; }
    .player-progress-bar { width:100%; height:6px; background: rgba(255,255,255,.1); border-radius:3px; position:relative; cursor:pointer; overflow:visible; }
    .player-progress-fill { height:100%; background: linear-gradient(90deg, var(--primary-color), var(--secondary-color)); width:0%; transition: width .1s linear; border-radius:3px; position:relative; }
    .player-progress-handle { position:absolute; top:50%; transform:translateY(-50%); width:20px; height:20px; background:#fff; border-radius:50%; box-shadow:0 2px 8px rgba(0,0,0,.3); right:-10px; z-index:2; }

    .time-in-controls { font-family: 'SF Mono', Monaco, 'Courier New', monospace; font-size:13px; color:var(--secondary-color); min-width:45px; text-align:center; user-select:none; }

    .volume-control-wrapper { width:100%; margin:5px 0; padding:0; position:relative; }
    .volume-track { position:absolute; top:50%; transform:translateY(-50%); width:100%; height:6px; background:rgba(255,255,255,.2); border-radius:3px; pointer-events:none; }
    .volume-fill { position:absolute; top:50%; transform:translateY(-50%); height:6px; background:var(--secondary-color); border-radius:3px; pointer-events:none; transition: width .1s; }
    .volume-slider { appearance:none; width:100%; height:20px; background:transparent; outline:none; cursor:pointer; position:relative; z-index:2; }
    .volume-slider::-webkit-slider-thumb { appearance:none; width:20px; height:20px; background:#fff; border-radius:50%; cursor:pointer; box-shadow:0 2px 8px rgba(0,0,0,.3); }
    .volume-slider::-moz-range-thumb { width:20px; height:20px; background:#fff; border-radius:50%; cursor:pointer; border:none; box-shadow:0 2px 8px rgba(0,0,0,.3); }

    /* Sleep */
    .sleep-timer-btn { background:none; border:none; color:var(--secondary-color); cursor:pointer; padding:8px; border-radius:50%; transition:.2s; display:flex; align-items:center; justify-content:center; width:44px; height:44px; position:relative; }
    .sleep-timer-btn:hover { background: rgba(77,170,255,.2); transform: scale(1.1); }
    .sleep-timer-btn.active { color: var(--primary-color); background: rgba(232,1,0,.2); }
    .sleep-timer-badge { position:absolute; top:-2px; right:-2px; background:var(--primary-color); color:#fff; border-radius:10px; padding:2px 6px; font-size:10px; font-weight:bold; min-width:20px; text-align:center; }
    .sleep-menu { position:absolute; bottom:100%; left:50%; transform:translateX(-50%); background: var(--modal-bg); border-radius:12px; padding:10px; margin-bottom:10px; box-shadow:0 4px 20px rgba(0,0,0,.3); z-index:100; min-width:150px; display:none; }
    .sleep-menu.active { display:block; animation: slideUp .2s; }
    .sleep-menu-item { padding:8px 12px; cursor:pointer; border-radius:6px; transition: background .2s; white-space:nowrap; color:var(--text-color); }
    .sleep-menu-item:hover { background: rgba(255,255,255,.1); }

    .sleep-overlay { position: fixed; inset:0; background: rgba(0,0,0,.95); display:none; align-items:center; justify-content:center; z-index:10000; }
    .sleep-overlay.active { display:flex; animation: fadeIn .5s; }
    .sleep-content { text-align:center; padding:40px; max-width:400px; }
    .sleep-icon { font-size:64px; margin-bottom:20px; opacity:.5; }
    .sleep-title { font-size:24px; margin-bottom:10px; color: var(--text-color); }
    .sleep-message { color: rgba(255,255,255,.6); margin-bottom:30px; }
    .sleep-buttons { display:flex; gap:10px; justify-content:center; }
    .sleep-btn { padding:12px 24px; border-radius:8px; border:none; cursor:pointer; font-weight:bold; transition:opacity .2s; }
    .sleep-btn-primary { background: var(--primary-color); color:#fff; }
    .sleep-btn-secondary { background: rgba(255,255,255,.1); color: var(--text-color); }
    .sleep-btn:hover { opacity:.8; }

    /* –ö–Ω–æ–ø–∫–∞ –ª–∏—Ä–∏–∫–∏ –∏ –ø—Ä–æ—á–∏–µ –Ω–∏–∂–Ω–∏–µ –∫–Ω–æ–ø–∫–∏ */
    .lyrics-toggle-btn { position:absolute; left:10px; top:50%; transform: translateY(-50%); width:44px; height:44px; background:none; border:none; cursor:pointer; padding:0; display:flex; align-items:center; justify-content:center; font-weight:bold; transition:.2s; user-select:none; z-index:5; }
    .lyrics-toggle-btn-visual { font-size:36px; line-height:1; transition:.2s; pointer-events:none; }
    .lyrics-toggle-btn.lyrics-normal .lyrics-toggle-btn-visual { color: var(--secondary-color); font-size:36px; }
    .lyrics-toggle-btn.lyrics-hidden .lyrics-toggle-btn-visual { color: var(--primary-color); font-size:36px; }
    .lyrics-toggle-btn.lyrics-expanded .lyrics-toggle-btn-visual { color: var(--secondary-color); font-size:20px; }
    .lyrics-toggle-btn:hover .lyrics-toggle-btn-visual { transform: scale(1.1); }

    .player-buttons-wrapper { display:flex; flex-direction:column; align-items:center; gap:9px; margin-top:10px; width:100%; position:relative; }
    .karaoke-btn, .player-download-btn {
      color: var(--secondary-color) !important; background:none; border:none; cursor:pointer; font-size:1em; text-transform:uppercase; font-weight:700; letter-spacing:.02em; text-decoration:underline; transition:.18s; padding:4px 16px; min-width:148px; text-align:center; border-radius:7px; display:block; margin: 0 auto;
    }
    .karaoke-btn:hover, .player-download-btn:hover { color:#fff !important; background:#273050; }

    .bottom-controls-center { display:flex; flex-direction:column; align-items:center; justify-content:center; margin:32px auto 0 auto; gap:8px; width:100%; max-width:280px; padding-bottom: env(safe-area-inset-bottom); }

    .filter-favorites-btn { display:block; margin:0 auto 15px auto; padding:10px 20px; background: linear-gradient(135deg,#2a2a2a,#1a1a1a); color: var(--secondary-color); border:2px solid var(--border-color); border-radius:12px; font-size:.95em; font-weight:bold; cursor:pointer; transition:.3s; text-align:center; min-width:100%; white-space:nowrap; box-shadow:0 2px 8px rgba(0,0,0,.3); }
    .filter-favorites-btn:hover { background: linear-gradient(135deg,#3a3a3a,#2a2a2a); border-color: var(--secondary-color); transform: translateY(-2px); box-shadow:0 4px 12px rgba(0,0,0,.5); }
    .filter-favorites-btn.filtered { background: linear-gradient(135deg,#4a1a1a,#2a0a0a); border-color: var(--primary-color); color:#fff; }

    #install-pwa-btn, #download-album-main {
      color:#fff; background: var(--secondary-color); border:none; border-radius:7px; font-size:1.07em; font-weight:bold; letter-spacing:.02em; margin:15px 0 5px 0; padding:8px 13px; cursor:pointer; width:98%; box-shadow:0 4px 14px #0005; transition: background .2s;
    }
    #download-album-main { background: var(--primary-color); font-size:1.09em; margin-bottom:8px; }
    #install-pwa-btn:hover { background:#3275c2; } #download-album-main:hover { background:#c60000; }

    .feedback-link, .support-link { color: var(--secondary-color) !important; text-decoration: underline !important; font-weight:700; text-transform:uppercase; letter-spacing:.03em; cursor:pointer; transition: color .18s; font-size:1em; display:block; text-align:center; width:100%; margin:0; }
    .feedback-link:hover, .support-link:hover { color:#fff !important; }

    .offline-btn { min-width:102px; height:38px; font-size:1.05em; font-weight:bold; border:none; border-radius:9px; cursor:pointer; letter-spacing:.07em; box-shadow:0 2px 8px #06000032; transition: background .2s, color .14s; display:block; margin:0 auto; }
    .offline-btn.online { background: var(--primary-color); color:#fff; }
    .offline-btn.offline { background:#27b34c; color:#fff; }
    .offline-progress { margin-top:11px; width:100%; height:8px; background:#222; border-radius:6px; overflow:hidden; box-shadow:0 1px 6px #222b; }
    .offline-progress-bar { height:100%; background:#2fed54; transition: width .33s; }
    .offline-desc { text-align:center; font-size:.97em; margin-top:5px; opacity:.85; }

    .modal-bg { position:fixed; inset:0; background:rgba(0,0,0,.62); display:none; align-items:center; justify-content:center; backdrop-filter: blur(4px); z-index: 99; }
    .modal-bg.active { display:flex; animation: fadeIn .3s; }
    @keyframes fadeIn { from{opacity:0} to{opacity:1} }
    .modal-feedback { background: var(--modal-bg); border-radius:14px; padding:24px 20px; min-width:215px; max-width:96vw; box-shadow:0 4px 32px #0009; position:relative; animation: slideUp .3s; }
    @keyframes slideUp { from{ transform:translateY(20px); opacity:0 } to{ transform:translateY(0); opacity:1 } }
    .modal-feedback .bigclose { background:none; border:none; position:absolute; top:13px; right:13px; cursor:pointer; color:#eee; border-radius:50%; width:32px; height:32px; transition: transform .2s; }
    .modal-feedback .bigclose:hover { transform: scale(1.1); }
    .modal-feedback .bigclose svg { width:31px; height:31px; }

    .hotkeys-btn { color: var(--secondary-color) !important; text-decoration: underline !important; font-weight:700; text-transform:uppercase; letter-spacing:.03em; cursor:pointer; transition:color .18s; font-size:1em; display:block; text-align:center; width:100%; margin:0; background:none; border:none; padding:8px; }
    .hotkeys-btn:hover { color:#fff !important; }
    @media (max-width: 600px) { .hotkeys-btn { display:none !important; } }
    @media (display-mode: standalone) { .bottom-controls-center { padding-bottom: calc(env(safe-area-inset-bottom) + 10px); } }
    @media (hover:none) { .tooltip { display:none; } }

    /* –¢–æ—Å—Ç—ã */
    .toast {
      position: fixed;
      bottom: 80px;
      left: 50%;
      transform: translateX(-50%) translateY(100px);
      background: #2a2a2a;
      border-radius: 12px;
      padding: 15px 20px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.3);
      z-index: 9999;
      opacity: 0;
      transition: all 0.3s ease;
      max-width: 90%;
      word-wrap: break-word;
      pointer-events: none;
    }
    .toast.show { transform: translateX(-50%) translateY(0); opacity: 1; }
    .toast-content { display: flex; align-items: center; gap: 10px; }
    .toast-emoji { width: 24px; height: 24px; display: inline-flex; align-items: center; justify-content: center; flex-shrink: 0; }
    .toast-info { border-left: 4px solid var(--secondary-color); }
    .toast-success { border-left: 4px solid #27b34c; }
    .toast-error { border-left: 4px solid var(--primary-color); }
    .toast-warning { border-left: 4px solid #ff9800; }
    .toast-offline { border-left: 4px solid #666; }

    /* iOS —É—Å—Ç–∞–Ω–æ–≤–∫–∞ ‚Äî —Å—Ç–∏–ª–∏ */
    .ios-install-prompt {
      position: fixed; bottom:0; left:0; right:0; background:#1a1a1a;
      border-top-left-radius: 20px; border-top-right-radius: 20px; padding: 20px;
      transform: translateY(100%); transition: transform 0.3s ease; z-index: 10000;
      box-shadow: 0 -4px 20px rgba(0,0,0,0.3);
    }
    .ios-install-prompt.show { transform: translateY(0); }
    .ios-prompt-content { max-width: 400px; margin: 0 auto; text-align: center; }
    .ios-prompt-icon { width: 60px; height: 60px; margin-bottom: 15px; }
    .ios-prompt-close { position: absolute; top: 10px; right: 10px; background: none; border: none; color: #666; font-size: 28px; cursor: pointer; }
    .ios-prompt-button { background: var(--primary-color); color: white; border: none; padding: 12px 30px; border-radius: 25px; font-weight: bold; margin-top: 20px; cursor: pointer; }
  </style>
</head>
<body>
  <!-- –ü—Ä–æ–º–æ–∫–æ–¥ -->
  <div id="promocode-block">
    <div class="promo-inner">
      <img class="promo-cover" id="promo-cover" src="img/logo.png" alt="–û–±–ª–æ–∂–∫–∞" draggable="false"/>
      <h2>–í—Ö–æ–¥ –ø–æ –ø—Ä–æ–º–æ–∫–æ–¥—É</h2>
      <input id="promo-inp" type="text" placeholder="–í–≤–µ–¥–∏—Ç–µ –ø—Ä–æ–º–æ–∫–æ–¥" autocomplete="off" autofocus />
      <button id="promo-btn" onclick="checkPromo()">–í–æ–π—Ç–∏</button>
      <div id="promo-error"></div>
    </div>
  </div>

  <div id="main-block" class="hidden">
    <header>
      <!-- –í—ã–±–æ—Ä –∞–ª—å–±–æ–º–∞ -->
      <div class="album-picker">
        <select id="album-select" aria-label="–í—ã–±–æ—Ä –∞–ª—å–±–æ–º–∞"></select>
      </div>

      <div id="cover-wrap">
        <button class="cover-gallery-arrow" id="cover-gallery-arrow-left" title="–ù–∞–∑–∞–¥" aria-label="–ü—Ä–µ–¥—ã–¥—É—â–∞—è –æ–±–ª–æ–∂–∫–∞">
          <svg width="34" height="34" viewBox="0 0 34 34"><circle cx="17" cy="17" r="16" fill="#23252e" opacity="0.65"/><polyline points="20,10 13,17 20,24" fill="none" stroke="#fff" stroke-width="2.9" stroke-linecap="round" stroke-linejoin="round"/></svg>
        </button>
        <img id="cover" src="" alt="–û–±–ª–æ–∂–∫–∞ –∞–ª—å–±–æ–º–∞" draggable="false"/>
        <button class="cover-gallery-arrow" id="cover-gallery-arrow-right" title="–í–ø–µ—Ä—ë–¥" aria-label="–°–ª–µ–¥—É—é—â–∞—è –æ–±–ª–æ–∂–∫–∞">
          <svg width="34" height="34" viewBox="0 0 34 34"><circle cx="17" cy="17" r="16" fill="#23252e" opacity="0.65"/><polyline points="14,10 21,17 14,24" fill="none" stroke="#fff" stroke-width="2.9" stroke-linecap="round" stroke-linejoin="round"/></svg>
        </button>
      </div>

      <div id="social-links" class="socials-under-cover"></div>
    </header>

    <!-- –¢–µ–∫—É—â–∏–π –ø—Ä–æ–∏–≥—Ä—ã–≤–∞—Ç–µ–ª—å, —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –ø—Ä–∏ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–∏ –∞–ª—å–±–æ–º–∞ -->
    <div id="now-playing" style="width:100%; max-width:395px; margin:8px auto 0 auto;"></div>

    <div class="track-list" id="track-list"></div>

    <div class="bottom-controls-center">
      <button class="filter-favorites-btn" id="filter-favorites-btn" onclick="toggleFavoritesFilter()">–°–∫—Ä—ã—Ç—å –Ω–µ –æ—Ç–º–µ—á–µ–Ω–Ω—ã–µ ‚≠ê –ø–µ—Å–Ω–∏</button>
      <img class="logo-bottom" id="logo-bottom" src="img/logo.png" alt="–õ–æ–≥–æ—Ç–∏–ø" onclick="handleLogoClick()"/>

      <button id="install-pwa-btn" style="display: none;">–£–°–¢–ê–ù–û–í–ò–¢–¨ –ö–ê–ö –ü–†–ò–õ–û–ñ–ï–ù–ò–ï</button>
      <button id="download-album-main" onclick="openAlbumDownloadModal()">–°–ö–ê–ß–ê–¢–¨ –í–ï–°–¨ –ê–õ–¨–ë–û–ú</button>

      <button class="hotkeys-btn" id="hotkeys-btn" style="display:none;" onclick="showHotkeysModal()">–ì–û–†–Ø–ß–ò–ï –ö–õ–ê–í–ò–®–ò</button>
      <span class="feedback-link" id="feedback-link">–û–ë–†–ê–¢–ù–ê–Ø –°–í–Ø–ó–¨</span>
      <a class="support-link" id="support-link" href="#" target="_blank">–ü–û–î–î–ï–†–ñ–ê–¢–¨</a>
      <button class="offline-btn online" id="offline-btn" onclick="offlineUIClick()">ONLINE</button>
    </div>
  </div>

  <!-- –ú–æ–¥–∞–ª–∫–∏: –û–±—Ä–∞—Ç–Ω–∞—è —Å–≤—è–∑—å (–∑–∞–≥–ª—É—à–∫–∞) -->
  <div class="modal-bg" id="modal-feedback">
    <div class="modal-feedback" style="max-width:420px;">
      <button class="bigclose" onclick="closeFeedbackModal()" title="–ó–∞–∫—Ä—ã—Ç—å">
        <svg viewBox="0 0 48 48"><line x1="12" y1="12" x2="36" y2="36" stroke="currentColor" stroke-width="6" stroke-linecap="round"/><line x1="36" y1="12" x2="12" y2="36" stroke="currentColor" stroke-width="6" stroke-linecap="round"/></svg>
      </button>
      <div style="font-size:1.12em;font-weight:700;margin-bottom:10px;">–û–±—Ä–∞—Ç–Ω–∞—è —Å–≤—è–∑—å</div>
      <div style="color:#cfe3ff; background:rgba(255,255,255,.06); border:1px solid rgba(255,255,255,.1); border-radius:8px; padding:12px;">
        –†–∞–∑–¥–µ–ª –≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ. –ù–∞–ø–∏—à–∏—Ç–µ –Ω–∞–º –≤ Telegram: <a href="https://t.me/vitrina_razbita" target="_blank" rel="noopener">@vitrina_razbita</a>
      </div>
    </div>
  </div>

  <!-- –ú–æ–¥–∞–ª–∫–∞ —Å–∫–∞—á–∏–≤–∞–Ω–∏—è —Ç—Ä–µ–∫–∞ -->
  <div class="modal-bg" id="download-modal">
    <div class="modal-feedback" style="max-width:400px;">
      <div class="download-modal-title">–ß—Ç–æ —Å–¥–µ–ª–∞—Ç—å —Å —ç—Ç–∏–º —Ñ–∞–π–ª–æ–º?</div>
      <div style="margin-bottom:19px;font-size:.98em;" id="download-modal-filename"></div>
      <button class="offline-btn online" style="width:98%;margin-bottom:10px;" onclick="downloadCurrentTrack()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –Ω–∞ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ</button>
      <button class="offline-btn" style="width:98%;margin-bottom:10px;" onclick="shareCurrentTrack()">–ü–æ–¥–µ–ª–∏—Ç—å—Å—è —Å –¥—Ä—É–∑—å—è–º–∏</button>
      <button class="offline-btn" style="width:98%;margin-bottom:10px;" onclick="openInAppCurrentTrack()">–û—Ç–∫—Ä—ã—Ç—å –≤ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏</button>
      <button class="offline-btn" style="width:98%;margin-bottom:10px;" onclick="copyLinkCurrentTrack()">–°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å —Å—Å—ã–ª–∫—É</button>
      <button class="offline-btn" style="width:98%;margin-bottom:10px;" onclick="openAlbumDownloadModal()">–°–∫–∞—á–∞—Ç—å –≤–µ—Å—å –∞–ª—å–±–æ–º</button>
      <button class="offline-btn" style="width:98%;" onclick="closeDownloadModal()">–û—Ç–º–µ–Ω–∞</button>
    </div>
  </div>

  <!-- –ú–æ–¥–∞–ª–∫–∞ —Å–∫–∞—á–∏–≤–∞–Ω–∏—è –∞–ª—å–±–æ–º–∞ -->
  <div class="modal-bg" id="albumDownloadModal">
    <div class="modal-feedback" style="max-width: 400px;">
      <h2 style="text-align: center; margin-bottom: 25px;" id="album-title-modal">–ê–ª—å–±–æ–º</h2>
      <div class="download-options">
        <label class="checkbox-container"><input type="checkbox" id="includeCovers" checked><span class="checkmark"></span>–û–±–ª–æ–∂–∫–∏ (–≥–∞–ª–µ—Ä–µ—è)</label>
        <label class="checkbox-container"><input type="checkbox" id="includeLyrics" checked><span class="checkmark"></span>–¢–µ–∫—Å—Ç—ã –ø–µ—Å–µ–Ω</label>
        <hr style="margin: 15px 0; border-color: #333;">
        <label class="checkbox-container"><input type="checkbox" id="onlyFavorites"><span class="checkmark"></span>–¢–æ–ª—å–∫–æ –∏–∑–±—Ä–∞–Ω–Ω—ã–µ –ø–µ—Å–Ω–∏</label>
        <label class="checkbox-container"><input type="checkbox" id="fullAlbum" checked><span class="checkmark"></span>–ü–æ–ª–Ω–æ—Å—Ç—å—é –∞–ª—å–±–æ–º</label>
      </div>
      <div class="modal-buttons">
        <button onclick="closeAlbumDownloadModal()" class="btn-secondary">–û–¢–ú–ï–ù–ê</button>
        <button onclick="prepareDownload()" class="btn-primary">–°–ö–ê–ß–ê–¢–¨</button>
      </div>
    </div>
  </div>

  <!-- –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ —Ä–∞–∑–º–µ—Ä–∞ -->
  <div class="modal-bg" id="sizeConfirmModal">
    <div class="modal-feedback" style="max-width: 350px;">
      <h3 style="text-align: center;">–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –∑–∞–≥—Ä—É–∑–∫–∏</h3>
      <div class="size-info">
        <div style="font-size: 48px; color: #E80100; margin-bottom: 15px;">üì¶</div>
        <p style="font-size: 18px; margin: 10px 0;">–†–∞–∑–º–µ—Ä –∞—Ä—Ö–∏–≤–∞: <strong id="archiveSize">0 –ú–ë</strong></p>
        <p style="color: #888; font-size: 14px;">–§–∞–π–ª–æ–≤ –≤ –∞—Ä—Ö–∏–≤–µ: <span id="fileCount">0</span></p>
      </div>
      <div class="modal-buttons">
        <button onclick="closeSizeConfirmModal()" class="btn-secondary">–û–¢–ú–ï–ù–ê</button>
        <button onclick="startDownload()" class="btn-primary">–°–ö–ê–ß–ê–¢–¨</button>
      </div>
    </div>
  </div>

  <!-- –ü—Ä–æ–≥—Ä–µ—Å—Å –∞—Ä—Ö–∏–≤–∞—Ü–∏–∏ -->
  <div class="modal-bg" id="downloadProgressModal">
    <div class="modal-feedback" style="max-width: 400px;">
      <h3 style="text-align: center; margin-bottom: 20px;">–ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –∞—Ä—Ö–∏–≤–∞</h3>
      <div class="progress-bar"><div id="progressFill" class="progress-fill" style="width: 0%"></div></div>
      <p id="progressText" style="text-align: center; margin-top: 10px;">–ó–∞–≥—Ä—É–∑–∫–∞ —Ñ–∞–π–ª–æ–≤: 0/0</p>
      <div id="errorsList" style="display: none; color: #ff6b6b; font-size: 14px; margin-top: 15px;">
        <p><strong>–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å:</strong></p>
        <ul id="errorsListContent"></ul>
      </div>
    </div>
  </div>

  <!-- –ú–æ–¥–∞–ª–∫–∞ –≥–æ—Ä—è—á–∏—Ö –∫–ª–∞–≤–∏—à -->
  <div class="modal-bg" id="hotkeys-modal">
    <div class="modal-feedback hotkeys-modal">
      <button class="bigclose" onclick="closeHotkeysModal()" title="–ó–∞–∫—Ä—ã—Ç—å">
        <svg viewBox="0 0 48 48"><line x1="12" y1="12" x2="36" y2="36" stroke="currentColor" stroke-width="6" stroke-linecap="round"/><line x1="36" y1="12" x2="12" y2="36" stroke="currentColor" stroke-width="6" stroke-linecap="round"/></svg>
      </button>
      <h2>üìå –ì–û–†–Ø–ß–ò–ï –ö–õ–ê–í–ò–®–ò</h2>
      <div class="hotkeys-section">
        <h3>‚ñ∂Ô∏è –í–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ</h3>
        <div class="hotkey-item"><span class="hotkey-combo">K / –ü—Ä–æ–±–µ–ª</span><span class="hotkey-desc">–í–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ/–ü–∞—É–∑–∞</span></div>
        <div class="hotkey-item"><span class="hotkey-combo">X</span><span class="hotkey-desc">–°—Ç–æ–ø</span></div>
        <div class="hotkey-item"><span class="hotkey-combo">N</span><span class="hotkey-desc">–°–ª–µ–¥—É—é—â–∏–π —Ç—Ä–µ–∫</span></div>
        <div class="hotkey-item"><span class="hotkey-combo">P</span><span class="hotkey-desc">–ü—Ä–µ–¥—ã–¥—É—â–∏–π —Ç—Ä–µ–∫</span></div>
        <div class="hotkey-item"><span class="hotkey-combo">J / L</span><span class="hotkey-desc">–ü–µ—Ä–µ–º–æ—Ç–∫–∞ ‚Üê10—Å–µ–∫ / 10—Å–µ–∫‚Üí</span></div>
        <div class="hotkey-item"><span class="hotkey-combo">+ / -</span><span class="hotkey-desc">–ì—Ä–æ–º–∫–æ—Å—Ç—å ¬±10%</span></div>
      </div>
      <div class="hotkeys-section">
        <h3>üéµ –†–µ–∂–∏–º—ã</h3>
        <div class="hotkey-item"><span class="hotkey-combo">R</span><span class="hotkey-desc">–ü–æ–≤—Ç–æ—Ä</span></div>
        <div class="hotkey-item"><span class="hotkey-combo">U</span><span class="hotkey-desc">–°–ª—É—á–∞–π–Ω—ã–π –ø–æ—Ä—è–¥–æ–∫</span></div>
        <div class="hotkey-item"><span class="hotkey-combo">F</span><span class="hotkey-desc">–ò–∑–±—Ä–∞–Ω–Ω—ã–µ</span></div>
        <div class="hotkey-item"><span class="hotkey-combo">M</span><span class="hotkey-desc">–ë–µ–∑ –∑–≤—É–∫–∞</span></div>
        <div class="hotkey-item"><span class="hotkey-combo">T</span><span class="hotkey-desc">–¢–∞–π–º–µ—Ä —Å–Ω–∞</span></div>
      </div>
      <div class="hotkeys-section">
        <h3>‚ú® –≠—Ñ—Ñ–µ–∫—Ç—ã</h3>
        <div class="hotkey-item"><span class="hotkey-combo">A</span><span class="hotkey-desc">–ê–Ω–∏–º–∞—Ü–∏—è –ª–∏—Ä–∏–∫–∏</span></div>
        <div class="hotkey-item"><span class="hotkey-combo">B</span><span class="hotkey-desc">–ü—É–ª—å—Å–∞—Ü–∏—è –ª–æ–≥–æ—Ç–∏–ø–∞</span></div>
        <div class="hotkey-item"><span class="hotkey-combo">1 / 2 / 3</span><span class="hotkey-desc">–ò–Ω—Ç–µ–Ω—Å–∏–≤–Ω–æ—Å—Ç—å (100%/50%/15%)</span></div>
      </div>
      <div class="hotkeys-section">
        <h3>üì± –ò–Ω—Ç–µ—Ä—Ñ–µ–π—Å</h3>
        <div class="hotkey-item"><span class="hotkey-combo">Y</span><span class="hotkey-desc">–ü–æ–∫–∞–∑–∞—Ç—å –ª–∏—Ä–∏–∫—É</span></div>
        <div class="hotkey-item"><span class="hotkey-combo">W</span><span class="hotkey-desc">–ü–æ–∫–∞–∑–∞—Ç—å –ø–ª–µ–π–ª–∏—Å—Ç</span></div>
        <div class="hotkey-item"><span class="hotkey-combo">D</span><span class="hotkey-desc">–í –∏–∑–±—Ä–∞–Ω–Ω–æ–µ</span></div>
        <div class="hotkey-item"><span class="hotkey-combo">?</span><span class="hotkey-desc">–≠—Ç–∞ —Å–ø—Ä–∞–≤–∫–∞</span></div>
        <div class="hotkey-item"><span class="hotkey-combo">Esc</span><span class="hotkey-desc">–ó–∞–∫—Ä—ã—Ç—å –æ–∫–Ω–æ</span></div>
      </div>
    </div>
  </div>

  <!-- –ü—É—Å—Ç—ã–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã –¥–ª—è –æ—Ñ—Ñ–ª–∞–π–Ω/—É—Å—Ç–∞–Ω–æ–≤–∫–∏ (–∏—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏) -->
  <div class="modal-bg" id="modal-offline"></div>

<script>
/* ====== –í–µ—Ä—Å–∏—è –∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ ====== */
const VERSION = '7.2.0';
const BUILD_DATE = '2025-10-29';
const PROMO_CODE = 'VITRINA2025';

/* ====== –°–ø–∏—Å–æ–∫ –∞–ª—å–±–æ–º–æ–≤: fallback –Ω–∞ –≤–∞—à–∏ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–∏ ====== */
const ALBUMS_FALLBACK = [
  {
    key: 'mezhdu-zlom-i-dobrom',
    title: '–ú–µ–∂–¥—É –ó–ª–æ–º –∏ –î–æ–±—Ä–æ–º (2025)',
    base: 'https://apel-s-in.github.io/vi3na1bita-mezhdu-zlom-i-dobrom/'
  },
  {
    key: 'golos-dushi',
    title: '–ì–æ–ª–æ—Å –î—É—à–∏',
    base: 'https://apel-s-in.github.io/vi3na1bita-golos-dushi/'
  },
  {
    key: 'odnazhdi-v-skazke',
    title: '–û–¥–Ω–∞–∂–¥—ã –≤ —Å–∫–∞–∑–∫–µ',
    base: 'https://apel-s-in.github.io/vi3na1bita-odnazhdi-v-skazke/'
  },
  {
    key: 'krevetochka',
    title: '–ö—Ä–µ–≤–µ—Ç–æ—á–∫–∞',
    base: 'https://apel-s-in.github.io/krevetochka/'
  }
];

/* ====== –ì–ª–æ–±–∞–ª—å–Ω—ã–µ ====== */
let albumsIndex = [];
let currentAlbumKey = null;   // –∞–ª—å–±–æ–º, –∫–æ—Ç–æ—Ä—ã–π –ü–†–û–°–ú–ê–¢–†–ò–í–ê–ï–ú
let albumBase = '';
let config = null;

/* –ù–æ–≤—ã–π –Ω–µ–∑–∞–≤–∏—Å–∏–º—ã–π –ö–û–ù–¢–ï–ö–°–¢ –í–û–°–ü–†–û–ò–ó–í–ï–î–ï–ù–ò–Ø */
let playingAlbumKey = null;   // –∞–ª—å–±–æ–º, –∫–æ—Ç–æ—Ä—ã–π –í–û–°–ü–†–û–ò–ó–í–û–î–ò–ú
let playingAlbumBase = '';
let playingConfig = null;

let coverGalleryArr = [];
let coverGalleryIdx = 0;
let coverAutoplay = null;

let currentTrack = -1;        // –∏–Ω–¥–µ–∫—Å —Ç—Ä–µ–∫–∞ –≤ playingConfig
let currentLyrics = [];
let autoPlayEnabled = true;
let offlineMode = false;
let offlineDownloading = false;
let deferredPrompt = null;

let shuffleMode = false;
let shuffledPlaylist = [];
let shuffleIndex = 0;
let repeatMode = false;
let favoritesOnlyMode = false;
let availableTracks = [];
let favoritesFilterActive = false;

let animationEnabled = false;
let bitEnabled = false;
let bitIntensity = 100;
let audioContext = null;
let analyser = null;
let audioSource = null;
let animationFrame = null;

let filesToDownload = [];
let __currentAudio = null;

/* ====== –ë–µ–∑–æ–ø–∞—Å–Ω—ã–µ URL helper'—ã (–∞–±—Å–æ–ª—é—Ç–Ω–æ–µ —Å–∫–ª–µ–∏–≤–∞–Ω–∏–µ) ====== */
function normalizeBase(b) {
  try {
    const hasScheme = /^[a-z]+:\/\//i.test(String(b));
    const u = new URL(String(b), hasScheme ? undefined : (location.origin + '/'));
    return u.origin + u.pathname.replace(/\/+$/, '');
  } catch {
    const s = String(b || '').replace(/[?#].*$/, '').replace(/\/+$/, '');
    if (/^https?:\/\//i.test(s)) return s;
    return location.origin + '/' + s.replace(/^\/+/, '');
  }
}
function absJoin(base, rel) {
  try {
    return new URL(String(rel || ''), normalizeBase(base) + '/').toString();
  } catch {
    const norm = normalizeBase(base);
    return norm + '/' + String(rel || '').replace(/^\/+/, '');
  }
}

/* ====== –ü—Ä–æ–º–æ–∫–æ–¥ ====== */
function checkPromo() {
  const inp = document.getElementById('promo-inp');
  const err = document.getElementById('promo-error');
  const val = (inp?.value || '').trim();
  if (!val) { if (err) err.innerText = '–í–≤–µ–¥–∏—Ç–µ –ø—Ä–æ–º–æ–∫–æ–¥'; return; }
  if (val.toUpperCase() === PROMO_CODE.toUpperCase()) {
    localStorage.setItem('promoPassed', '1');
    showMain();
  } else {
    if (err) err.innerText = '–ù–µ–≤–µ—Ä–Ω—ã–π –ø—Ä–æ–º–æ–∫–æ–¥. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â—ë!';
  }
}
document.getElementById('promo-inp').addEventListener('keydown', e => { if (e.key === 'Enter') checkPromo(); });

/* ====== –£—Å—Ç—Ä–æ–π—Å—Ç–≤–∞ —Å –∫–ª–∞–≤–∏–∞—Ç—É—Ä–æ–π ====== */
function hasKeyboard() {
  try {
    const isDesktop = !/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
    const hasPointer = matchMedia('(pointer: fine)').matches;
    const canHover = matchMedia('(hover: hover)').matches;
    const noTouch = (navigator.maxTouchPoints || 0) === 0;
    return (isDesktop && hasPointer) || (canHover && noTouch);
  } catch {
    return true;
  }
}

/* ====== –ü–µ—Ä–µ—Ö–æ–¥ –∫ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—é ====== */
function showMain() {
  document.getElementById('promocode-block').classList.add('hidden');
  document.getElementById('main-block').classList.remove('hidden');
  initializeMainUi();
}

/* ====== –ê–ª—å–±–æ–º—ã ====== */
async function loadAlbumsIndex() {
  const sel = document.getElementById('album-select');
  try {
    const r = await fetch('./albums.json', { cache:'no-cache' });
    const j = await r.json();
    albumsIndex = Array.isArray(j.albums) ? j.albums : [];
    if (!albumsIndex.length) throw new Error('empty index');
  } catch(e) {
    albumsIndex = ALBUMS_FALLBACK.slice();
  }
  sel.innerHTML = albumsIndex.map(a => `<option value="${a.key}">${a.title}</option>`).join('');
  const first = albumsIndex[0];
  if (first) {
    document.getElementById('promo-cover').src = absJoin(first.base, 'Cover.png');
  }
}
function albumByKey(key) { return albumsIndex.find(a => a.key === key) || null; }

async function loadAlbumByKey(key) {
  const meta = albumByKey(key);
  if (!meta) { NotificationSystem.error('–ê–ª—å–±–æ–º –Ω–µ –Ω–∞–π–¥–µ–Ω'); return; }
  currentAlbumKey = key;
  albumBase = normalizeBase(meta.base);
  localStorage.setItem('currentAlbum', currentAlbumKey);
  await loadAlbumConfig(albumBase);
}

async function loadAlbumConfig(base) {
  try {
    const resp = await fetch(absJoin(base,'config.json'), { cache:'no-cache' });
    if (!resp.ok) throw new Error('HTTP '+resp.status);
    const data = await resp.json();
    (data.tracks || []).forEach(t => {
      t.audio = absJoin(base, t.audio);
      t.lyrics = absJoin(base, t.lyrics);
      if (t.fulltext) t.fulltext = absJoin(base, t.fulltext);
    });
    if (data.background) {
      document.body.style.background = `url(${absJoin(base, data.background)}) center/cover fixed #111`;
    } else {
      document.body.style.background = `#181818`;
    }
    config = data;

    coverGalleryArr = [
      absJoin(base, 'Cover.png'),
      absJoin(base, 'Cover01.png'),
      absJoin(base, 'Cover02.png'),
      absJoin(base, 'Cover03.png')
    ];
    coverGalleryIdx = 0;
    setCoverImage(coverGalleryIdx);

    document.getElementById('support-link').href = (config.donateLink || '#');
    document.getElementById('album-title-modal').textContent = (config.albumName || '–ê–ª—å–±–æ–º');
    buildSocials();

    // –°–æ—Ö—Ä–∞–Ω—è–µ–º/–ø–µ—Ä–µ–Ω–æ—Å–∏–º –¥–µ–π—Å—Ç–≤—É—é—â–∏–π –ø–ª–µ–µ—Ä
    (function preservePlayer() {
      const lp = document.getElementById('lyricsplayerblock');
      const holder = document.getElementById('now-playing');
      if (lp && holder) {
        if (!holder.contains(lp)) {
          holder.innerHTML = '';
          holder.appendChild(lp);
        }
      }
    })();

    // –ü–µ—Ä–µ—Å—Ç—Ä–æ–∏–º —Å–ø–∏—Å–æ–∫ —Ç—Ä–µ–∫–æ–≤ –∞–ª—å–±–æ–º–∞, –∫–æ—Ç–æ—Ä—ã–π –ú–´ –ü–†–û–°–ú–ê–¢–†–ò–í–ê–ï–ú (–∏–≥—Ä–∞—é—â–∏–π –∞–ª—å–±–æ–º –Ω–µ —Ç—Ä–æ–≥–∞–µ–º)
    buildTrackList();
    // –í–∞–∂–Ω–æ: availableTracks —Ä–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ—Ç—Å—è –æ—Ç playingConfig, –ø–æ—ç—Ç–æ–º—É —Ç—Ä–æ–≥–∞—Ç—å –∑–¥–µ—Å—å –Ω–µ –Ω–∞–¥–æ

    parseDeepLink();
  } catch(e) {
    console.error('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å config.json –∞–ª—å–±–æ–º–∞:', e);
    NotificationSystem.error('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –∞–ª—å–±–æ–º');
  }
}

/* ====== –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è –ø–ª–µ–µ—Ä–∞ (—É–ø—Ä–æ—â—ë–Ω–Ω–æ) ====== */
const PlayerState = {
  save() {
    try {
      const a = document.getElementById('audio');
      const data = {
        album: playingAlbumKey,                   // —Å–æ—Ö—Ä–∞–Ω—è–µ–º –∏–º–µ–Ω–Ω–æ –ò–ì–†–ê–Æ–©–ò–ô –∞–ª—å–±–æ–º
        trackIndex: currentTrack,
        position: a ? a.currentTime : 0,
        volume: a ? a.volume : parseFloat(localStorage.getItem('playerVolume')) || 1,
        ts: Date.now()
      };
      localStorage.setItem('playerState', JSON.stringify(data));
    } catch {}
  },
  restore() {
    try {
      const raw = localStorage.getItem('playerState'); if (!raw) return null;
      const st = JSON.parse(raw);
      if (!st || (Date.now() - (st.ts||0)) > 24*60*60*1000) return null;
      return st;
    } catch { return null; }
  }
};
setInterval(()=> {
  const a = document.getElementById('audio');
  if (a && !a.paused) PlayerState.save();
}, 5000);
window.addEventListener('beforeunload', () => PlayerState.save());

/* ====== –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è UI ====== */
function initializeMainUi() {
  (async () => {
    await loadAlbumsIndex();

    const sel = document.getElementById('album-select');
    const params = new URLSearchParams(location.search);
    const urlAlbum = params.get('album');
    const savedAlbum = localStorage.getItem('currentAlbum');
    const first = albumsIndex[0]?.key || null;

    const toLoad = urlAlbum && albumByKey(urlAlbum) ? urlAlbum
                  : (savedAlbum && albumByKey(savedAlbum) ? savedAlbum : first);

    if (toLoad) sel.value = toLoad;
    sel.onchange = () => loadAlbumByKey(sel.value);

    if (localStorage.getItem('promoPassed') === '1') {
      // –ü–µ—Ä–µ—Ö–æ–¥ –Ω–∞–ø—Ä—è–º—É—é –≤ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –ø—Ä–∏ –ø–æ–≤—Ç–æ—Ä–Ω–æ–º –∑–∞–ø—É—Å–∫–µ
      document.getElementById('promocode-block').classList.add('hidden');
      document.getElementById('main-block').classList.remove('hidden');

      // –°–æ—Å—Ç–æ—è–Ω–∏—è
      try {
        shuffleMode = localStorage.getItem('shuffleMode') === '1';
        repeatMode = localStorage.getItem('repeatMode') === '1';
        favoritesOnlyMode = localStorage.getItem('favoritesOnlyMode') === '1';
        offlineMode = localStorage.getItem('offlineMode') === '1';
        animationEnabled = localStorage.getItem('animationEnabled') === '1';
        bitEnabled = localStorage.getItem('bitEnabled') === '1';
        const savedIntensity = localStorage.getItem('bitIntensity'); if (savedIntensity) bitIntensity = parseInt(savedIntensity);
      } catch {}

      await loadAlbumByKey(sel.value);

      const st = PlayerState.restore();
      if (st && st.album && albumByKey(st.album)) {
        if (sel.value !== st.album) {
          sel.value = st.album;
          await loadAlbumByKey(st.album);
        }
      }
      if (st && Number.isInteger(st.trackIndex)) {
        // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∫–æ–Ω—Ç–µ–∫—Å—Ç –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è –∏–∑ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ –ø—Ä–æ—Å–º–æ—Ç—Ä–∞
        setPlaybackContextFromViewing();
        // –ò –≤–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ç—Ä–µ–∫ + –ø–æ–∑–∏—Ü–∏—é
        if (playingConfig && st.trackIndex >= 0 && st.trackIndex < (playingConfig.tracks || []).length) {
          showTrack(st.trackIndex, false);
          setTimeout(()=> {
            const a = document.getElementById('audio');
            if (a) {
              a.currentTime = st.position || 0;
              a.volume = (typeof st.volume === 'number') ? st.volume : a.volume;
            }
            applyLyricsViewMode();
            PlayerState.save();
          }, 300);
        }
      }
    }

    // –ì–∞–ª–µ—Ä–µ—è
    document.getElementById('cover-gallery-arrow-left').onclick = () => { setCoverImage(coverGalleryIdx - 1); startCoverAutoPlay(); };
    document.getElementById('cover-gallery-arrow-right').onclick = () => { setCoverImage(coverGalleryIdx + 1); startCoverAutoPlay(); };
    let startX = null;
    const el = document.getElementById('cover-wrap');
    el.addEventListener('touchstart', e => { startX = e.touches[0].clientX; });
    el.addEventListener('touchend', e => {
      if (startX === null) return;
      const dx = e.changedTouches[0].clientX - startX;
      if (Math.abs(dx) > 30) {
        if (dx > 0) setCoverImage(coverGalleryIdx - 1); else setCoverImage(coverGalleryIdx + 1);
        startCoverAutoPlay();
      }
      startX = null;
    });
    startCoverAutoPlay();

    // –•–æ—Ç–∫–µ–∏
    if (hasKeyboard()) {
      const hot = document.getElementById('hotkeys-btn');
      if (hot) hot.style.display = 'block';
    }

    // –û–±—Ä–∞—Ç–Ω–∞—è —Å–≤—è–∑—å (–∑–∞–≥–ª—É—à–∫–∞)
    document.getElementById('feedback-link').onclick = openFeedbackModal;
    document.getElementById('modal-feedback').onclick = (e) => { if (e.target === e.currentTarget) closeFeedbackModal(); };

    // PWA install
    window.addEventListener('beforeinstallprompt', (e) => {
      e.preventDefault();
      deferredPrompt = e;
      const btn = document.getElementById('install-pwa-btn');
      if (btn) btn.style.display = '';
    });
    document.getElementById('install-pwa-btn').onclick = async () => {
      if (deferredPrompt) {
        deferredPrompt.prompt();
        deferredPrompt.userChoice.finally(() => {
          document.getElementById('install-pwa-btn').style.display = 'none';
          deferredPrompt = null;
        });
      } else {
        NotificationSystem.info('–í–∞—à –±—Ä–∞—É–∑–µ—Ä –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç —É—Å—Ç–∞–Ω–æ–≤–∫—É PWA');
      }
    };

    detectIOSAndShowInstallGuide();

    // Service Worker
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('./service-worker.js').then(async reg => {
        await navigator.serviceWorker.ready;
        syncOfflineState();
        try { reg.active && reg.active.postMessage({ type: 'REQUEST_OFFLINE_STATE' }); } catch(e){}
        try { reg.update(); } catch(e) {}
        setInterval(async () => {
          try { const r = await navigator.serviceWorker.getRegistration(); if (r) r.update(); } catch(e) {}
        }, 60 * 60 * 1000);
      });

      let __swReloaded = false;
      navigator.serviceWorker.addEventListener('controllerchange', () => {
        if (__swReloaded) return;
        __swReloaded = true;
        NotificationSystem.info('–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø—Ä–∏–º–µ–Ω–µ–Ω–æ, –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∞...');
        setTimeout(() => location.reload(), 300);
      });

      navigator.serviceWorker.addEventListener('message', event => {
        const msg = event.data || {};
        if (msg.type === 'OFFLINE_STATE') {
          offlineMode = !!msg.value;
          setOfflineUIState(offlineMode ? 'offline' : 'online');
        }
      });
    }

    document.addEventListener('visibilitychange', () => { if (!document.hidden) checkSleepTimer(); });
    window.addEventListener('focus', checkSleepTimer);

    window.addEventListener('online', () => NotificationSystem.success('–°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ'));
    window.addEventListener('offline', () => NotificationSystem.offline('–ù–µ—Ç —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è —Å –∏–Ω—Ç–µ—Ä–Ω–µ—Ç–æ–º'));
  })();
}

/* ====== –°–æ—Ü—Å–µ—Ç–∏ ====== */
function buildSocials() {
  const linksEl = document.getElementById('social-links');
  if (!config || !config.socials || !linksEl) { linksEl.innerHTML = ''; return; }
  linksEl.innerHTML = (config.socials || []).map(x => `<a href="${x.url}" target="_blank" rel="noopener">${x.title}</a>`).join(" ");
}

/* ====== –ì–∞–ª–µ—Ä–µ—è ====== */
function setCoverImage(idx) {
  if (!coverGalleryArr.length) return;
  coverGalleryIdx = (idx + coverGalleryArr.length) % coverGalleryArr.length;
  const img = document.getElementById('cover');
  img.src = coverGalleryArr[coverGalleryIdx];
}
function startCoverAutoPlay() {
  if (coverAutoplay) clearInterval(coverAutoplay);
  coverAutoplay = setInterval(() => setCoverImage(coverGalleryIdx + 1), 5000);
}

/* ====== –¢–æ—Å—Ç—ã ====== */
class NotificationSystem {
  static queue = []; static isShowing = false;
  static show(message, type = 'info', duration = 3000) { this.queue.push({ message, type, duration }); if (!this.isShowing) this.processQueue(); }
  static async processQueue() {
    if (this.queue.length===0) { this.isShowing=false; return; }
    this.isShowing=true;
    const { message, type, duration } = this.queue.shift();
    const toast = document.createElement('div');
    toast.className = `toast toast-${type}`;
    toast.innerHTML = `<div class="toast-content"><span class="toast-emoji" aria-hidden="true"></span><span class="toast-text">${message}</span></div>`;
    document.body.appendChild(toast);
    await new Promise(r=>setTimeout(r,50));
    toast.classList.add('show');
    await new Promise(r=>setTimeout(r,duration));
    toast.classList.remove('show');
    await new Promise(r=>setTimeout(r,300));
    toast.remove();
    this.processQueue();
  }
  static info(msg){ this.show(msg,'info'); }
  static success(msg){ this.show(msg,'success'); }
  static error(msg){ this.show(msg,'error',5000); }
  static warning(msg){ this.show(msg,'warning',4000); }
  static offline(msg){ this.show(msg,'offline'); }
}

/* ====== –ò–∑–±—Ä–∞–Ω–Ω–æ–µ (–∫–∞—Ä—Ç–∞ {albumKey: number[]}) ====== */
const LIKED_STORAGE_KEY_V2 = 'likedTracks:v2';

/* –ö–∞—Ä—Ç–∞ { albumKey: number[] } */
function getLikedMap() {
  try {
    const raw = localStorage.getItem(LIKED_STORAGE_KEY_V2);
    const map = raw ? JSON.parse(raw) : {};
    return (map && typeof map === 'object') ? map : {};
  } catch {
    return {};
  }
}

/* –ú–∏–≥—Ä–∞—Ü–∏—è —Å–æ —Å—Ç–∞—Ä–æ–≥–æ —Ñ–æ—Ä–º–∞—Ç–∞ (–≥–ª–æ–±–∞–ª—å–Ω—ã–π –º–∞—Å—Å–∏–≤) –≤ –∫–∞—Ä—Ç—É –¥–ª—è –¢–ï–ö–£–©–ï–ì–û –ø—Ä–æ—Å–º–∞—Ç—Ä–∏–≤–∞–µ–º–æ–≥–æ –∞–ª—å–±–æ–º–∞ */
function migrateLegacyLikedIfNeeded(map) {
  try {
    const legacyRaw = localStorage.getItem('likedTracks');
    if (!legacyRaw) return map;
    const legacy = JSON.parse(legacyRaw);
    if (Array.isArray(legacy) && currentAlbumKey) {
      if (!Array.isArray(map[currentAlbumKey]) || map[currentAlbumKey].length === 0) {
        map[currentAlbumKey] = legacy.slice();
      }
    }
    localStorage.removeItem('likedTracks');
    localStorage.setItem(LIKED_STORAGE_KEY_V2, JSON.stringify(map));
  } catch {}
  return map;
}

/* –°–ø–∏—Å–∫–∏ –¥–ª—è –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ –∞–ª—å–±–æ–º–∞ */
function getLikedForAlbum(albumKey) {
  if (!albumKey) return [];
  let map = getLikedMap();
  map = migrateLegacyLikedIfNeeded(map);
  const arr = map[albumKey];
  return Array.isArray(arr) ? arr : [];
}
function saveLikedForAlbum(albumKey, arr) {
  if (!albumKey) return;
  const map = getLikedMap();
  map[albumKey] = Array.from(new Set((arr || []).filter(n => Number.isInteger(n))));
  localStorage.setItem(LIKED_STORAGE_KEY_V2, JSON.stringify(map));
}
function isLikedForAlbum(albumKey, idx) {
  return getLikedForAlbum(albumKey).includes(idx);
}

/* –°—Ç–∞—Ä—ã–µ —É–¥–æ–±–Ω—ã–µ –æ–±—ë—Ä—Ç–∫–∏ ‚Äî –¥–ª—è –°–ü–ò–°–ö–ê (—Ç–µ–∫—É—â–∏–π –ø—Ä–æ—Å–º–∞—Ç—Ä–∏–≤–∞–µ–º—ã–π –∞–ª—å–±–æ–º) */
function getLiked(){ return getLikedForAlbum(currentAlbumKey); }
function saveLiked(arr){ return saveLikedForAlbum(currentAlbumKey, arr); }
function isLiked(idx){ return isLikedForAlbum(currentAlbumKey, idx); }

/* ====== –°–ø–∏—Å–æ–∫ —Ç—Ä–µ–∫–æ–≤ (–¥–ª—è –ü–†–û–°–ú–û–¢–†–ê) ====== */
function buildTrackList() {
  const list = document.getElementById('track-list');
  if (!config) { list.innerHTML = ''; return; }

  const preservedInNowPlaying = !!document.getElementById('now-playing')?.querySelector('#lyricsplayerblock');
  const sameAlbumAsPlaying = (currentAlbumKey && playingAlbumKey && currentAlbumKey === playingAlbumKey);

  let html = '';
  for (let i = 0; i < config.tracks.length; i++) {
    const t = config.tracks[i];
    const isCurrentInThisList = sameAlbumAsPlaying && (i === currentTrack);
    html += `<div class="track${isCurrentInThisList ? ' current' : ''}" id="trk${i}" onclick="pickAndPlayTrack(${i})">
      <span class="tnum">${String(i + 1).padStart(2, '0')}.</span>
      <span class="track-title">${t.title}</span>
      <img src="${isLiked(i) ? 'img/star.png' : 'img/star2.png'}"
           class="like-star"
           alt="–∑–≤–µ–∑–¥–∞"
           title="${isLiked(i) ? '–£–±—Ä–∞—Ç—å –∏–∑ –ø–æ–Ω—Ä–∞–≤–∏–≤—à–∏—Ö—Å—è' : '–î–æ–±–∞–≤–∏—Ç—å –≤ –ø–æ–Ω—Ä–∞–≤–∏–≤—à–∏–µ—Å—è'}"
           onclick="toggleLike(${i}, event)"/>
    </div>`;

    // –í—Å—Ç–∞–≤–ª—è—Ç—å –ø–ª–µ–µ—Ä-–ø–ª–µ–π—Å—Ö–æ–ª–¥–µ—Ä –∏–º–µ–µ—Ç —Å–º—ã—Å–ª –¢–û–õ–¨–ö–û –µ—Å–ª–∏
    // 1) –ø–ª–µ–µ—Ä –Ω–µ —Å–æ—Ö—Ä–∞–Ω—ë–Ω –≤ now-playing –∏
    // 2) —Ç–µ–∫—É—â–∏–π –∞–ª—å–±–æ–º ‚Äî —Ç–æ—Ç –∂–µ, —á—Ç–æ –ø—Ä–æ–∏–≥—Ä—ã–≤–∞–µ—Ç—Å—è
    if (isCurrentInThisList && !preservedInNowPlaying) {
      html += `<div class="lyrics-player-block" id="lyricsplayerblock"></div>`;
    }
  }

  list.innerHTML = html;

  if (favoritesFilterActive) {
    list.classList.add('filtered');
    updateFavoriteClasses();
  }

  // –ï—Å–ª–∏ –ø–ª–µ–µ—Ä –Ω–µ —Å–æ—Ö—Ä–∞–Ω—ë–Ω –≤ now-playing ‚Äî –æ—Ç—Ä–∏—Å–æ–≤—ã–≤–∞–µ–º –±–ª–æ–∫ –∏ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –ø–ª–µ–µ—Ä
  if (!preservedInNowPlaying && sameAlbumAsPlaying && currentTrack >= 0) {
    renderLyricsBlock();
  }
}

/* ====== –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è ====== */
function setPlaybackContextFromViewing() {
  playingAlbumKey = currentAlbumKey;
  playingAlbumBase = albumBase;
  playingConfig = config;
}

/* ====== –ò–∑–±—Ä–∞–Ω–Ω–æ–µ –≤ —Å–ø–∏—Å–∫–µ (–¥–ª—è –ø—Ä–æ—Å–º–∞—Ç—Ä–∏–≤–∞–µ–º–æ–≥–æ) ====== */
function toggleLike(idx, e, albumKeyOverride) {
  if (e) e.stopPropagation();
  const albumKey = albumKeyOverride || currentAlbumKey;
  let liked = getLikedForAlbum(albumKey);
  const was = liked.includes(idx);
  liked = was ? liked.filter(x=>x!==idx) : [...liked, idx];
  saveLikedForAlbum(albumKey, liked);

  // –ï—Å–ª–∏ –∫–ª–∏–∫ –±—ã–ª –≤ –≤–∏–¥–∏–º–æ–º —Å–ø–∏—Å–∫–µ (—Ç.–µ. —Ä–∞–±–æ—Ç–∞–µ–º —Å currentAlbumKey)
  if (!albumKeyOverride || albumKeyOverride === currentAlbumKey) {
    const star = e ? e.target : document.querySelector(`#trk${idx} .like-star`);
    if (star){ star.src = was? 'img/star2.png':'img/star.png'; star.title = was?'–î–æ–±–∞–≤–∏—Ç—å –≤ –ø–æ–Ω—Ä–∞–≤–∏–≤—à–∏–µ—Å—è':'–£–±—Ä–∞—Ç—å –∏–∑ –ø–æ–Ω—Ä–∞–≤–∏–≤—à–∏—Ö—Å—è'; star.classList.add('animating'); setTimeout(()=>star.classList.remove('animating'),300); }
    if (favoritesFilterActive) {
      updateFavoriteClasses();
      const count = document.querySelectorAll('.track.is-favorite').length;
      if (count===0) {
        toggleFavoritesFilter();
        NotificationSystem.warning('–í—Å–µ —Ç—Ä–µ–∫–∏ —É–¥–∞–ª–µ–Ω—ã –∏–∑ –∏–∑–±—Ä–∞–Ω–Ω–æ–≥–æ, —Ñ–∏–ª—å—Ç—Ä –æ—Ç–∫–ª—é—á—ë–Ω');
      } else {
        NotificationSystem.info(`‚≠ê –ò–∑–±—Ä–∞–Ω–Ω—ã—Ö —Ç—Ä–µ–∫–æ–≤: ${count}`);
      }
    }
  }

  // –ï—Å–ª–∏ —Ä–µ–∂–∏–º "—Ç–æ–ª—å–∫–æ –∏–∑–±—Ä–∞–Ω–Ω—ã–µ" –≤–∫–ª—é—á—ë–Ω –¥–ª—è –ø–ª–µ–µ—Ä–∞ ‚Äî –æ–±–Ω–æ–≤–ª—è–µ–º –æ—á–µ—Ä–µ–¥—å –ø–ª–µ–µ—Ä–∞
  if (favoritesOnlyMode) {
    updateAvailableTracks();
    // –ï—Å–ª–∏ —Ç—Ä–µ–∫, –∫–æ—Ç–æ—Ä—ã–π –ò–ì–†–ê–ï–¢, —Ç–µ–ø–µ—Ä—å –Ω–µ –≤ –∏–∑–±—Ä–∞–Ω–Ω–æ–º –∞–ª—å–±–æ–º–∞ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è ‚Äî –ø–µ—Ä–µ—Å–∫–æ—á–∏–º
    if (albumKey === playingAlbumKey && !isLikedForAlbum(playingAlbumKey, currentTrack)) {
      const nextFavorite = getNextFavoriteTrack();
      if (nextFavorite !== -1) setTimeout(()=>showTrack(nextFavorite, true), 300);
      else {
        toggleFavoritesOnly();
        NotificationSystem.warning('–í—Å–µ —Ç—Ä–µ–∫–∏ —É–¥–∞–ª–µ–Ω—ã –∏–∑ –∏–∑–±—Ä–∞–Ω–Ω–æ–≥–æ');
      }
    }
    if (shuffleMode) createShuffledPlaylist();
  }
}

function updateFavoriteClasses() {
  const liked = getLiked();
  document.querySelectorAll('.track').forEach(tr => tr.classList.remove('is-favorite'));
  liked.forEach(idx => { const el = document.getElementById(`trk${idx}`); if (el) el.classList.add('is-favorite'); });
}

function toggleFavoritesFilter() {
  const btn = document.getElementById('filter-favorites-btn');
  const list = document.getElementById('track-list');
  const liked = getLiked();
  favoritesFilterActive = !favoritesFilterActive;
  if (favoritesFilterActive) {
    if (!liked.length){ NotificationSystem.warning('–ù–µ—Ç –∏–∑–±—Ä–∞–Ω–Ω—ã—Ö —Ç—Ä–µ–∫–æ–≤!'); favoritesFilterActive=false; return; }
    btn.textContent='–ü–û–ö–ê–ó–ê–¢–¨ –í–°–ï –ü–ï–°–ù–ò'; btn.classList.add('filtered'); list.classList.add('filtered'); updateFavoriteClasses();
  } else {
    btn.textContent='–°–∫—Ä—ã—Ç—å –Ω–µ –æ—Ç–º–µ—á–µ–Ω–Ω—ã–µ ‚≠ê –ø–µ—Å–Ω–∏'; btn.classList.remove('filtered'); list.classList.remove('filtered');
  }
}

/* ====== –ü–ª–µ–µ—Ä ====== */
function getCurrentAudio() { return __currentAudio || document.getElementById('audio') || null; }
function stopAndCleanupAudio(a) {
  if (!a) return;
  try { a.pause(); } catch(e) {}
  try { a.currentTime = 0; } catch(e) {}
  try { a.removeAttribute('src'); a.load(); } catch(e) {}
}

function pickAndPlayTrack(n){
  // –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∫–ª–∏–∫–Ω—É–ª —Ç—Ä–µ–∫ –≤ —Å–ø–∏—Å–∫–µ –ü–†–û–°–ú–û–¢–†–ê ‚Äî –ø–µ—Ä–µ–Ω–æ—Å–∏–º –∫–æ–Ω—Ç–µ–∫—Å—Ç –≤ –í–û–°–ü–†–û–ò–ó–í–ï–î–ï–ù–ò–ï
  setPlaybackContextFromViewing();
  showTrack(n, true);
  autoPlayEnabled = true;
}

function showTrack(n, doPlay) {
  // –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ç–æ–ª—å–∫–æ —Ç–µ–∫—É—â–∏–π audio
  stopAndCleanupAudio(getCurrentAudio());
  __currentAudio = null;

  // –û—á–∏—â–∞–µ–º –≤–Ω–µ—à–Ω–∏–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –ø–ª–µ–µ—Ä–∞ (—Å—Ç–∞—Ä—ã–π UI)
  const holder = document.getElementById('now-playing');
  if (holder && holder.firstChild) {
    holder.innerHTML = '';
  }

  currentTrack = n;
  // –ü–µ—Ä–µ—Å—Ç—Ä–æ–∏–º —Å–ø–∏—Å–æ–∫ –ø—Ä–æ—Å–º–∞—Ç—Ä–∏–≤–∞–µ–º–æ–≥–æ –∞–ª—å–±–æ–º–∞ (–ø–æ–¥—Å–≤–µ—Ç–∏—Ç—Å—è —Ç–µ–∫—É—â–∏–π —Ç—Ä–µ–∫, –µ—Å–ª–∏ –∞–ª—å–±–æ–º —Å–æ–≤–ø–∞–¥–∞–µ—Ç)
  buildTrackList();

  const audio = document.getElementById('audio');
  if (!audio) return;

  __currentAudio = audio;

  // –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –≥—Ä–æ–º–∫–æ—Å—Ç–∏
  try {
    audio.muted = false;
    const saved = parseFloat(localStorage.getItem('playerVolume'));
    audio.volume = Number.isFinite(saved) && saved > 0 ? saved : 1;
  } catch {}

  if (doPlay) {
    audio.currentTime = 0;

    const tryPlay = () => {
      const p = audio.play();
      if (p && p.catch) p.catch(()=>{});
    };

    if (isNaN(audio.duration) || !isFinite(audio.duration)) {
      audio.addEventListener('canplay', tryPlay, { once: true });
      setTimeout(tryPlay, 200);
    } else {
      tryPlay();
    }
  }
}

function renderLyricsBlock() {
  const block = document.getElementById('lyricsplayerblock');
  if (!block) return;
  block.innerHTML = `
    <div id="lyrics-window" class="lyrics-normal">
      <div class="lyrics-animated-bg${animationEnabled ? ' active' : ''}"></div>
      <div class="lyrics-scroll" id="lyrics"></div>
    </div>
    <div class="player-progress-wrapper">
      <div class="player-progress-bar" id="player-progress-bar"><div class="player-progress-fill" id="player-progress-fill"><div class="player-progress-handle"></div></div></div>
    </div>
    <div class="audio-wrapper"><audio id="audio" preload="metadata" playsinline crossorigin="anonymous" aria-hidden="true" tabindex="-1"></audio></div>
    <div class="player-controls" role="group" aria-label="–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ–º">
      <div class="player-controls-row">
        <span class="time-in-controls" id="time-elapsed">00:00</span>
        <button class="player-control-btn" onclick="previousTrack()" title="–ü—Ä–µ–¥—ã–¥—É—â–∏–π —Ç—Ä–µ–∫ (P)" aria-label="–ü—Ä–µ–¥—ã–¥—É—â–∏–π —Ç—Ä–µ–∫"><svg viewBox="0 0 24 24" fill="currentColor"><path d="M11 5L4 12l7 7V5zm9 0v14l-7-7 7-7z"/></svg></button>
        <button class="player-control-btn main" onclick="togglePlayPause()" title="–í–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ/–ü–∞—É–∑–∞ (K/–ü—Ä–æ–±–µ–ª)" aria-label="–í–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ/–ü–∞—É–∑–∞"><svg id="play-pause-icon" viewBox="0 0 24 24" fill="currentColor"><path d="M8 5v14l11-7z"/></svg></button>
        <button class="player-control-btn" onclick="stopPlayback()" title="–°—Ç–æ–ø (X)" aria-label="–°—Ç–æ–ø"><svg viewBox="0 0 24 24" fill="currentColor"><rect x="6" y="6" width="12" height="12"/></svg></button>
        <button class="player-control-btn" onclick="nextTrack()" title="–°–ª–µ–¥—É—é—â–∏–π —Ç—Ä–µ–∫ (N)" aria-label="–°–ª–µ–¥—É—é—â–∏–π —Ç—Ä–µ–∫"><svg viewBox="0 0 24 24" fill="currentColor"><path d="M13 5l7 7-7 7V5zM4 5v14l7-7-7-7z"/></svg></button>
        <span class="time-in-controls" id="time-remaining">--:--</span>
      </div>
      <div class="player-controls-row">
        <button class="player-control-btn" id="mute-btn" onclick="toggleMute()" title="–ë–µ–∑ –∑–≤—É–∫–∞ (M)" aria-label="–ë–µ–∑ –∑–≤—É–∫–∞"><svg viewBox="0 0 24 24" fill="currentColor"><path d="M3 9v6h4l5 5V4L7 9H3zm13.5 3c0-1.77-1.02-3.29-2.5-4.03v8.05c1.48-.73 2.5-2.25 2.5-4.02z"/></svg></button>
        <button class="player-control-btn${shuffleMode?' active':''}" id="shuffle-btn" onclick="toggleShuffle()" title="–°–ª—É—á–∞–π–Ω—ã–π –ø–æ—Ä—è–¥–æ–∫ (U)" aria-label="Shuffle"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 17h2.735a4 4 0 003.43-1.942l3.67-6.116A4 4 0 0116.265 7H21m0 0l-3-3m3 3l-3 3"/><path d="M3 7h2.735a4 4 0 013.43 1.942l3.67 6.116A4 4 0 0016.265 17H21m0 0l-3 3m3-3l-3-3"/></svg></button>
        <button class="player-control-btn animation-btn${animationEnabled?' animation-active':''}" id="animation-btn" onclick="toggleAnimation()" title="–ê–Ω–∏–º–∞—Ü–∏—è –ª–∏—Ä–∏–∫–∏ (A)" aria-label="–ê–Ω–∏–º–∞—Ü–∏—è">A</button>
        <button class="player-control-btn bit-btn${bitEnabled?' bit-active':''}" id="bit-btn" onclick="toggleBit()" title="–ü—É–ª—å—Å–∞—Ü–∏—è –ª–æ–≥–æ—Ç–∏–ø–∞ (B)" aria-label="–ü—É–ª—å—Å–∞—Ü–∏—è">B</button>
        <button class="player-control-btn${repeatMode?' repeat-active':''}" id="repeat-btn" onclick="toggleRepeat()" title="–ü–æ–≤—Ç–æ—Ä —Ç—Ä–µ–∫–∞ (R)" aria-label="–ü–æ–≤—Ç–æ—Ä"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M17 2l4 4-4 4"/><path d="M3 11V9a4 4 0 014-4h14"/><path d="M7 22l-4-4 4-4"/><path d="M21 13v2a4 4 0 01-4 4H3"/><circle cx="12" cy="12" r="1" fill="currentColor"/></svg></button>
        <button class="sleep-timer-btn" id="sleep-timer-btn" onclick="toggleSleepMenu()" title="–¢–∞–π–º–µ—Ä —Å–Ω–∞ (T)" aria-label="–¢–∞–π–º–µ—Ä —Å–Ω–∞">
          <svg viewBox="0 0 24 24" width="24" height="24" aria-hidden="true">
            <circle cx="12" cy="12" r="9" fill="none" stroke="currentColor" stroke-width="2"></circle>
            <path d="M12 7v5l3 3" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"></path>
          </svg>
          <span class="sleep-timer-badge" id="sleep-timer-badge" style="display:none;">0</span>
          <div class="sleep-menu" id="sleep-menu">
            <div class="sleep-menu-item" onclick="setSleepTimer('off')">–í—ã–∫–ª—é—á–∏—Ç—å</div>
            <div class="sleep-menu-item" onclick="setSleepTimer(15)">15 –º–∏–Ω—É—Ç</div>
            <div class="sleep-menu-item" onclick="setSleepTimer(30)">30 –º–∏–Ω—É—Ç</div>
            <div class="sleep-menu-item" onclick="setSleepTimer(60)">60 –º–∏–Ω—É—Ç</div>
            <div class="sleep-menu-item" onclick="showTimePickerForSleep()">–ö –≤—Ä–µ–º–µ–Ω–∏...</div>
          </div>
        </button>
        <button class="player-control-btn${favoritesOnlyMode?' favorites-active':''}" id="favorites-btn" onclick="toggleFavoritesOnly()" title="–¢–æ–ª—å–∫–æ –∏–∑–±—Ä–∞–Ω–Ω—ã–µ (F)" aria-label="–ò–∑–±—Ä–∞–Ω–Ω—ã–µ"><img src="img/${favoritesOnlyMode?'star.png':'star2.png'}" alt="‚òÖ" id="favorites-btn-icon"/></button>
      </div>
    </div>
    <div class="volume-control-wrapper">
      <div class="volume-track"></div><div class="volume-fill" id="volume-fill"></div>
      <input type="range" class="volume-slider" id="volume-slider" min="0" max="100" value="100" aria-label="–ì—Ä–æ–º–∫–æ—Å—Ç—å" aria-valuemin="0" aria-valuemax="100" aria-valuenow="100">
    </div>
    <div class="player-buttons-wrapper">
      <button class="lyrics-toggle-btn lyrics-normal" onclick="toggleLyricsView()" aria-label="–°–∫—Ä—ã—Ç—å –ª–∏—Ä–∏–∫—É" title="–°–∫—Ä—ã—Ç—å –ª–∏—Ä–∏–∫—É (Y)"><span class="lyrics-toggle-btn-visual">–¢</span></button>
      <button class="karaoke-btn" onclick="copyLyrics()">–°–ö–û–ü–ò–†–û–í–ê–¢–¨ –¢–ï–ö–°–¢</button>
      <a class="player-download-btn" href="#" onclick="openDownloadModal(event)">–°–ö–ê–ß–ê–¢–¨ –ü–ï–°–ù–Æ</a>
    </div>
  `;

  if (!playingConfig || !playingConfig.tracks || currentTrack < 0) return;
  const tr = playingConfig.tracks[currentTrack];
  const audioEl = document.getElementById('audio');
  if (__currentAudio && __currentAudio !== audioEl) stopAndCleanupAudio(__currentAudio);
  __currentAudio = audioEl;
  audioEl.src = tr.audio;

  // –ï—Å–ª–∏ –ø—É–ª—å—Å–∞—Ü–∏—è –≤–∫–ª—é—á–µ–Ω–∞ ‚Äî –ø–µ—Ä–µ–ø—Ä–∏–≤—è–∑—ã–≤–∞–µ–º –∏—Å—Ç–æ—á–Ω–∏–∫
  if (bitEnabled) {
    try {
      initAudioContext();
      startLogoPulsation();
    } catch(e) {}
  }

  loadLyrics(tr.lyrics);
  setupMediaSession();
  restorePlayerButtonsState();
  applyLyricsViewMode();
  initializePlayerControls();
  prefetchNextTrackAssets();

  audioEl.addEventListener('loadedmetadata', onAudioMetadataLoaded);
  audioEl.addEventListener('timeupdate', onAudioTimeUpdate);
  audioEl.addEventListener('ended', onAudioEnded);
}

/* ====== –õ–∏—Ä–∏–∫–∞ ====== */
let lyricsViewMode = 'normal';
function restoreLyricsViewMode() {
  try {
    const saved = localStorage.getItem('lyricsViewMode');
    if (saved && ['normal','hidden','expanded'].includes(saved)) lyricsViewMode = saved;
  } catch {}
}
function saveLyricsViewMode() { try { localStorage.setItem('lyricsViewMode', lyricsViewMode); } catch {} }
restoreLyricsViewMode();

function renderLyrics(time) {
  if (!currentLyrics || !currentLyrics.length) {
    const el = document.getElementById('lyrics');
    if (el) el.innerHTML = '';
    return;
  }
  const windowSize = (lyricsViewMode === 'expanded') ? 9 : 5;
  const centerLine = Math.floor(windowSize / 2);

  let active = 0;
  for (let i = 0; i < currentLyrics.length; i++) {
    if (time >= currentLyrics[i].time) active = i;
  }

  const start = Math.max(0, active - centerLine);
  const padTop = Math.max(0, centerLine - active);
  const rows = [];

  for (let p = 0; p < padTop; ++p) rows.push('<div class="lyrics-window-line"></div>');
  for (let i = start; i < Math.min(currentLyrics.length, start + windowSize - padTop); i++) {
    const cls = (i === active) ? 'lyrics-window-line active' : 'lyrics-window-line';
    rows.push(`<div class="${cls}">${currentLyrics[i] ? currentLyrics[i].line : ''}</div>`);
  }
  while (rows.length < windowSize) rows.push('<div class="lyrics-window-line"></div>');

  const lyricsEl = document.getElementById('lyrics');
  if (lyricsEl) lyricsEl.innerHTML = rows.join('');
}
function renderLyricsEnhanced(t){ if (lyricsViewMode==='hidden') return; renderLyrics(t); }
function copyLyrics(){
  if (!playingConfig || currentTrack<0 || !playingConfig.tracks[currentTrack].fulltext) { NotificationSystem.warning('–§–∞–π–ª —Å —Ç–µ–∫—Å—Ç–æ–º –Ω–µ –Ω–∞–π–¥–µ–Ω!'); return; }
  fetch(playingConfig.tracks[currentTrack].fulltext).then(r=>r.text()).then(txt=>{
    if (navigator.clipboard && window.isSecureContext) navigator.clipboard.writeText(txt).then(()=>NotificationSystem.success('–¢–µ–∫—Å—Ç —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω!'),()=>NotificationSystem.error('–ù–µ —É–¥–∞–ª–æ—Å—å —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å'));
    else {
      const ta=document.createElement('textarea'); ta.value=txt; document.body.appendChild(ta); ta.select();
      try { document.execCommand('copy'); NotificationSystem.success('–¢–µ–∫—Å—Ç —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω!'); } catch { NotificationSystem.error('–ù–µ —É–¥–∞–ª–æ—Å—å —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å'); }
      document.body.removeChild(ta);
    }
  }).catch(()=> NotificationSystem.error('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å —Ç–µ–∫—Å—Ç!'));
}
function toggleLyricsView(){
  const modes=['normal','hidden','expanded'];
  lyricsViewMode = modes[(modes.indexOf(lyricsViewMode)+1)%modes.length];
  applyLyricsViewMode();
  saveLyricsViewMode();
  const msg = {normal:'üìù –û–±—ã—á–Ω—ã–π –≤–∏–¥ –ª–∏—Ä–∏–∫–∏', hidden:'üö´ –õ–∏—Ä–∏–∫–∞ —Å–∫—Ä—ã—Ç–∞', expanded:'üìñ –†–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–π –≤–∏–¥ –ª–∏—Ä–∏–∫–∏'}[lyricsViewMode];
  NotificationSystem.info(msg);
}
function applyLyricsViewMode(){
  const w=document.getElementById('lyrics-window'), btn=document.querySelector('.lyrics-toggle-btn');
  if (!w||!btn) return;
  w.classList.remove('lyrics-normal','lyrics-hidden','lyrics-expanded'); btn.classList.remove('lyrics-normal','lyrics-hidden','lyrics-expanded');
  w.classList.add(`lyrics-${lyricsViewMode}`); btn.classList.add(`lyrics-${lyricsViewMode}`);
}

/* ====== –ö–æ–Ω—Ç—Ä–æ–ª—ã –ø–ª–µ–µ—Ä–∞ ====== */
let lastTimeUpdate = 0, isSeekingProgress=false, isMuted=false, sleepTimerInterval=null, sleepTimerTarget=null;

function initializePlayerControls() {
  const progressBar = document.getElementById('player-progress-bar');
  if (progressBar) {
    progressBar.addEventListener('click', seekToPosition);
    const startDrag = (e)=>{
      isSeekingProgress = true;
      const moveHandler = (e2) => {
        const rect = progressBar.getBoundingClientRect();
        const clientX = e2.touches ? e2.touches[0].clientX : e2.clientX;
        const percent = Math.max(0, Math.min(1, (clientX - rect.left) / rect.width));
        document.getElementById('player-progress-fill').style.width = `${percent*100}%`;
      };
      const endHandler = (e3) => {
        const rect = progressBar.getBoundingClientRect();
        const clientX = e3.changedTouches ? e3.changedTouches[0].clientX : e3.clientX;
        const percent = Math.max(0, Math.min(1, (clientX - rect.left) / rect.width));
        const audio = document.getElementById('audio');
        audio.currentTime = (audio.duration || 0) * percent;
        isSeekingProgress = false;
        document.removeEventListener('mousemove', moveHandler);
        document.removeEventListener('mouseup', endHandler);
        document.removeEventListener('touchmove', moveHandler);
        document.removeEventListener('touchend', endHandler);
      };
      document.addEventListener('mousemove', moveHandler);
      document.addEventListener('mouseup', endHandler);
      document.addEventListener('touchmove', moveHandler, {passive:false});
      document.addEventListener('touchend', endHandler);
      e.preventDefault();
    };
    progressBar.addEventListener('mousedown', startDrag);
    progressBar.addEventListener('touchstart', startDrag, {passive:false});
  }

  const volumeSlider = document.getElementById('volume-slider');
  if (volumeSlider) {
    volumeSlider.addEventListener('input', onVolumeSliderChange);
    const savedVolumeRaw = localStorage.getItem('playerVolume');
    const savedVolume = parseFloat(savedVolumeRaw);
    const volume = Number.isFinite(savedVolume) ? savedVolume : 1;
    volumeSlider.value = Math.round(volume * 100);
    updateVolumeUI(volume);
    const audio = document.getElementById('audio');
    if (audio) audio.volume = volume;
  }
}

function onAudioMetadataLoaded(e) {
  const audio = (e && (e.currentTarget || e.target)) || document.getElementById('audio');
  if (!audio) return;
  const duration = audio.duration || 0;
  const elapsedEl = document.getElementById('time-elapsed');
  const remainingEl = document.getElementById('time-remaining');
  if (elapsedEl) elapsedEl.textContent = '00:00';
  if (remainingEl) remainingEl.textContent = formatTime(duration);
}
function onAudioTimeUpdate(e) {
  const audio = (e && (e.currentTarget || e.target)) || document.getElementById('audio');
  if (!audio) return;
  const currentTime = audio.currentTime || 0;
  const duration = audio.duration || 0;

  if (!isSeekingProgress && duration > 0) {
    const fill = document.getElementById('player-progress-fill');
    if (fill) fill.style.width = `${(currentTime / duration) * 100}%`;
  }
  renderLyricsEnhanced(currentTime);

  const now = Date.now();
  if (now - lastTimeUpdate >= 1000) {
    lastTimeUpdate = now;
    const elapsedEl = document.getElementById('time-elapsed');
    const remainingEl = document.getElementById('time-remaining');
    if (elapsedEl) elapsedEl.textContent = formatTime(currentTime);
    if (remainingEl) remainingEl.textContent = formatTime(Math.max(0, duration - currentTime));
    try { PlayerState.save(); } catch {}
  }
  updatePlayPauseIcon();
}
function onAudioEnded(e) {
  const remainingEl = document.getElementById('time-remaining');
  if (remainingEl) remainingEl.textContent = '00:00';
  const audio = (e && (e.currentTarget || e.target)) || document.getElementById('audio');
  if (repeatMode && audio) {
    audio.currentTime = 0;
    const p = audio.play();
    if (p && p.catch) p.catch(()=>{});
  } else {
    nextTrack();
  }
}

function seekToPosition(e) {
  const audio = document.getElementById('audio');
  if (!audio || !isFinite(audio.duration) || audio.duration <= 0) return;
  const rect = e.currentTarget.getBoundingClientRect();
  const clientX = e.clientX ?? (e.touches && e.touches[0] && e.touches[0].clientX);
  if (typeof clientX !== 'number') return;
  const percent = Math.max(0, Math.min(1, (clientX - rect.left) / rect.width));
  audio.currentTime = audio.duration * percent;
}
function onVolumeSliderChange(e) {
  const value = (e && e.target ? e.target.value : 100) / 100;
  const audio = document.getElementById('audio');
  if (audio) audio.volume = value;
  updateVolumeUI(value);
  try { localStorage.setItem('playerVolume', value); } catch {}
}
function updateVolumeUI(volume){
  const percent = Math.max(0, Math.min(100, Math.round(volume * 100)));
  const vf = document.getElementById('volume-fill');
  if (vf) {
    vf.style.width = `${percent}%`;
  }
}
function toggleMute() {
  const audio = document.getElementById('audio');
  if (!audio) return;
  if (isMuted) {
    const saved = parseFloat(localStorage.getItem('playerVolume'));
    audio.volume = Number.isFinite(saved) && saved > 0 ? saved : 1;
    isMuted = false;
  } else {
    try { localStorage.setItem('playerVolume', audio.volume); } catch {}
    audio.volume = 0;
    isMuted = true;
  }
  updateVolumeUI(audio.volume);
}
function togglePlayPause() {
  const a = getCurrentAudio(); if (!a) return;
  if (a.paused) { a.play().catch(()=>{}); } else { a.pause(); }
}
function updatePlayPauseIcon() {
  const a = document.getElementById('audio'), icon = document.getElementById('play-pause-icon'); if (!a || !icon) return;
  icon.innerHTML = a.paused ? '<path d="M8 5v14l11-7z"/>' : '<path d="M6 6h4v12H6zM14 6h4v12h-4z"/>';
}
function stopPlayback(){
  const a = getCurrentAudio(); if (!a) return;
  a.pause(); a.currentTime = 0; updatePlayPauseIcon();
}
function toggleRepeat(){ repeatMode = !repeatMode; const btn=document.getElementById('repeat-btn'); if (repeatMode) btn.classList.add('repeat-active'); else btn.classList.remove('repeat-active'); localStorage.setItem('repeatMode', repeatMode?'1':'0'); }
function toggleShuffle(){ shuffleMode=!shuffleMode; const btn=document.getElementById('shuffle-btn'); if (shuffleMode){ btn.classList.add('active'); createShuffledPlaylist(); NotificationSystem.info('üîÄ –°–ª—É—á–∞–π–Ω—ã–π –ø–æ—Ä—è–¥–æ–∫'); } else { btn.classList.remove('active'); NotificationSystem.info('–ü–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ'); } localStorage.setItem('shuffleMode', shuffleMode?'1':'0'); }
function toggleFavoritesOnly(){
  const likedPlaying = getLikedForAlbum(playingAlbumKey);
  if (!likedPlaying.length) {
    NotificationSystem.warning('–ù–µ—Ç –∏–∑–±—Ä–∞–Ω–Ω—ã—Ö —Ç—Ä–µ–∫–æ–≤ –≤ –∞–ª—å–±–æ–º–µ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è!');
    return;
  }

  favoritesOnlyMode = !favoritesOnlyMode;
  const btn = document.getElementById('favorites-btn');
  const icon = document.getElementById('favorites-btn-icon');

  if (favoritesOnlyMode) {
    btn && btn.classList.add('favorites-active');
    if (icon) icon.src = 'img/star.png';

    // –ï—Å–ª–∏ –∞–ª—å–±–æ–º –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ —Å–æ–≤–ø–∞–¥–∞–µ—Ç —Å –∞–ª—å–±–æ–º–æ–º –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è ‚Äî –º–æ–∂–Ω–æ –≤–∫–ª—é—á–∏—Ç—å —Ñ–∏–ª—å—Ç—Ä –≤ —Å–ø–∏—Å–∫–µ
    if (currentAlbumKey === playingAlbumKey) {
      favoritesFilterActive = true;
      const filterBtn = document.getElementById('filter-favorites-btn');
      const list = document.getElementById('track-list');
      filterBtn && filterBtn.classList.add('filtered');
      if (filterBtn) filterBtn.textContent = '–ü–û–ö–ê–ó–ê–¢–¨ –í–°–ï –ü–ï–°–ù–ò';
      list && list.classList.add('filtered');
      updateFavoriteClasses();
    }

    updateAvailableTracks();
    NotificationSystem.success(`‚≠ê –¢–æ–ª—å–∫–æ –∏–∑–±—Ä–∞–Ω–Ω—ã–µ (${likedPlaying.length})`);

    if (!isLikedForAlbum(playingAlbumKey, currentTrack)) {
      const n = getNextFavoriteTrack();
      if (n !== -1) showTrack(n, true);
    }

    if (shuffleMode) createShuffledPlaylist();
  } else {
    btn && btn.classList.remove('favorites-active');
    if (icon) icon.src = 'img/star2.png';

    if (currentAlbumKey === playingAlbumKey) {
      favoritesFilterActive = false;
      const filterBtn = document.getElementById('filter-favorites-btn');
      const list = document.getElementById('track-list');
      filterBtn && filterBtn.classList.remove('filtered');
      if (filterBtn) filterBtn.textContent = '–°–∫—Ä—ã—Ç—å –Ω–µ –æ—Ç–º–µ—á–µ–Ω–Ω—ã–µ ‚≠ê –ø–µ—Å–Ω–∏';
      list && list.classList.remove('filtered');
    }

    updateAvailableTracks();
    NotificationSystem.info('–ò–≥—Ä–∞—é—Ç –≤—Å–µ —Ç—Ä–µ–∫–∏');

    if (shuffleMode) createShuffledPlaylist();
  }

  localStorage.setItem('favoritesOnlyMode', favoritesOnlyMode ? '1' : '0');
}

function updateAvailableTracks(){
  const len = playingConfig?.tracks?.length || 0;
  if (!len) { availableTracks = []; return; }
  if (favoritesOnlyMode) {
    const liked = getLikedForAlbum(playingAlbumKey).filter(i => Number.isInteger(i) && i >= 0 && i < len);
    availableTracks = liked;
  } else {
    availableTracks = Array.from({length: len}, (_,i)=>i);
  }
}
function getNextFavoriteTrack(){
  const liked = getLikedForAlbum(playingAlbumKey);
  if (!liked.length) return -1;
  const pos = liked.indexOf(currentTrack);
  return pos!==-1 && pos<liked.length-1 ? liked[pos+1] : liked[0];
}

function previousTrack(){
  if (!playingConfig?.tracks?.length) return;
  if (repeatMode){ const a=document.getElementById('audio'); a.currentTime=0; a.play(); return; }
  updateAvailableTracks();
  if (!availableTracks.length) return NotificationSystem.warning('–ù–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã—Ö —Ç—Ä–µ–∫–æ–≤');
  if (shuffleMode){
    shuffleIndex = Math.max(0, shuffleIndex-1);
    showTrack(shuffledPlaylist[shuffleIndex]||availableTracks[0], true);
  }
  else if (favoritesOnlyMode){
    const idx=availableTracks.indexOf(currentTrack);
    const prev = idx>0 ? availableTracks[idx-1] : availableTracks[availableTracks.length-1];
    showTrack(prev,true);
  }
  else {
    const prev = currentTrack>0 ? currentTrack-1 : playingConfig.tracks.length-1;
    showTrack(prev,true);
  }
}
function nextTrack(){
  if (!playingConfig?.tracks?.length) return;
  if (repeatMode) {
    const a = document.getElementById('audio');
    if (a) { a.currentTime = 0; a.play().catch(()=>{}); }
    return;
  }

  updateAvailableTracks();
  if (!availableTracks.length) {
    NotificationSystem.warning('–ù–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã—Ö —Ç—Ä–µ–∫–æ–≤');
    return;
  }

  if (shuffleMode) {
    if (!Array.isArray(shuffledPlaylist) || shuffledPlaylist.length === 0) {
      createShuffledPlaylist();
    }
    shuffleIndex++;
    if (shuffleIndex >= shuffledPlaylist.length) {
      createShuffledPlaylist();
      shuffleIndex = 0;
    }
    let candidate = shuffledPlaylist[shuffleIndex];

    if (availableTracks.length > 1 && candidate === currentTrack) {
      shuffleIndex = (shuffleIndex + 1) % shuffledPlaylist.length;
      candidate = shuffledPlaylist[shuffleIndex];
    }
    showTrack(candidate, true);
    return;
  }

  if (favoritesOnlyMode) {
    const idx = availableTracks.indexOf(currentTrack);
    const next = availableTracks[(idx + 1 + availableTracks.length) % availableTracks.length];
    showTrack(next, true);
    return;
  }

  const n = (currentTrack + 1) % playingConfig.tracks.length;
  showTrack(n, true);
}
function createShuffledPlaylist(){
  updateAvailableTracks();
  shuffledPlaylist = [...availableTracks];

  const i = shuffledPlaylist.indexOf(currentTrack);
  if (i !== -1) shuffledPlaylist.splice(i, 1);

  for (let j = shuffledPlaylist.length - 1; j > 0; j--) {
    const k = Math.floor(Math.random() * (j + 1));
    [shuffledPlaylist[j], shuffledPlaylist[k]] = [shuffledPlaylist[k], shuffledPlaylist[j]];
  }

  if (availableTracks.includes(currentTrack)) shuffledPlaylist.unshift(currentTrack);
  shuffleIndex = 0;
}

/* ====== Prefetch —Å–ª–µ–¥—É—é—â–µ–≥–æ —Ç—Ä–µ–∫–∞ ====== */
function computeNextTrackIndexCandidate() {
  if (!playingConfig || !Array.isArray(playingConfig.tracks) || playingConfig.tracks.length === 0) return -1;
  updateAvailableTracks();
  if (shuffleMode) {
    if (!Array.isArray(shuffledPlaylist) || shuffledPlaylist.length === 0) createShuffledPlaylist();
    const nextIdxInShuffled = Math.min(shuffleIndex + 1, Math.max(0, shuffledPlaylist.length - 1));
    const cand = shuffledPlaylist[nextIdxInShuffled];
    return (typeof cand === 'number') ? cand : -1;
  }
  if (favoritesOnlyMode) {
    if (!Array.isArray(availableTracks) || availableTracks.length === 0) return -1;
    const curPos = availableTracks.indexOf(currentTrack);
    if (curPos === -1) return availableTracks[0] ?? -1;
    const nextPos = (curPos + 1) % availableTracks.length;
    return availableTracks[nextPos] ?? -1;
  }
  return (currentTrack >= 0) ? ((currentTrack + 1) % playingConfig.tracks.length) : 0;
}
function prefetchAudioLink(url, asType='audio') {
  if (!url) return;
  try {
    const link = document.createElement('link');
    link.rel = 'prefetch';
    link.as = asType;
    link.href = url;
    link.crossOrigin = 'anonymous';
    document.head.appendChild(link);
    fetch(url).catch(()=>{});
  } catch(e) {}
}
function prefetchNextTrackAssets() {
  const cand = computeNextTrackIndexCandidate();
  if (cand < 0 || !playingConfig?.tracks?.[cand]) return;
  const t = playingConfig.tracks[cand];
  prefetchAudioLink(t.audio, 'audio');
  if (t.lyrics) prefetchAudioLink(t.lyrics, 'fetch');
  if (t.fulltext) prefetchAudioLink(t.fulltext, 'fetch');
}

/* ====== –ó–∞–≥—Ä—É–∑–∫–∞ –ª–∏—Ä–∏–∫–∏ ====== */
function loadLyrics(file){ fetch(file).then(r=>r.json()).then(js=>{ currentLyrics=js; renderLyrics(0); }).catch(()=>{ currentLyrics=[]; }); }

/* ====== MediaSession ====== */
function setupMediaSession(){
  if (!('mediaSession' in navigator) || !playingConfig || currentTrack<0) return;
  const tr=playingConfig.tracks[currentTrack];
  navigator.mediaSession.metadata = new MediaMetadata({
    title: tr.title, artist: playingConfig.artist || '–í–∏—Ç—Ä–∏–Ω–∞ –†–∞–∑–±–∏—Ç–∞', album: playingConfig.albumName || '–ê–ª—å–±–æ–º',
    artwork: [{src: coverGalleryArr[0]||'img/logo.png', sizes:'512x512', type:'image/png'}]
  });
  navigator.mediaSession.setActionHandler('play', ()=>{ const a=document.getElementById('audio'); a&&a.play(); updatePlayPauseIcon(); });
  navigator.mediaSession.setActionHandler('pause', ()=>{ const a=document.getElementById('audio'); a&&a.pause(); updatePlayPauseIcon(); });
  navigator.mediaSession.setActionHandler('previoustrack', previousTrack);
  navigator.mediaSession.setActionHandler('nexttrack', nextTrack);
  navigator.mediaSession.setActionHandler('seekbackward', ()=>{ const a=document.getElementById('audio'); if (a) a.currentTime=Math.max(0,(a.currentTime||0)-10); });
  navigator.mediaSession.setActionHandler('seekforward', ()=>{ const a=document.getElementById('audio'); if (a) a.currentTime=Math.min(a.duration,(a.currentTime||0)+10); });
}

/* ====== –í—Ä–µ–º—è ====== */
function formatTime(sec){ if (isNaN(sec)||sec<0) return '--:--'; const m=Math.floor(sec/60), s=Math.floor(sec%60); return `${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}`; }

/* ====== –•–æ—Ç–∫–µ–∏ ====== */
window.addEventListener('keydown', function(e){
  if (e.target.tagName==='INPUT' || e.target.tagName==='TEXTAREA') return;
  const hasModal = document.querySelector('.modal-bg.active');
  if (e.key==='Escape' && hasModal){ e.preventDefault(); document.querySelectorAll('.modal-bg.active').forEach(m=>m.classList.remove('active')); return; }
  if (hasModal) return;
  const audio=document.getElementById('audio');
  switch(e.key.toUpperCase()){
    case ' ': case 'K': e.preventDefault(); togglePlayPause(); break;
    case 'X': e.preventDefault(); stopPlayback(); break;
    case 'N': e.preventDefault(); nextTrack(); break;
    case 'P': e.preventDefault(); previousTrack(); break;
    case 'J': e.preventDefault(); if (audio) audio.currentTime=Math.max(0,(audio.currentTime||0)-10); break;
    case 'L': e.preventDefault(); if (audio) audio.currentTime=Math.min(audi‚Ä¶ (truncated in editor for brevity)
    case 'L':
      e.preventDefault();
      if (audio) audio.currentTime = Math.min(audio.duration || 0, (audio.currentTime || 0) + 10);
      break;
    case 'ARROWLEFT':
      e.preventDefault();
      if (audio) audio.currentTime = Math.max(0, (audio.currentTime || 0) - 5);
      break;
    case 'ARROWRIGHT':
      e.preventDefault();
      if (audio) audio.currentTime = Math.min(audio.duration || 0, (audio.currentTime || 0) + 5);
      break;
    case 'ARROWUP':
      e.preventDefault();
      if (audio) {
        const v = Math.min(1, (audio.volume || 0) + 0.05);
        audio.volume = v;
        updateVolumeUI(v);
        try { localStorage.setItem('playerVolume', v); } catch {}
      }
      break;
    case 'ARROWDOWN':
      e.preventDefault();
      if (audio) {
        const v = Math.max(0, (audio.volume || 0) - 0.05);
        audio.volume = v;
        updateVolumeUI(v);
        try { localStorage.setItem('playerVolume', v); } catch {}
      }
      break;
    case 'A':
      e.preventDefault();
      toggleAnimation();
      break;
    case 'B':
      e.preventDefault();
      toggleBit();
      break;
    case 'F':
      e.preventDefault();
      toggleFavoritesOnly();
      break;
    case 'R':
      e.preventDefault();
      toggleRepeat();
      break;
    case 'U':
      e.preventDefault();
      toggleShuffle();
      break;
    case 'M':
      e.preventDefault();
      toggleMute();
      break;
    case 'Y':
      e.preventDefault();
      toggleLyricsView();
      break;
    case 'T':
      e.preventDefault();
      toggleSleepMenu();
      break;
    case 'D':
      e.preventDefault();
      toggleLikeForPlayingTrack();
      break;
  }
});

/* ====== –ò–∑–±—Ä–∞–Ω–Ω–æ–µ: –≥–æ—Ä—è—á–∞—è –∫–ª–∞–≤–∏—à–∞ –¥–ª—è –ò–ì–†–ê–Æ–©–ï–ì–û –∞–ª—å–±–æ–º–∞ ====== */
function toggleLikeForPlayingTrack() {
  if (!playingAlbumKey || currentTrack < 0) return;
  toggleLike(currentTrack, null, playingAlbumKey);
  if (currentAlbumKey === playingAlbumKey) {
    // –û–±–Ω–æ–≤–∏–º –ø–æ–¥—Å–≤–µ—Ç–∫—É —Ç–µ–∫—É—â–µ–≥–æ —Ç—Ä–µ–∫–∞ –≤ —Å–ø–∏—Å–∫–µ (–µ—Å–ª–∏ –ø—Ä–æ—Å–º–∞—Ç—Ä–∏–≤–∞–µ–º —Ç–æ—Ç –∂–µ –∞–ª—å–±–æ–º)
    const el = document.querySelector(`#trk${currentTrack} .like-star`);
    if (el) {
      const liked = isLikedForAlbum(playingAlbumKey, currentTrack);
      el.src = liked ? 'img/star.png' : 'img/star2.png';
      el.title = liked ? '–£–±—Ä–∞—Ç—å –∏–∑ –ø–æ–Ω—Ä–∞–≤–∏–≤—à–∏—Ö—Å—è' : '–î–æ–±–∞–≤–∏—Ç—å –≤ –ø–æ–Ω—Ä–∞–≤–∏–≤—à–∏–µ—Å—è';
    }
  }
}

/* ====== –ö–Ω–æ–ø–∫–∏/–∏–∫–æ–Ω–∫–∏ —Å–æ—Å—Ç–æ—è–Ω–∏—è ====== */
function restorePlayerButtonsState() {
  const shuffleBtn = document.getElementById('shuffle-btn');
  const repeatBtn = document.getElementById('repeat-btn');
  const favBtn = document.getElementById('favorites-btn');
  const favIcon = document.getElementById('favorites-btn-icon');
  const animBtn = document.getElementById('animation-btn');
  const bitBtn = document.getElementById('bit-btn');

  if (shuffleBtn) shuffleBtn.classList.toggle('active', !!shuffleMode);
  if (repeatBtn) repeatBtn.classList.toggle('repeat-active', !!repeatMode);
  if (favBtn) favBtn.classList.toggle('favorites-active', !!favoritesOnlyMode);
  if (favIcon) favIcon.src = favoritesOnlyMode ? 'img/star.png' : 'img/star2.png';
  if (animBtn) animBtn.classList.toggle('animation-active', !!animationEnabled);
  if (bitBtn) bitBtn.classList.toggle('bit-active', !!bitEnabled);
}

/* ====== –ê–Ω–∏–º–∞—Ü–∏—è –ª–∏—Ä–∏–∫–∏ ====== */
function toggleAnimation() {
  animationEnabled = !animationEnabled;
  const bg = document.querySelector('.lyrics-animated-bg');
  if (bg) bg.classList.toggle('active', animationEnabled);
  const btn = document.getElementById('animation-btn');
  if (btn) btn.classList.toggle('animation-active', animationEnabled);
  try { localStorage.setItem('animationEnabled', animationEnabled ? '1' : '0'); } catch {}
  NotificationSystem.info(animationEnabled ? '–ê–Ω–∏–º–∞—Ü–∏—è –≤–∫–ª—é—á–µ–Ω–∞' : '–ê–Ω–∏–º–∞—Ü–∏—è –≤—ã–∫–ª—é—á–µ–Ω–∞');
}

/* ====== –ü—É–ª—å—Å–∞—Ü–∏—è –ª–æ–≥–æ—Ç–∏–ø–∞ –æ—Ç –±–∏—Ç–∞ ====== */
function toggleBit() {
  bitEnabled = !bitEnabled;
  const btn = document.getElementById('bit-btn');
  if (btn) btn.classList.toggle('bit-active', bitEnabled);
  try { localStorage.setItem('bitEnabled', bitEnabled ? '1' : '0'); } catch {}

  if (bitEnabled) {
    try {
      initAudioContext();
      startLogoPulsation();
      NotificationSystem.info('–ü—É–ª—å—Å–∞—Ü–∏—è –≤–∫–ª—é—á–µ–Ω–∞');
    } catch {
      NotificationSystem.warning('–ù–µ —É–¥–∞–ª–æ—Å—å –≤–∫–ª—é—á–∏—Ç—å –ø—É–ª—å—Å–∞—Ü–∏—é');
      bitEnabled = false;
      btn && btn.classList.remove('bit-active');
      try { localStorage.setItem('bitEnabled', '0'); } catch {}
    }
  } else {
    stopLogoPulsation();
    NotificationSystem.info('–ü—É–ª—å—Å–∞—Ü–∏—è –≤—ã–∫–ª—é—á–µ–Ω–∞');
  }
}

function initAudioContext() {
  if (audioContext) return;
  const AudioCtx = window.AudioContext || window.webkitAudioContext;
  if (!AudioCtx) throw new Error('AudioContext not supported');
  audioContext = new AudioCtx();
}

function startLogoPulsation() {
  const audioEl = document.getElementById('audio');
  if (!audioEl || !audioContext) return;

  try {
    if (!audioSource) {
      audioSource = audioContext.createMediaElementSource(audioEl);
      analyser = audioContext.createAnalyser();
      analyser.fftSize = 2048;
      audioSource.connect(analyser);
      analyser.connect(audioContext.destination);
    }
  } catch {
    // –í –Ω–µ–∫–æ—Ç–æ—Ä—ã—Ö –±—Ä–∞—É–∑–µ—Ä–∞—Ö –ø–æ–≤—Ç–æ—Ä–Ω–æ–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∏—Å—Ç–æ—á–Ω–∏–∫–∞ –º–æ–∂–µ—Ç –±—Ä–æ—Å–∞—Ç—å –æ—à–∏–±–∫—É
  }

  cancelAnimationFrame(animationFrame);

  const logo = document.getElementById('logo') || document.querySelector('.brand-logo') || document.querySelector('#header .logo') || document.body;
  const bufferLength = analyser ? analyser.frequencyBinCount : 0;
  const dataArray = bufferLength ? new Uint8Array(bufferLength) : null;

  const animate = () => {
    if (!bitEnabled || !analyser || !dataArray) { if (logo && logo.style) logo.style.transform = ''; return; }
    analyser.getByteFrequencyData(dataArray);
    // –ü—Ä–æ—Å—Ç–æ–π RMS –ø–æ –Ω–∏–∑–∫–∏–º —á–∞—Å—Ç–æ—Ç–∞–º
    const take = Math.max(8, Math.floor(bufferLength * 0.1));
    let sum = 0;
    for (let i = 0; i < take; i++) sum += dataArray[i] * dataArray[i];
    const rms = Math.sqrt(sum / take) / 255;
    const scale = 1 + (rms * (bitIntensity / 100)) * 0.15;
    if (logo && logo.style) logo.style.transform = `scale(${scale.toFixed(3)})`;
    animationFrame = requestAnimationFrame(animate);
  };
  animationFrame = requestAnimationFrame(animate);
}

function stopLogoPulsation() {
  if (animationFrame) cancelAnimationFrame(animationFrame);
  animationFrame = null;
  const logo = document.getElementById('logo') || document.querySelector('.brand-logo') || document.querySelector('#header .logo') || document.body;
  if (logo && logo.style) logo.style.transform = '';
}

/* ====== –¢–∞–π–º–µ—Ä —Å–Ω–∞ ====== */
function toggleSleepMenu() {
  const btn = document.getElementById('sleep-timer-btn');
  if (!btn) return;
  const menu = document.getElementById('sleep-menu');
  if (!menu) return;
  menu.classList.toggle('open');
  // –ó–∞–∫—Ä—ã—Ç–∏–µ –ø–æ –∫–ª–∏–∫—É –≤–Ω–µ
  const onDoc = (e) => {
    if (!btn.contains(e.target)) {
      menu.classList.remove('open');
      document.removeEventListener('click', onDoc);
    }
  };
  setTimeout(() => document.addEventListener('click', onDoc), 0);
}

function setSleepTimer(value) {
  const badge = document.getElementById('sleep-timer-badge');
  const now = Date.now();

  if (value === 'off') {
    sleepTimerTarget = null;
    if (sleepTimerInterval) clearInterval(sleepTimerInterval);
    sleepTimerInterval = null;
    if (badge) badge.style.display = 'none';
    NotificationSystem.info('–¢–∞–π–º–µ—Ä —Å–Ω–∞ –æ—Ç–∫–ª—é—á—ë–Ω');
    return;
  }

  if (typeof value === 'number' && value > 0) {
    sleepTimerTarget = now + value * 60 * 1000;
  } else if (value instanceof Date) {
    const t = value.getTime();
    sleepTimerTarget = t > now ? t : now + 60 * 1000;
  } else {
    return;
  }

  if (sleepTimerInterval) clearInterval(sleepTimerInterval);
  sleepTimerInterval = setInterval(checkSleepTimer, 1000);
  updateSleepBadge();
  NotificationSystem.success('–¢–∞–π–º–µ—Ä —Å–Ω–∞ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω');
  const menu = document.getElementById('sleep-menu');
  if (menu) menu.classList.remove('open');
}

function showTimePickerForSleep() {
  const inp = prompt('–í–≤–µ–¥–∏—Ç–µ –≤—Ä–µ–º—è –≤ —Ñ–æ—Ä–º–∞—Ç–µ –ß–ß:–ú–ú (24—á), –∫–æ–≥–¥–∞ –≤—ã–∫–ª—é—á–∏—Ç—å –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ:', '23:00');
  if (!inp) return;
  const m = /^(\d{1,2}):(\d{2})$/.exec(inp.trim());
  if (!m) { NotificationSystem.error('–ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –≤—Ä–µ–º–µ–Ω–∏'); return; }
  let hh = parseInt(m[1], 10), mm = parseInt(m[2], 10);
  if (hh < 0 || hh > 23 || mm < 0 || mm > 59) { NotificationSystem.error('–ù–µ–≤–µ—Ä–Ω–æ–µ –≤—Ä–µ–º—è'); return; }
  const now = new Date();
  const tgt = new Date(now.getFullYear(), now.getMonth(), now.getDate(), hh, mm, 0, 0);
  if (tgt.getTime() <= now.getTime()) tgt.setDate(tgt.getDate() + 1);
  setSleepTimer(tgt);
}

function checkSleepTimer() {
  if (!sleepTimerTarget) return;
  const now = Date.now();
  if (now >= sleepTimerTarget) {
    setSleepTimer('off');
    const a = document.getElementById('audio');
    if (a) a.pause();
    NotificationSystem.info('–¢–∞–π–º–µ—Ä —Å–Ω–∞: –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ');
  } else {
    updateSleepBadge();
  }
}

function updateSleepBadge() {
  const badge = document.getElementById('sleep-timer-badge');
  if (!badge || !sleepTimerTarget) return;
  const remainMs = Math.max(0, sleepTimerTarget - Date.now());
  const remainMin = Math.ceil(remainMs / 60000);
  badge.textContent = remainMin;
  badge.style.display = remainMin > 0 ? '' : 'none';
}

/* ====== –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –Ω–∞ iOS: –ø–æ–¥—Å–∫–∞–∑–∫–∞ ====== */
function detectIOSAndShowInstallGuide() {
  try {
    const isIOS = /iP(ad|hone|od)/.test(navigator.platform) || (navigator.userAgent.includes('Mac') && 'ontouchend' in document);
    const isStandalone = window.navigator.standalone || window.matchMedia('(display-mode: standalone)').matches;
    const el = document.getElementById('ios-install-hint');
    if (!el) return;
    if (isIOS && !isStandalone) {
      el.style.display = '';
    } else {
      el.style.display = 'none';
    }
  } catch {}
}

/* ====== –û—Ñ—Ñ–ª–∞–π–Ω ====== */
function syncOfflineState() {
  try {
    if (navigator.serviceWorker && navigator.serviceWorker.controller) {
      navigator.serviceWorker.controller.postMessage({ type: 'REQUEST_OFFLINE_STATE' });
    }
  } catch {}
}
function setOfflineUIState(state) {
  document.body.classList.toggle('offline', state === 'offline');
}

/* ====== –ì–ª—É–±–æ–∫–∏–µ —Å—Å—ã–ª–∫–∏ ====== */
function parseDeepLink() {
  const params = new URLSearchParams(location.search);
  // –ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Ä–µ–∂–∏–º–æ–≤
  if (params.get('shuffle') === '1') {
    shuffleMode = true; localStorage.setItem('shuffleMode','1');
  }
  if (params.get('repeat') === '1') {
    repeatMode = true; localStorage.setItem('repeatMode','1');
  }
  if (params.get('fav') === '1' || params.get('favorites') === '1') {
    favoritesOnlyMode = true; localStorage.setItem('favoritesOnlyMode','1');
  }

  const tParam = params.get('t') ?? params.get('track');
  if (tParam != null && config && Array.isArray(config.tracks)) {
    let n = parseInt(String(tParam), 10);
    if (Number.isNaN(n)) n = 0;
    // –ü–æ–¥–¥–µ—Ä–∂–∫–∞ –∫–∞–∫ 1-based, —Ç–∞–∫ –∏ 0-based
    if (n >= 1 && n <= config.tracks.length) n = n - 1;
    else if (n >= config.tracks.length) n = config.tracks.length - 1;
    else if (n < 0) n = 0;

    const autoplay = params.get('play') === '1' || params.get('autoplay') === '1';
    setPlaybackContextFromViewing();
    showTrack(n, autoplay);
  } else {
    // –ï—Å–ª–∏ –Ω–∏—á–µ–≥–æ –Ω–µ –ø–µ—Ä–µ–¥–∞–Ω–æ ‚Äî –ø—Ä–æ—Å—Ç–æ –æ–±–Ω–æ–≤–∏–º —Å–æ—Å—Ç–æ—è–Ω–∏—è –∫–Ω–æ–ø–æ–∫
    restorePlayerButtonsState();
  }
}

/* ====== –°–∫–∞—á–∏–≤–∞–Ω–∏–µ —Ç–µ–∫—É—â–µ–≥–æ —Ç—Ä–µ–∫–∞ ====== */
function openDownloadModal(e) {
  if (e) e.preventDefault();
  if (!playingConfig || currentTrack < 0) {
    NotificationSystem.warning('–ù–µ—Ç –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ —Ç—Ä–µ–∫–∞');
    return;
  }
  const tr = playingConfig.tracks[currentTrack];
  if (!tr || !tr.audio) { NotificationSystem.error('–°—Å—ã–ª–∫–∞ –Ω–∞ –∞—É–¥–∏–æ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞'); return; }

  // –°–∫–∞—á–∏–≤–∞–µ–º –Ω–∞–ø—Ä—è–º—É—é
  const a = document.createElement('a');
  a.href = tr.audio;
  a.download = makeDownloadFileName(playingConfig, tr);
  a.rel = 'noopener';
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
  NotificationSystem.success('–°–∫–∞—á–∏–≤–∞–Ω–∏–µ –Ω–∞—á–∞—Ç–æ');
}

function makeDownloadFileName(cfg, track) {
  const sanitize = (s) => String(s || '').replace(/[\\/:*?"<>|]+/g, ' ').trim();
  const album = sanitize(cfg.albumName || 'Album');
  const artist = sanitize(cfg.artist || 'Artist');
  const title = sanitize(track.title || 'Track');
  const ext = (track.audio || '').split('?')[0].split('#')[0].split('.').pop() || 'mp3';
  return `${artist} - ${album} - ${title}.${ext}`;
}

/* ====== –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ –º–æ–¥–∞–ª–∫–∏ –æ–±—Ä–∞—Ç–Ω–æ–π —Å–≤—è–∑–∏ ====== */
function openFeedbackModal(e) {
  if (e) e.preventDefault();
  const m = document.getElementById('modal-feedback');
  if (m) m.classList.add('active');
}
function closeFeedbackModal() {
  const m = document.getElementById('modal-feedback');
  if (m) m.classList.remove('active');
}

/* ====== Prefetch —Å–ª–µ–¥—É—é—â–µ–≥–æ —Ç—Ä–µ–∫–∞ –ø–æ—Å–ª–µ —Å–æ–±—ã—Ç–∏–π ====== */
document.addEventListener('click', (e) => {
  // –ü–æ—Å–ª–µ –ª—é–±—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏—Ö –¥–µ–π—Å—Ç–≤–∏–π –º–æ–∂–Ω–æ –ø–æ–¥–≥—Ä—É–∂–∞—Ç—å –±—É–¥—É—â–∏–µ —Ñ–∞–π–ª—ã
  setTimeout(prefetchNextTrackAssets, 300);
});
</script>

