
<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <title>Витрина Разбита — Музыка</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
  <meta name="description" content="Официальные альбомы группы Витрина Разбита. Слушайте онлайн и офлайн.">

  <!-- PWA -->
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#181818" />

  <!-- iOS -->
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="Витрина">
  <link rel="apple-touch-icon" href="icons/apple-touch-icon.png">

  <!-- Preload -->
  <link rel="preload" href="img/logo.png" as="image">

  <style>
    :root {
      --primary-bg: #181818;
      --primary-color: #E80100;
      --secondary-color: #4daaff;
      --text-color: #f2f2f2;
      --modal-bg: #252d39;
      --border-color: #394866;
    }
    * { box-sizing: border-box; }
    html, body { height: 100%; }
    body {
      min-height: 100vh;
      background: var(--primary-bg);
      color: var(--text-color);
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      margin: 0; padding: 0; display: flex; flex-direction: column; min-width: 100vw;
      padding-top: env(safe-area-inset-top);
    }
    /* Промокод */
    #promocode-block {
      position: fixed; inset: 0; display: flex; align-items: center; justify-content: center;
      background: var(--primary-bg); z-index: 100;
    }
    .promo-inner {
      display: flex; flex-direction: column; align-items: center;
      background: rgba(15,18,24,0.98); border-radius: 16px; box-shadow: 0 6px 24px #0008;
      padding: 36px 26px 32px 26px; min-width: 260px; min-height: 170px;
    }
    .promo-cover {
      width: 256px; height: 256px; object-fit: cover; border-radius: 12px; box-shadow: 0 4px 24px #000c;
      margin-bottom: 19px; display: block; background: var(--primary-bg);
    }
    #promo-inp {
      padding: 10px; border-radius: 8px; border: 1px solid var(--border-color);
      background: rgba(255,255,255,0.1); color: var(--text-color); margin: 10px 0; width: 100%; font-size: 16px;
    }
    #promo-btn {
      padding: 10px 20px; background: var(--primary-color); color: white; border: none; border-radius: 8px;
      cursor: pointer; font-weight: bold; transition: opacity 0.2s;
    }
    #promo-btn:hover:not(:disabled) { opacity: .8; }
    #promo-btn:disabled { opacity: .5; cursor: not-allowed; }
    #promo-error { color: #ff6b6b; margin-top: 10px; font-size: 14px; }

    .hidden { display: none !important; }

    /* Основной блок */
    #main-block { max-width: 420px; margin: 0 auto; flex: 1 0 auto; display: flex; flex-direction: column; align-items: center; width: 100%; padding: 0 10px; }
    header { width: 100%; text-align: center; margin: 0 auto; }

    /* Выбор альбома */
    .album-picker {
      width: 100%; max-width: 400px; margin: 18px auto 0 auto; display:flex; gap:8px; align-items:center; justify-content:center;
    }
    .album-picker select {
      width: 100%; max-width: 400px; background: #1f2533; color:#cfe3ff; border:1px solid var(--border-color);
      padding:10px 12px; border-radius:10px; font-weight:700; letter-spacing:.02em; cursor:pointer;
    }

    /* Обложка/галерея */
    #cover-wrap { width: 100%; max-width: 400px; margin: 14px auto 0 auto; aspect-ratio: 1/1; display: flex; align-items: center; justify-content: center; position: relative; }
    .cover-gallery-arrow {
      position: absolute; top: 50%; transform: translateY(-50%); z-index: 2; border: none; cursor: pointer; background: none; padding: 0; width: 44px; height: 44px; display: flex; align-items: center; justify-content: center; transition: opacity 0.2s;
    }
    .cover-gallery-arrow:hover { opacity: 0.8; }
    #cover-gallery-arrow-left { left: 7px; }
    #cover-gallery-arrow-right { right: 7px; }
    #cover { width: 100%; max-width: 100%; border-radius: 12px; aspect-ratio: 1/1; object-fit: cover; display: block; margin: 0; box-shadow: 0 4px 24px rgba(0,0,0,0.3); }

    /* Лого */
    .logo-bottom {
      max-width: 112px; width: 23vw; min-width: 66px; height: auto; display: block; margin: 0 auto 15px auto !important;
      cursor: pointer; transition: transform 0.1s ease-out; will-change: transform; transform: translateZ(0); transform-origin: center center; isolation: isolate; z-index: 10; position: relative;
    }
    #logo-bottom { will-change: transform; backface-visibility: hidden; transform: translateZ(0); }

    .socials-under-cover { margin: 14px auto 0 auto; width: 100%; max-width: 398px; text-align: center; font-size: 1.03em; display: flex; flex-wrap: wrap; justify-content: center; gap: 12px; }
    .socials-under-cover a { color: var(--secondary-color); text-decoration: none; transition: color 0.2s; }
    .socials-under-cover a:hover { color: var(--text-color); }

    /* Треки */
    .track-list { margin: 0 auto; max-width: 370px; width: 100%; font-size: 1.05em; color: #eee; background: none; padding: 0; }
    .track-list.filtered .track:not(.is-favorite) { display: none !important; }
    .track { display: flex; align-items: center; padding: 7px 8px; border-bottom: 1px solid var(--border-color); cursor: pointer; transition: background 0.13s; background: none; }
    .track:hover { background: rgba(255,255,255,0.05); }
    .track.current { background: #232b38; }
    .tnum { min-width: 27px; color: #8ab8fd; }
    .track-title { margin-left: 7px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; flex: 1; }
    .like-star { margin-left: auto; width: 19px; height: 19px; cursor: pointer; opacity: 0.97; border: none; background: none; padding: 0; appearance: none; display: inline-block; transition: transform 0.2s, filter 0.13s, opacity 0.13s; }
    .like-star:hover { filter: brightness(1.13); opacity: 1; transform: scale(1.1); }
    .like-star.animating { animation: starPulse 0.3s; }
    @keyframes starPulse { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.3); } }

    /* Лирика + Плеер (ваши стили) */
    .lyrics-player-block { width: 100%; margin: 8px 0 3px 0; }
    #lyrics-window { width: 100%; background: rgba(34,34,34,0.98); border-radius: 12px; box-shadow: 0 8px 24px #0007; overflow: hidden; height: 8.5em; position: relative; display: flex; flex-direction: column; align-items: stretch; justify-content: center; margin-bottom: 7px; transition: height 0.2s ease, opacity 0.2s ease, margin 0.2s ease; will-change: height, opacity; }
    #lyrics-window.lyrics-hidden { height: 0 !important; opacity: 0; margin: 0; overflow: hidden; pointer-events: none; }
    #lyrics-window.lyrics-normal { height: 8.5em; }
    #lyrics-window.lyrics-expanded { height: 15.3em; }
    .lyrics-scroll { position: relative; z-index: 1; }
    .lyrics-window-line { opacity: 0.57; font-size: 1.13em; transition: all 0.2s; line-height: 1.7em; text-align: center; min-height: 1.7em; max-width: 97%; margin: 0 auto; color: #eee; white-space: pre-line; user-select: none; word-break: break-word; position: relative; z-index: 1; }
    .lyrics-window-line.active { color: var(--primary-color); font-weight: bold; opacity: 1; text-shadow: 0 1px 7px #73161644; background: rgba(0,0,0,0.07); border-radius: 8px; font-size: 1.19em; }
    .lyrics-animated-bg { position: absolute; inset:0; opacity:0; background: linear-gradient(45deg, rgba(232,1,0,0.15), rgba(77,170,255,0.15), rgba(232,1,0,0.15)); background-size: 400% 400%; animation: none; z-index:0; pointer-events:none; transition: opacity .5s; }
    .lyrics-animated-bg.active { opacity: 1; animation: lyricsGradient 10s ease infinite; }
    @keyframes lyricsGradient { 0%{background-position:0% 50%} 50%{background-position:100% 50%} 100%{background-position:0% 50%} }
    #lyrics-window.animation-active .lyrics-window-line { transition: opacity .3s ease; }
    #lyrics-window.animation-active .lyrics-window-line.active { animation: lyricsGlow 2s ease-in-out infinite; }
    @keyframes lyricsGlow { 0%,50%,100% { opacity:1 } }

    .audio-wrapper { width: 100%; max-width: 395px; margin: 0 auto; }
    #audio { position:absolute; width:1px; height:1px; opacity:0; pointer-events:none; }

    .player-controls { display:flex; flex-direction:column; gap:5px; margin:5px 0; padding:8px 10px; background:rgba(0,0,0,0.3); border-radius:12px; }
    .player-controls-row { display:flex; align-items:center; justify-content:center; gap:12px; }
    .player-control-btn { background:none; border:none; color:var(--secondary-color); cursor:pointer; padding:4px; border-radius:50%; transition:all .2s; display:flex; align-items:center; justify-content:center; width:32px; height:32px; font-weight:bold; font-size:16px; position:relative; }
    .player-controls-row:first-child .player-control-btn { width:48px; height:48px; padding:8px; }
    .player-controls-row:first-child .player-control-btn svg { width:28px; height:28px; }
    .player-controls-row:last-child .player-control-btn svg { width:20px; height:20px; }
    .player-control-btn:hover { background: rgba(77,170,255,.2); transform: scale(1.1); }
    .player-control-btn:active { transform: scale(.95); }
    .player-control-btn.active, .player-control-btn.repeat-active { color:var(--primary-color); background: rgba(232,1,0,.2); }
    .player-control-btn.favorites-active { background: rgba(255,215,0,.3); }
    .player-control-btn.animation-btn, .player-control-btn.bit-btn { font-size:22px; font-weight:bold; }
    .player-control-btn.animation-active, .player-control-btn.bit-active { color: var(--primary-color); background: rgba(232,1,0,.2); }
    .player-control-btn svg { width:24px; height:24px; }
    .player-control-btn.main { width:54px; height:54px; }
    .player-control-btn.main svg { width:30px; height:30px; }
    .player-control-btn img { width:22px; height:22px; }
    .player-control-btn.favorites-active img { filter: drop-shadow(0 0 4px gold); }
    @keyframes pulse { 0%,100%{transform:scale(1)} 50%{transform:scale(1.1)} }
    .player-control-btn.repeat-active svg, .player-control-btn.favorites-active img { animation: pulse 2s infinite; }

    .player-progress-wrapper { width:100%; margin:3px 0 5px 0; position:relative; }
    .player-progress-bar { width:100%; height:6px; background: rgba(255,255,255,.1); border-radius:3px; position:relative; cursor:pointer; overflow:visible; }
    .player-progress-fill { height:100%; background: linear-gradient(90deg, var(--primary-color), var(--secondary-color)); width:0%; transition: width .1s linear; border-radius:3px; position:relative; }
    .player-progress-handle { position:absolute; top:50%; transform:translateY(-50%); width:20px; height:20px; background:#fff; border-radius:50%; box-shadow:0 2px 8px rgba(0,0,0,.3); right:-10px; z-index:2; }

    .time-in-controls { font-family: 'SF Mono', Monaco, 'Courier New', monospace; font-size:13px; color:var(--secondary-color); min-width:45px; text-align:center; user-select:none; }

    .volume-control-wrapper { width:100%; margin:5px 0; padding:0 10px; }
    .volume-track { position:absolute; top:50%; transform:translateY(-50%); width:100%; height:6px; background:rgba(255,255,255,.2); border-radius:3px; pointer-events:none; }
    .volume-fill { position:absolute; top:50%; transform:translateY(-50%); height:6px; background:var(--secondary-color); border-radius:3px; pointer-events:none; transition: width .1s; }
    .volume-slider { appearance:none; width:100%; height:20px; background:transparent; outline:none; cursor:pointer; position:relative; z-index:2; }
    .volume-slider::-webkit-slider-thumb { appearance:none; width:20px; height:20px; background:#fff; border-radius:50%; cursor:pointer; box-shadow:0 2px 8px rgba(0,0,0,.3); }
    .volume-slider::-moz-range-thumb { width:20px; height:20px; background:#fff; border-radius:50%; cursor:pointer; border:none; box-shadow:0 2px 8px rgba(0,0,0,.3); }

    /* Sleep */
    .sleep-timer-btn { background:none; border:none; color:var(--secondary-color); cursor:pointer; padding:8px; border-radius:50%; transition:.2s; display:flex; align-items:center; justify-content:center; width:44px; height:44px; position:relative; }
    .sleep-timer-btn:hover { background: rgba(77,170,255,.2); transform: scale(1.1); }
    .sleep-timer-btn.active { color: var(--primary-color); background: rgba(232,1,0,.2); }
    .sleep-timer-badge { position:absolute; top:-2px; right:-2px; background:var(--primary-color); color:#fff; border-radius:10px; padding:2px 6px; font-size:10px; font-weight:bold; min-width:20px; text-align:center; }
    .sleep-menu { position:absolute; bottom:100%; left:50%; transform:translateX(-50%); background: var(--modal-bg); border-radius:12px; padding:10px; margin-bottom:10px; box-shadow:0 4px 20px rgba(0,0,0,.3); z-index:100; min-width:150px; display:none; }
    .sleep-menu.active { display:block; animation: slideUp .2s; }
    .sleep-menu-item { padding:8px 12px; cursor:pointer; border-radius:6px; transition: background .2s; white-space:nowrap; color:var(--text-color); }
    .sleep-menu-item:hover { background: rgba(255,255,255,.1); }

    .sleep-overlay { position: fixed; inset:0; background: rgba(0,0,0,.95); display:none; align-items:center; justify-content:center; z-index:10000; }
    .sleep-overlay.active { display:flex; animation: fadeIn .5s; }
    .sleep-content { text-align:center; padding:40px; max-width:400px; }
    .sleep-icon { font-size:64px; margin-bottom:20px; opacity:.5; }
    .sleep-title { font-size:24px; margin-bottom:10px; color:var(--text-color); }
    .sleep-message { color: rgba(255,255,255,.6); margin-bottom:30px; }
    .sleep-buttons { display:flex; gap:10px; justify-content:center; }
    .sleep-btn { padding:12px 24px; border-radius:8px; border:none; cursor:pointer; font-weight:bold; transition:opacity .2s; }
    .sleep-btn-primary { background: var(--primary-color); color:#fff; }
    .sleep-btn-secondary { background: rgba(255,255,255,.1); color: var(--text-color); }
    .sleep-btn:hover { opacity:.8; }

    /* Кнопка лирики и прочие нижние кнопки */
    .lyrics-toggle-btn { position:absolute; left:10px; top:50%; transform: translateY(-50%); width:44px; height:44px; background:none; border:none; cursor:pointer; padding:0; display:flex; align-items:center; justify-content:center; font-weight:bold; transition:.2s; user-select:none; z-index:5; }
    .lyrics-toggle-btn-visual { font-size:36px; line-height:1; transition:.2s; pointer-events:none; }
    .lyrics-toggle-btn.lyrics-normal .lyrics-toggle-btn-visual { color: var(--secondary-color); font-size:36px; }
    .lyrics-toggle-btn.lyrics-hidden .lyrics-toggle-btn-visual { color: var(--primary-color); font-size:36px; }
    .lyrics-toggle-btn.lyrics-expanded .lyrics-toggle-btn-visual { color: var(--secondary-color); font-size:20px; }
    .lyrics-toggle-btn:hover .lyrics-toggle-btn-visual { transform: scale(1.1); }

    .player-buttons-wrapper { display:flex; flex-direction:column; align-items:center; gap:9px; margin-top:10px; width:100%; position:relative; }
    .karaoke-btn, .player-download-btn {
      color: var(--secondary-color) !important; background:none; border:none; cursor:pointer; font-size:1em; text-transform:uppercase; font-weight:700; letter-spacing:.02em; text-decoration:underline; transition:.18s; padding:4px 16px; min-width:148px; text-align:center; border-radius:7px; display:block; margin: 0 auto;
    }
    .karaoke-btn:hover, .player-download-btn:hover { color:#fff !important; background:#273050; }

    .bottom-controls-center { display:flex; flex-direction:column; align-items:center; justify-content:center; margin:32px auto 0 auto; gap:8px; width:100%; max-width:280px; padding-bottom: env(safe-area-inset-bottom); }

    .filter-favorites-btn { display:block; margin:0 auto 15px auto; padding:10px 20px; background: linear-gradient(135deg,#2a2a2a,#1a1a1a); color: var(--secondary-color); border:2px solid var(--border-color); border-radius:12px; font-size:.95em; font-weight:bold; cursor:pointer; transition:.3s; text-align:center; min-width:100%; white-space:nowrap; box-shadow:0 2px 8px rgba(0,0,0,.3); }
    .filter-favorites-btn:hover { background: linear-gradient(135deg,#3a3a3a,#2a2a2a); border-color: var(--secondary-color); transform: translateY(-2px); box-shadow:0 4px 12px rgba(0,0,0,.5); }
    .filter-favorites-btn.filtered { background: linear-gradient(135deg,#4a1a1a,#2a0a0a); border-color: var(--primary-color); color:#fff; }

    #install-pwa-btn, #download-album-main {
      color:#fff; background: var(--secondary-color); border:none; border-radius:7px; font-size:1.07em; font-weight:bold; letter-spacing:.02em; margin:15px 0 5px 0; padding:8px 13px; cursor:pointer; width:98%; box-shadow:0 4px 14px #0005; transition: background .2s;
    }
    #download-album-main { background: var(--primary-color); font-size:1.09em; margin-bottom:8px; }
    #install-pwa-btn:hover { background:#3275c2; } #download-album-main:hover { background:#c60000; }

    .feedback-link, .support-link { color: var(--secondary-color) !important; text-decoration: underline !important; font-weight:700; text-transform:uppercase; letter-spacing:.03em; cursor:pointer; transition: color .18s; font-size:1em; display:block; text-align:center; width:100%; margin:0; }
    .feedback-link:hover, .support-link:hover { color:#fff !important; }

    .offline-btn { min-width:102px; height:38px; font-size:1.05em; font-weight:bold; border:none; border-radius:9px; cursor:pointer; letter-spacing:.07em; box-shadow:0 2px 8px #06000032; transition: background .2s, color .14s; display:block; margin:0 auto; }
    .offline-btn.online { background: var(--primary-color); color:#fff; }
    .offline-btn.offline { background:#27b34c; color:#fff; }
    .offline-progress { margin-top:11px; width:100%; height:8px; background:#222; border-radius:6px; overflow:hidden; box-shadow:0 1px 6px #222b; }
    .offline-progress-bar { height:100%; background:#2fed54; transition: width .33s; }
    .offline-desc { text-align:center; font-size:.97em; margin-top:5px; opacity:.85; }

    /* Модалки */
    .modal-bg { position:fixed; inset:0; background:rgba(0,0,0,.62); display:none; align-items:center; justify-content:center; backdrop-filter: blur(4px); z-index: 99; }
    .modal-bg.active { display:flex; animation: fadeIn .3s; }
    @keyframes fadeIn { from{opacity:0} to{opacity:1} }
    .modal-feedback { background: var(--modal-bg); border-radius:14px; padding:24px 20px; min-width:215px; max-width:96vw; box-shadow:0 4px 32px #0009; position:relative; animation: slideUp .3s; }
    @keyframes slideUp { from{ transform:translateY(20px); opacity:0 } to{ transform:translateY(0); opacity:1 } }
    .modal-feedback .bigclose { background:none; border:none; position:absolute; top:13px; right:13px; cursor:pointer; color:#eee; border-radius:50%; width:32px; height:32px; transition: transform .2s; }
    .modal-feedback .bigclose:hover { transform: scale(1.1); }
    .modal-feedback .bigclose svg { width:31px; height:31px; }

    /* Подсказки/мобильные */
    .hotkeys-btn { color: var(--secondary-color) !important; text-decoration: underline !important; font-weight:700; text-transform:uppercase; letter-spacing:.03em; cursor:pointer; transition:color .18s; font-size:1em; display:block; text-align:center; width:100%; margin:0; background:none; border:none; padding:8px; }
    .hotkeys-btn:hover { color:#fff !important; }
    @media (max-width: 600px) { .hotkeys-btn { display:none !important; } }
    @media (display-mode: standalone) { .bottom-controls-center { padding-bottom: calc(env(safe-area-inset-bottom) + 10px); } }
    @media (hover:none) { .tooltip { display:none; } }
  </style>
</head>
<body>
  <!-- Промокод -->
  <div id="promocode-block">
    <div class="promo-inner">
      <img class="promo-cover" id="promo-cover" src="img/logo.png" alt="Обложка" draggable="false"/>
      <h2>Вход по промокоду</h2>
      <input id="promo-inp" type="text" placeholder="Введите промокод" autocomplete="off" autofocus disabled />
      <button id="promo-btn" onclick="checkPromo()" disabled>Войти</button>
      <div id="promo-error"></div>
    </div>
  </div>

  <div id="main-block" class="hidden">
    <header>
      <!-- Выбор альбома -->
      <div class="album-picker">
        <select id="album-select" aria-label="Выбор альбома"></select>
      </div>

      <div id="cover-wrap">
        <button class="cover-gallery-arrow" id="cover-gallery-arrow-left" title="Назад" aria-label="Предыдущая обложка">
          <svg width="34" height="34" viewBox="0 0 34 34"><circle cx="17" cy="17" r="16" fill="#23252e" opacity="0.65"/><polyline points="20,10 13,17 20,24" fill="none" stroke="#fff" stroke-width="2.9" stroke-linecap="round" stroke-linejoin="round"/></svg>
        </button>
        <img id="cover" src="" alt="Обложка альбома" draggable="false"/>
        <button class="cover-gallery-arrow" id="cover-gallery-arrow-right" title="Вперёд" aria-label="Следующая обложка">
          <svg width="34" height="34" viewBox="0 0 34 34"><circle cx="17" cy="17" r="16" fill="#23252e" opacity="0.65"/><polyline points="14,10 21,17 14,24" fill="none" stroke="#fff" stroke-width="2.9" stroke-linecap="round" stroke-linejoin="round"/></svg>
        </button>
      </div>

      <div id="social-links" class="socials-under-cover"></div>
    </header>

    <div class="track-list" id="track-list"></div>

    <div class="bottom-controls-center">
      <button class="filter-favorites-btn" id="filter-favorites-btn" onclick="toggleFavoritesFilter()">Скрыть не отмеченные ⭐ песни</button>
      <img class="logo-bottom" id="logo-bottom" src="img/logo.png" alt="Логотип" onclick="handleLogoClick()"/>

      <button id="install-pwa-btn" style="display: none;">УСТАНОВИТЬ КАК ПРИЛОЖЕНИЕ</button>
      <button id="download-album-main" onclick="openAlbumDownloadModal()">СКАЧАТЬ ВЕСЬ АЛЬБОМ</button>

      <button class="hotkeys-btn" id="hotkeys-btn" style="display:none;" onclick="showHotkeysModal()">ГОРЯЧИЕ КЛАВИШИ</button>
      <span class="feedback-link" id="feedback-link">ОБРАТНАЯ СВЯЗЬ</span>
      <a class="support-link" id="support-link" href="#" target="_blank">ПОДДЕРЖАТЬ</a>
      <button class="offline-btn online" id="offline-btn" onclick="offlineUIClick()">ONLINE</button>
    </div>
  </div>

  <!-- Модалки: Обратная связь (заглушка) -->
  <div class="modal-bg" id="modal-feedback">
    <div class="modal-feedback" style="max-width:420px;">
      <button class="bigclose" onclick="closeFeedbackModal()" title="Закрыть">
        <svg viewBox="0 0 48 48"><line x1="12" y1="12" x2="36" y2="36" stroke="currentColor" stroke-width="6" stroke-linecap="round"/><line x1="36" y1="12" x2="12" y2="36" stroke="currentColor" stroke-width="6" stroke-linecap="round"/></svg>
      </button>
      <div style="font-size:1.12em;font-weight:700;margin-bottom:10px;">Обратная связь</div>
      <div style="color:#cfe3ff; background:rgba(255,255,255,.06); border:1px solid rgba(255,255,255,.1); border-radius:8px; padding:12px;">
        Раздел в разработке. Напишите нам в Telegram: <a href="https://t.me/vitrina_razbita" target="_blank" rel="noopener">@vitrina_razbita</a>
      </div>
    </div>
  </div>

  <!-- Модалка скачивания трека -->
  <div class="modal-bg" id="download-modal">
    <div class="modal-feedback" style="max-width:400px;">
      <div class="download-modal-title">Что сделать с этим файлом?</div>
      <div style="margin-bottom:19px;font-size:.98em;" id="download-modal-filename"></div>
      <button class="offline-btn online" style="width:98%;margin-bottom:10px;" onclick="downloadCurrentTrack()">Сохранить на устройство</button>
      <button class="offline-btn" style="width:98%;margin-bottom:10px;" onclick="shareCurrentTrack()">Поделиться с друзьями</button>
      <button class="offline-btn" style="width:98%;margin-bottom:10px;" onclick="openInAppCurrentTrack()">Открыть в приложении</button>
      <button class="offline-btn" style="width:98%;margin-bottom:10px;" onclick="copyLinkCurrentTrack()">Скопировать ссылку</button>
      <button class="offline-btn" style="width:98%;margin-bottom:10px;" onclick="openAlbumDownloadModal()">Скачать весь альбом</button>
      <button class="offline-btn" style="width:98%;" onclick="closeDownloadModal()">Отмена</button>
    </div>
  </div>

  <!-- Модалка скачивания альбома + подтверждение размера + прогресс -->
  <div class="modal-bg" id="albumDownloadModal">
    <div class="modal-feedback" style="max-width: 400px;">
      <h2 style="text-align: center; margin-bottom: 25px;" id="album-title-modal">Альбом</h2>
      <div class="download-options">
        <label class="checkbox-container"><input type="checkbox" id="includeCovers" checked><span class="checkmark"></span>Обложки (галерея)</label>
        <label class="checkbox-container"><input type="checkbox" id="includeLyrics" checked><span class="checkmark"></span>Тексты песен</label>
        <hr style="margin: 15px 0; border-color: #333;">
        <label class="checkbox-container"><input type="checkbox" id="onlyFavorites"><span class="checkmark"></span>Только избранные песни</label>
        <label class="checkbox-container"><input type="checkbox" id="fullAlbum" checked><span class="checkmark"></span>Полностью альбом</label>
      </div>
      <div class="modal-buttons">
        <button onclick="closeAlbumDownloadModal()" class="btn-secondary">ОТМЕНА</button>
        <button onclick="prepareDownload()" class="btn-primary">СКАЧАТЬ</button>
      </div>
    </div>
  </div>

  <div class="modal-bg" id="sizeConfirmModal">
    <div class="modal-feedback" style="max-width: 350px;">
      <h3 style="text-align: center;">Подтверждение загрузки</h3>
      <div class="size-info">
        <div style="font-size: 48px; color: #E80100; margin-bottom: 15px;">📦</div>
        <p style="font-size: 18px; margin: 10px 0;">Размер архива: <strong id="archiveSize">0 МБ</strong></p>
        <p style="color: #888; font-size: 14px;">Файлов в архиве: <span id="fileCount">0</span></p>
      </div>
      <div class="modal-buttons">
        <button onclick="closeSizeConfirmModal()" class="btn-secondary">ОТМЕНА</button>
        <button onclick="startDownload()" class="btn-primary">СКАЧАТЬ</button>
      </div>
    </div>
  </div>

  <div class="modal-bg" id="downloadProgressModal">
    <div class="modal-feedback" style="max-width: 400px;">
      <h3 style="text-align: center; margin-bottom: 20px;">Подготовка архива</h3>
      <div class="progress-bar"><div id="progressFill" class="progress-fill" style="width: 0%"></div></div>
      <p id="progressText" style="text-align: center; margin-top: 10px;">Загрузка файлов: 0/0</p>
      <div id="errorsList" style="display: none; color: #ff6b6b; font-size: 14px; margin-top: 15px;">
        <p><strong>Не удалось загрузить:</strong></p>
        <ul id="errorsListContent"></ul>
      </div>
    </div>
  </div>

  <!-- Модалка горячих клавиш -->
  <div class="modal-bg" id="hotkeys-modal">
    <div class="modal-feedback hotkeys-modal">
      <button class="bigclose" onclick="closeHotkeysModal()" title="Закрыть">
        <svg viewBox="0 0 48 48"><line x1="12" y1="12" x2="36" y2="36" stroke="currentColor" stroke-width="6" stroke-linecap="round"/><line x1="36" y1="12" x2="12" y2="36" stroke="currentColor" stroke-width="6" stroke-linecap="round"/></svg>
      </button>
      <h2>📌 ГОРЯЧИЕ КЛАВИШИ</h2>
      <div class="hotkeys-section">
        <h3>▶️ Воспроизведение</h3>
        <div class="hotkey-item"><span class="hotkey-combo">K / Пробел</span><span class="hotkey-desc">Воспроизведение/Пауза</span></div>
        <div class="hotkey-item"><span class="hotkey-combo">X</span><span class="hotkey-desc">Стоп</span></div>
        <div class="hotkey-item"><span class="hotkey-combo">N</span><span class="hotkey-desc">Следующий трек</span></div>
        <div class="hotkey-item"><span class="hotkey-combo">P</span><span class="hotkey-desc">Предыдущий трек</span></div>
        <div class="hotkey-item"><span class="hotkey-combo">J / L</span><span class="hotkey-desc">Перемотка ←10сек / 10сек→</span></div>
        <div class="hotkey-item"><span class="hotkey-combo">+ / -</span><span class="hotkey-desc">Громкость ±10%</span></div>
      </div>
      <div class="hotkeys-section">
        <h3>🎵 Режимы</h3>
        <div class="hotkey-item"><span class="hotkey-combo">R</span><span class="hotkey-desc">Повтор</span></div>
        <div class="hotkey-item"><span class="hotkey-combo">U</span><span class="hotkey-desc">Случайный порядок</span></div>
        <div class="hotkey-item"><span class="hotkey-combo">F</span><span class="hotkey-desc">Избранные</span></div>
        <div class="hotkey-item"><span class="hotkey-combo">M</span><span class="hotkey-desc">Без звука</span></div>
        <div class="hotkey-item"><span class="hotkey-combo">T</span><span class="hotkey-desc">Таймер сна</span></div>
      </div>
      <div class="hotkeys-section">
        <h3>✨ Эффекты</h3>
        <div class="hotkey-item"><span class="hotkey-combo">A</span><span class="hotkey-desc">Анимация лирики</span></div>
        <div class="hotkey-item"><span class="hotkey-combo">B</span><span class="hotkey-desc">Пульсация логотипа</span></div>
        <div class="hotkey-item"><span class="hotkey-combo">1 / 2 / 3</span><span class="hotkey-desc">Интенсивность (100%/50%/15%)</span></div>
      </div>
      <div class="hotkeys-section">
        <h3>📱 Интерфейс</h3>
        <div class="hotkey-item"><span class="hotkey-combo">Y</span><span class="hotkey-desc">Показать лирику</span></div>
        <div class="hotkey-item"><span class="hotkey-combo">W</span><span class="hotkey-desc">Показать плейлист</span></div>
        <div class="hotkey-item"><span class="hotkey-combo">D</span><span class="hotkey-desc">В избранное</span></div>
        <div class="hotkey-item"><span class="hotkey-combo">?</span><span class="hotkey-desc">Эта справка</span></div>
        <div class="hotkey-item"><span class="hotkey-combo">Esc</span><span class="hotkey-desc">Закрыть окно</span></div>
      </div>
    </div>
  </div>

  <!-- Скрытые модалки офлайн/установки оставлены из вашего кода (не меняем разметку) -->
  <div class="modal-bg" id="modal-offline"><!-- наполняется скриптом --></div>
  <div class="modal-bg" id="install-modal"><!-- наполняется скриптом --></div>

<script>
// Версия
const VERSION = '7.0.0';
const BUILD_DATE = '2025-02-10';

// Константы
const PROMO_CODE = 'VITRINA2025';

// Глобальные переменные
let albumsIndex = [];         // [{key,title,base}]
let currentAlbumKey = null;   // 'mzid' и т.п.
let albumBase = '';           // базовый URL текущего альбома (обязательно со слешем)
let config = null;
let promoPassed = false;
let coverGalleryArr = [];     // массив абсолютных URL обложек
let coverGalleryIdx = 0;
let coverAutoplay = null;

let currentTrack = -1;
let currentLyrics = [];
let autoPlayEnabled = true;
let offlineMode = false;
let offlineDownloading = false;
let deferredPrompt = null;

let shuffleMode = false;
let shuffledPlaylist = [];
let shuffleIndex = 0;
let repeatMode = false;
let favoritesOnlyMode = false;
let availableTracks = [];
let favoritesFilterActive = false;

let animationEnabled = false;
let bitEnabled = false;
let bitIntensity = 100;
let audioContext = null;
let analyser = null;
let audioSource = null;
let animationFrame = null;
let hasShownAnimationWarning = false;
let hasShownBitWarning = false;

let downloadOptions = { includeCovers: true, includeLyrics: true, onlyFavorites: false, fullAlbum: true };
let filesToDownload = [];

// Утилиты
function absJoin(base, rel) {
  if (!rel) return '';
  if (/^https?:\/\//i.test(rel)) return rel;
  return base.replace(/\/+$/, '') + '/' + rel.replace(/^\/+/, '');
}

// Промокод
function checkPromo() {
  const inp = document.getElementById('promo-inp');
  const err = document.getElementById('promo-error');
  const val = (inp?.value || '').trim();
  if (!val) { if (err) err.innerText = 'Введите промокод'; return; }
  if (val.toUpperCase() === PROMO_CODE.toUpperCase()) {
    localStorage.setItem('promoPassed', '1');
    showMain();
  } else {
    if (err) err.innerText = 'Неверный промокод. Попробуйте ещё!';
  }
}

// Показ/скрытие основного UI
function showMain() {
  document.getElementById('promocode-block').classList.add('hidden');
  document.getElementById('main-block').classList.remove('hidden');
  initializeMainUi();
}

document.getElementById('promo-inp').addEventListener('keydown', e => { if (e.key === 'Enter') checkPromo(); });

// === Альбомы ===
async function loadAlbumsIndex() {
  const sel = document.getElementById('album-select');
  try {
    const r = await fetch('./albums.json', { cache:'no-cache' });
    const j = await r.json();
    albumsIndex = Array.isArray(j.albums) ? j.albums : [];
    // Заполним селект
    sel.innerHTML = albumsIndex.map(a => `<option value="${a.key}">${a.title}</option>`).join('');
  } catch(e) {
    albumsIndex = [];
    sel.innerHTML = `<option value="">Нет списка альбомов</option>`;
  }
}

function albumByKey(key) {
  return albumsIndex.find(a => a.key === key) || null;
}

async function loadAlbumByKey(key) {
  const meta = albumByKey(key);
  if (!meta) {
    NotificationSystem.error('Альбом не найден');
    return;
  }
  currentAlbumKey = key;
  albumBase = meta.base;
  localStorage.setItem('currentAlbum', currentAlbumKey);
  await loadAlbumConfig(albumBase);
}

async function loadAlbumConfig(base) {
  try {
    const resp = await fetch(absJoin(base,'config.json'), { cache:'no-cache' });
    if (!resp.ok) throw new Error('HTTP '+resp.status);
    const data = await resp.json();

    // Нормализуем пути (делаем абсолютными)
    (data.tracks || []).forEach(t => {
      t.audio = absJoin(base, t.audio);
      t.lyrics = absJoin(base, t.lyrics);
      if (t.fulltext) t.fulltext = absJoin(base, t.fulltext);
    });

    // Бэкграунд
    if (data.background) {
      document.body.style.background = `url(${absJoin(base, data.background)}) center/cover fixed #111`;
    } else {
      document.body.style.background = `#181818`;
    }

    config = data;

    // Обложки (галерея) — предполагаем Cover.png, Cover01.png, Cover02.png, Cover03.png
    coverGalleryArr = [
      absJoin(base, 'Cover.png'),
      absJoin(base, 'Cover01.png'),
      absJoin(base, 'Cover02.png'),
      absJoin(base, 'Cover03.png')
    ];
    coverGalleryIdx = 0;
    setCoverImage(coverGalleryIdx);

    // Кнопка доната
    document.getElementById('support-link').href = (config.donateLink || '#');
    // Заголовок альбома в модалке
    document.getElementById('album-title-modal').textContent = (config.albumName || 'Альбом');

    // Соцсети
    buildSocials();

    // Список треков
    currentTrack = -1;
    buildTrackList();
    updateAvailableTracks();

    // Пробуем восстановить состояние плеера по альбому (не сохраняем альбомно — упрощаем)
    parseDeepLink();

  } catch(e) {
    console.error('Не удалось загрузить config.json альбома:', e);
    NotificationSystem.error('Не удалось загрузить альбом');
  }
}

// === UI и Плеер (взято из вашего кода, убрано всё про ачивки/статы/призы) ===
function initializeMainUi() {
  // Инициализируем селектор альбомов
  (async () => {
    const promoCover = document.getElementById('promo-cover');
    if (promoCover) promoCover.src = 'img/logo.png';

    await loadAlbumsIndex();
    const sel = document.getElementById('album-select');

    // Выбор альбома из URL (?album=key) или localStorage, иначе первый
    const params = new URLSearchParams(location.search);
    const urlAlbum = params.get('album');
    const savedAlbum = localStorage.getItem('currentAlbum');
    const first = albumsIndex[0]?.key || null;

    const toLoad = urlAlbum && albumByKey(urlAlbum) ? urlAlbum
                  : (savedAlbum && albumByKey(savedAlbum) ? savedAlbum : first);

    if (toLoad) sel.value = toLoad;
    sel.onchange = () => loadAlbumByKey(sel.value);

    // Включаем ввод промокода (страховка)
    const inp = document.getElementById('promo-inp');
    const btn = document.getElementById('promo-btn');
    if (inp) inp.disabled = false;
    if (btn) btn.disabled = false;

    // Если промо уже введён — сразу показываем выбранный альбом
    if (localStorage.getItem('promoPassed') === '1') {
      showMain();
      await loadAlbumByKey(sel.value);
    } else {
      // На экране промокода уже активны поля
    }

    // Автовоспроизведение обложек
    document.getElementById('cover-gallery-arrow-left').onclick = () => { setCoverImage(coverGalleryIdx - 1); startCoverAutoPlay(); };
    document.getElementById('cover-gallery-arrow-right').onclick = () => { setCoverImage(coverGalleryIdx + 1); startCoverAutoPlay(); };

    let startX = null;
    const el = document.getElementById('cover-wrap');
    el.addEventListener('touchstart', e => { startX = e.touches[0].clientX; });
    el.addEventListener('touchend', e => {
      if (startX === null) return;
      const dx = e.changedTouches[0].clientX - startX;
      if (Math.abs(dx) > 30) {
        if (dx > 0) setCoverImage(coverGalleryIdx - 1); else setCoverImage(coverGalleryIdx + 1);
        startCoverAutoPlay();
      }
      startX = null;
    });
    startCoverAutoPlay();

    // Горячие клавиши — показывать на десктопе
    if (hasKeyboard()) {
      const hot = document.getElementById('hotkeys-btn');
      if (hot) hot.style.display = 'block';
    }

    // Обратная связь (заглушка)
    document.getElementById('feedback-link').onclick = openFeedbackModal;
    document.getElementById('modal-feedback').onclick = (e) => { if (e.target === e.currentTarget) closeFeedbackModal(); };

    // PWA установка
    window.addEventListener('beforeinstallprompt', (e) => {
      e.preventDefault();
      deferredPrompt = e;
      const btn = document.getElementById('install-pwa-btn');
      if (btn) btn.style.display = '';
    });
    document.getElementById('install-pwa-btn').onclick = async () => {
      if (deferredPrompt) {
        deferredPrompt.prompt();
        deferredPrompt.userChoice.finally(() => {
          document.getElementById('install-pwa-btn').style.display = 'none';
          deferredPrompt = null;
        });
      } else {
        NotificationSystem.info('Ваш браузер не поддерживает установку PWA');
      }
    };

    // iOS подсказка установки
    detectIOSAndShowInstallGuide();

    // Service Worker
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('./service-worker.js').then(async reg => {
        await navigator.serviceWorker.ready;
        syncOfflineState();
        try { reg.active && reg.active.postMessage({ type: 'REQUEST_OFFLINE_STATE' }); } catch(e){}
        try { reg.update(); } catch(e) {}
        setInterval(async () => {
          try { const r = await navigator.serviceWorker.getRegistration(); if (r) r.update(); } catch(e) {}
        }, 60 * 60 * 1000);
      });

      let __swReloaded = false;
      navigator.serviceWorker.addEventListener('controllerchange', () => {
        if (__swReloaded) return;
        __swReloaded = true;
        NotificationSystem.info('Обновление применено, перезагрузка...');
        setTimeout(() => location.reload(), 300);
      });

      navigator.serviceWorker.addEventListener('message', event => {
        const msg = event.data || {};
        if (msg.type === 'OFFLINE_STATE') {
          offlineMode = !!msg.value;
          setOfflineUIState(offlineMode ? 'offline' : 'online');
        }
      });
    }

    // Настройки плеера из localStorage
    shuffleMode = localStorage.getItem('shuffleMode') === '1';
    repeatMode = localStorage.getItem('repeatMode') === '1';
    favoritesOnlyMode = localStorage.getItem('favoritesOnlyMode') === '1';
    offlineMode = localStorage.getItem('offlineMode') === '1';
    animationEnabled = localStorage.getItem('animationEnabled') === '1';
    bitEnabled = localStorage.getItem('bitEnabled') === '1';
    const savedIntensity = localStorage.getItem('bitIntensity'); if (savedIntensity) bitIntensity = parseInt(savedIntensity);

    // Слушатели для sleep таймера и т.п.
    document.addEventListener('visibilitychange', () => { if (!document.hidden) checkSleepTimer(); });
    window.addEventListener('focus', checkSleepTimer);

    // Сеть
    window.addEventListener('online', () => NotificationSystem.success('Соединение восстановлено'));
    window.addEventListener('offline', () => NotificationSystem.offline('Нет соединения с интернетом'));
  })();
}

// Соцсети
function buildSocials() {
  const linksEl = document.getElementById('social-links');
  if (!config || !config.socials || !linksEl) { linksEl.innerHTML = ''; return; }
  linksEl.innerHTML = (config.socials || []).map(x => `<a href="${x.url}" target="_blank" rel="noopener">${x.title}</a>`).join(" ");
}

// Галерея обложек
function setCoverImage(idx) {
  if (!coverGalleryArr.length) return;
  coverGalleryIdx = (idx + coverGalleryArr.length) % coverGalleryArr.length;
  const img = document.getElementById('cover');
  img.src = coverGalleryArr[coverGalleryIdx];
}
function startCoverAutoPlay() {
  if (coverAutoplay) clearInterval(coverAutoplay);
  coverAutoplay = setInterval(() => setCoverImage(coverGalleryIdx + 1), 5000);
}

// Определение наличия клавиатуры
function hasKeyboard() {
  const isDesktop = !/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
  const hasPointer = matchMedia('(pointer: fine)').matches;
  const canHover = matchMedia('(hover: hover)').matches;
  const noTouch = navigator.maxTouchPoints === 0;
  return (isDesktop && hasPointer) || (canHover && noTouch);
}

// Уведомления (ваши)
class NotificationSystem {
  static queue = []; static isShowing = false;
  static show(message, type = 'info', duration = 3000) { this.queue.push({ message, type, duration }); if (!this.isShowing) this.processQueue(); }
  static async processQueue() {
    if (this.queue.length===0) { this.isShowing=false; return; }
    this.isShowing=true;
    const { message, type, duration } = this.queue.shift();
    const toast = document.createElement('div');
    toast.className = `toast toast-${type}`;
    toast.innerHTML = `<div class="toast-content"><span class="toast-emoji" aria-hidden="true"></span><span class="toast-text">${message}</span></div>`;
    document.body.appendChild(toast);
    await new Promise(r=>setTimeout(r,50));
    toast.classList.add('show');
    await new Promise(r=>setTimeout(r,duration));
    toast.classList.remove('show');
    await new Promise(r=>setTimeout(r,300));
    toast.remove();
    this.processQueue();
  }
  static info(msg){ this.show(msg,'info'); }
  static success(msg){ this.show(msg,'success'); }
  static error(msg){ this.show(msg,'error',5000); }
  static warning(msg){ this.show(msg,'warning',4000); }
  static offline(msg){ this.show(msg,'offline'); }
}

// Избранное
function getLiked(){ try{ return JSON.parse(localStorage.getItem('likedTracks')||'[]'); }catch{ return []; } }
function saveLiked(arr){ localStorage.setItem('likedTracks', JSON.stringify(arr)); }
function isLiked(idx){ return getLiked().includes(idx); }

// Построение списка треков
function buildTrackList() {
  const list = document.getElementById('track-list');
  if (!config) { list.innerHTML=''; return; }
  let html = '';
  for (let i=0;i<config.tracks.length;i++) {
    const t = config.tracks[i];
    html += `<div class="track${i===currentTrack?' current':''}" id="trk${i}" onclick="pickAndPlayTrack(${i})">
      <span class="tnum">${String(i+1).padStart(2,'0')}.</span>
      <span class="track-title">${t.title}</span>
      <img src="${isLiked(i)?'img/star.png':'img/star2.png'}" class="like-star" alt="звезда" title="${isLiked(i)?'Убрать из понравившихся':'Добавить в понравившиеся'}" onclick="toggleLike(${i}, event)"/>
    </div>`;
    if (i===currentTrack) html += `<div class="lyrics-player-block" id="lyricsplayerblock"></div>`;
  }
  list.innerHTML = html;
  if (favoritesFilterActive) list.classList.add('filtered');

  if (currentTrack>=0) renderLyricsBlock();
}

// Тумблер лайков (с поддержкой фильтра/плеера)
function toggleLike(idx, e) {
  if (e) e.stopPropagation();
  let liked = getLiked();
  const was = liked.includes(idx);
  liked = was ? liked.filter(x=>x!==idx) : [...liked, idx];
  saveLiked(liked);
  const star = e ? e.target : document.querySelector(`#trk${idx} .like-star`);
  if (star){ star.src = was? 'img/star2.png':'img/star.png'; star.title = was?'Добавить в понравившиеся':'Убрать из понравившихся'; star.classList.add('animating'); setTimeout(()=>star.classList.remove('animating'),300); }

  if (favoritesFilterActive) {
    updateFavoriteClasses();
    const count = document.querySelectorAll('.track.is-favorite').length;
    if (count===0) {
      toggleFavoritesFilter();
      NotificationSystem.warning('Все треки удалены из избранного, фильтр отключён');
    } else {
      NotificationSystem.info(`⭐ Избранных треков: ${count}`);
    }
  }

  if (favoritesOnlyMode) {
    updateAvailableTracks();
    if (!isLiked(currentTrack)) {
      const nextFavorite = getNextFavoriteTrack();
      if (nextFavorite !== -1) setTimeout(()=>showTrack(nextFavorite, true), 300);
      else {
        toggleFavoritesOnly();
        NotificationSystem.warning('Все треки удалены из избранного');
      }
    }
    if (shuffleMode) createShuffledPlaylist();
  }
}

function updateFavoriteClasses() {
  const liked = getLiked();
  document.querySelectorAll('.track').forEach(tr => tr.classList.remove('is-favorite'));
  liked.forEach(idx => { const el = document.getElementById(`trk${idx}`); if (el) el.classList.add('is-favorite'); });
}

function toggleFavoritesFilter() {
  const btn = document.getElementById('filter-favorites-btn');
  const list = document.getElementById('track-list');
  const liked = getLiked();
  favoritesFilterActive = !favoritesFilterActive;
  if (favoritesFilterActive) {
    if (!liked.length){ NotificationSystem.warning('Нет избранных треков!'); favoritesFilterActive=false; return; }
    btn.textContent='ПОКАЗАТЬ ВСЕ ПЕСНИ'; btn.classList.add('filtered'); list.classList.add('filtered'); updateFavoriteClasses();
  } else {
    btn.textContent='Скрыть не отмеченные ⭐ песни'; btn.classList.remove('filtered'); list.classList.remove('filtered');
  }
}

// Плеер (адаптирован из вашего)
function pickAndPlayTrack(n){ showTrack(n, true); autoPlayEnabled = true; }
function showTrack(n, doPlay) {
  currentTrack = n;
  buildTrackList();
  if (doPlay && document.getElementById('audio')) {
    setTimeout(()=>{ const audio = document.getElementById('audio'); audio.currentTime = 0; audio.play().catch(()=>{}); }, 140);
  }
}

function renderLyricsBlock() {
  const block = document.getElementById('lyricsplayerblock');
  if (!block) return;
  let lyricsDiv = `
    <div id="lyrics-window" class="lyrics-normal">
      <div class="lyrics-animated-bg${animationEnabled ? ' active' : ''}"></div>
      <div class="lyrics-scroll" id="lyrics"></div>
    </div>
    <div class="player-progress-wrapper">
      <div class="player-progress-bar" id="player-progress-bar">
        <div class="player-progress-fill" id="player-progress-fill"><div class="player-progress-handle"></div></div>
      </div>
    </div>
    <div class="audio-wrapper"><audio id="audio" preload="metadata" aria-hidden="true" tabindex="-1"></audio></div>
    <div class="player-controls" role="group" aria-label="Управление воспроизведением">
      <div class="player-controls-row">
        <span class="time-in-controls" id="time-elapsed">00:00</span>
        <button class="player-control-btn" onclick="previousTrack()" title="Предыдущий трек (P)" aria-label="Предыдущий трек"><svg viewBox="0 0 24 24" fill="currentColor"><path d="M11 5L4 12l7 7V5zm9 0v14l-7-7 7-7z"/></svg></button>
        <button class="player-control-btn main" onclick="togglePlayPause()" title="Воспроизведение/Пауза (K/Пробел)" aria-label="Воспроизведение/Пауза"><svg id="play-pause-icon" viewBox="0 0 24 24" fill="currentColor"><path d="M8 5v14l11-7z"/></svg></button>
        <button class="player-control-btn" onclick="stopPlayback()" title="Стоп (X)" aria-label="Стоп"><svg viewBox="0 0 24 24" fill="currentColor"><rect x="6" y="6" width="12" height="12"/></svg></button>
        <button class="player-control-btn" onclick="nextTrack()" title="Следующий трек (N)" aria-label="Следующий трек"><svg viewBox="0 0 24 24" fill="currentColor"><path d="M13 5l7 7-7 7V5zM4 5v14l7-7-7-7z"/></svg></button>
        <span class="time-in-controls" id="time-remaining">--:--</span>
      </div>
      <div class="player-controls-row">
        <button class="player-control-btn" id="mute-btn" onclick="toggleMute()" title="Без звука (M)" aria-label="Без звука"><svg viewBox="0 0 24 24" fill="currentColor"><path d="M3 9v6h4l5 5V4L7 9H3zm13.5 3c0-1.77-1.02-3.29-2.5-4.03v8.05c1.48-.73 2.5-2.25 2.5-4.02z"/></svg></button>
        <button class="player-control-btn${shuffleMode?' active':''}" id="shuffle-btn" onclick="toggleShuffle()" title="Случайный порядок (U)" aria-label="Shuffle"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 17h2.735a4 4 0 003.43-1.942l3.67-6.116A4 4 0 0116.265 7H21m0 0l-3-3m3 3l-3 3"/><path d="M3 7h2.735a4 4 0 013.43 1.942l3.67 6.116A4 4 0 0016.265 17H21m0 0l-3 3m3-3l-3-3"/></svg></button>
        <button class="player-control-btn animation-btn${animationEnabled?' animation-active':''}" id="animation-btn" onclick="toggleAnimation()" title="Анимация лирики (A)" aria-label="Анимация">A</button>
        <button class="player-control-btn bit-btn${bitEnabled?' bit-active':''}" id="bit-btn" onclick="toggleBit()" title="Пульсация логотипа (B)" aria-label="Пульсация">B</button>
        <button class="player-control-btn${repeatMode?' repeat-active':''}" id="repeat-btn" onclick="toggleRepeat()" title="Повтор трека (R)" aria-label="Повтор"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M17 2l4 4-4 4"/><path d="M3 11V9a4 4 0 014-4h14"/><path d="M7 22l-4-4 4-4"/><path d="M21 13v2a4 4 0 01-4 4H3"/><circle cx="12" cy="12" r="1" fill="currentColor"/></svg></button>
        <button class="sleep-timer-btn" id="sleep-timer-btn" onclick="toggleSleepMenu()" title="Таймер сна (T)" aria-label="Таймер сна"><svg viewBox="0 0 24 24" fill="currentColor" width="24" height="24"><path d="M12 2C6.5 2 2 6.5 2 12s4.5 10 10 10 10-4.5 10-10S17.5 2 12 2zm.5 5H11v6l5.2 3.2.8-1.3-4.5-2.7V7z"/></svg><span class="sleep-timer-badge" id="sleep-timer-badge" style="display:none;">0</span><div class="sleep-menu" id="sleep-menu"><div class="sleep-menu-item" onclick="setSleepTimer('off')">Выключить</div><div class="sleep-menu-item" onclick="setSleepTimer(15)">15 минут</div><div class="sleep-menu-item" onclick="setSleepTimer(30)">30 минут</div><div class="sleep-menu-item" onclick="setSleepTimer(60)">60 минут</div></div></button>
        <button class="player-control-btn${favoritesOnlyMode?' favorites-active':''}" id="favorites-btn" onclick="toggleFavoritesOnly()" title="Только избранные (F)" aria-label="Избранные"><img src="img/${favoritesOnlyMode?'star.png':'star2.png'}" alt="★" id="favorites-btn-icon"/></button>
      </div>
    </div>
    <div class="volume-control-wrapper">
      <div class="volume-track"></div><div class="volume-fill" id="volume-fill"></div>
      <input type="range" class="volume-slider" id="volume-slider" min="0" max="100" value="100" aria-label="Громкость" aria-valuemin="0" aria-valuemax="100" aria-valuenow="100">
    </div>
    <div class="player-buttons-wrapper">
      <button class="lyrics-toggle-btn lyrics-normal" onclick="toggleLyricsView()" aria-label="Скрыть лирику" title="Скрыть лирику (Y)"><span class="lyrics-toggle-btn-visual">Т</span></button>
      <button class="karaoke-btn" onclick="copyLyrics()">СКОПИРОВАТЬ ТЕКСТ</button>
      <a class="player-download-btn" href="#" onclick="openDownloadModal(event)">СКАЧАТЬ ПЕСНЮ</a>
    </div>
  `;
  block.innerHTML = lyricsDiv;

  const tr = config.tracks[currentTrack];
  const audioEl = document.getElementById('audio');
  audioEl.src = tr.audio;

  loadLyrics(tr.lyrics);
  setupMediaSession();
  restorePlayerButtonsState();
  initializePlayerControls();
  applyLyricsViewMode();

  audioEl.addEventListener('loadedmetadata', onAudioMetadataLoaded);
  audioEl.addEventListener('timeupdate', onAudioTimeUpdate);
  audioEl.addEventListener('ended', onAudioEnded);
}

// Дальше — адаптированные обработчики (укороченные, без статы/ачивок)
let lastTimeUpdate = 0, isSeekingProgress=false, isMuted=false, sleepTimerInterval=null, sleepTimerTarget=null;

function initializePlayerControls() {
  const progressBar = document.getElementById('player-progress-bar');
  if (progressBar) {
    progressBar.addEventListener('click', seekToPosition);
    const startDrag = (e)=>{
      isSeekingProgress = true;
      const moveHandler = (e2) => {
        const rect = progressBar.getBoundingClientRect();
        const clientX = e2.touches ? e2.touches[0].clientX : e2.clientX;
        const percent = Math.max(0, Math.min(1, (clientX - rect.left) / rect.width));
        document.getElementById('player-progress-fill').style.width = `${percent*100}%`;
      };
      const endHandler = (e3) => {
        const rect = progressBar.getBoundingClientRect();
        const clientX = e3.changedTouches ? e3.changedTouches[0].clientX : e3.clientX;
        const percent = Math.max(0, Math.min(1, (clientX - rect.left) / rect.width));
        const audio = document.getElementById('audio');
        audio.currentTime = audio.duration * percent;
        isSeekingProgress = false;
        document.removeEventListener('mousemove', moveHandler);
        document.removeEventListener('mouseup', endHandler);
        document.removeEventListener('touchmove', moveHandler);
        document.removeEventListener('touchend', endHandler);
      };
      document.addEventListener('mousemove', moveHandler);
      document.addEventListener('mouseup', endHandler);
      document.addEventListener('touchmove', moveHandler, {passive:false});
      document.addEventListener('touchend', endHandler);
      e.preventDefault();
    };
    progressBar.addEventListener('mousedown', startDrag);
    progressBar.addEventListener('touchstart', startDrag, {passive:false});
  }

  const volumeSlider = document.getElementById('volume-slider');
  if (volumeSlider) {
    volumeSlider.addEventListener('input', onVolumeSliderChange);
    const savedVolume = localStorage.getItem('playerVolume');
    if (savedVolume !== null) {
      const volume = parseFloat(savedVolume);
      volumeSlider.value = Math.round(volume*100);
      updateVolumeUI(volume);
      const audio = document.getElementById('audio');
      if (audio) audio.volume = volume;
    }
  }
}

function onAudioMetadataLoaded() {
  const audio = document.getElementById('audio');
  const duration = audio.duration;
  document.getElementById('time-elapsed').textContent = '00:00';
  document.getElementById('time-remaining').textContent = formatTime(duration);
}

function onAudioTimeUpdate() {
  const audio = document.getElementById('audio');
  const currentTime = audio.currentTime, duration = audio.duration || 0;
  if (!isSeekingProgress && duration>0) document.getElementById('player-progress-fill').style.width = `${(currentTime/duration)*100}%`;
  renderLyricsEnhanced(currentTime);
  const now = Date.now();
  if (now - lastTimeUpdate >= 1000) {
    lastTimeUpdate = now;
    document.getElementById('time-elapsed').textContent = formatTime(currentTime);
    document.getElementById('time-remaining').textContent = formatTime(duration - currentTime);
  }
  updatePlayPauseIcon();
}

function onAudioEnded() {
  document.getElementById('time-remaining').textContent = '00:00';
  if (repeatMode) {
    const audio = document.getElementById('audio');
    audio.currentTime = 0; audio.play();
  } else nextTrack();
}

function seekToPosition(e) {
  const audio = document.getElementById('audio');
  const rect = e.currentTarget.getBoundingClientRect();
  const percent = (e.clientX - rect.left) / rect.width;
  audio.currentTime = audio.duration * Math.max(0, Math.min(1, percent));
}

function onVolumeSliderChange(e) {
  const value = e.target.value / 100;
  const audio = document.getElementById('audio');
  if (audio) audio.volume = value;
  updateVolumeUI(value);
  localStorage.setItem('playerVolume', value);
}
function updateVolumeUI(volume){ document.getElementById('volume-fill').style.width = `${Math.round(volume*100)}%`; }
function toggleMute() {
  const audio = document.getElementById('audio');
  if (!audio) return;
  if (isMuted) { audio.volume = parseFloat(localStorage.getItem('playerVolume') || 1); isMuted=false; }
  else { localStorage.setItem('playerVolume', audio.volume); audio.volume=0; isMuted=true; }
  updateVolumeUI(audio.volume);
}

function togglePlayPause() {
  const a = document.getElementById('audio'); if (!a) return;
  if (a.paused) a.play(); else a.pause();
}
function updatePlayPauseIcon() {
  const a = document.getElementById('audio'), icon = document.getElementById('play-pause-icon'); if (!a || !icon) return;
  icon.innerHTML = a.paused ? '<path d="M8 5v14l11-7z"/>' : '<path d="M6 6h4v12H6zM14 6h4v12h-4z"/>';
}
function stopPlayback(){ const a=document.getElementById('audio'); if (!a) return; a.pause(); a.currentTime=0; updatePlayPauseIcon(); }

function toggleRepeat(){ repeatMode = !repeatMode; const btn=document.getElementById('repeat-btn'); if (repeatMode) btn.classList.add('repeat-active'); else btn.classList.remove('repeat-active'); localStorage.setItem('repeatMode', repeatMode?'1':'0'); }
function toggleShuffle(){ shuffleMode=!shuffleMode; const btn=document.getElementById('shuffle-btn'); if (shuffleMode){ btn.classList.add('active'); createShuffledPlaylist(); NotificationSystem.info('🔀 Случайный порядок'); } else { btn.classList.remove('active'); NotificationSystem.info('Последовательно'); } localStorage.setItem('shuffleMode', shuffleMode?'1':'0'); }

function toggleFavoritesOnly(){
  const liked = getLiked();
  if (!liked.length){ NotificationSystem.warning('Нет избранных треков!'); return; }
  favoritesOnlyMode = !favoritesOnlyMode;
  const btn = document.getElementById('favorites-btn'), icon = document.getElementById('favorites-btn-icon');
  if (favoritesOnlyMode){ btn.classList.add('favorites-active'); icon.src='img/star.png'; updateAvailableTracks(); NotificationSystem.success(`⭐ Только избранные (${liked.length})`); if (!isLiked(currentTrack)){ const n=getNextFavoriteTrack(); if (n!==-1) showTrack(n,true); } }
  else { btn.classList.remove('favorites-active'); icon.src='img/star2.png'; updateAvailableTracks(); NotificationSystem.info('Играют все треки'); }
  if (shuffleMode) createShuffledPlaylist();
  localStorage.setItem('favoritesOnlyMode', favoritesOnlyMode?'1':'0');
}
function updateAvailableTracks(){ availableTracks = favoritesOnlyMode ? getLiked() : Array.from({length:config.tracks.length},(_,i)=>i); }
function getNextFavoriteTrack(){ const liked=getLiked(); if (!liked.length) return -1; const pos=liked.indexOf(currentTrack); return pos!==-1 && pos<liked.length-1 ? liked[pos+1] : liked[0]; }

function previousTrack(){
  if (repeatMode){ const a=document.getElementById('audio'); a.currentTime=0; a.play(); return; }
  updateAvailableTracks();
  if (!availableTracks.length) return NotificationSystem.warning('Нет доступных треков');
  if (shuffleMode){ shuffleIndex = Math.max(0, shuffleIndex-1); showTrack(shuffledPlaylist[shuffleIndex]||availableTracks[0], true); }
  else if (favoritesOnlyMode){ const idx=availableTracks.indexOf(currentTrack); const prev = idx>0 ? availableTracks[idx-1] : availableTracks[availableTracks.length-1]; showTrack(prev,true); }
  else { const prev = currentTrack>0 ? currentTrack-1 : config.tracks.length-1; showTrack(prev,true); }
}
function nextTrack(){
  if (repeatMode){ const a=document.getElementById('audio'); a.currentTime=0; a.play(); return; }
  updateAvailableTracks();
  if (!availableTracks.length) return NotificationSystem.warning('Нет доступных треков');
  if (shuffleMode){ shuffleIndex++; if (shuffleIndex>=shuffledPlaylist.length){ createShuffledPlaylist(); shuffleIndex=0; } showTrack(shuffledPlaylist[shuffleIndex], true); }
  else if (favoritesOnlyMode){ const idx=availableTracks.indexOf(currentTrack); const next = availableTracks[(idx+1)%availableTracks.length]; showTrack(next,true); }
  else { const n = (currentTrack+1)%config.tracks.length; showTrack(n,true); }
}
function createShuffledPlaylist(){
  updateAvailableTracks();
  shuffledPlaylist = [...availableTracks];
  const i = shuffledPlaylist.indexOf(currentTrack);
  if (i!==-1) shuffledPlaylist.splice(i,1);
  for (let j=shuffledPlaylist.length-1;j>0;j--){ const k=Math.floor(Math.random()*(j+1)); [shuffledPlaylist[j],shuffledPlaylist[k]]=[shuffledPlaylist[k],shuffledPlaylist[j]]; }
  if (availableTracks.includes(currentTrack)) shuffledPlaylist.unshift(currentTrack);
  shuffleIndex=0;
}

// Лирика
let lyricsViewMode='normal';
function renderLyrics(time) { // базовая версия (window size=5)
  if (!currentLyrics || !currentLyrics.length) { document.getElementById('lyrics').innerHTML=''; return; }
  let active=0; for (let i=0;i<currentLyrics.length;i++){ if (time>=currentLyrics[i].time) active=i; }
  const windowSize = 5, start = Math.max(0, active-2); const padTop = Math.max(0, 2-active);
  const rows=[];
  for (let p=0;p<padTop;p++) rows.push('<div class="lyrics-window-line"></div>');
  for (let i=start;i<Math.min(currentLyrics.length, start+windowSize-padTop);i++){
    const cls = (i===active)?'lyrics-window-line active':'lyrics-window-line';
    rows.push(`<div class="${cls}">${currentLyrics[i]?currentLyrics[i].line:''}</div>`);
  }
  while (rows.length<windowSize) rows.push('<div class="lyrics-window-line"></div>');
  document.getElementById('lyrics').innerHTML = rows.join('');
}
function renderLyricsEnhanced(t){ if (lyricsViewMode==='hidden') return; renderLyrics(t); }
function copyLyrics(){
  if (!config || currentTrack<0 || !config.tracks[currentTrack].fulltext) { NotificationSystem.warning('Файл с текстом не найден!'); return; }
  fetch(config.tracks[currentTrack].fulltext).then(r=>r.text()).then(txt=>{
    if (navigator.clipboard && window.isSecureContext) navigator.clipboard.writeText(txt).then(()=>NotificationSystem.success('Текст скопирован!'),()=>NotificationSystem.error('Не удалось скопировать'));
    else {
      const ta=document.createElement('textarea'); ta.value=txt; document.body.appendChild(ta); ta.select();
      try { document.execCommand('copy'); NotificationSystem.success('Текст скопирован!'); } catch { NotificationSystem.error('Не удалось скопировать'); }
      document.body.removeChild(ta);
    }
  }).catch(()=> NotificationSystem.error('Не удалось загрузить текст!'));
}
function toggleLyricsView(){
  const modes=['normal','hidden','expanded']; lyricsViewMode=modes[(modes.indexOf(lyricsViewMode)+1)%modes.length];
  applyLyricsViewMode();
  const msg = {normal:'📝 Обычный вид лирики', hidden:'🚫 Лирика скрыта', expanded:'📖 Расширенный вид лирики'}[lyricsViewMode];
  NotificationSystem.info(msg);
}
function applyLyricsViewMode(){
  const w=document.getElementById('lyrics-window'), btn=document.querySelector('.lyrics-toggle-btn');
  if (!w||!btn) return;
  w.classList.remove('lyrics-normal','lyrics-hidden','lyrics-expanded'); btn.classList.remove('lyrics-normal','lyrics-hidden','lyrics-expanded');
  w.classList.add(`lyrics-${lyricsViewMode}`); btn.classList.add(`lyrics-${lyricsViewMode}`);
}

// Анимации/пульсация
function toggleAnimation(){
  animationEnabled=!animationEnabled;
  const btn=document.getElementById('animation-btn'), bg=document.querySelector('.lyrics-animated-bg'), win=document.getElementById('lyrics-window');
  if (animationEnabled){ if (btn) btn.classList.add('animation-active'); if (bg) bg.classList.add('active'); if (win) win.classList.add('animation-active'); NotificationSystem.success('✨ Анимация лирики включена'); }
  else { if (btn) btn.classList.remove('animation-active'); if (bg) bg.classList.remove('active'); if (win) win.classList.remove('animation-active'); NotificationSystem.info('Анимация лирики выключена'); }
  localStorage.setItem('animationEnabled', animationEnabled?'1':'0');
}
function toggleBit(){
  bitEnabled=!bitEnabled;
  const btn=document.getElementById('bit-btn'); if (bitEnabled) btn.classList.add('bit-active'); else btn.classList.remove('bit-active');
  if (bitEnabled){ try{ initAudioContext(); startLogoPulsation(); NotificationSystem.success('🎵 Пульсация включена'); }catch{ bitEnabled=false; btn.classList.remove('bit-active'); NotificationSystem.error('Не удалось включить'); } }
  else { stopLogoPulsation(); try{ if (audioSource) audioSource.disconnect(); if (analyser) analyser.disconnect(); }catch{} analyser=null; audioSource=null; }
  localStorage.setItem('bitEnabled', bitEnabled?'1':'0');
}
function initAudioContext(){
  if (!audioContext) { const AC = window.AudioContext||window.webkitAudioContext; audioContext = new AC(); }
  analyser = audioContext.createAnalyser(); analyser.fftSize=256; analyser.smoothingTimeConstant=.8;
  const a=document.getElementById('audio'); if (!a) return;
  if (!audioSource){ audioSource = audioContext.createMediaElementSource(a); audioSource.connect(analyser); analyser.connect(audioContext.destination); }
  if (audioContext.state==='suspended') audioContext.resume();
}
function startLogoPulsation(){
  if (!bitEnabled || !analyser) return; const logo=document.getElementById('logo-bottom'); if (!logo) return;
  logo.classList.add('logo-pulsing'); const dataArray = new Uint8Array(analyser.frequencyBinCount); let lastScale=1;
  (function animate(){
    if (!bitEnabled){ if (lastScale!==1){ logo.style.transform='scale3d(1,1,1)'; lastScale=1; } return; }
    animationFrame = requestAnimationFrame(animate);
    analyser.getByteFrequencyData(dataArray);
    let bass=0; for (let i=0;i<8;i++) bass+=dataArray[i]; bass/=8; let mid=0; for (let i=8;i<32;i++) mid+=dataArray[i]; mid/=24;
    const amplitude = (bass*.7 + mid*.3)/255; const scaled = amplitude*(bitIntensity/100); const scale = 1 + scaled*.3;
    if (Math.abs(scale-lastScale)>0.01){ logo.style.transform=`scale3d(${scale},${scale},1)`; lastScale=scale; }
  })();
}
function stopLogoPulsation(){ const logo=document.getElementById('logo-bottom'); if (logo){ logo.classList.remove('logo-pulsing'); logo.style.transform='scale(1)'; } if (animationFrame){ cancelAnimationFrame(animationFrame); animationFrame=null; } }
function handleLogoClick(){ if (!bitEnabled) return; if (bitIntensity===100) bitIntensity=50; else if (bitIntensity===50) bitIntensity=15; else bitIntensity=100; localStorage.setItem('bitIntensity', String(bitIntensity)); NotificationSystem.info(`💿 Интенсивность: ${bitIntensity}%`); }

// MediaSession
function setupMediaSession(){
  if (!('mediaSession' in navigator)) return;
  const tr=config.tracks[currentTrack];
  navigator.mediaSession.metadata = new MediaMetadata({
    title: tr.title, artist: config.artist || 'Витрина Разбита', album: config.albumName || 'Альбом',
    artwork: [{src: coverGalleryArr[0]||'img/logo.png', sizes:'512x512', type:'image/png'}]
  });
  navigator.mediaSession.setActionHandler('play', ()=>{ const a=document.getElementById('audio'); a&&a.play(); updatePlayPauseIcon(); });
  navigator.mediaSession.setActionHandler('pause', ()=>{ const a=document.getElementById('audio'); a&&a.pause(); updatePlayPauseIcon(); });
  navigator.mediaSession.setActionHandler('previoustrack', previousTrack);
  navigator.mediaSession.setActionHandler('nexttrack', nextTrack);
  navigator.mediaSession.setActionHandler('seekbackward', ()=>{ const a=document.getElementById('audio'); if (a) a.currentTime=Math.max(0,a.currentTime-10); });
  navigator.mediaSession.setActionHandler('seekforward', ()=>{ const a=document.getElementById('audio'); if (a) a.currentTime=Math.min(a.duration,a.currentTime+10); });
}

// Загрузка лирики
function loadLyrics(file){ fetch(file).then(r=>r.json()).then(js=>{ currentLyrics=js; renderLyrics(0); }).catch(()=>{ currentLyrics=[]; }); }

// Формат времени
function formatTime(sec){ if (isNaN(sec)||sec<0) return '--:--'; const m=Math.floor(sec/60), s=Math.floor(sec%60); return `${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}`; }

// Горячие клавиши
window.addEventListener('keydown', function(e){
  if (e.target.tagName==='INPUT' || e.target.tagName==='TEXTAREA') return;
  const hasModal = document.querySelector('.modal-bg.active');
  if (e.key==='Escape' && hasModal){ e.preventDefault(); document.querySelectorAll('.modal-bg.active').forEach(m=>m.classList.remove('active')); return; }
  if (hasModal) return;
  const audio=document.getElementById('audio');
  switch(e.key.toUpperCase()){
    case ' ': case 'K': e.preventDefault(); togglePlayPause(); break;
    case 'X': e.preventDefault(); stopPlayback(); break;
    case 'N': e.preventDefault(); nextTrack(); break;
    case 'P': e.preventDefault(); previousTrack(); break;
    case 'J': e.preventDefault(); if (audio) audio.currentTime=Math.max(0,(audio.currentTime||0)-10); break;
    case 'L': e.preventDefault(); if (audio) audio.currentTime=Math.min(audio.duration,(audio.currentTime||0)+10); break;
    case '+': case '=': e.preventDefault(); const vs1=document.getElementById('volume-slider'); if (vs1){ vs1.value=Math.min(100, parseInt(vs1.value)+10); vs1.dispatchEvent(new Event('input')); } break;
    case '-': e.preventDefault(); const vs2=document.getElementById('volume-slider'); if (vs2){ vs2.value=Math.max(0, parseInt(vs2.value)-10); vs2.dispatchEvent(new Event('input')); } break;
    case 'M': case '0': e.preventDefault(); toggleMute(); break;
    case 'R': e.preventDefault(); toggleRepeat(); break;
    case 'U': e.preventDefault(); toggleShuffle(); break;
    case 'F': e.preventDefault(); toggleFavoritesOnly(); break;
    case 'T': e.preventDefault(); toggleSleepMenu(); break;
    case 'A': e.preventDefault(); toggleAnimation(); break;
    case 'B': e.preventDefault(); toggleBit(); break;
    case '1': if (bitEnabled){ bitIntensity=100; localStorage.setItem('bitIntensity','100'); NotificationSystem.info('💿 Интенсивность: 100%'); } break;
    case '2': if (bitEnabled){ bitIntensity=50; localStorage.setItem('bitIntensity','50'); NotificationSystem.info('💿 Интенсивность: 50%'); } break;
    case '3': if (bitEnabled){ bitIntensity=15; localStorage.setItem('bitIntensity','15'); NotificationSystem.info('💿 Интенсивность: 15%'); } break;
    case 'Y': e.preventDefault(); if (currentTrack>=0) toggleLyricsView(); break;
    case 'W': e.preventDefault(); document.getElementById('track-list')?.scrollIntoView({behavior:'smooth'}); break;
    case 'D': e.preventDefault(); if (currentTrack>=0) toggleLike(currentTrack); break;
    case '?': e.preventDefault(); showHotkeysModal(); break;
  }
  if (e.key>='1' && e.key<='9' && !e.shiftKey && !e.ctrlKey && !e.altKey){
    const i=parseInt(e.key)-1; if (config && i<config.tracks.length){ e.preventDefault(); showTrack(i,true); }
  }
});

// Диалог горячих клавиш
function showHotkeysModal(){ document.getElementById('hotkeys-modal').classList.add('active'); }
function closeHotkeysModal(){ document.getElementById('hotkeys-modal').classList.remove('active'); }

// Обратная связь (заглушка)
function openFeedbackModal(){ document.getElementById('modal-feedback').classList.add('active'); }
function closeFeedbackModal(){ document.getElementById('modal-feedback').classList.remove('active'); }

// Deep-link
function parseDeepLink(){
  const params=new URLSearchParams(location.search);
  const t=params.get('track');
  if (t){ const idx=parseInt(t,10); if (!isNaN(idx) && idx>=0 && idx<config.tracks.length){ showTrack(idx,true); setTimeout(()=>document.getElementById(`trk${idx}`)?.scrollIntoView({behavior:'smooth',block:'center'}), 300); } }
}

// Скачивание трека/альбома (ваши функции, с адаптацией абсолютных URL)
function getTrackFileName(track, idx, artist){ return `${String(idx+1).padStart(2,'0')} - ${track.title} - ${artist}.mp3`.replace(/[\\/:"*?<>|]+/g,'_'); }
function openDownloadModal(e){ if (e) e.preventDefault(); const tr=config.tracks[currentTrack]; const fn=getTrackFileName(tr,currentTrack,config.artist); document.getElementById('download-modal-filename').innerHTML=`<b>${fn}</b>`; document.getElementById('download-modal').classList.add('active'); }
function closeDownloadModal(){ document.getElementById('download-modal').classList.remove('active'); }
document.getElementById('download-modal').onclick = function(e){ if (e.target===this) closeDownloadModal(); };
function downloadCurrentTrack(){ const tr=config.tracks[currentTrack]; const fn=getTrackFileName(tr,currentTrack,config.artist); const a=document.createElement('a'); a.href=tr.audio; a.download=fn; document.body.appendChild(a); a.click(); setTimeout(()=>{ document.body.removeChild(a); },250); closeDownloadModal(); NotificationSystem.success('Файл будет загружен!'); }
async function shareCurrentTrack(){ const tr=config.tracks[currentTrack]; const shareUrl = location.origin + location.pathname + `?album=${currentAlbumKey}&track=${currentTrack}`; const txt=`🎵 ${tr.title} - ${config.artist}\n🎧 Слушай:`; if (navigator.share){ try { await navigator.share({title: tr.title, text: txt, url: shareUrl}); NotificationSystem.success('Ссылка отправлена!'); closeDownloadModal(); } catch{} } else { await navigator.clipboard.writeText(`${txt}\n${shareUrl}`); NotificationSystem.success('Ссылка скопирована!'); } }
async function openInAppCurrentTrack(){ await shareCurrentTrack(); }
function copyLinkCurrentTrack(){ const tr=config.tracks[currentTrack]; const directUrl = tr.audio; if (navigator.clipboard && window.isSecureContext){ navigator.clipboard.writeText(directUrl).then(()=>NotificationSystem.success('Прямая ссылка скопирована!'),()=>NotificationSystem.error('Не удалось скопировать')); } else { const ta=document.createElement('textarea'); ta.value=directUrl; document.body.appendChild(ta); ta.select(); try{ document.execCommand('copy'); NotificationSystem.success('Прямая ссылка скопирована!'); }catch{ NotificationSystem.error('Не удалось скопировать'); } document.body.removeChild(ta); } closeDownloadModal(); }

// Скачивание альбома
function openAlbumDownloadModal(){ document.getElementById('albumDownloadModal').classList.add('active'); checkFavoritesAvailable(); }
function closeAlbumDownloadModal(){ document.getElementById('albumDownloadModal').classList.remove('active'); }
document.getElementById('albumDownloadModal').onclick = function(e){ if (e.target===this) closeAlbumDownloadModal(); };
function checkFavoritesAvailable(){ const favCheckbox=document.getElementById('onlyFavorites'); const liked=getLiked(); favCheckbox.disabled = liked.length===0; favCheckbox.parentElement.style.opacity = liked.length===0 ? '.5' : '1'; }
async function prepareFilesList(){
  filesToDownload=[]; const added = new Set();
  const liked = getLiked();
  let idxs = [];
  const onlyFav = document.getElementById('onlyFavorites').checked;
  const fullAlbum = document.getElementById('fullAlbum').checked;
  if (onlyFav && liked.length>0) idxs = liked;
  else if (fullAlbum) idxs = config.tracks.map((_,i)=>i);

  for (const i of idxs){
    const t=config.tracks[i]; const num=String(i+1).padStart(2,'0'); const name=`${num} - ${t.title} - ${config.artist}.mp3`;
    if (!added.has(name)){ added.add(name); filesToDownload.push({url: t.audio, name, type:'audio'}); }
    if (document.getElementById('includeLyrics').checked && t.fulltext){
      const n2 = `${num} - ${t.title} - ${config.artist}.txt`;
      if (!added.has(n2)){ added.add(n2); try{ const r=await fetch(t.fulltext); const text=await r.text(); filesToDownload.push({content:text, name:n2, type:'text'}); }catch{} }
    }
  }
  if (document.getElementById('includeCovers').checked){
    ['Cover.png','Cover01.png','Cover02.png','Cover03.png'].forEach(c=>{
      const url = absJoin(albumBase, c); const nm = c;
      if (!added.has(nm)){ added.add(nm); filesToDownload.push({url, name:nm, type:'image'}); }
    });
  }
  if (!added.has('logo.png')) filesToDownload.push({url:'img/logo.png', name:'logo.png', type:'image'});
  if (!added.has('social.txt')) filesToDownload.push({content: generateSocialText(), name:'social.txt', type:'text'});
}
function generateSocialText(){
  const s = config.socials||[]; const lines = s.map(one=>`${one.title}: ${one.url}`).join('\n');
  return `═══════════════════════════════════════
       ВИТРИНА РАЗБИТА — ${config.albumName||'Альбом'}
═══════════════════════════════════════

Спасибо за интерес к нашему творчеству!
Поддержите нас и подпишитесь:

${lines}

С любовью, "Витрина Разбита"
═══════════════════════════════════════`;
}
async function prepareDownload(){
  downloadOptions.includeCovers=document.getElementById('includeCovers').checked;
  downloadOptions.includeLyrics=document.getElementById('includeLyrics').checked;
  downloadOptions.onlyFavorites=document.getElementById('onlyFavorites').checked;
  downloadOptions.fullAlbum=document.getElementById('fullAlbum').checked;
  if (!downloadOptions.onlyFavorites && !downloadOptions.fullAlbum) return NotificationSystem.warning('Выберите треки для скачивания');

  await loadJSZip();
  await prepareFilesList();
  if (!filesToDownload.length) return NotificationSystem.error('Нет файлов для архива');

  const sizeMB = await calculateArchiveSize();
  document.getElementById('archiveSize').textContent = sizeMB+' МБ';
  document.getElementById('fileCount').textContent = filesToDownload.length;
  closeAlbumDownloadModal();
  document.getElementById('sizeConfirmModal').classList.add('active');
}
function closeSizeConfirmModal(){ document.getElementById('sizeConfirmModal').classList.remove('active'); }
document.getElementById('sizeConfirmModal').onclick = function(e){ if (e.target===this) closeSizeConfirmModal(); };
async function loadJSZip(){ if (window.JSZip) return; await new Promise((res,rej)=>{ const s=document.createElement('script'); s.src='https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js'; s.onload=res; s.onerror=rej; document.head.appendChild(s); }); }
async function calculateArchiveSize(){
  let total=0; const promises=[];
  for (const f of filesToDownload){
    if (f.url){
      const head = fetch(f.url, {method:'HEAD'}).then(r=>{ const s=r.headers.get('content-length'); return s?parseInt(s):null; }).catch(()=>null);
      const heur = new Promise(r=>setTimeout(()=>r(f.type==='audio'? 5*1024*1024 : f.type==='image'? 500*1024 : 10*1024),500));
      promises.push(Promise.race([head,heur]).then(sz=>{ if (sz) total+=sz; }));
    } else if (f.content){
      total += new Blob([f.content]).size;
    }
  }
  await Promise.allSettled(promises);
  total = Math.ceil(total*1.1);
  return (total/1024/1024).toFixed(1);
}
function startDownload(){ document.getElementById('sizeConfirmModal').classList.remove('active'); createAndDownloadZip(); }
function showProgressModal(){ document.getElementById('downloadProgressModal').classList.add('active'); document.getElementById('progressFill').style.width='0%'; document.getElementById('progressText').textContent = `Загрузка файлов: 0/${filesToDownload.length}`; document.getElementById('errorsList').style.display='none'; }
function updateProgress(done,total){ document.getElementById('progressFill').style.width = `${Math.round(done/total*100)}%`; document.getElementById('progressText').textContent = `Загрузка файлов: ${done}/${total}`; }
function showErrors(errors){ if (errors.length){ document.getElementById('errorsList').style.display='block'; document.getElementById('errorsListContent').innerHTML = errors.map(e=>`<li>${e}</li>`).join(''); } }
async function createAndDownloadZip(){
  await loadJSZip();
  const zip = new JSZip(); const errors=[]; let done=0;
  showProgressModal();
  const BATCH=5;
  for (let i=0;i<filesToDownload.length;i+=BATCH){
    const batch=filesToDownload.slice(i,i+BATCH);
    await Promise.allSettled(batch.map(async f=>{
      try {
        if (f.url){ const r=await fetch(f.url); if (!r.ok) throw new Error(`HTTP ${r.status}`); const b=await r.blob(); zip.file(f.name,b); }
        else zip.file(f.name, f.content);
        done++; updateProgress(done, filesToDownload.length);
      } catch(e){ errors.push(f.name); done++; updateProgress(done, filesToDownload.length); }
    }));
  }
  if (errors.length){ showErrors(errors); await new Promise(r=>setTimeout(r,1500)); }
  document.getElementById('progressText').textContent='Создание архива...';
  const content = await zip.generateAsync({type:'blob', compression:'DEFLATE', compressionOptions:{level:6}}, meta=>{
    document.getElementById('progressText').textContent = `Создание архива: ${meta.percent.toFixed(0)}%`;
    document.getElementById('progressFill').style.width = `${meta.percent.toFixed(0)}%`;
  });
  const a=document.createElement('a'); a.href=URL.createObjectURL(content);
  const date=new Date().toISOString().split('T')[0];
  const albumName = (config?.albumName || 'album').replace(/[\\/:"*?<>|]+/g,'_');
  a.download = `vitrina-razbita-${albumName}-${date}.zip`; a.click();
  setTimeout(()=>{ document.getElementById('downloadProgressModal').classList.remove('active'); URL.revokeObjectURL(a.href); NotificationSystem.success('Архив скачан!'); }, 800);
}

// Sleep таймер (короткая версия)
function toggleSleepMenu(){ const menu=document.getElementById('sleep-menu'); menu.classList.toggle('active'); if (menu.classList.contains('active')) setTimeout(()=>document.addEventListener('click', closeSleepMenu),100); }
function closeSleepMenu(e){ if (e && e.target.closest('#sleep-timer-btn')) return; document.getElementById('sleep-menu').classList.remove('active'); document.removeEventListener('click', closeSleepMenu); }
function setSleepTimer(minutes){ closeSleepMenu(); if (minutes==='off'){ clearSleepTimer(); return; } sleepTimerTarget = Date.now()+minutes*60*1000; updateSleepTimerUI(); if (sleepTimerInterval) clearInterval(sleepTimerInterval); sleepTimerInterval=setInterval(updateSleepTimerUI,1000); NotificationSystem.info(`Таймер сна: ${minutes} мин`); }
function updateSleepTimerUI(){ if (!sleepTimerTarget) return; const rem=sleepTimerTarget-Date.now(); if (rem<=0){ executeSleepTimer(); return; } const m=Math.ceil(rem/60000); const badge=document.getElementById('sleep-timer-badge'); badge.textContent=String(m); badge.style.display='block'; const btn=document.getElementById('sleep-timer-btn'); btn.classList.add('active'); btn.setAttribute('aria-label',`Таймер сна: осталось ${m} минут`); }
function clearSleepTimer(){ sleepTimerTarget=null; if (sleepTimerInterval) clearInterval(sleepTimerInterval); const badge=document.getElementById('sleep-timer-badge'); if (badge) badge.style.display='none'; const btn=document.getElementById('sleep-timer-btn'); if (btn) btn.classList.remove('active'); NotificationSystem.info('Таймер сна отключён'); }
function executeSleepTimer(){ const a=document.getElementById('audio'); if (a && !a.paused) a.pause(); clearSleepTimer(); showSleepOverlay(); }
function showSleepOverlay(){ const o=document.createElement('div'); o.className='sleep-overlay active'; o.innerHTML=`<div class="sleep-content"><div class="sleep-icon">😴</div><h2 class="sleep-title">Таймер сна сработал</h2><p class="sleep-message">Воспроизведение остановлено</p><div class="sleep-buttons"><button class="sleep-btn sleep-btn-primary" onclick="closeSleepOverlay()">Готово</button></div></div>`; document.body.appendChild(o); }
function closeSleepOverlay(){ const o=document.querySelector('.sleep-overlay'); if (o){ o.classList.remove('active'); setTimeout(()=>o.remove(),300); } }

// Офлайн/PWA (адаптировано)
function syncOfflineState(){
  offlineMode = localStorage.getItem('offlineMode') === '1';
  if (navigator.serviceWorker && navigator.serviceWorker.controller){
    navigator.serviceWorker.controller.postMessage({ type:'SET_OFFLINE_MODE', value: offlineMode });
  }
}
function setOfflineUIState(state, progress, needMb){
  const btn=document.getElementById('offline-btn');
  if (state==='downloading'){
    btn.disabled=true; btn.className='offline-btn offline'; btn.innerHTML='OFFLINE';
    if (!document.getElementById('offline-progr-div')){
      const div=document.createElement('div'); div.id='offline-progr-div';
      div.innerHTML = `<div class="offline-progress"><div class="offline-progress-bar" id="offline-progress-bar" style="width:0%"></div></div><div class="offline-desc" id="offline-desc"></div>`;
      btn.parentElement.insertBefore(div, btn.nextSibling);
    }
    document.getElementById('offline-progress-bar').style.width = Math.round((progress||0)*100)+'%';
    document.getElementById('offline-desc').innerText = `Загружается ~${needMb||0} МБ ...`;
  }
  if (state==='offline'){ btn.disabled=false; btn.className='offline-btn offline'; btn.innerHTML='OFFLINE'; const d=document.getElementById('offline-progr-div'); if (d) d.remove(); }
  if (state==='online'){ btn.disabled=false; btn.className='offline-btn online'; btn.innerHTML='ONLINE'; const d=document.getElementById('offline-progr-div'); if (d) d.remove(); }
}
function offlineUIClick(){
  if (offlineDownloading) return;
  const modal = document.getElementById('modal-offline');
  modal.classList.add('active');
  if (!offlineMode){
    modal.innerHTML = `<div class="modal-feedback" style="max-width:400px;">
      <button class="bigclose" onclick="closeOfflineModal()"><svg viewBox="0 0 48 48"><line x1="12" y1="12" x2="36" y2="36" stroke="currentColor" stroke-width="6" stroke-linecap="round"/><line x1="36" y1="12" x2="12" y2="36" stroke="currentColor" stroke-width="6" stroke-linecap="round"/></svg></button>
      <div style="font-size:1.09em;font-weight:700;margin-bottom:10px;">Оффлайн-режим</div>
      <div style="margin-bottom:16px;">Скачаем музыку на устройство.<br>На iOS Safari объём может быть ограничен.</div>
      <button class="offline-btn online" style="width:99%;margin-bottom:7px;" onclick="nextOfflineChoice()">Согласен</button>
      <button class="offline-btn" style="width:99%;" onclick="closeOfflineModal()">Отмена</button>
    </div>`;
  } else {
    modal.innerHTML = `<div class="modal-feedback" style="max-width:400px;">
      <button class="bigclose" onclick="closeOfflineModal()"><svg viewBox="0 0 48 48"><line x1="12" y1="12" x2="36" y2="36" stroke="currentColor" stroke-width="6" stroke-linecap="round"/><line x1="36" y1="12" x2="12" y2="36" stroke="currentColor" stroke-width="6" stroke-linecap="round"/></svg></button>
      <div style="font-size:1.10em;font-weight:700;margin-bottom:15px;">Вернуться ONLINE?</div>
      <div style="margin-bottom:20px;">Все офлайн‑файлы будут удалены.</div>
      <button class="offline-btn online" style="width:99%;" onclick="confirmGoOnline()">Удалить файлы и ONLINE</button>
      <button class="offline-btn" style="width:99%;margin-top:7px;" onclick="closeOfflineModal()">Отмена</button>
    </div>`;
  }
}
function closeOfflineModal(){ document.getElementById('modal-offline').classList.remove('active'); }
function nextOfflineChoice(){
  const liked = getLiked();
  const allCount = config.tracks.length, likedCount = liked.length;
  const modal = document.getElementById('modal-offline');
  modal.innerHTML = `<div class="modal-feedback" style="max-width:400px;">
    <button class="bigclose" onclick="closeOfflineModal()"><svg viewBox="0 0 48 48"><line x1="12" y1="12" x2="36" y2="36" stroke="currentColor" stroke-width="6" stroke-linecap="round"/><line x1="36" y1="12" x2="12" y2="36" stroke="currentColor" stroke-width="6" stroke-linecap="round"/></svg></button>
    <div style="font-size:1.10em;font-weight:700;margin-bottom:13px;">Что скачать?</div>
    <div style="text-align:left;">
      <label style="display:block;margin:8px 0;"><input type="radio" name="offline-mode" value="all" checked> Весь альбом (${allCount} песен)</label>
      <label style="display:block;margin:8px 0;"><input type="radio" name="offline-mode" value="liked"> Только понравившиеся (${likedCount} песен)</label>
    </div>
    <button class="offline-btn online" style="width:99%;margin-top:12px;" onclick="startOfflineDownload()">Скачать выбранное</button>
    <button class="offline-btn" style="width:99%;margin-top:8px;" onclick="closeOfflineModal()">Отмена</button>
  </div>`;
}
function getAllAssetsForOffline(mode){
  const files = [ './', './index.html', './manifest.json', './albums.json', 'img/logo.png', 'img/star.png', 'img/star2.png' ];
  ['Cover.png','Cover01.png','Cover02.png','Cover03.png'].forEach(c=> files.push(absJoin(albumBase, c)));
  const liked = getLiked();
  const include = (i)=> mode==='all' || liked.includes(i);
  for (let i=0;i<config.tracks.length;i++){
    if (include(i)){
      const t=config.tracks[i];
      files.push(t.audio); files.push(t.lyrics); if (t.fulltext) files.push(t.fulltext);
    }
  }
  return Array.from(new Set(files));
}
function startOfflineDownload(){
  offlineDownloading=true; closeOfflineModal(); setOfflineUIState('downloading');
  const mode = document.querySelector('input[name="offline-mode"]:checked').value;
  const files = getAllAssetsForOffline(mode);
  navigator.serviceWorker.ready.then(async sw=>{
    sw.active.postMessage({ type:'CACHE_FILES', files, offlineMode:true });
    const max = files.length;
    const timer = setInterval(async ()=>{
      const cache = await caches.open('album-offline-v1'); let ok=0;
      for (const src of files){ const res = await cache.match(src); if (res) ok++; }
      setOfflineUIState('downloading', ok/max, null);
      if (ok>=max){
        clearInterval(timer);
        offlineDownloading=false; offlineMode=true; localStorage.setItem('offlineMode','1'); setOfflineUIState('offline'); syncOfflineState();
        NotificationSystem.success('Все файлы доступны офлайн');
      }
    },400);
  });
}
function confirmGoOnline(){
  offlineMode=false; localStorage.removeItem('offlineMode'); setOfflineUIState('online'); closeOfflineModal();
  navigator.serviceWorker.ready.then(sw=>{ sw.active.postMessage({ type:'CLEAR_CACHE', offlineMode:false }); });
}

// iOS установка
function detectIOSAndShowInstallGuide(){
  const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream;
  const isInStandaloneMode = window.navigator.standalone === true;
  const isInPWA = window.matchMedia('(display-mode: standalone)').matches;
  if (isIOS && !isInStandaloneMode && !isInPWA){
    if (!localStorage.getItem('ios-install-dismissed')){
      setTimeout(()=>{
        const prompt=document.createElement('div');
        prompt.className='ios-install-prompt show';
        prompt.innerHTML=`<div class="ios-prompt-content"><button class="ios-prompt-close" onclick="dismissIOSPrompt()">×</button><img src="img/logo.png" alt="Logo" class="ios-prompt-icon"><h3>Установить приложение</h3><p>Нажмите «Поделиться» → «На экран Домой» → «Добавить»</p><button onclick="dismissIOSPrompt()" class="ios-prompt-button">Понятно</button></div>`;
        document.body.appendChild(prompt);
      }, 1500);
    }
  }
}
function dismissIOSPrompt(){ const p=document.querySelector('.ios-install-prompt'); if (p){ p.classList.remove('show'); setTimeout(()=>p.remove(),300); localStorage.setItem('ios-install-dismissed', Date.now().toString()); } }
<script>
// Включаем поля промокода сразу после загрузки страницы
document.addEventListener('DOMContentLoaded', () => {
  const inp = document.getElementById('promo-inp');
  const btn = document.getElementById('promo-btn');
  if (inp) inp.disabled = false;
  if (btn) btn.disabled = false;

  // Если пользователь уже входил ранее — сразу показываем приложение
  if (localStorage.getItem('promoPassed') === '1') {
    showMain();
  }
});
</script>

console.log(`🎵 Витрина Разбита App v${VERSION} (${BUILD_DATE})`);
</script>
</body>
</html>
