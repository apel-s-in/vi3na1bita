<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <title>–í–∏—Ç—Ä–∏–Ω–∞ –†–∞–∑–±–∏—Ç–∞</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
  <meta name="description" content="–û—Ñ–∏—Ü–∏–∞–ª—å–Ω—ã–µ –∞–ª—å–±–æ–º—ã –≥—Ä—É–ø–ø—ã –í–∏—Ç—Ä–∏–Ω–∞ –†–∞–∑–±–∏—Ç–∞. –°–ª—É—à–∞–π—Ç–µ –æ–Ω–ª–∞–π–Ω –∏ –æ—Ñ–ª–∞–π–Ω.">

  <!-- PWA -->
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#181818" />

  <!-- iOS -->
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="–í–∏—Ç—Ä–∏–Ω–∞ –†–∞–∑–±–∏—Ç–∞">
  <link rel="apple-touch-icon" href="icons/apple-touch-icon.png">

  <!-- Preload -->
  <link rel="preload" href="img/logo.png" as="image">

  <!-- FAVICONS -->
  <link rel="icon" href="icons/favicon.svg" type="image/svg+xml">
  <link rel="alternate icon" href="icons/favicon-32.png" sizes="32x32" type="image/png">
  <link rel="alternate icon" href="icons/favicon-16.png" sizes="16x16" type="image/png">
  <link rel="apple-touch-icon" href="icons/apple-touch-icon.png">

  <style>
    :root {
      --primary-bg: #181818;
      --primary-color: #E80100;
      --secondary-color: #4daaff;
      --text-color: #f2f2f2;
      --modal-bg: #252d39;
      --border-color: #394866;
    }
    * { box-sizing: border-box; }
    html, body { height: 100%; }
    body {
      min-height: 100vh;
      background: var(--primary-bg);
      color: var(--text-color);
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      margin: 0; padding: 0; display: flex; flex-direction: column; min-width: 100vw;
      padding-top: env(safe-area-inset-top);
    }

    /* –ü—Ä–æ–º–æ–∫–æ–¥ */
    #promocode-block {
      position: fixed; inset: 0; display: flex; align-items: center; justify-content: center;
      background: var(--primary-bg); z-index: 100;
    }
    .promo-inner {
      display: flex; flex-direction: column; align-items: center;
      background: rgba(15,18,24,0.98); border-radius: 16px; box-shadow: 0 6px 24px #0008;
      padding: 36px 26px 32px 26px; min-width: 260px; min-height: 170px;
    }
    .promo-cover {
      width: 256px; height: 256px; object-fit: cover; border-radius: 12px; box-shadow: 0 4px 24px #000c;
      margin-bottom: 19px; display: block; background: var(--primary-bg);
    }
    #promo-inp {
      padding: 10px; border-radius: 8px; border: 1px solid var(--border-color);
      background: rgba(255,255,255,0.1); color: var(--text-color); margin: 10px 0; width: 100%; font-size: 16px;
    }
    #promo-btn {
      padding: 10px 20px; background: var(--primary-color); color: white; border: none; border-radius: 8px;
      cursor: pointer; font-weight: bold; transition: opacity 0.2s;
    }
    #promo-btn:hover:not(:disabled) { opacity: .8; }
    #promo-btn:disabled { opacity: .5; cursor: not-allowed; }
    #promo-error { color: #ff6b6b; margin-top: 10px; font-size: 14px; }

    .hidden { display: none !important; }

    /* –û—Å–Ω–æ–≤–Ω–æ–π –±–ª–æ–∫ */
    #main-block { max-width: 420px; margin: 0 auto; flex: 1 0 auto; display: flex; flex-direction: column; align-items: center; width: 100%; padding: 0 10px; }
    header { width: 100%; text-align: center; margin: 0 auto; }
    /* –ö—Ä—É–ø–Ω—ã–π –≤—ã–ø–∞–¥–∞—é—â–∏–π –∑–∞–≥–æ–ª–æ–≤–æ–∫-–≤—ã–±–æ—Ä –∞–ª—å–±–æ–º–∞ */
    .album-title-button{
      display:block;
      width:100%;
      max-width:400px;
      margin: 18px auto 2px auto;
      background: none;
      border: none;
      color: #eaf2ff;
      font-weight: 900;
      letter-spacing: .01em;
      line-height: 1.15;
      text-align: center;
      cursor: pointer;
      padding: 4px 6px;
      text-shadow: 0 1px 0 rgba(0,0,0,.35);
    }
    .album-menu{
      width:100%;
      max-width:400px;
      margin: 6px auto 0 auto;
      display:none;           /* –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é —Å–∫—Ä—ã—Ç–æ */
      background: transparent; /* —Ä–æ–¥–Ω–æ–π —Ç—ë–º–Ω—ã–π —Ñ–æ–Ω —Å—Ç—Ä–∞–Ω–∏—Ü—ã */
      border-radius: 0;       /* –±–µ–∑ –∫–∞—Ä—Ç–æ—á–µ–∫/—Ä–∞–º–æ–∫ */
    }
    .album-menu.open{ display:block; }
    .album-menu-item{
      display:flex;
      align-items:center;
      justify-content:center;
      padding: 10px 6px;
      color: #cfe3ff;
      font-weight: 800;
      letter-spacing: .01em;
      cursor: pointer;
      user-select: none;
    }
    .album-menu-item:hover{ color:#fff; background: rgba(255,255,255,.05); }
    .album-menu-item.active{ color:#fff; background: rgba(232,1,0,.18); }

    /* –í—ã–±–æ—Ä –∞–ª—å–±–æ–º–∞ */
    .album-picker {
      width: 100%; max-width: 400px; margin: 18px auto 0 auto; display:flex; gap:8px; align-items:center; justify-content:center;
    }
    .album-picker select {
      width: 100%; max-width: 400px; background: #1f2533; color:#cfe3ff; border:1px solid var(--border-color);
      padding:10px 12px; border-radius:10px; font-weight:700; letter-spacing:.02em; cursor:pointer;
    }

    /* –û–±–ª–æ–∂–∫–∞/–≥–∞–ª–µ—Ä–µ—è */
    #cover-wrap { width: 100%; max-width: 400px; margin: 14px auto 0 auto; aspect-ratio: 1/1; display: flex; align-items: center; justify-content: center; position: relative; }
    .cover-gallery-arrow {
      position: absolute; top: 50%; transform: translateY(-50%); z-index: 2; border: none; cursor: pointer; background: none; padding: 0; width: 44px; height: 44px; display: flex; align-items: center; justify-content: center; transition: opacity 0.2s;
    }
    .cover-gallery-arrow:hover { opacity: 0.8; }
    #cover-gallery-arrow-left { left: 7px; }
    #cover-gallery-arrow-right { right: 7px; }
    #cover { width: 100%; max-width: 100%; border-radius: 12px; object-fit: contain; display: block; margin: 0; box-shadow: 0 4px 24px rgba(0,0,0,0.3); }
    /* –£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–π —Å–ª–æ—Ç –≥–∞–ª–µ—Ä–µ–∏ (–∫–∞—Ä—Ç–∏–Ω–∫–∞ –∏–ª–∏ HTML-–±–∞–Ω–Ω–µ—Ä) */
    #cover-slot {
      width: 100%;
      height: 100%;
      border-radius: 12px;
      overflow: hidden;
      background: #0b0e15;
      box-shadow: 0 4px 24px rgba(0,0,0,0.3);
      position: relative;
    }
    #cover-slot img,
    #cover-slot iframe {
      width: 100%;
      height: 100%;
      display: block;
      border: 0;
      background: #000;
    }
    #cover-slot img { object-fit: contain; }
    #cover-slot iframe {
      /* –±–∞–Ω–Ω–µ—Ä—ã –∏–∑–æ–ª–∏—Ä–æ–≤–∞–Ω—ã, –±–µ–∑ —Å–∫—Ä–∏–ø—Ç–æ–≤, —á—Ç–æ–±—ã –Ω–µ –ª–æ–º–∞—Ç—å —Å—Ç—Ä–∞–Ω–∏—Ü—É */
      background: #000;
    }

    /* –°—Ç—Ä–µ–ª–∫–∏ –¥–æ –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏ –≥–∞–ª–µ—Ä–µ–∏ –Ω–µ–∞–∫—Ç–∏–≤–Ω—ã */
    .cover-gallery-arrow {
      visibility: hidden;
      pointer-events: none;
    }
    #cover-wrap.gallery-nav-ready .cover-gallery-arrow {
      visibility: visible;
      pointer-events: auto;
    }

    /* –õ–æ–≥–æ */
    .logo-bottom {
      max-width: 112px; width: 23vw; min-width: 66px; height: auto; display: block; margin: 0 auto 15px auto !important;
      cursor: pointer; transition: transform 0.1s ease-out; will-change: transform; transform: translateZ(0); transform-origin: center center; isolation: isolate; z-index: 10; position: relative;
    }
    #logo-bottom { will-change: transform; backface-visibility: hidden; transform: translateZ(0); }

    .socials-under-cover { margin: 14px auto 0 auto; width: 100%; max-width: 398px; text-align: center; font-size: 1.03em; display: flex; flex-wrap: wrap; justify-content: center; gap: 12px; }
    .socials-under-cover a { color: var(--secondary-color); text-decoration: none; transition: color 0.2s; }
    .socials-under-cover a:hover { color: var(--text-color); }

    /* –¢—Ä–µ–∫–∏ */
    .track-list { margin: 0 auto; max-width: 370px; width: 100%; font-size: 1.05em; color: #eee; background: none; padding: 0; }
    .track-list.filtered .track:not(.is-favorite) { display: none !important; }
    .track { display: flex; align-items: center; padding: 7px 8px; border-bottom: 1px solid var(--border-color); cursor: pointer; transition: background 0.13s; background: none; }
    .track:hover { background: rgba(255,255,255,0.05); }
    .track.current { background: #232b38; }
    .tnum { min-width: 27px; color: #8ab8fd; }
    .track-title { margin-left: 7px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; flex: 1; }
    .like-star { margin-left: auto; width: 19px; height: 19px; cursor: pointer; opacity: 0.97; border: none; background: none; padding: 0; appearance: none; display: inline-block; transition: transform 0.2s, filter 0.13s, opacity 0.13s; }
    .like-star:hover { filter: brightness(1.13); opacity: 1; transform: scale(1.1); }
    .like-star.animating { animation: starPulse 0.3s; }
    @keyframes starPulse { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.3); } }

    /* –õ–∏—Ä–∏–∫–∞ + –ü–ª–µ–µ—Ä */
    .lyrics-player-block { width: 100%; margin: 8px 0 3px 0; }
    #lyrics-window { width: 100%; background: rgba(34,34,34,0.98); border-radius: 12px; box-shadow: 0 8px 24px #0007; overflow: hidden; height: 8.5em; position: relative; display: flex; flex-direction: column; align-items: stretch; justify-content: center; margin-bottom: 7px; transition: height 0.2s ease, opacity 0.2s ease, margin 0.2s ease; will-change: height, opacity; }
    #lyrics-window.lyrics-hidden { height: 0 !important; opacity: 0; margin: 0; overflow: hidden; pointer-events: none; }
    #lyrics-window.lyrics-normal { height: 8.7em; }      /* 5 * 1.7em + –∑–∞–ø–∞—Å */
    #lyrics-window.lyrics-expanded { height: 15.6em; }   /* 9 * 1.7em + –∑–∞–ø–∞—Å */
    .lyrics-scroll { position: relative; z-index: 1; }
    .lyrics-window-line { opacity: 0.57; font-size: 1.13em; transition: all 0.2s; line-height: 1.7em; text-align: center; min-height: 1.7em; max-width: 97%; margin: 0 auto; color: #eee; white-space: pre-line; user-select: none; word-break: break-word; position: relative; z-index: 1; }
    .lyrics-window-line.active { color: var(--primary-color); font-weight: bold; opacity: 1; text-shadow: 0 1px 7px #73161644; background: rgba(0,0,0,0.07); border-radius: 8px; font-size: 1.19em; }

    .lyrics-animated-bg { position: absolute; inset:0; opacity:0; background: linear-gradient(45deg, rgba(232,1,0,0.15), rgba(77,170,255,0.15), rgba(232,1,0,0.15)); background-size: 400% 400%; animation: none; z-index:0; pointer-events:none; transition: opacity .5s; }
    .lyrics-animated-bg.active { opacity: 1; animation: lyricsGradient 10s ease infinite; }
    @keyframes lyricsGradient { 0%{background-position:0% 50%} 50%{background-position:100% 50%} 100%{background-position:0% 50%} }
    #lyrics-window.animation-active .lyrics-window-line { transition: opacity .3s ease; }
    #lyrics-window.animation-active .lyrics-window-line.active { animation: lyricsGlow 2s ease-in-out infinite; }
    @keyframes lyricsGlow { 0%,50%,100% { opacity:1 } }

    .audio-wrapper { width: 100%; max-width: 395px; margin: 0 auto; }
    #audio { position:absolute; width:1px; height:1px; opacity:0; pointer-events:none; }

    .player-controls { display:flex; flex-direction:column; gap:5px; margin:5px 0; padding:8px 10px; background:rgba(0,0,0,0.3); border-radius:12px; }
    .player-controls-row { display:flex; align-items:center; justify-content:center; gap:12px; }
    .player-control-btn {
      background:none; border:none; color:var(--secondary-color); cursor:pointer; padding:4px; border-radius:50%;
      transition:all .2s; display:flex; align-items:center; justify-content:center;
      width:32px; height:32px; font-weight:bold; font-size:16px; position:relative;
      /* –í–ê–ñ–ù–û: –Ω–µ –¥–∞—ë–º –∫–æ–Ω—Ç–µ–Ω—Ç—É –≤—ã–ª–µ–∑–∞—Ç—å –∑–∞ –≥—Ä–∞–Ω–∏—Ü—ã –∫–Ω–æ–ø–∫–∏ */
      overflow: hidden;
    }
    .player-controls-row:first-child .player-control-btn { width:48px; height:48px; padding:8px; }
    .player-controls-row:first-child .player-control-btn svg { width:28px; height:28px; }

    .player-control-btn:hover { background: rgba(77,170,255,.2); transform: scale(1.1); }
    .player-control-btn:active { transform: scale(.95); }

    .player-control-btn.active,
    .player-control-btn.repeat-active { color:var(--primary-color); background: rgba(232,1,0,.2); }

    .player-control-btn.favorites-active { background: rgba(255,215,0,.3); }

    .player-control-btn.animation-btn,
    .player-control-btn.bit-btn { font-size:22px; font-weight:bold; }

    .player-control-btn.animation-active,
    .player-control-btn.bit-active { color: var(--primary-color); background: rgba(232,1,0,.2); }

    /* –ò–∫–æ–Ω–∫–∏ SVG –≤ –∫–Ω–æ–ø–∫–∞—Ö */
    .player-control-btn svg { width:24px; height:24px; }

    /* –î–û–ë–ê–í–õ–ï–ù–û: —Ñ–∏–∫—Å–∏—Ä—É–µ–º —Ä–∞–∑–º–µ—Ä—ã –∫–∞—Ä—Ç–∏–Ω–æ–∫ –≤–Ω—É—Ç—Ä–∏ –∫–Ω–æ–ø–æ–∫ (–≤ —Ç.—á. –∑–≤–µ–∑–¥—ã –∏–∑–±—Ä–∞–Ω–Ω–æ–≥–æ) */
    .player-control-btn img {
      width: 22px;
      height: 22px;
      display: block;
      object-fit: contain;
      pointer-events: none; /* –∫–ª–∏–∫–∏ –æ—Å—Ç–∞—é—Ç—Å—è –Ω–∞ –∫–Ω–æ–ø–∫–µ */
    }

    /* –ù–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ: –ø–æ–¥—Å–≤–µ—Ç –∏ –ª—ë–≥–∫–∞—è –ø—É–ª—å—Å–∞—Ü–∏—è –∞–∫—Ç–∏–≤–Ω–æ–π –∑–≤–µ–∑–¥—ã */
    .player-control-btn.favorites-active img { filter: drop-shadow(0 0 4px gold); }

    @keyframes pulseFav {
      0%,100% { transform: scale(1); }
      50%     { transform: scale(1.1); }
    }
    .player-control-btn.favorites-active img { animation: pulseFav 2s infinite; }

    /* –ì–ª–∞–≤–Ω–∞—è —Ü–µ–Ω—Ç—Ä–∞–ª—å–Ω–∞—è –∫–Ω–æ–ø–∫–∞ –ø–æ–±–æ–ª—å—à–µ */
    .player-control-btn.main { width:54px; height:54px; }
    .player-control-btn.main svg { width:30px; height:30px; }

    .player-progress-wrapper { width:100%; margin:3px 0 5px 0; position:relative; }
    .player-progress-bar { width:100%; height:6px; background: rgba(255,255,255,.1); border-radius:3px; position:relative; cursor:pointer; overflow:visible; }
    .player-progress-fill { height:100%; background: linear-gradient(90deg, var(--primary-color), var(--secondary-color)); width:0%; transition: width .1s linear; border-radius:3px; position:relative; }
    .player-progress-handle { position:absolute; top:50%; transform:translateY(-50%); width:20px; height:20px; background:#fff; border-radius:50%; box-shadow:0 2px 8px rgba(0,0,0,.3); right:-10px; z-index:2; }

    .time-in-controls { font-family: 'SF Mono', Monaco, 'Courier New', monospace; font-size:13px; color:var(--secondary-color); min-width:45px; text-align:center; user-select:none; }

    .volume-control-wrapper { width:100%; margin:5px 0; padding:0; position:relative; }
    .volume-track { position:absolute; top:50%; transform:translateY(-50%); width:100%; height:6px; background:rgba(255,255,255,.2); border-radius:3px; pointer-events:none; }
    .volume-fill { position:absolute; top:50%; transform:translateY(-50%); height:6px; background:var(--secondary-color); border-radius:3px; pointer-events:none; transition: width .1s; }
    .volume-slider { appearance:none; width:100%; height:20px; background:transparent; outline:none; cursor:pointer; position:relative; z-index:2; }
    .volume-slider::-webkit-slider-thumb { appearance:none; width:20px; height:20px; background:#fff; border-radius:50%; cursor:pointer; box-shadow:0 2px 8px rgba(0,0,0,.3); }
    .volume-slider::-moz-range-thumb { width:20px; height:20px; background:#fff; border-radius:50%; cursor:pointer; border:none; box-shadow:0 2px 8px rgba(0,0,0,.3); }

    /* Sleep */
    .sleep-timer-btn { background:none; border:none; color:var(--secondary-color); cursor:pointer; padding:8px; border-radius:50%; transition:.2s; display:flex; align-items:center; justify-content:center; width:44px; height:44px; position:relative; }
    .sleep-timer-btn:hover { background: rgba(77,170,255,.2); transform: scale(1.1); }
    .sleep-timer-btn.active { color: var(--primary-color); background: rgba(232,1,0,.2); }
    .sleep-timer-badge { position:absolute; top:-2px; right:-2px; background:var(--primary-color); color:#fff; border-radius:10px; padding:2px 6px; font-size:10px; font-weight:bold; min-width:20px; text-align:center; }
    .sleep-menu { position:absolute; bottom:100%; left:50%; transform:translateX(-50%); background: var(--modal-bg); border-radius:12px; padding:10px; margin-bottom:10px; box-shadow:0 4px 20px rgba(0,0,0,.3); z-index:100; min-width:150px; display:none; }
    .sleep-menu.active { display:block; animation: slideUp .2s; }
    .sleep-menu-item { padding:8px 12px; cursor:pointer; border-radius:6px; transition: background .2s; white-space:nowrap; color:var(--text-color); }
    .sleep-menu-item:hover { background: rgba(255,255,255,.1); }

    .sleep-overlay { position: fixed; inset:0; background: rgba(0,0,0,.95); display:none; align-items:center; justify-content:center; z-index:10000; }
    .sleep-overlay.active { display:flex; animation: fadeIn .5s; }
    .sleep-content { text-align:center; padding:40px; max-width:400px; }
    .sleep-icon { font-size:64px; margin-bottom:20px; opacity:.5; }
    .sleep-title { font-size:24px; margin-bottom:10px; color: var(--text-color); }
    .sleep-message { color: rgba(255,255,255,.6); margin-bottom:30px; }
    .sleep-buttons { display:flex; gap:10px; justify-content:center; }
    .sleep-btn { padding:12px 24px; border-radius:8px; border:none; cursor:pointer; font-weight:bold; transition:opacity .2s; }
    .sleep-btn-primary { background: var(--primary-color); color:#fff; }
    .sleep-btn-secondary { background: rgba(255,255,255,.1); color: var(--text-color); }
    .sleep-btn:hover { opacity:.8; }

    /* –ö–Ω–æ–ø–∫–∞ –ª–∏—Ä–∏–∫–∏ –∏ –ø—Ä–æ—á–∏–µ –Ω–∏–∂–Ω–∏–µ –∫–Ω–æ–ø–∫–∏ */
    .lyrics-toggle-btn { position:absolute; left:10px; top:50%; transform: translateY(-50%); width:44px; height:44px; background:none; border:none; cursor:pointer; padding:0; display:flex; align-items:center; justify-content:center; font-weight:bold; transition:.2s; user-select:none; z-index:5; }
    .lyrics-toggle-btn-visual { font-size:36px; line-height:1; transition:.2s; pointer-events:none; }
    .lyrics-toggle-btn.lyrics-normal .lyrics-toggle-btn-visual { color: var(--secondary-color); font-size:36px; }
    .lyrics-toggle-btn.lyrics-hidden .lyrics-toggle-btn-visual { color: var(--primary-color); font-size:36px; }
    .lyrics-toggle-btn.lyrics-expanded .lyrics-toggle-btn-visual { color: var(--secondary-color); font-size:20px; }
    .lyrics-toggle-btn:hover .lyrics-toggle-btn-visual { transform: scale(1.1); }

    .player-buttons-wrapper { display:flex; flex-direction:column; align-items:center; gap:9px; margin-top:10px; width:100%; position:relative; }
    .karaoke-btn, .player-download-btn {
      color: var(--secondary-color) !important; background:none; border:none; cursor:pointer; font-size:1em; text-transform:uppercase; font-weight:700; letter-spacing:.02em; text-decoration:underline; transition:.18s; padding:4px 16px; min-width:148px; text-align:center; border-radius:7px; display:block; margin: 0 auto;
    }
    .karaoke-btn:hover, .player-download-btn:hover { color:#fff !important; background:#273050; }

    .bottom-controls-center { display:flex; flex-direction:column; align-items:center; justify-content:center; margin:32px auto 0 auto; gap:8px; width:100%; max-width:280px; padding-bottom: env(safe-area-inset-bottom); }

    .filter-favorites-btn { display:block; margin:0 auto 15px auto; padding:10px 20px; background: linear-gradient(135deg,#2a2a2a,#1a1a1a); color: var(--secondary-color); border:2px solid var(--border-color); border-radius:12px; font-size:.95em; font-weight:bold; cursor:pointer; transition:.3s; text-align:center; min-width:100%; white-space:nowrap; box-shadow:0 2px 8px rgba(0,0,0,.3); }
    .filter-favorites-btn:hover { background: linear-gradient(135deg,#3a3a3a,#2a2a2a); border-color: var(--secondary-color); transform: translateY(-2px); box-shadow:0 4px 12px rgba(0,0,0,.5); }
    .filter-favorites-btn.filtered { background: linear-gradient(135deg,#4a1a1a,#2a0a0a); border-color: var(--primary-color); color:#fff; }

    #install-pwa-btn, #download-album-main {
      color:#fff; background: var(--secondary-color); border:none; border-radius:7px; font-size:1.07em; font-weight:bold; letter-spacing:.02em; margin:15px 0 5px 0; padding:8px 13px; cursor:pointer; width:98%; box-shadow:0 4px 14px #0005; transition: background .2s;
    }
    #download-album-main { background: var(--primary-color); font-size:1.09em; margin-bottom:8px; }
    #install-pwa-btn:hover { background:#3275c2; } #download-album-main:hover { background:#c60000; }

    .feedback-link, .support-link { color: var(--secondary-color) !important; text-decoration: underline !important; font-weight:700; text-transform:uppercase; letter-spacing:.03em; cursor:pointer; transition: color .18s; font-size:1em; display:block; text-align:center; width:100%; margin:0; }
    .feedback-link:hover, .support-link:hover { color:#fff !important; }

    .offline-btn { min-width:102px; height:38px; font-size:1.05em; font-weight:bold; border:none; border-radius:9px; cursor:pointer; letter-spacing:.07em; box-shadow:0 2px 8px #06000032; transition: background .2s, color .14s; display:block; margin:0 auto; }
    .offline-btn.online { background: var(--primary-color); color:#fff; }
    .offline-btn.offline { background:#27b34c; color:#fff; }
    .offline-progress { margin-top:11px; width:100%; height:8px; background:#222; border-radius:6px; overflow:hidden; box-shadow:0 1px 6px #222b; }
    .offline-progress-bar { height:100%; background:#2fed54; transition: width .33s; }
    .offline-desc { text-align:center; font-size:.97em; margin-top:5px; opacity:.85; }

    .modal-bg { position:fixed; inset:0; background:rgba(0,0,0,.62); display:none; align-items:center; justify-content:center; backdrop-filter: blur(4px); z-index: 99; }
    .modal-bg.active { display:flex; animation: fadeIn .3s; }
    @keyframes fadeIn { from{opacity:0} to{opacity:1} }
    .modal-feedback { background: var(--modal-bg); border-radius:14px; padding:24px 20px; min-width:215px; max-width:96vw; box-shadow:0 4px 32px #0009; position:relative; animation: slideUp .3s; }
    @keyframes slideUp { from{ transform:translateY(20px); opacity:0 } to{ transform:translateY(0); opacity:1 } }
    .modal-feedback .bigclose { background:none; border:none; position:absolute; top:13px; right:13px; cursor:pointer; color:#eee; border-radius:50%; width:32px; height:32px; transition: transform .2s; }
    .modal-feedback .bigclose:hover { transform: scale(1.1); }
    .modal-feedback .bigclose svg { width:31px; height:31px; }

    .hotkeys-btn { color: var(--secondary-color) !important; text-decoration: underline !important; font-weight:700; text-transform:uppercase; letter-spacing:.03em; cursor:pointer; transition:color .18s; font-size:1em; display:block; text-align:center; width:100%; margin:0; background:none; border:none; padding:8px; }
    .hotkeys-btn:hover { color:#fff !important; }
    @media (max-width: 600px) { .hotkeys-btn { display:none !important; } }
    @media (display-mode: standalone) { .bottom-controls-center { padding-bottom: calc(env(safe-area-inset-bottom) + 10px); } }
    @media (hover:none) { .tooltip { display:none; } }

    /* –¢–æ—Å—Ç—ã */
    .toast {
      position: fixed;
      bottom: 80px;
      left: 50%;
      transform: translateX(-50%) translateY(100px);
      background: #2a2a2a;
      border-radius: 12px;
      padding: 15px 20px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.3);
      z-index: 9999;
      opacity: 0;
      transition: all 0.3s ease;
      max-width: 90%;
      word-wrap: break-word;
      pointer-events: none;
    }
    .toast.show { transform: translateX(-50%) translateY(0); opacity: 1; }
    .toast-content { display: flex; align-items: center; gap: 10px; }
    .toast-emoji { width: 24px; height: 24px; display: inline-flex; align-items: center; justify-content: center; flex-shrink: 0; }
    .toast-info { border-left: 4px solid var(--secondary-color); }
    .toast-success { border-left: 4px solid #27b34c; }
    .toast-error { border-left: 4px solid var(--primary-color); }
    .toast-warning { border-left: 4px solid #ff9800; }
    .toast-offline { border-left: 4px solid #666; }

    /* iOS —É—Å—Ç–∞–Ω–æ–≤–∫–∞ ‚Äî —Å—Ç–∏–ª–∏ */
    .ios-install-prompt {
      position: fixed; bottom:0; left:0; right:0; background:#1a1a1a;
      border-top-left-radius: 20px; border-top-right-radius: 20px; padding: 20px;
      transform: translateY(100%); transition: transform 0.3s ease; z-index: 10000;
      box-shadow: 0 -4px 20px rgba(0,0,0,0.3);
    }
    .ios-install-prompt.show { transform: translateY(0); }
    .ios-prompt-content { max-width: 400px; margin: 0 auto; text-align: center; }
    .ios-prompt-icon { width: 60px; height: 60px; margin-bottom: 15px; }
    .ios-prompt-close { position: absolute; top: 10px; right: 10px; background: none; border: none; color: #666; font-size: 28px; cursor: pointer; }
    .ios-prompt-button { background: var(--primary-color); color: white; border: none; padding: 12px 30px; border-radius: 25px; font-weight: bold; margin-top: 20px; cursor: pointer; }

    /* –ú–∏–Ω–∏‚Äë—Ä–µ–∂–∏–º –ø–ª–µ–µ—Ä–∞: –∫–æ–≥–¥–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å–º–æ—Ç—Ä–∏—Ç –¥—Ä—É–≥–æ–π –∞–ª—å–±–æ–º ‚Äî –ø–ª–µ–µ—Ä —Å–≤–æ—Ä–∞—á–∏–≤–∞–µ—Ç—Å—è */
    #now-playing:empty { display: none; }
    .mini-mode .player-buttons-wrapper { display: none !important; } /* —Å–∫—Ä—ã–≤–∞–µ–º –¢, –°–ö–û–ü–ò–†–û–í–ê–¢–¨, –°–ö–ê–ß–ê–¢–¨ */
    /* –†—è–¥ –∏–∫–æ–Ω–æ–∫ –∞–ª—å–±–æ–º–æ–≤ */
    .album-icons { 
      display: flex; gap: 10px; align-items: center; justify-content: center; 
      margin: 10px auto 0 auto; max-width: 400px; overflow-x: auto; padding: 4px 0;
    }
    .album-icon { 
      width: 60px; height: 60px; border-radius: 10px; overflow: hidden; 
      border: 1px solid var(--border-color); cursor: pointer;
      filter: grayscale(70%) brightness(.88); opacity: .72;
      transition: transform .15s, filter .15s, opacity .15s, box-shadow .15s, width .15s ease, height .15s ease;
      flex: 0 0 auto;
    }
    .album-icon.active { 
      filter: none; opacity: 1; box-shadow: 0 2px 10px rgba(0,0,0,.35); 
      width: 66px; height: 66px;      /* +10% –∫ —Ä–∞–∑–º–µ—Ä—É, —Å–æ—Å–µ–¥–µ–π —Ä–∞–∑–¥–≤–∏–Ω–µ—Ç layout, gap —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è */
    }
    .album-icon:hover { transform: translateY(-2px); }

    /* –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–æ–Ω–Ω–æ–π —Å—Ç—Ä–∞–Ω–∏—Ü—ã (–ë—É–¥—É—â–∏–µ —Ä–µ–ª–∏–∑—ã) */
    #reliz-container { width: 100%; max-width: 400px; margin: 12px auto 0 auto; }
    #reliz-container iframe, #reliz-container .embed-reliz { width: 100%; border: none; }

    /* –°–ª–µ–¥—É—é—â–∞—è ‚Äî –æ–¥–Ω–∞ —Å—Ç—Ä–æ–∫–∞ —Å –∫—Ä–∞—Å–Ω—ã–º –º–Ω–æ–≥–æ—Ç–æ—á–∏–µ–º */
    .next-up { 
      display: none;
      margin: 8px 4px 0 4px; 
      font-size: .98em; 
      align-items: center; 
      gap: 6px;
    }
    .mini-mode .next-up { display: flex; }
    .next-up .label { color: #8ab8fd; opacity: .9; }
    .next-up .title { 
      color: var(--primary-color); 
      font-weight: 700; 
      white-space: nowrap; 
      overflow: hidden; 
      text-overflow: ellipsis;
      min-width: 0;            /* –≤–∞–∂–Ω–æ –¥–ª—è flex, —á—Ç–æ–±—ã —Ä–∞–±–æ—Ç–∞–ª ellipsis */
      flex: 1;
    }

    /* –ú–∏–Ω–∏‚Äë—à–∞–ø–∫–∞ —Å —Ç–µ–∫—É—â–∏–º —Ç—Ä–µ–∫–æ–º –≤ –º–∏–Ω–∏‚Äë–ø–ª–µ–µ—Ä–µ */
    .mini-now { 
      display: none; 
      align-items: center; 
      padding: 6px 8px; 
      margin: 0 0 6px 0;
      background: #0f2a3a; 
      border-radius: 8px; 
      border: 1px solid var(--border-color);
      cursor: pointer;        /* –∫–ª–∏–∫–∞–±–µ–ª—å–Ω–∞: –ø–æ –∫–ª–∏–∫—É ‚Äî –ø–µ—Ä–µ–π—Ç–∏ –≤ –∏–≥—Ä–∞—é—â–∏–π –∞–ª—å–±–æ–º */
      user-select: none;
    }
    .mini-mode .mini-now { display: flex; }
    .mini-now .tnum { min-width: 27px; color: #8ab8fd; }
    .mini-now .track-title { margin-left: 7px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; flex: 1; }
    .mini-now .like-star { margin-left: auto; width: 19px; height: 19px; cursor: pointer; opacity: .97; }

    /* –í –º–∏–Ω–∏‚Äë—Ä–µ–∂–∏–º–µ –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ –æ—Ç–∫–ª—é—á–∞–µ–º –ª—é–±—ã–µ —ç—Ñ—Ñ–µ–∫—Ç—ã –ª–∏—Ä–∏–∫–∏ (–¥–∞–∂–µ –µ—Å–ª–∏ –æ–Ω–∏ –±—ã–ª–∏ –≤–∫–ª—é—á–µ–Ω—ã) */
    .mini-mode .lyrics-animated-bg { opacity: 0 !important; animation: none !important; }
    .mini-mode #lyrics-window.animation-active .lyrics-window-line.active { animation: none !important; }

    .track.inactive { opacity: .5; filter: grayscale(60%); }
    
    /* ===== –ú–æ–¥–∞–ª–∫–∞ —Ç–µ–∫—Å—Ç–∞ –ø–µ—Å–Ω–∏ ===== */
    #lyrics-text-modal { z-index: 110; } /* –≤—ã—à–µ –æ–±—ã—á–Ω—ã—Ö –æ–∫–æ–Ω */
    #lyrics-text-modal .lyrics-modal {
      position: relative;
      /* –®–∏—Ä–∏–Ω–∞ –∑–∞–¥–∞—ë—Ç—Å—è —á–µ—Ä–µ–∑ CSS‚Äë–ø–µ—Ä–µ–º–µ–Ω–Ω—É—é –∏–∑ JS.
         –ù–∞ –º–æ–±–∏–ª—å–Ω—ã—Ö –≤—ã—Å—Ç–∞–≤–∏–º 100vw, –Ω–∞ –¥–µ—Å–∫—Ç–æ–ø–µ ‚Äî —Ä–µ–∞–ª—å–Ω–∞—è —à–∏—Ä–∏–Ω–∞ –ø–ª–µ–µ—Ä–∞. */
      width: var(--lyrics-modal-width, 100vw);
      max-width: var(--lyrics-modal-width, 100vw);
      height: min(92vh, 820px);
      background: var(--modal-bg);
      border: 1px solid rgba(255,255,255,.1);
      border-radius: 16px;
     box-shadow: 0 10px 32px rgba(0,0,0,.6);
      overflow: hidden;
      display: flex;
      flex-direction: column;
      padding: 12px;
    }

    /* –ù–∞ —É–∑–∫–∏—Ö —ç–∫—Ä–∞–Ω–∞—Ö –º–æ–¥–∞–ª–∫–∞ –≤–æ –≤—Å—é —à–∏—Ä–∏–Ω—É —ç–∫—Ä–∞–Ω–∞, —Å–∫—Ä—É–≥–ª–µ–Ω–∏—è –º–æ–∂–Ω–æ —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å */
    @media (max-width: 600px) {
      #lyrics-text-modal .lyrics-modal {
        width: 100vw;
        max-width: 100vw;
        border-radius: 16px;
      }
    }

    /* –ê–Ω–∏–º–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —Ñ–æ–Ω ‚Äî —Ç–æ—Ç –∂–µ –∫–ª–∞—Å—Å, —á—Ç–æ –∏ —É –ª–∏—Ä–∏–∫–∏ */
    #lyrics-text-modal .lyrics-animated-bg {
      position: absolute;
      inset: 0;
      opacity: .5;
      background: linear-gradient(45deg, rgba(232,1,0,0.15), rgba(77,170,255,0.15), rgba(232,1,0,0.15));
      background-size: 400% 400%;
      animation: lyricsGradient 10s ease infinite;
      pointer-events: none;
      z-index: 0;
    }

    /* –®–∞–ø–∫–∞ */
    .lyrics-modal-header {
      position: relative;
      z-index: 1;
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 4px 4px 8px 4px;
      border-bottom: 1px solid rgba(255,255,255,.08);
      background: linear-gradient(180deg, rgba(255,255,255,.03), transparent);
    }
    .lyrics-modal-title {
      font-size: 1.2rem;
     font-weight: 800;
      letter-spacing: .02em;
      color: #e7f0ff;
      flex: 1;
      overflow: hidden; white-space: nowrap; text-overflow: ellipsis;
    }
    .lyrics-modal-close {
      background: none; border: none; color: #cfe3ff; cursor: pointer;
      border-radius: 10px; width: 36px; height: 36px;
      display: inline-flex; align-items: center; justify-content: center;
      transition: transform .15s ease;
      z-index: 1;
    }
    .lyrics-modal-close:hover { transform: scale(1.05); }
    .lyrics-modal-close svg { width: 28px; height: 28px; }

    /* –ö–æ–Ω—Ç–µ–Ω—Ç —Å —Ç–µ–∫—Å—Ç–æ–º ‚Äî —Å–∫—Ä–æ–ª–ª —Ç–æ–ª—å–∫–æ –≤–Ω—É—Ç—Ä–∏! */
    .lyrics-modal-content {
      position: relative;
      z-index: 1;
     flex: 1;
      display: flex;
      min-height: 0; /* –≤–∞–∂–Ω–æ, —á—Ç–æ–±—ã flex-child –º–æ–≥ —Å–∫—Ä–æ–ª–ª–∏—Ç—å—Å—è */
      padding: 8px 4px 8px 4px;
    }
    .lyrics-modal-scroll {
      position: relative;
      flex: 1;
      min-height: 0;
      overflow: auto; /* —Ç–æ–ª—å–∫–æ –æ–±–ª–∞—Å—Ç—å —Ç–µ–∫—Å—Ç–∞ —Å–∫—Ä–æ–ª–ª–∏—Ç—Å—è */
      border-radius: 10px;
      border: 1px solid rgba(255,255,255,.08);
      background: rgba(0,0,0,.25);
      padding: 10px;
    }

    /* –°–∞–º —Ç–µ–∫—Å—Ç: –∏–∑–Ω–∞—á–∞–ª—å–Ω–æ –ë–ï–ó –ø–µ—Ä–µ–Ω–æ—Å–æ–≤, —á—Ç–æ–±—ã —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å —Å—Ç—Ä—É–∫—Ç—É—Ä—É —Å—Ç–∏—Ö–æ—Ç–≤–æ—Ä–µ–Ω–∏—è
       (–Ω–∞ —Å—Ç–∞—Ä—Ç–µ –ø–æ–¥–±–∏—Ä–∞–µ–º —Ä–∞–∑–º–µ—Ä —à—Ä–∏—Ñ—Ç–∞ –ø–æ–¥ —Å–∞–º—É—é –¥–ª–∏–Ω–Ω—É—é —Å—Ç—Ä–æ–∫—É) */
    .lyrics-modal-pre {
      margin: 0;
      color: #eef4ff;
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      font-size: 1rem;
      line-height: 1.5;
      white-space: pre;          /* –±–µ–∑ –ø–µ—Ä–µ–Ω–æ—Å–æ–≤ ‚Äî –∫–∞–∫ –ø—Ä–æ—Å–∏–ª–∏ */
      word-break: normal;
      overflow-wrap: normal;
    }

    /* –ù–∏–∑ –º–æ–¥–∞–ª–∫–∏: –¥–≤–µ –∑–æ–Ω—ã ‚Äî 1) —Ä—è–¥ —Å –ª—É–ø–∞–º–∏ –∏ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ–º; 2) –∫–Ω–æ–ø–∫–∞ ¬´–ó–∞–∫—Ä—ã—Ç—å¬ª */
    .lyrics-modal-buttons {
      position: relative;
      z-index: 1;
      display: flex;
      flex-direction: column;
      gap: 8px;
      padding: 8px 4px 4px 4px;
      border-top: 1px solid rgba(255,255,255,.08);
      background: linear-gradient(0deg, rgba(255,255,255,.03), transparent);
    }
    /* –ü–µ—Ä–≤–∞—è —Å—Ç—Ä–æ–∫–∞ ‚Äî –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ, –æ—Ç–¥–µ–ª—å–Ω–æ–π –∫–Ω–æ–ø–∫–æ–π, –±–µ–∑ –ø–µ—Ä–µ–Ω–æ—Å–æ–≤ */
    .lyrics-modal-btn.primary.bigcopy {
      width: 100%;
      font-size: 1.06rem;
      text-decoration: underline;
      color: var(--secondary-color);
      background: none;
      white-space: nowrap;
    }

    /* –í—Ç–æ—Ä–∞—è —Å—Ç—Ä–æ–∫–∞ ‚Äî —á–µ—Ç—ã—Ä–µ –æ–¥–∏–Ω–∞–∫–æ–≤—ã–µ –∫–≤–∞–¥—Ä–∞—Ç–Ω—ã–µ –∫–Ω–æ–ø–∫–∏: [-] [‚õ∂] [Share] [+] ‚Äî –≤ –æ–¥–Ω—É —Å—Ç—Ä–æ–∫—É */
    .lyrics-controls-grid {
      display: grid;
      grid-template-columns: repeat(4, 1fr); /* —á–µ—Ç—ã—Ä–µ —Ä–∞–≤–Ω—ã—Ö —Å—Ç–æ–ª–±—Ü–∞ */
      gap: 8px;
      align-items: center;
    }
    .lyrics-square-btn {
      height: 42px;
      border-radius: 10px;
      border: 1px solid rgba(255,255,255,.1);
      background: rgba(255,255,255,.1);
      color: #cfe3ff;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      transition: transform .12s ease, opacity .2s ease;
    }
    .lyrics-square-btn:hover { opacity: .95; transform: translateY(-1px); }

    .lyrics-modal-btn {
      padding: 12px 16px;
      border: none;
      border-radius: 10px;
      font-weight: 800;
      letter-spacing: .02em;
      cursor: pointer;
      color: var(--text-color);
      background: rgba(255,255,255,.12);
      transition: transform .12s ease, opacity .2s ease;
    }
    .lyrics-modal-btn.primary {
      /* ‚Äú–ö–∞–∫ —É –°–ö–û–ü–ò–†–û–í–ê–¢–¨ –¢–ï–ö–°–¢‚Äù: –¥–µ–ª–∞–µ–º —Ç—É –∂–µ —Ü–≤–µ—Ç–æ–≤—É—é –¥–æ–º–∏–Ω–∞–Ω—Ç—É, —á—Ç–æ —É —Å—Å—ã–ª–æ–∫ */
      background: none;
      color: var(--secondary-color);
      text-decoration: underline;
    }
    .lyrics-modal-btn:hover { opacity: .9; transform: translateY(-1px); }
    /* –ü–æ–ª–Ω–æ—ç–∫—Ä–∞–Ω–Ω—ã–π —Ä–µ–∂–∏–º –ø–∞–Ω–µ–ª–∏ –º–æ–¥–∞–ª–∫–∏ (—ç–ª–µ–º–µ–Ω—Ç .lyrics-modal —É—Ö–æ–¥–∏–º –≤ FS) */
    .lyrics-modal:fullscreen {
      width: 100vw !important;
      max-width: 100vw !important;
      height: 100dvh !important;
      border-radius: 0 !important;
      margin: 0 !important;
      padding: 12px !important;
    }

    /* –ö–æ–≥–¥–∞ –≤ FS ‚Äî –æ–±–ª–∞—Å—Ç—å –∫–æ–Ω—Ç–µ–Ω—Ç–∞ —Ä–∞—Å—Ç—è–≥–∏–≤–∞–µ–º –Ω–∞ –≤—Å—é –≤—ã—Å–æ—Ç—É */
    .lyrics-modal:fullscreen .lyrics-modal-content {
      flex: 1 1 auto;
    }

    /* –ö–Ω–æ–ø–∫–∞ ‚õ∂: —á—É—Ç—å –±–æ–ª—å—à–µ –∏–∫–æ–Ω–∫–∞ */
    .lyrics-square-btn svg {
      width: 22px;
      height: 22px;
    }

    /* –ö–ª–∏–∫ –ø–æ –ø–æ–¥–ª–æ–∂–∫–µ –∑–∞–∫—Ä—ã–≤–∞–µ—Ç –æ–∫–Ω–æ */
    #lyrics-text-modal.active { display: flex; }
    #lyrics-text-modal { align-items: center; justify-content: center; }
  </style>
</head>
<body>
  <!-- –ü—Ä–æ–º–æ–∫–æ–¥ -->
  <div id="promocode-block">
    <div class="promo-inner">
      <img class="promo-cover" id="promo-cover" src="img/logo.png" alt="–û–±–ª–æ–∂–∫–∞" draggable="false"/>
      <h2>–í—Ö–æ–¥ –ø–æ –ø—Ä–æ–º–æ–∫–æ–¥—É</h2>
      <input id="promo-inp" type="text" placeholder="–í–≤–µ–¥–∏—Ç–µ –ø—Ä–æ–º–æ–∫–æ–¥" autocomplete="off" autofocus />
      <button id="promo-btn" onclick="checkPromo()">–í–æ–π—Ç–∏</button>
      <div id="promo-error"></div>
    </div>
  </div>

  <div id="main-block" class="hidden">
    <header>
      <!-- –í—ã–±–æ—Ä –∞–ª—å–±–æ–º–∞ -->
      <div class="album-picker">
        <button id="album-title-button" class="album-title-button" aria-haspopup="listbox" aria-expanded="false">‚Äî</button>
        <div id="album-menu" class="album-menu" role="listbox" aria-label="–í—ã–±–æ—Ä –∞–ª—å–±–æ–º–∞"></div>
        <!-- –°–∫—Ä—ã—Ç—ã–π select –æ—Å—Ç–∞–≤–ª—è–µ–º –¥–ª—è –æ–±—Ä–∞—Ç–Ω–æ–π —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏ —Å –∫–æ–¥–æ–º -->
        <select id="album-select" aria-label="–í—ã–±–æ—Ä –∞–ª—å–±–æ–º–∞" style="display:none;"></select>
      </div>
      <div id="album-icons" class="album-icons" aria-label="–ê–ª—å–±–æ–º—ã"></div>

      <div id="cover-wrap">
        <button class="cover-gallery-arrow" id="cover-gallery-arrow-left" title="–ù–∞–∑–∞–¥" aria-label="–ü—Ä–µ–¥—ã–¥—É—â–∞—è –æ–±–ª–æ–∂–∫–∞">
          <svg width="34" height="34" viewBox="0 0 34 34"><circle cx="17" cy="17" r="16" fill="#23252e" opacity="0.65"/><polyline points="20,10 13,17 20,24" fill="none" stroke="#fff" stroke-width="2.9" stroke-linecap="round" stroke-linejoin="round"/></svg>
        </button>

        <!-- –£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–π —Å–ª–æ—Ç: —Å—é–¥–∞ –ø–æ–¥—Å—Ç–∞–≤–ª—è–µ–º <img> –∏–ª–∏ <iframe> (–¥–ª—è HTML –±–∞–Ω–Ω–µ—Ä–æ–≤) -->
        <div id="cover-slot" aria-label="–û–±–ª–æ–∂–∫–∞ –∞–ª—å–±–æ–º–∞"></div>

        <button class="cover-gallery-arrow" id="cover-gallery-arrow-right" title="–í–ø–µ—Ä—ë–¥" aria-label="–°–ª–µ–¥—É—é—â–∞—è –æ–±–ª–æ–∂–∫–∞">
          <svg width="34" height="34" viewBox="0 0 34 34"><circle cx="17" cy="17" r="16" fill="#23252e" opacity="0.65"/><polyline points="14,10 21,17 14,24" fill="none" stroke="#fff" stroke-width="2.9" stroke-linecap="round" stroke-linejoin="round"/></svg>
        </button>
      </div>

      <div id="social-links" class="socials-under-cover"></div>
    </header>

    <!-- –¢–µ–∫—É—â–∏–π –ø—Ä–æ–∏–≥—Ä—ã–≤–∞—Ç–µ–ª—å, —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –ø—Ä–∏ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–∏ –∞–ª—å–±–æ–º–∞ -->
    <div id="now-playing" style="width:100%; max-width:395px; margin:8px auto 0 auto;"></div>

    <div class="track-list" id="track-list"></div>

    <div class="bottom-controls-center">
      <button class="filter-favorites-btn" id="filter-favorites-btn" onclick="toggleFavoritesFilter()">–°–∫—Ä—ã—Ç—å –Ω–µ –æ—Ç–º–µ—á–µ–Ω–Ω—ã–µ ‚≠ê –ø–µ—Å–Ω–∏</button>
      <img class="logo-bottom" id="logo-bottom" src="img/logo.png" alt="–õ–æ–≥–æ—Ç–∏–ø" onclick="handleLogoClick()"/>

      <button id="install-pwa-btn" style="display: none;">–£–°–¢–ê–ù–û–í–ò–¢–¨ –ö–ê–ö –ü–†–ò–õ–û–ñ–ï–ù–ò–ï</button>
      <button id="download-album-main" onclick="openAlbumDownloadModal()">–°–ö–ê–ß–ê–¢–¨ –í–ï–°–¨ –ê–õ–¨–ë–û–ú</button>

      <button class="hotkeys-btn" id="hotkeys-btn" style="display:none;" onclick="showHotkeysModal()">–ì–û–†–Ø–ß–ò–ï –ö–õ–ê–í–ò–®–ò</button>
      <span class="feedback-link" id="feedback-link">–û–ë–†–ê–¢–ù–ê–Ø –°–í–Ø–ó–¨</span>
      <a class="support-link" id="support-link" href="#" target="_blank">–ü–û–î–î–ï–†–ñ–ê–¢–¨</a>
      <button class="offline-btn online" id="offline-btn" onclick="offlineUIClick()">ONLINE</button>
    </div>
  </div>

  <!-- –ú–æ–¥–∞–ª–∫–∏: –û–±—Ä–∞—Ç–Ω–∞—è —Å–≤—è–∑—å (–∑–∞–≥–ª—É—à–∫–∞) -->
  <div class="modal-bg" id="modal-feedback">
    <div class="modal-feedback" style="max-width:420px;">
      <button class="bigclose" onclick="closeFeedbackModal()" title="–ó–∞–∫—Ä—ã—Ç—å">
        <svg viewBox="0 0 48 48"><line x1="12" y1="12" x2="36" y2="36" stroke="currentColor" stroke-width="6" stroke-linecap="round"/><line x1="36" y1="12" x2="12" y2="36" stroke="currentColor" stroke-width="6" stroke-linecap="round"/></svg>
      </button>
      <div style="font-size:1.12em;font-weight:700;margin-bottom:10px;">–û–±—Ä–∞—Ç–Ω–∞—è —Å–≤—è–∑—å</div>
      <div style="color:#cfe3ff; background:rgba(255,255,255,.06); border:1px solid rgba(255,255,255,.1); border-radius:8px; padding:12px;">
        –†–∞–∑–¥–µ–ª –≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ. –ù–∞–ø–∏—à–∏—Ç–µ –Ω–∞–º –≤ Telegram: <a href="https://t.me/vitrina_razbita" target="_blank" rel="noopener">@vitrina_razbita</a>
      </div>
    </div>
  </div>

  <!-- –ú–æ–¥–∞–ª–∫–∞ —Å–∫–∞—á–∏–≤–∞–Ω–∏—è —Ç—Ä–µ–∫–∞ -->
  <div class="modal-bg" id="download-modal">
    <div class="modal-feedback" style="max-width:400px;">
      <div class="download-modal-title">–ß—Ç–æ —Å–¥–µ–ª–∞—Ç—å —Å —ç—Ç–∏–º —Ñ–∞–π–ª–æ–º?</div>
      <div style="margin-bottom:19px;font-size:.98em;" id="download-modal-filename"></div>
      <button class="offline-btn online" style="width:98%;margin-bottom:10px;" onclick="downloadCurrentTrack()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –Ω–∞ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ</button>
      <button class="offline-btn" style="width:98%;margin-bottom:10px;" onclick="shareCurrentTrack()">–ü–æ–¥–µ–ª–∏—Ç—å—Å—è —Å –¥—Ä—É–∑—å—è–º–∏</button>
      <button class="offline-btn" style="width:98%;margin-bottom:10px;" onclick="openInAppCurrentTrack()">–û—Ç–∫—Ä—ã—Ç—å –≤ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏</button>
      <button class="offline-btn" style="width:98%;margin-bottom:10px;" onclick="copyLinkCurrentTrack()">–°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å —Å—Å—ã–ª–∫—É</button>
      <button class="offline-btn" style="width:98%;margin-bottom:10px;" onclick="openAlbumDownloadModal()">–°–∫–∞—á–∞—Ç—å –≤–µ—Å—å –∞–ª—å–±–æ–º</button>
      <button class="offline-btn" style="width:98%;" onclick="closeDownloadModal()">–û—Ç–º–µ–Ω–∞</button>
    </div>
  </div>

  <!-- –ú–æ–¥–∞–ª–∫–∞ —Å–∫–∞—á–∏–≤–∞–Ω–∏—è –∞–ª—å–±–æ–º–∞ -->
  <div class="modal-bg" id="albumDownloadModal">
    <div class="modal-feedback" style="max-width: 400px;">
      <h2 style="text-align: center; margin-bottom: 25px;" id="album-title-modal">–ê–ª—å–±–æ–º</h2>
      <div class="download-options">
        <label class="checkbox-container"><input type="checkbox" id="includeCovers" checked><span class="checkmark"></span>–û–±–ª–æ–∂–∫–∏ (–≥–∞–ª–µ—Ä–µ—è)</label>
        <label class="checkbox-container"><input type="checkbox" id="includeLyrics" checked><span class="checkmark"></span>–¢–µ–∫—Å—Ç—ã –ø–µ—Å–µ–Ω</label>
        <hr style="margin: 15px 0; border-color: #333;">
        <label class="checkbox-container"><input type="checkbox" id="onlyFavorites"><span class="checkmark"></span>–¢–æ–ª—å–∫–æ –∏–∑–±—Ä–∞–Ω–Ω—ã–µ –ø–µ—Å–Ω–∏</label>
        <label class="checkbox-container"><input type="checkbox" id="fullAlbum" checked><span class="checkmark"></span>–ü–æ–ª–Ω–æ—Å—Ç—å—é –∞–ª—å–±–æ–º</label>
      </div>
      <div class="modal-buttons">
        <button onclick="closeAlbumDownloadModal()" class="btn-secondary">–û–¢–ú–ï–ù–ê</button>
        <button onclick="prepareDownload()" class="btn-primary">–°–ö–ê–ß–ê–¢–¨</button>
      </div>
    </div>
  </div>

  <!-- –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ —Ä–∞–∑–º–µ—Ä–∞ -->
  <div class="modal-bg" id="sizeConfirmModal">
    <div class="modal-feedback" style="max-width: 350px;">
      <h3 style="text-align: center;">–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –∑–∞–≥—Ä—É–∑–∫–∏</h3>
      <div class="size-info">
        <div style="font-size: 48px; color: #E80100; margin-bottom: 15px;">üì¶</div>
        <p style="font-size: 18px; margin: 10px 0;">–†–∞–∑–º–µ—Ä –∞—Ä—Ö–∏–≤–∞: <strong id="archiveSize">0 –ú–ë</strong></p>
        <p style="color: #888; font-size: 14px;">–§–∞–π–ª–æ–≤ –≤ –∞—Ä—Ö–∏–≤–µ: <span id="fileCount">0</span></p>
      </div>
      <div class="modal-buttons">
        <button onclick="closeSizeConfirmModal()" class="btn-secondary">–û–¢–ú–ï–ù–ê</button>
        <button onclick="startDownload()" class="btn-primary">–°–ö–ê–ß–ê–¢–¨</button>
      </div>
    </div>
  </div>

  <!-- –ü—Ä–æ–≥—Ä–µ—Å—Å –∞—Ä—Ö–∏–≤–∞—Ü–∏–∏ -->
  <div class="modal-bg" id="downloadProgressModal">
    <div class="modal-feedback" style="max-width: 400px;">
      <h3 style="text-align: center; margin-bottom: 20px;">–ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –∞—Ä—Ö–∏–≤–∞</h3>
      <div class="progress-bar"><div id="progressFill" class="progress-fill" style="width: 0%"></div></div>
      <p id="progressText" style="text-align: center; margin-top: 10px;">–ó–∞–≥—Ä—É–∑–∫–∞ —Ñ–∞–π–ª–æ–≤: 0/0</p>
      <div id="errorsList" style="display: none; color: #ff6b6b; font-size: 14px; margin-top: 15px;">
        <p><strong>–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å:</strong></p>
        <ul id="errorsListContent"></ul>
      </div>
    </div>
  </div>
  <!-- –ú–æ–¥–∞–ª–∫–∞ —Ç–µ–∫—Å—Ç–∞ –ø–µ—Å–Ω–∏ -->
  <div class="modal-bg" id="lyrics-text-modal">
    <div class="lyrics-modal" role="dialog" aria-modal="true" aria-labelledby="lyrics-modal-title">
      <!-- –ê–Ω–∏–º–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —Ñ–æ–Ω (–∫–∞–∫ —É –ª–∏—Ä–∏–∫–∏) -->
      <div class="lyrics-animated-bg"></div>

      <!-- –í–µ—Ä—Ö–Ω—è—è —à–∞–ø–∫–∞ c –Ω–∞–∑–≤–∞–Ω–∏–µ–º —Ç—Ä–µ–∫–∞ -->
      <div class="lyrics-modal-header">
        <div class="lyrics-modal-title" id="lyrics-modal-title">–¢—Ä–µ–∫</div>
      </div>

      <!-- –°–∫—Ä–æ–ª–ª–∏—Ä—É–µ–º–∞—è –æ–±–ª–∞—Å—Ç—å —Å —Ç–µ–∫—Å—Ç–æ–º -->
      <div class="lyrics-modal-content">
        <div class="lyrics-modal-scroll">
          <pre class="lyrics-modal-pre" id="lyrics-modal-pre"></pre>
        </div>
      </div>

      <!-- –ö–Ω–æ–ø–∫–∏ –≤–Ω–∏–∑—É -->
      <div class="lyrics-modal-buttons">

        <!-- –æ—Ç–¥–µ–ª—å–Ω–æ–π —Å—Ç—Ä–æ–∫–æ–π: –≤—Å–µ–≥–¥–∞ –≤ –æ–¥–Ω—É —Å—Ç—Ä–æ–∫—É -->
        <button class="lyrics-modal-btn primary bigcopy" type="button" onclick="copyLyricsFromModal()">–°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å –≤ –±—É—Ñ–µ—Ä –æ–±–º–µ–Ω–∞</button>

        <!-- —Å–µ—Ç–∫–∞ –∏–∑ —á–µ—Ç—ã—Ä—ë—Ö –æ–¥–∏–Ω–∞–∫–æ–≤—ã—Ö –∫–≤–∞–¥—Ä–∞—Ç–Ω—ã—Ö –∫–Ω–æ–ø–æ–∫: -, ‚õ∂, Share, + (–≤ –æ–¥–Ω–æ–π —Å—Ç—Ä–æ–∫–µ) -->
        <div class="lyrics-controls-grid">
          <!-- –£–º–µ–Ω—å—à–∏—Ç—å -->
          <button class="lyrics-square-btn" type="button" title="–£–º–µ–Ω—å—à–∏—Ç—å" aria-label="–£–º–µ–Ω—å—à–∏—Ç—å" onclick="zoomLyrics(-1)">
            <svg viewBox="0 0 24 24" fill="currentColor" aria-hidden="true">
              <path d="M15.5 14h-.79l-.28-.27A6.47 6.47 0 0016 9.5 6.5 6.5 0 109.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 5L20.49 19l-5-5zM9.5 14C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z"/>
              <rect x="7" y="9" width="5" height="1.8" rx=".9"></rect>
            </svg>
          </button>

          <!-- –ü–æ–ª–Ω–æ—ç–∫—Ä–∞–Ω–Ω—ã–π —Ä–µ–∂–∏–º -->
          <button class="lyrics-square-btn" id="lyrics-fs-btn" type="button" title="–ü–æ–ª–Ω–æ—ç–∫—Ä–∞–Ω–Ω—ã–π —Ä–µ–∂–∏–º" aria-label="–ü–æ–ª–Ω–æ—ç–∫—Ä–∞–Ω–Ω—ã–π —Ä–µ–∂–∏–º" onclick="toggleLyricsFullscreen()">
            <!-- –∏–∫–æ–Ω–∫–∞ ‚õ∂ -->
            <svg viewBox="0 0 24 24" fill="currentColor" aria-hidden="true">
              <path d="M3 10V3h7v2H5v5H3zm16-5h-5V3h7v7h-2V5zM5 19h5v2H3v-7h2v5zm16-5h2v7h-7v-2h5v-5z"/>
            </svg>
          </button>

          <!-- –ü–æ–¥–µ–ª–∏—Ç—å—Å—è -->
          <button class="lyrics-square-btn" type="button" title="–ü–æ–¥–µ–ª–∏—Ç—å—Å—è" aria-label="–ü–æ–¥–µ–ª–∏—Ç—å—Å—è" onclick="shareLyricsFromModal()">
            <svg viewBox="0 0 24 24" fill="currentColor" aria-hidden="true">
             <path d="M14 9l-4-4v3H5v2h5v3l4-4zM19 13v5H5v-5H3v7h18v-7h-2z"/>
            </svg>
          </button>

          <!-- –£–≤–µ–ª–∏—á–∏—Ç—å -->
          <button class="lyrics-square-btn" type="button" title="–£–≤–µ–ª–∏—á–∏—Ç—å" aria-label="–£–≤–µ–ª–∏—á–∏—Ç—å" onclick="zoomLyrics(1)">
            <svg viewBox="0 0 24 24" fill="currentColor" aria-hidden="true">
              <path d="M15.5 14h-.79l-.28-.27A6.47 6.47 0 0016 9.5 6.5 6.5 0 109.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 5L20.49 19l-5-5zM9.5 14C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z"/>
              <path d="M10.4 7.7h-1.8v1.8H6.8v1.8h1.8v1.8h1.8v-1.8h1.8V9.5h-1.8V7.7z"/>
            </svg>
          </button>
        </div>

        <!-- –∫–∞–∫ –±—ã–ª–æ -->
        <button class="lyrics-modal-btn" type="button" onclick="closeLyricsModal()">–ó–∞–∫—Ä—ã—Ç—å</button>
      </div>
    </div>
  </div>

  <!-- –ú–æ–¥–∞–ª–∫–∞ –≥–æ—Ä—è—á–∏—Ö –∫–ª–∞–≤–∏—à -->
  <div class="modal-bg" id="hotkeys-modal">
    <div class="modal-feedback hotkeys-modal">
      <button class="bigclose" onclick="closeHotkeysModal()" title="–ó–∞–∫—Ä—ã—Ç—å">
        <svg viewBox="0 0 48 48"><line x1="12" y1="12" x2="36" y2="36" stroke="currentColor" stroke-width="6" stroke-linecap="round"/><line x1="36" y1="12" x2="12" y2="36" stroke="currentColor" stroke-width="6" stroke-linecap="round"/></svg>
      </button>
      <h2>üìå –ì–û–†–Ø–ß–ò–ï –ö–õ–ê–í–ò–®–ò</h2>
      <div class="hotkeys-section">
        <h3>‚ñ∂Ô∏è –í–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ</h3>
        <div class="hotkey-item"><span class="hotkey-combo">K / –ü—Ä–æ–±–µ–ª</span><span class="hotkey-desc">–í–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ/–ü–∞—É–∑–∞</span></div>
        <div class="hotkey-item"><span class="hotkey-combo">X</span><span class="hotkey-desc">–°—Ç–æ–ø</span></div>
        <div class="hotkey-item"><span class="hotkey-combo">N</span><span class="hotkey-desc">–°–ª–µ–¥—É—é—â–∏–π —Ç—Ä–µ–∫</span></div>
        <div class="hotkey-item"><span class="hotkey-combo">P</span><span class="hotkey-desc">–ü—Ä–µ–¥—ã–¥—É—â–∏–π —Ç—Ä–µ–∫</span></div>
        <div class="hotkey-item"><span class="hotkey-combo">J / L</span><span class="hotkey-desc">–ü–µ—Ä–µ–º–æ—Ç–∫–∞ ‚Üê10—Å–µ–∫ / 10—Å–µ–∫‚Üí</span></div>
        <div class="hotkey-item"><span class="hotkey-combo">+ / -</span><span class="hotkey-desc">–ì—Ä–æ–º–∫–æ—Å—Ç—å ¬±10%</span></div>
      </div>
      <div class="hotkeys-section">
        <h3>üéµ –†–µ–∂–∏–º—ã</h3>
        <div class="hotkey-item"><span class="hotkey-combo">R</span><span class="hotkey-desc">–ü–æ–≤—Ç–æ—Ä</span></div>
        <div class="hotkey-item"><span class="hotkey-combo">U</span><span class="hotkey-desc">–°–ª—É—á–∞–π–Ω—ã–π –ø–æ—Ä—è–¥–æ–∫</span></div>
        <div class="hotkey-item"><span class="hotkey-combo">F</span><span class="hotkey-desc">–ò–∑–±—Ä–∞–Ω–Ω—ã–µ</span></div>
        <div class="hotkey-item"><span class="hotkey-combo">M</span><span class="hotkey-desc">–ë–µ–∑ –∑–≤—É–∫–∞</span></div>
        <div class="hotkey-item"><span class="hotkey-combo">T</span><span class="hotkey-desc">–¢–∞–π–º–µ—Ä —Å–Ω–∞</span></div>
      </div>
      <div class="hotkeys-section">
        <h3>‚ú® –≠—Ñ—Ñ–µ–∫—Ç—ã</h3>
        <div class="hotkey-item"><span class="hotkey-combo">A</span><span class="hotkey-desc">–ê–Ω–∏–º–∞—Ü–∏—è –ª–∏—Ä–∏–∫–∏</span></div>
        <div class="hotkey-item"><span class="hotkey-combo">B</span><span class="hotkey-desc">–ü—É–ª—å—Å–∞—Ü–∏—è –ª–æ–≥–æ—Ç–∏–ø–∞</span></div>
        <div class="hotkey-item"><span class="hotkey-combo">1 / 2 / 3</span><span class="hotkey-desc">–ò–Ω—Ç–µ–Ω—Å–∏–≤–Ω–æ—Å—Ç—å (100%/50%/15%)</span></div>
      </div>
      <div class="hotkeys-section">
        <h3>üì± –ò–Ω—Ç–µ—Ä—Ñ–µ–π—Å</h3>
        <div class="hotkey-item"><span class="hotkey-combo">Y</span><span class="hotkey-desc">–ü–æ–∫–∞–∑–∞—Ç—å –ª–∏—Ä–∏–∫—É</span></div>
        <div class="hotkey-item"><span class="hotkey-combo">W</span><span class="hotkey-desc">–ü–æ–∫–∞–∑–∞—Ç—å –ø–ª–µ–π–ª–∏—Å—Ç</span></div>
        <div class="hotkey-item"><span class="hotkey-combo">D</span><span class="hotkey-desc">–í –∏–∑–±—Ä–∞–Ω–Ω–æ–µ</span></div>
        <div class="hotkey-item"><span class="hotkey-combo">?</span><span class="hotkey-desc">–≠—Ç–∞ —Å–ø—Ä–∞–≤–∫–∞</span></div>
        <div class="hotkey-item"><span class="hotkey-combo">Esc</span><span class="hotkey-desc">–ó–∞–∫—Ä—ã—Ç—å –æ–∫–Ω–æ</span></div>
      </div>
    </div>
  </div>

  <!-- –ü—É—Å—Ç—ã–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã –¥–ª—è –æ—Ñ—Ñ–ª–∞–π–Ω/—É—Å—Ç–∞–Ω–æ–≤–∫–∏ (–∏—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏) -->
  <div class="modal-bg" id="modal-offline"></div>

<script>
/* ====== –í–µ—Ä—Å–∏—è –∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ ====== */
const VERSION = '7.2.0';
const BUILD_DATE = '2025-10-29';
const PROMO_CODE = 'VITRINA2025';

/* ====== –°–ø–∏—Å–æ–∫ –∞–ª—å–±–æ–º–æ–≤: fallback –Ω–∞ –≤–∞—à–∏ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–∏ ====== */
const ALBUMS_FALLBACK = [
  {
    key: 'mezhdu-zlom-i-dobrom',
    title: '–ú–µ–∂–¥—É –ó–ª–æ–º –∏ –î–æ–±—Ä–æ–º (2025)',
    base: 'https://apel-s-in.github.io/vi3na1bita-mezhdu-zlom-i-dobrom/'
  },
  {
    key: 'golos-dushi',
    title: '–ì–æ–ª–æ—Å –î—É—à–∏',
    base: 'https://apel-s-in.github.io/vi3na1bita-golos-dushi/'
  },
  {
    key: 'odnazhdi-v-skazke',
    title: '–û–¥–Ω–∞–∂–¥—ã –≤ —Å–∫–∞–∑–∫–µ',
    base: 'https://apel-s-in.github.io/vi3na1bita-odnazhdi-v-skazke/'
  },
  {
    key: 'krevetochka',
    title: '–ö—Ä–µ–≤–µ—Ç–æ—á–∫–∞',
    base: 'https://apel-s-in.github.io/krevetochka/'
  }
];

/* ====== –ì–ª–æ–±–∞–ª—å–Ω—ã–µ ====== */
let albumsIndex = [];
let currentAlbumKey = null;
let albumBase = '';
let config = null;

/* –ö–æ–Ω—Ç–µ–∫—Å—Ç —Ä–µ–∞–ª—å–Ω–æ–≥–æ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è (–Ω–µ –ø—É—Ç–∞—Ç—å —Å –ø—Ä–æ—Å–º–∞—Ç—Ä–∏–≤–∞–µ–º—ã–º –∞–ª—å–±–æ–º–æ–º) */
let playingAlbumKey = null;
let playingTracks = null;
let playingArtist = '';
let playingAlbumName = '';
let playingCover = 'img/logo.png';
let playingShuffledPlaylist = [];
let playingShuffleIndex = 0;
let playingTrack = -1; // –∏–Ω–¥–µ–∫—Å —Ç–µ–∫—É—â–µ–≥–æ –ò–ì–†–ê–Æ–©–ï–ì–û —Ç—Ä–µ–∫–∞ (–≤—Å–µ–≥–¥–∞ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞–Ω —Å currentTrack)
function isBrowsingOtherAlbum() {
  const lp = document.getElementById('lyricsplayerblock');
  if (!playingAlbumKey || !lp) return false;

  // –ï—Å–ª–∏ –º—ã —Å–º–æ—Ç—Ä–∏–º ¬´–ò–ó–ë–†–ê–ù–ù–û–ï¬ª, –º–∏–Ω–∏‚Äë—Ä–µ–∂–∏–º –Ω—É–∂–µ–Ω —Ç–æ–≥–¥–∞, –∫–æ–≥–¥–∞ –∏–≥—Ä–∞–µ—Ç –ù–ï ¬´–ò–ó–ë–†–ê–ù–ù–û–ï¬ª
  if (viewMode === 'favorites') {
    return playingAlbumKey !== SPECIAL_FAVORITES_KEY;
  }

  // –õ—é–±–æ–π –∏–Ω—Ñ–æ‚Äë—Ä–∞–∑–¥–µ–ª (–Ω–∞–ø—Ä–∏–º–µ—Ä, ¬´–ù–û–í–û–°–¢–ò¬ª) ‚Äî –≤—Å–µ–≥–¥–∞ –º–∏–Ω–∏‚Äë—Ä–µ–∂–∏–º
  if (viewMode === 'reliz') return true;

  // –û–±—ã—á–Ω—ã–π —Å–ª—É—á–∞–π: —Å–º–æ—Ç—Ä–∏–º –æ–¥–∏–Ω –∞–ª—å–±–æ–º, –∏–≥—Ä–∞–µ—Ç –¥—Ä—É–≥–æ–π
  return !!(currentAlbumKey && playingAlbumKey !== currentAlbumKey);
}

let coverGalleryArr = [];
let coverGalleryIdx = 0;
let coverAutoplay = null;

let currentTrack = -1;
let currentLyrics = [];
let autoPlayEnabled = true;
let offlineMode = false;
let offlineDownloading = false;
let deferredPrompt = null;

let shuffleMode = false;
let shuffledPlaylist = [];
let shuffleIndex = 0;
let repeatMode = false;
let favoritesOnlyMode = false;
let availableTracks = [];
let favoritesFilterActive = false;

let animationEnabled = false;
let bitEnabled = false;
let bitIntensity = 100;
let audioContext = null;
let analyser = null;
let audioSource = null;
let animationFrame = null;

let filesToDownload = [];
let __currentAudio = null;
/* –í—Ä–µ–º–µ–Ω–Ω–æ–µ —Å–∫—Ä—ã—Ç–∏–µ –ª–∏—Ä–∏–∫–∏ –ø—Ä–∏ –º–∏–Ω–∏‚Äë—Ä–µ–∂–∏–º–µ */
let __wasMini = false;
let __savedLyricsModeForMini = null;  // 'normal' | 'hidden' | 'expanded' –∏–ª–∏ null
let __savedAnimationForMini = null;    // true | false | null ‚Äî –≤—Ä–µ–º–µ–Ω–Ω–æ–µ —Ö—Ä–∞–Ω–µ–Ω–∏–µ –∞–Ω–∏–º–∞—Ü–∏–∏ –ª–∏—Ä–∏–∫–∏ –¥–ª—è –º–∏–Ω–∏‚Äë—Ä–µ–∂–∏–º–∞
/* –¢–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –≤–∏–¥–∏–º–æ—Å—Ç–∏ –≥–∞–ª–µ—Ä–µ–∏ –¥–ª—è –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ –∞–ª—å–±–æ–º–∞ (—Å–±—Ä–∞—Å—ã–≤–∞–µ—Ç—Å—è –ø—Ä–∏ –∫–∞–∂–¥–æ–º –≤—ã–±–æ—Ä–µ –Ω–æ–≤–æ–≥–æ –∞–ª—å–±–æ–º–∞) */
let __currentGalleryVisible = true;
/* ====== –ê–ª—å–±–æ–º–Ω—ã–µ –∏–∫–æ–Ω–∫–∏ / —Å–ø–µ—Ü-—Ä–µ–∂–∏–º—ã ====== */
const SPECIAL_FAVORITES_KEY = '__favorites__';
const SPECIAL_RELIZ_KEY = '__reliz__'; // –æ—Å—Ç–∞–≤–ª—è–µ–º –∫–ª—é—á —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏
let viewMode = 'album'; // 'album' | 'favorites' | 'reliz'

/* –í–∏–∑—É–∞–ª—å–Ω—ã–π —Ä—è–¥ –∏–∫–æ–Ω–æ–∫: –∫–ª—é—á–∏-¬´–ø—Å–µ–≤–¥–æ–Ω–∏–º—ã¬ª –¥–ª—è –∫—Ä–∞—Å–æ—Ç—ã, —Ä–µ–∞–ª—å–Ω—ã–µ –∫–ª—é—á–∏ —Ä–µ–∑–æ–ª–≤–∏–º –ø–æ –∞–ª–∏–∞—Å–∞–º –Ω–∏–∂–µ */
const ICON_ALBUMS_ORDER = [
  { key: SPECIAL_FAVORITES_KEY,        title: '‚≠ê‚≠ê‚≠ê–ò–ó–ë–†–ê–ù–ù–û–ï‚≠ê‚≠ê‚≠ê', icon: 'img/icon_album/icon-album-00.png' },
  { key: 'golos-dushi',                title: '–ì–æ–ª–æ—Å –î—É—à–∏',            icon: 'img/icon_album/icon-album-02.png' },
  { key: 'mezhdu-zlom-i-dobrom',       title: '–ú–µ–∂–¥—É –ó–ª–æ–º –∏ –î–æ–±—Ä–æ–º',   icon: 'img/icon_album/icon-album-01.png' },
  { key: 'krevetochka',                title: '–ö–†–ï–í–ï„ÉÑTOCHKA',         icon: 'img/icon_album/icon-album+00.png' },
  { key: SPECIAL_RELIZ_KEY,            title: '–ù–û–í–û–°–¢–ò',               icon: 'img/icon_album/icon-album-news.png' }
];

/* –ê–ª–∏–∞—Å—ã: —Å–æ–ø–æ—Å—Ç–∞–≤–ª—è–µ–º –ø—Å–µ–≤–¥–æ-–∫–ª—é—á–∏ –∏ —Ä–µ–∞–ª—å–Ω—ã–µ –∫–ª—é—á–∏ –∏–∑ albums.json */
const ICON_KEY_ALIASES = {
  'golos-dushi': ['golos', 'golos-dushi'],
  'mezhdu-zlom-i-dobrom': ['mzid', 'mezhdu-zlom-i-dobrom'],
  'odnazhdi-v-skazke': ['skazka', 'odnazhdi-v-skazke'],
  'krevetochka': ['krevetochka']
};
/* –î–ª—è –ø–æ–¥—Å—Ç—Ä–∞—Ö–æ–≤–∫–∏ ‚Äî —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ –ø—Å–µ–≤–¥–æ–∫–ª—é—á–∞ –∏ –æ–∂–∏–¥–∞–µ–º–æ–≥–æ –Ω–∞–∑–≤–∞–Ω–∏—è */
const ICON_TITLE_MAP = {
  'golos-dushi': '–ì–æ–ª–æ—Å –î—É—à–∏',
  'mezhdu-zlom-i-dobrom': '–ú–µ–∂–¥—É –ó–ª–æ–º –∏ –î–æ–±—Ä–æ–º',
  'odnazhdi-v-skazke': '–û–¥–Ω–∞–∂–¥—ã –≤ —Å–∫–∞–∑–∫–µ',
  'krevetochka': '–ö—Ä–µ–≤–µ—Ç–æ—á–∫–∞'
};

/* –†–µ–∑–æ–ª–≤–∏–º —Ä–µ–∞–ª—å–Ω—ã–π –∫–ª—é—á –∞–ª—å–±–æ–º–∞ –ø–æ–¥ –∏–∫–æ–Ω–∫–æ–π
   1) –¢–æ—á–Ω–æ–µ —Å–æ–≤–ø–∞–¥–µ–Ω–∏–µ –ø–æ –∫–ª—é—á—É
   2) –°–æ–≤–ø–∞–¥–µ–Ω–∏–µ –ø–æ –∞–ª–∏–∞—Å–∞–º
   3) –ü–æ–∏—Å–∫ –ø–æ –Ω–∞–∑–≤–∞–Ω–∏—é (–Ω–∞ –≤—Å—è–∫–∏–π —Å–ª—É—á–∞–π) */
function resolveRealAlbumKey(iconKey) {
  // 1) —Ç–æ—á–Ω–æ–µ —Å–æ–≤–ø–∞–¥–µ–Ω–∏–µ
  if (albumByKey(iconKey)) return iconKey;

  // 2) –∞–ª–∏–∞—Å—ã
  const aliases = ICON_KEY_ALIASES[iconKey] || [];
  for (const k of aliases) {
    if (albumByKey(k)) return k;
  }

  // 3) –ø–æ–∏—Å–∫ –ø–æ –Ω–∞–∑–≤–∞–Ω–∏—é
  const expectedTitle = ICON_TITLE_MAP[iconKey];
  if (expectedTitle) {
    const found = albumsIndex.find(a => String(a.title).toLowerCase().includes(expectedTitle.toLowerCase()));
    if (found) return found.key;
  }

  // 4) fallback: –ø–µ—Ä–≤—ã–π –∞–ª—å–±–æ–º (—á—Ç–æ–±—ã –Ω–µ –ø–∞–¥–∞—Ç—å), –Ω–æ –ª—É—á—à–µ –≤–µ—Ä–Ω—É—Ç—å null –∏ –æ–±—Ä–∞–±–æ—Ç–∞—Ç—å
  return null;
}

/* ====== –í–∏—Ä—Ç—É–∞–ª—å–Ω—ã–π –∞–ª—å–±–æ–º ¬´–ò–ó–ë–†–ê–ù–ù–û–ï¬ª ====== */
/* –°—Ç–∞—Ä–æ–µ favoritesModel (—Ç–æ–ª—å–∫–æ –ª–∞–π–∫–Ω—É—Ç—ã–µ) –±–æ–ª—å—à–µ –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ–º –∫–∞–∫ –±–∞–∑—É –∞–ª—å–±–æ–º–∞.
   –¢–µ–ø–µ—Ä—å —É –Ω–∞—Å ¬´–∞–ª—å–±–æ–º¬ª ‚Äî —ç—Ç–æ —Å–ø–∏—Å–æ–∫ —Å—Å—ã–ª–æ–∫ refs (–≤ —Ç.—á. –ù–ï–∞–∫—Ç–∏–≤–Ω—ã–µ —Ç—Ä–µ–∫–∏ –æ—Å—Ç–∞—é—Ç—Å—è –≤ —Å–ø–∏—Å–∫–µ),
   –∞ –¥–ª—è –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è –∏ UI —Å—Ç—Ä–æ–∏–º –ø–æ–ª–Ω—É—é –º–æ–¥–µ–ª—å favoritesRefsModel. */
let favoritesModel = null;          // –æ—Å—Ç–∞–≤–ª—è–µ–º –¥–ª—è –æ–±—Ä–∞—Ç–Ω–æ–π —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏ (–Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è —Å–ø–∏—Å–∫–∞)
let favoritesRefsModel = null;      // –ø–æ–ª–Ω–æ—Ü–µ–Ω–Ω–∞—è –º–æ–¥–µ–ª—å "–ò–ó–ë–†–ê–ù–ù–û–ï" (–≤—Å–µ refs, –≤–∫–ª—é—á–∞—è —Å–µ—Ä—ã–µ)
let favoritesShuffledPlaylist = []; // –Ω–∞ –±—É–¥—É—â–µ–µ (shuffle –¥–ª—è ¬´–ò–ó–ë–†–ê–ù–ù–û–ï¬ª)
let favoritesShuffleIndex = 0;      // –Ω–∞ –±—É–¥—É—â–µ–µ

// –ö—ç—à –∫–æ–Ω—Ñ–∏–≥–æ–≤ –∞–ª—å–±–æ–º–æ–≤ (–µ–¥–∏–Ω—ã–π –Ω–∞ –≤—Å—ë –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ)
const albumConfigCache = {}; // { albumKey: { base, config } }

/* –°–≤–æ—Ä–∞—á–∏–≤–∞–Ω–∏–µ/—Ä–∞–∑–≤–æ—Ä–∞—á–∏–≤–∞–Ω–∏–µ –≥–∞–ª–µ—Ä–µ–∏ –æ–±–ª–æ–∂–µ–∫ –ø–æ –∞–ª—å–±–æ–º–∞–º */
let coverCollapsedMap = {};
try { coverCollapsedMap = JSON.parse(localStorage.getItem('coverCollapsedMap')||'{}'); } catch { coverCollapsedMap = {}; }

/* –ü–µ—Ä—Å–∏—Å—Ç-–ª–∏—Å—Ç ‚Äú–ò–∑–±—Ä–∞–Ω–Ω–æ–≥–æ‚Äù ‚Äî –Ω–µ–∞–∫—Ç–∏–≤–Ω—ã–µ –ø–æ–∑–∏—Ü–∏–∏ —Ç–æ–∂–µ —Ö—Ä–∞–Ω—è—Ç—Å—è (—á—Ç–æ–±—ã –ø–æ–∫–∞–∑–∞—Ç—å —Å–µ—Ä—ã–º) */
const FAVORITES_REFS_KEY = 'favoritesAlbumRefs:v1'; // –º–∞—Å—Å–∏–≤ –æ–±—ä–µ–∫—Ç–æ–≤ { a: albumKey, t: trackIndex }

/* ====== –°–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å —Å–æ —Å—Ç–∞—Ä—ã–º API ¬´getPlayerConfig/playingTrack¬ª ====== */
function getPlayerConfig() {
  if (playingTracks) {
    return { tracks: playingTracks, artist: playingArtist, albumName: playingAlbumName };
  }
  return config ? { tracks: config.tracks, artist: config.artist, albumName: config.albumName } : null;
}
function getPlayerAlbumKey() { return playingAlbumKey || currentAlbumKey || null; }
function isBrowsingSameAsPlaying() { return !!(playingAlbumKey && playingAlbumKey === currentAlbumKey); }

function getLikedForAlbumKey(key) { return getLikedForAlbum(key); }
function getLikedForPlayback() { return getLikedForAlbum(playingAlbumKey); }
function isLikedInPlayback(idx) {
  if (playingAlbumKey === SPECIAL_FAVORITES_KEY) {
    const ref = favoritesRefsModel?.[idx];
    return ref ? getLikedForAlbum(ref.__a).includes(ref.__t) : false;
  }
  return getLikedForAlbum(playingAlbumKey).includes(idx);
}

/* ====== –ë–µ–∑–æ–ø–∞—Å–Ω—ã–µ URL helper'—ã (–∞–±—Å–æ–ª—é—Ç–Ω–æ–µ —Å–∫–ª–µ–∏–≤–∞–Ω–∏–µ) ====== */
function normalizeBase(b) {
  try {
    const hasScheme = /^[a-z]+:\/\//i.test(String(b));
    const u = new URL(String(b), hasScheme ? undefined : (location.origin + '/'));
    return u.origin + u.pathname.replace(/\/+$/, '');
  } catch {
    const s = String(b || '').replace(/[?#].*$/, '').replace(/\/+$/, '');
    if (/^https?:\/\//i.test(s)) return s;
    return location.origin + '/' + s.replace(/^\/+/, '');
  }
}
function absJoin(base, rel) {
  try {
    return new URL(String(rel || ''), normalizeBase(base) + '/').toString();
  } catch {
    const norm = normalizeBase(base);
    return norm + '/' + String(rel || '').replace(/^\/+/, '');
  }
}
// –†–∞—Å–ø–æ–∑–Ω–∞—ë–º —Å–æ–æ—Ç–Ω–æ—à–µ–Ω–∏–µ —Å—Ç–æ—Ä–æ–Ω –∏–∑ –∏–º–µ–Ω–∏ —Ñ–∞–π–ª–∞: ... (16x9), -16x9, _16x9 –∏ —Ç.–ø.
function parseAspectFromFileName(url) {
  try {
    const name = url.split('?')[0].split('#')[0].split('/').pop();
    const m = name.match(/(?:\(|-|_)(\d+)\s*[x:]\s*(\d+)\)?/i);
    if (m) {
      const w = parseInt(m[1], 10), h = parseInt(m[2], 10);
      if (w > 0 && h > 0) return (w / h);
    }
  } catch {}
  return 1; // –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –∫–≤–∞–¥—Ä–∞—Ç
}
/* –¶–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–∞—è –≥–∞–ª–µ—Ä–µ—è –æ–±–ª–æ–∂–µ–∫ (—É—Å–∫–æ—Ä—è–µ—Ç –æ—Ç—Ä–∏—Å–æ–≤–∫—É):
   albums/gallery/NN/NN-cover-XX.jpg|png */
const CENTRAL_GALLERY_BASE = './albums/gallery/';
const CENTRAL_GALLERY_MAX = 20; // —Å–∫–∞–Ω–∏—Ä—É–µ–º 01..20; –º–æ–∂–Ω–æ —É–≤–µ–ª–∏—á–∏—Ç—å
/* –ü–µ—Ä-–∞–ª—å–±–æ–º–Ω—ã–µ –ª–∏–º–∏—Ç—ã –≥–ª—É–±–∏–Ω—ã —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è (–¥–ª—è —É—Å–∫–æ—Ä–µ–Ω–∏—è) */
const CENTRAL_GALLERY_MAX_BY_ID = {
  'news': 6,
  'stars': 12
};
/* –ü–µ—Ä–µ–æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –ø–∞–ø–æ–∫ –≤ —Ü–µ–Ω—Ç—Ä–∞–ª—å–Ω–æ–º —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–∏:
   - krevetochka -> 00
   - –∏–∑–±—Ä–∞–Ω–Ω–æ–µ -> stars
   - –Ω–æ–≤–æ—Å—Ç–∏   -> news */
const CENTRAL_GALLERY_OVERRIDES = {
  'krevetochka': '00',
  [SPECIAL_FAVORITES_KEY]: 'stars',
  [SPECIAL_RELIZ_KEY]: 'news'
};

/* –§–ª–∞–≥–∏ –∏ –æ–∂–∏–¥–∞–Ω–∏—è –¥–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–≥–æ —Å—Ç–∞—Ä—Ç–∞ –∞–≤—Ç–æ–ø—Ä–æ–∫—Ä—É—Ç–∫–∏ */
let galleryAllLoaded = false;     // –≤—Å—è –≥–∞–ª–µ—Ä–µ—è (–≤—Å–µ —ç–ª–µ–º–µ–Ω—Ç—ã) –¥–æ–≥—Ä—É–∂–µ–Ω—ã
let galleryRotationStarted = false; // –∞–≤—Ç–æ–ø—Ä–æ–∫—Ä—É—Ç–∫–∞ –∑–∞–ø—É—â–µ–Ω–∞
function markGalleryNotReady() {
  galleryAllLoaded = false;
  galleryRotationStarted = false;
  const wrap = document.getElementById('cover-wrap');
  if (wrap) wrap.classList.remove('gallery-nav-ready');
  if (coverAutoplay) { clearInterval(coverAutoplay); coverAutoplay = null; }
}
/* –ü–ª–µ–µ—Ä —Å—á–∏—Ç–∞–µ—Ç—Å—è "–≥–æ—Ç–æ–≤", –µ—Å–ª–∏:
   - –µ—Å—Ç—å audio –∏ –æ–Ω –∏–º–µ–µ—Ç –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ (readyState>=2), –ª–∏–±–æ
   - audio –≤–æ–æ–±—â–µ –µ—â—ë –Ω–µ—Ç (—Ç–æ–≥–¥–∞ –Ω–µ –±–ª–æ–∫–∏—Ä—É–µ–º –≥–∞–ª–µ—Ä–µ—é). */
function isPlayerUiReady() {
  const a = document.getElementById('audio');
  return !a || (a.readyState >= 2);
}
/* –°—Ç–∞—Ä—Ç –∞–≤—Ç–æ–ø—Ä–æ–∫—Ä—É—Ç–∫–∏ –Ω–∞ 5 —Å–µ–∫ –ø–æ–∑–∂–µ –ø–æ–ª–Ω–æ–π –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏ */
function maybeStartCoverAutoAfterReady() {
  if (galleryRotationStarted) return;
  if (!galleryAllLoaded) return;
  if (!isPlayerUiReady()) return;
  galleryRotationStarted = true;
  setTimeout(() => {
    const wrap = document.getElementById('cover-wrap');
    if (wrap) wrap.classList.add('gallery-nav-ready'); // –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Å—Ç—Ä–µ–ª–∫–∏
    startCoverAutoPlay();
  }, 5000);
}

/* –ü–æ—Ä—è–¥–∫–æ–≤—ã–π –Ω–æ–º–µ—Ä –∞–ª—å–±–æ–º–∞ –≤ —Å–ø–∏—Å–∫–µ albumsIndex => "01","02",... */
function albumOrderIndexStr(albumKey) {
  try {
    const i = (albumsIndex || []).findIndex(a => a && a.key === albumKey);
    if (i < 0) return null;
    return String(i + 1).padStart(2, '0');
  } catch { return null; }
}
/* –ò–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä –ø–∞–ø–∫–∏ –≤ —Ü–µ–Ω—Ç—Ä–∞–ª—å–Ω–æ–π –≥–∞–ª–µ—Ä–µ–µ:
   - –µ—Å–ª–∏ –µ—Å—Ç—å override -> –±–µ—Ä—ë–º –µ–≥–æ
   - –∏–Ω–∞—á–µ -> –ø–æ—Ä—è–¥–∫–æ–≤—ã–π –Ω–æ–º–µ—Ä NN */
function centralIdForAlbumKey(albumKey) {
  if (CENTRAL_GALLERY_OVERRIDES[albumKey]) {
    return CENTRAL_GALLERY_OVERRIDES[albumKey];
  }
  return albumOrderIndexStr(albumKey); // "01","02"... –∏–ª–∏ null
}

/* –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –º–≥–Ω–æ–≤–µ–Ω–Ω–æ –∫–∞—Ä—Ç–∏–Ω–∫—É –≤ —Å–ª–æ—Ç (–±–µ–∑ –æ–∂–∏–¥–∞–Ω–∏—è –≥–∞–ª–µ—Ä–µ–∏) */
function setQuickCoverSrc(url) {
  try {
    const slot = document.getElementById('cover-slot');
    const wrap = document.getElementById('cover-wrap');
    if (!slot) return;
    slot.innerHTML = '';
    const img = new Image();
    img.decoding = 'async';
    img.loading = 'eager';
    img.referrerPolicy = 'no-referrer';
    img.alt = '–û–±–ª–æ–∂–∫–∞ –∞–ª—å–±–æ–º–∞';
    img.onload = () => {
      try {
        if (wrap && img.naturalWidth && img.naturalHeight) {
          const ar = img.naturalWidth / img.naturalHeight;
          if (isFinite(ar) && ar > 0) wrap.style.aspectRatio = String(ar);
        }
      } catch {}
      // —É–∂–µ –¥–æ–±–∞–≤–ª–µ–Ω –∏–ª–∏ –¥–æ–±–∞–≤–∏–º –Ω–∏–∂–µ
    };
    img.src = url;
    slot.appendChild(img);
  } catch {}
}

function ensureQuickCoverForAlbum(meta) {
  try {
    const base = normalizeBase(meta.base);
    const id = centralIdForAlbumKey(meta.key);
    if (id) {
      const centralJpg = `${CENTRAL_GALLERY_BASE}${id}/${id}-cover-01.jpg`;
      const centralPng = `${CENTRAL_GALLERY_BASE}${id}/${id}-cover-01.png`;
      // –°–Ω–∞—á–∞–ª–∞ –ø—Ä–æ–±—É–µ–º jpg, –µ—Å–ª–∏ –Ω–µ—Ç ‚Äî png, –µ—Å–ª–∏ –Ω–µ—Ç ‚Äî —Ñ–æ–ª–±—ç–∫ –≤ –∞–ª—å–±–æ–º
      const probe = new Image();
      probe.onload = () => setQuickCoverSrc(centralJpg);
      probe.onerror = () => {
        const probe2 = new Image();
        probe2.onload = () => setQuickCoverSrc(centralPng);
        probe2.onerror = () => ensureQuickCover(base);
        probe2.src = centralPng;
      };
      probe.src = centralJpg;
      return;
    }
    ensureQuickCover(base);
  } catch(e) {}
}
function ensureQuickCover(baseUrl) {
  try {
    const jpg = absJoin(baseUrl, 'Cover.jpg');
    const png = absJoin(baseUrl, 'Cover.png');
    const probe = new Image();
    probe.onload = () => setQuickCoverSrc(jpg);
    probe.onerror = () => setQuickCoverSrc(png);
    probe.src = jpg;
  } catch(e) {}
}
  
/* –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞–ª–∏—á–∏—è –∫–∞—Ä—Ç–∏–Ω–∫–∏ —á–µ—Ä–µ–∑ <img> */
function probeImage(url, timeout = 1200) {
  return new Promise(resolve => {
    const img = new Image();
    let done = false;
    const timer = setTimeout(() => { if (!done) { done = true; img.src = ''; resolve(false); } }, timeout);
    img.onload = () => { if (!done) { done = true; clearTimeout(timer); resolve(true); } };
    img.onerror = () => { if (!done) { done = true; clearTimeout(timer); resolve(false); } };
    img.decoding = 'async';
    img.referrerPolicy = 'no-referrer';
    img.src = url;
  });
}
/* –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞–ª–∏—á–∏—è HTML (–±–∞–Ω–Ω–µ—Ä–∞) —á–µ—Ä–µ–∑ fetch */
async function probeHtml(url, timeout = 1500) {
  const ctrl = new AbortController();
  const t = setTimeout(() => ctrl.abort(), timeout);
  try {
    const r = await fetch(url, { method: 'GET', signal: ctrl.signal, cache: 'no-cache' });
    return !!(r && (r.ok || r.status === 304));
  } catch {
    return false;
  } finally {
    clearTimeout(t);
  }
}

/* –ö–∞–Ω–¥–∏–¥–∞—Ç—ã –¥–ª—è —Ñ–∞–π–ª–æ–≤ Cover / Cover01 / ... */
function coverCandidatesShort(baseUrl, baseName) {
  return [
    absJoin(baseUrl, `${baseName}.jpg`),
    absJoin(baseUrl, `${baseName}.png`)
  ];
}
function coverCandidatesExtended(baseUrl, baseName) {
  const exts = ['jpg','png'];
  const tokens = ['16x9','9x16','3x2','2x3','4x3','3x4','1x1'];
  const urls = [];
  for (const t of tokens) {
    for (const e of exts) urls.push(absJoin(baseUrl, `${baseName}(${t}).${e}`));
    for (const e of exts) urls.push(absJoin(baseUrl, `${baseName}-${t}.${e}`));
    for (const e of exts) urls.push(absJoin(baseUrl, `${baseName}_${t}.${e}`));
  }
  return urls;
}
async function pickFirstExistingCover(baseUrl, baseName) {
  const short = coverCandidatesShort(baseUrl, baseName);
  const shortResults = await Promise.all(short.map(async u => (await probeImage(u)) ? u : null));
  const foundShort = shortResults.find(Boolean);
  if (foundShort) return foundShort;

  const ext = coverCandidatesExtended(baseUrl, baseName);
  const CONC = 4;
  for (let i = 0; i < ext.length; i += CONC) {
    const chunk = ext.slice(i, i + CONC);
    const res = await Promise.all(chunk.map(async u => (await probeImage(u, 900)) ? u : null));
    const ok = res.find(Boolean);
    if (ok) return ok;
  }
  return null;
}

/* –¶–µ–Ω—Ç—Ä–∞–ª—å–Ω–∞—è –≥–∞–ª–µ—Ä–µ—è: –∫–∞—Ä—Ç–∏–Ω–∫–∏ + HTML-–±–∞–Ω–Ω–µ—Ä—ã.
   –î–ª—è id: "00", "01"...; "stars"; "news".
   –ò—â–µ–º –ø–æ—Ä—è–¥–∫–æ–≤–æ 01..CENTRAL_GALLERY_MAX.
   –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º –∏–º–µ–Ω–∞:
   - <id>-cover-XX.jpg|png   (–∫–∞—Ä—Ç–∏–Ω–∫–∏)
   - <id>-banner-XX.html     (–±–∞–Ω–Ω–µ—Ä—ã)
   - <id>-XX-banner.html     (–∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω–æ)
   - <id>-XX-baner.html      (—Å –æ–¥–Ω–∏–º 'n', –∫–∞–∫ –≤ –ø—Ä–∏–º–µ—Ä–µ)
   –í–ê–ñ–ù–û: —á—Ç–æ–±—ã –Ω–∞—Ö–æ–¥–∏–ª–∏—Å—å –¥–∞—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã –≤–∏–¥–∞ news-01-baner-2025-10-01.html,
          –¥–æ–±–∞–≤—å—Ç–µ –¥–ª—è –Ω–∏—Ö —Å–∏–º–≤–æ–ª—å–Ω—ã–π –¥—É–±–ª–∏–∫–∞—Ç –±–µ–∑ –¥–∞—Ç—ã: news-01-baner.html (—Å–º. –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –Ω–∏–∂–µ). */
async function buildCentralGalleryList(albumKey, signal) {
  const id = centralIdForAlbumKey(albumKey);
  if (!id) return [];

  const baseDir = `${CENTRAL_GALLERY_BASE}${id}/`;

  // 0) –ë—ã—Å—Ç—Ä—ã–π –ø—É—Ç—å: –µ—Å–ª–∏ –µ—Å—Ç—å –∏–Ω–¥–µ–∫—Å (albums/gallery/<id>/index.json)
  // –§–æ—Ä–º–∞—Ç:
  // { "items": [ { "type": "img", "src": "01.jpg" }, { "type": "html", "src": "news-01-baner.html" } ] }
  try {
    const r = await fetch(baseDir + 'index.json', { cache: 'no-cache', signal });
    if (r.ok) {
      const j = await r.json();
      const items = Array.isArray(j.items) ? j.items : [];
      const mapped = items.map(it => {
        const type = (it.type === 'html') ? 'html' : 'img';
        const src = (it.src || '').match(/^https?:\/\//i) ? it.src : (baseDir + it.src.replace(/^\.?\//,''));
        return { type, src, ar: parseAspectFromFileName(it.src || '') || 1 };
      }).filter(Boolean);
      if (mapped.length) return mapped;
    }
  } catch {}

  // 1) –ú–µ–¥–ª–µ–Ω–Ω—ã–π –ø—É—Ç—å: –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω—ã–π –ø–µ—Ä–µ–±–æ—Ä
  const out = [];
  let missStreak = 0;

  const maxItems = CENTRAL_GALLERY_MAX_BY_ID[id] || CENTRAL_GALLERY_MAX;
  for (let i = 1; i <= maxItems; i++) {
    if (signal?.aborted) return out;
    const xx = String(i).padStart(2, '0');

    // images
    const jpg = `${baseDir}${id}-cover-${xx}.jpg`;
    const png = `${baseDir}${id}-cover-${xx}.png`;

    // html banners (–Ω–µ—Å–∫–æ–ª—å–∫–æ —à–∞–±–ª–æ–Ω–æ–≤)
    const bn1 = `${baseDir}${id}-banner-${xx}.html`;
    const bn2 = `${baseDir}${id}-${xx}-banner.html`;
    const bn3 = `${baseDir}${id}-${xx}-baner.html`; // ¬´baner¬ª, –∫–∞–∫ –≤ –ø—Ä–∏–º–µ—Ä–µ

    const [okJpg, okPng, okH1, okH2, okH3] = await Promise.all([
      probeImage(jpg, 1100),
      probeImage(png, 1100),
      probeHtml(bn1, 1100),
      probeHtml(bn2, 1100),
      probeHtml(bn3, 1100),
    ]);

    if (okJpg || okPng || okH1 || okH2 || okH3) {
      if (okJpg) out.push({ type: 'img', src: jpg, ar: parseAspectFromFileName(jpg) });
      else if (okPng) out.push({ type: 'img', src: png, ar: parseAspectFromFileName(png) });
      else {
        const htmlSrc = okH1 ? bn1 : okH2 ? bn2 : bn3;
        out.push({ type: 'html', src: htmlSrc, ar: 1 });
      }
      missStreak = 0;
    } else {
      missStreak++;
      if (missStreak >= 2) break; // –¥–æ—Å—Ä–æ—á–Ω–∞—è –æ—Å—Ç–∞–Ω–æ–≤–∫–∞
    }
  }
  return out;
}

/* –û–±—â–∞—è —Å–±–æ—Ä–∫–∞ –≥–∞–ª–µ—Ä–µ–∏ –¥–ª—è –∞–ª—å–±–æ–º–∞:
   1) –ø—Ä–æ–±—É–µ–º —Ü–µ–Ω—Ç—Ä–∞–ª—å–Ω–æ–µ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ (–∫–∞—Ä—Ç–∏–Ω–∫–∏/–±–∞–Ω–Ω–µ—Ä—ã)
   2) —Ñ–æ–ª–±—ç–∫ –∫ —Ñ–∞–π–ª–∞–º –∞–ª—å–±–æ–º–∞ (—Ç–æ–ª—å–∫–æ –∫–∞—Ä—Ç–∏–Ω–∫–∏) */
async function buildCoverGalleryList(albumKey, baseUrl, signal) {
  try {
    const central = await buildCentralGalleryList(albumKey, signal);
    if (!signal?.aborted && Array.isArray(central) && central.length) {
      return central;
    }
  } catch {}

  try {
    const bases = ['Cover', 'Cover01', 'Cover02', 'Cover03'];
    const picks = await Promise.all(bases.map(b => pickFirstExistingCover(baseUrl, b)));
    const gallery = [];
    for (let i = 0; i < bases.length; i++) {
      const src = picks[i];
      if (src) gallery.push({ type: 'img', src, ar: parseAspectFromFileName(src) });
    }
    return gallery;
  } catch {
    return [];
  }
}

/* –†–µ–Ω–¥–µ—Ä —Ç–µ–∫—É—â–µ–≥–æ —ç–ª–µ–º–µ–Ω—Ç–∞ –≥–∞–ª–µ—Ä–µ–∏ –≤ —Å–ª–æ—Ç */
function renderCoverItem(item) {
  const slot = document.getElementById('cover-slot');
  const wrap = document.getElementById('cover-wrap');
  if (!slot || !item) return;

  // –ê–¥–∞–ø—Ç–∏—Ä—É–µ–º aspect-ratio –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞
  if (wrap && item.ar) {
    wrap.style.aspectRatio = String(item.ar);
  }

  slot.innerHTML = '';
  if (item.type === 'html') {
    // –í—Å—Ç—Ä–∞–∏–≤–∞–µ–º –∫–∞–∫ sandbox iframe (–±–µ–∑ —Å–∫—Ä–∏–ø—Ç–æ–≤, –±–µ–∑ top-navigation)
    const ifr = document.createElement('iframe');
    ifr.setAttribute('sandbox', 'allow-scripts allow-same-origin allow-popups allow-forms');
    ifr.setAttribute('referrerpolicy', 'no-referrer');
    ifr.src = item.src;
    slot.appendChild(ifr);
  } else {
    const img = new Image();
    img.decoding = 'async';
    img.loading = 'eager';
    img.referrerPolicy = 'no-referrer';
    img.alt = '–û–±–ª–æ–∂–∫–∞ –∞–ª—å–±–æ–º–∞';
    img.src = item.src;
    slot.appendChild(img);
  }
}

/* –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ —Ç–µ–∫—É—â–µ–≥–æ —Å–ª–∞–π–¥–∞ */
function setCoverImage(idx) {
  if (!Array.isArray(coverGalleryArr) || !coverGalleryArr.length) return;
  coverGalleryIdx = (idx + coverGalleryArr.length) % coverGalleryArr.length;
  const item = coverGalleryArr[coverGalleryIdx];
  if (item) renderCoverItem(item);
}

/* –ó–∞–ø—É—Å–∫–∞–µ–º –∞–≤—Ç–æ–ø—Ä–æ–∫—Ä—É—Ç–∫—É —Ç–æ–ª—å–∫–æ –∫–æ–≥–¥–∞ maybeStartCoverAutoAfterReady() –µ—ë —Ä–∞–∑—Ä–µ—à–∏—Ç */
function startCoverAutoPlay() {
  if (coverAutoplay) clearInterval(coverAutoplay);
  coverAutoplay = setInterval(() => setCoverImage(coverGalleryIdx + 1), 5000);
}

/* –ü–æ–ª–Ω–∞—è –ø—Ä–µ–¥–∑–∞–≥—Ä—É–∑–∫–∞ –≤—Å–µ—Ö —ç–ª–µ–º–µ–Ω—Ç–æ–≤ (–∫–∞—Ä—Ç–∏–Ω–∫–∏ ‚Äî —á–µ—Ä–µ–∑ decode(), html ‚Äî GET –∫—ç—à),
   —á—Ç–æ–±—ã –∏ –∞–≤—Ç–æ, –∏ —Ä—É—á–Ω–æ–π —Ä–µ–∂–∏–º —Å—Ç–∞–ª–∏ –¥–æ—Å—Ç—É–ø–Ω—ã —Ç–æ–ª—å–∫–æ –ø–æ—Å–ª–µ –ø–æ–ª–Ω–æ–π –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏ */
async function preloadGalleryItems(items, signal) {
  const tasks = items.map(async it => {
    if (signal?.aborted) return;
    if (it.type === 'img') {
      await new Promise(resolve => {
        const im = new Image();
        im.decoding = 'async';
        im.onload = () => resolve();
        im.onerror = () => resolve(); // –Ω–µ –±–ª–æ–∫–∏—Ä—É–µ–º –∏–∑-–∑–∞ –æ–¥–Ω–æ–π –æ—à–∏–±–∫–∏
        im.src = it.src;
      });
    } else if (it.type === 'html') {
      try {
        await fetch(it.src, { cache: 'no-cache', signal });
      } catch {}
    }
  });
  await Promise.allSettled(tasks);
}

async function getAlbumConfigByKey(albumKey){
  if (albumConfigCache[albumKey]?.config) return albumConfigCache[albumKey].config;
  const meta = albumsIndex.find(a => a.key === albumKey);
  if (!meta) return null;
  const base = normalizeBase(meta.base);
  try{
    const r = await fetch(absJoin(base,'config.json'), { cache:'no-cache' });
    const data = await r.json();
    (data.tracks||[]).forEach(t=>{
      t.audio = absJoin(base, t.audio);
      t.lyrics = absJoin(base, t.lyrics);
      if (t.fulltext) t.fulltext = absJoin(base, t.fulltext);
    });
    albumConfigCache[albumKey] = { base, config: data };
    return data;
  } catch { return null; }
}

/* –°–æ–±—Ä–∞—Ç—å –≤–∏—Ä—Ç—É–∞–ª—å–Ω—ã–π –ø–ª–µ–π–ª–∏—Å—Ç ¬´–∏–∑–±—Ä–∞–Ω–Ω–æ–µ¬ª –∏–∑ –ª–∞–π–∫–æ–≤ –ø–æ –≤—Å–µ–º –∞–ª—å–±–æ–º–∞–º */
async function buildFavoritesModel(){
  // –°—Ñ–æ—Ä–º–∏—Ä—É–µ–º —Å–ø–∏—Å–æ–∫ —Å—Å—ã–ª–æ–∫ {a:albumKey, t:trackIndex}
  const refs = [];
  // –ö–∞—Ä—Ç–∞ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–∞ –∞–ª—å–±–æ–º–æ–≤: –∫–∞–∫ –≤ ICON_ALBUMS_ORDER (–±–µ–∑ —Å–ø–µ—Ü-–∫–ª—é—á–µ–π)
  const order = ICON_ALBUMS_ORDER.map(x=>x.key).filter(k => k !== SPECIAL_FAVORITES_KEY && k !== SPECIAL_RELIZ_KEY);
  const orderMap = new Map(order.map((k,i)=>[k,i]));

  for (const alb of albumsIndex) {
    const liked = getLikedForAlbum(alb.key);
    if (liked.length) {
      liked.forEach(ti => refs.push({ a: alb.key, t: ti }));
    }
  }

  // –°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞: –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–Ω—ã–µ –∞–ª—å–±–æ–º—ã -> –∏–Ω–¥–µ–∫—Å —Ç—Ä–µ–∫–∞
  refs.sort((r1, r2) => {
    const o1 = orderMap.has(r1.a) ? orderMap.get(r1.a) : 999;
    const o2 = orderMap.has(r2.a) ? orderMap.get(r2.a) : 999;
    if (o1 !== o2) return o1 - o2;
    return r1.t - r2.t;
  });

  // –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º —Å—Å—ã–ª–∫–∏ –≤ —Ä–µ–∞–ª—å–Ω—ã–µ —Ç—Ä–µ–∫‚Äë–æ–±—ä–µ–∫—Ç—ã
  const out = [];
  for (const ref of refs) {
    const cfg = await getAlbumConfigByKey(ref.a);
    const tr = cfg?.tracks?.[ref.t];
    if (!tr) continue;
    out.push({
      title: tr.title,
      audio: tr.audio,
      lyrics: tr.lyrics,
      fulltext: tr.fulltext || null,
      __a: ref.a,
      __t: ref.t,
      __artist: cfg.artist || '–í–∏—Ç—Ä–∏–Ω–∞ –†–∞–∑–±–∏—Ç–∞',
      __album: cfg.albumName || '–ê–ª—å–±–æ–º'
    });
  }

  favoritesModel = out;
  return out;
}

/* ====== –ü—Ä–æ–º–æ–∫–æ–¥ ====== */
function checkPromo() {
  const inp = document.getElementById('promo-inp');
  const err = document.getElementById('promo-error');
  const val = (inp?.value || '').trim();
  if (!val) { if (err) err.innerText = '–í–≤–µ–¥–∏—Ç–µ –ø—Ä–æ–º–æ–∫–æ–¥'; return; }
  if (val.toUpperCase() === PROMO_CODE.toUpperCase()) {
    localStorage.setItem('promoPassed', '1');
    showMain();
  } else {
    if (err) err.innerText = '–ù–µ–≤–µ—Ä–Ω—ã–π –ø—Ä–æ–º–æ–∫–æ–¥. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â—ë!';
  }
}
document.getElementById('promo-inp').addEventListener('keydown', e => { if (e.key === 'Enter') checkPromo(); });

/* ====== –£—Å—Ç—Ä–æ–π—Å—Ç–≤–∞ —Å –∫–ª–∞–≤–∏–∞—Ç—É—Ä–æ–π ====== */
function hasKeyboard() {
  try {
    const isDesktop = !/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
    const hasPointer = matchMedia('(pointer: fine)').matches;
    const canHover = matchMedia('(hover: hover)').matches;
    const noTouch = (navigator.maxTouchPoints || 0) === 0;
    return (isDesktop && hasPointer) || (canHover && noTouch);
  } catch {
    return true;
  }
}

/* ====== –ü–µ—Ä–µ—Ö–æ–¥ –∫ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—é ====== */
function showMain() {
  document.getElementById('promocode-block').classList.add('hidden');
  document.getElementById('main-block').classList.remove('hidden');
  initializeMainUi();
}

/* ====== –ê–ª—å–±–æ–º—ã ====== */
async function loadAlbumsIndex() {
  const sel = document.getElementById('album-select');
  try {
    const r = await fetch('./albums.json', { cache:'no-cache' });
    const j = await r.json();
    albumsIndex = Array.isArray(j.albums) ? j.albums : [];
    if (!albumsIndex.length) throw new Error('empty index');
  } catch(e) {
    albumsIndex = ALBUMS_FALLBACK.slice();
  }
  sel.innerHTML = albumsIndex.map(a => `<option value="${a.key}">${a.title}</option>`).join('');
  // –û–±–ª–æ–∂–∫–∞ –Ω–∞ —ç–∫—Ä–∞–Ω–µ –ø—Ä–æ–º–æ–∫–æ–¥–∞ ‚Äî –ø–µ—Ä–≤–∞—è –æ–±–ª–æ–∂–∫–∞ –ø–µ—Ä–≤–æ–≥–æ –∞–ª—å–±–æ–º–∞ (–∫–∞–∫ —Ä–∞–Ω—å—à–µ –±—ã–ª–æ Cover.png)
  const first = albumsIndex[0];
  if (first) {
    document.getElementById('promo-cover').src = absJoin(first.base, 'Cover.png');
  }
  // –†—è–¥ –∏–∫–æ–Ω–æ–∫ ‚Äî –≤—Å–µ–≥–¥–∞
  buildAlbumIcons();
  // –ü–æ–¥—Å–≤–µ—Ç–∏–º –∞–∫—Ç–∏–≤–Ω—É—é –∏–∫–æ–Ω–∫—É, –µ—Å–ª–∏ select —É–∂–µ –≤—ã–±—Ä–∞–Ω
  setActiveAlbumIcon(document.getElementById('album-select')?.value || albumsIndex[0]?.key || '');
  }
function albumByKey(key) { return albumsIndex.find(a => a.key === key) || null; }

/* –û—Ç–º–µ–Ω–∞ –ø—Ä–µ–¥—ã–¥—É—â–µ–π –∑–∞–≥—Ä—É–∑–∫–∏ –∞–ª—å–±–æ–º–∞ –ø—Ä–∏ –±—ã—Å—Ç—Ä–æ–º –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–∏ */
let __albumLoadCtrl = null;

/* –ë—ã—Å—Ç—Ä–∞—è –∑–∞–≥—Ä—É–∑–∫–∞/–æ—Ç—Ä–∏—Å–æ–≤–∫–∞ –∞–ª—å–±–æ–º–∞ —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º –∫—ç—à–∞ –∏ –º–≥–Ω–æ–≤–µ–Ω–Ω–æ–π –æ–±–ª–æ–∂–∫–æ–π */
async function loadAlbumByKey(key) {
  const meta = albumByKey(key);
  if (!meta) { NotificationSystem.error('–ê–ª—å–±–æ–º –Ω–µ –Ω–∞–π–¥–µ–Ω'); return; }

  // –ü–æ–∫–∞ –≥—Ä—É–∑–∏–º ‚Äî –∑–∞–ø—Ä–µ—â–∞–µ–º —Å—Ç—Ä–µ–ª–∫–∏/–∞–≤—Ç–æ–ø—Ä–æ–∫—Ä—É—Ç–∫—É
  markGalleryNotReady();

  currentAlbumKey = key;
  const base = normalizeBase(meta.base);
  albumBase = base;
  localStorage.setItem('currentAlbum', currentAlbumKey);

  // –û—Ç–º–µ–Ω—è–µ–º –ø—Ä–µ–¥—ã–¥—É—â—É—é –∑–∞–≥—Ä—É–∑–∫—É
  try { __albumLoadCtrl?.abort(); } catch {}
  __albumLoadCtrl = new AbortController();
  const signal = __albumLoadCtrl.signal;

  // –ë—ã—Å—Ç—Ä—ã–π quick cover: —Å–ø–µ—Ä–≤–∞ —Ü–µ–Ω—Ç—Ä–∞–ª—å–Ω–æ–µ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ, –∑–∞—Ç–µ–º —Ñ–æ–ª–±—ç–∫ –≤ –∞–ª—å–±–æ–º
  ensureQuickCoverForAlbum({ key, base });

  // –ö—ç—à –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏
  if (albumConfigCache[key]?.config) {
    const cached = albumConfigCache[key];
    await applyAlbumConfig(cached.base, cached.config, { skipCovers: true, signal });

    // –ë—ã—Å—Ç—Ä—ã–π –ø–µ—Ä–≤—ã–π –∫–∞–¥—Ä –º–≥–Ω–æ–≤–µ–Ω–Ω–æ –∏–∑ —Ü–µ–Ω—Ç—Ä–∞–ª—å–Ω–æ–≥–æ/—Ñ–æ–ª–±—ç–∫ —É–∂–µ –ø–æ—Å—Ç–∞–≤–∏–ª–∏ ensureQuickCoverForAlbum()
    // –¢–µ–ø–µ—Ä—å ‚Äî —Å–æ–±–∏—Ä–∞–µ–º –ø–æ–ª–Ω—É—é –≥–∞–ª–µ—Ä–µ—é –∏ –ø—Ä–µ–¥–∑–∞–≥—Ä—É–∂–∞–µ–º
    buildCoverGalleryList(key, base, signal).then(async gal => {
      if (signal.aborted) return;
      if (Array.isArray(gal) && gal.length) {
        coverGalleryArr = gal;
        coverGalleryIdx = 0;
        setCoverImage(coverGalleryIdx); // —Å—Ä–∞–∑—É –ø–µ—Ä–µ–∫–ª—é—á–∏–º —Å–ª–æ—Ç –Ω–∞ –ø–µ—Ä–≤—ã–π –≤–∞–ª–∏–¥–Ω—ã–π —ç–ª–µ–º–µ–Ω—Ç
        await preloadGalleryItems(coverGalleryArr, signal);
        if (signal.aborted) return;
        galleryAllLoaded = true;
        maybeStartCoverAutoAfterReady();
      } else {
        // –∂—ë—Å—Ç–∫–∏–π —Ñ–æ–ª–±—ç–∫ –Ω–∞ Cover.png
        coverGalleryArr = [{ type:'img', src: absJoin(base, 'Cover.png'), ar: 1 }];
        coverGalleryIdx = 0;
        setCoverImage(0);
        galleryAllLoaded = true;
        maybeStartCoverAutoAfterReady();
      }
    }).catch(()=>{});

    warmupOtherAlbums(key);
    return;
  }

  // –ì—Ä—É–∑–∏–º config.json
  try {
    const resp = await fetch(absJoin(base, 'config.json'), { cache: 'no-cache', signal });
    if (!resp.ok) throw new Error('HTTP ' + resp.status);
    const data = await resp.json();

    (data.tracks || []).forEach(t => {
      t.audio = absJoin(base, t.audio);
      t.lyrics = absJoin(base, t.lyrics);
      if (t.fulltext) t.fulltext = absJoin(base, t.fulltext);
    });

    albumConfigCache[key] = { base, config: data };
    await applyAlbumConfig(base, data, { skipCovers: false, signal });

    warmupOtherAlbums(key);
  } catch(e) {
    if (signal.aborted) return;
    console.error('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å config.json –∞–ª—å–±–æ–º–∞:', e);
    NotificationSystem.error('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –∞–ª—å–±–æ–º');
  } finally {
    setActiveAlbumIcon(currentAlbumKey);
    setCoverWrapVisible(__currentGalleryVisible); // –≤–∏–¥–∏–º–æ—Å—Ç—å –≥–∞–ª–µ—Ä–µ–∏ –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç—Å—è –Ω–∞—à–µ–π –ª–æ–≥–∏–∫–æ–π
  }
}

/* –ü—Ä–∏–º–µ–Ω—è–µ–º –∫–æ–Ω—Ñ–∏–≥ –∞–ª—å–±–æ–º–∞ –∫ UI (–µ–¥–∏–Ω–∞—è —Ç–æ—á–∫–∞), –æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ –ø—Ä–æ–ø—É—Å–∫–∞—è –≥–∞–ª–µ—Ä–µ—é */
async function applyAlbumConfig(base, data, { skipCovers = false, signal } = {}) {
  // –§–æ–Ω
  try {
    if (data.background) {
      document.body.style.background = `url(${absJoin(base, data.background)}) center/cover fixed #111`;
    } else {
      document.body.style.background = `#181818`;
    }
  } catch {}

  // –ì–ª–æ–±–∞–ª—å–Ω—ã–π config
  config = data;

  // –ë—ã—Å—Ç—Ä–æ –ø–æ—Å—Ç—Ä–æ–∏–º/–æ–±–Ω–æ–≤–∏–º –≥–∞–ª–µ—Ä–µ—é (–µ—Å–ª–∏ –Ω–µ –ø–æ–ø—Ä–æ—Å–∏–ª–∏ –ø—Ä–æ–ø—É—Å—Ç–∏—Ç—å)
  if (!skipCovers) {
    try {
      const gal = await buildCoverGalleryList(currentAlbumKey, base, signal);
      if (!signal?.aborted && Array.isArray(gal) && gal.length) {
        coverGalleryArr = gal;
      } else {
        coverGalleryArr = [{ src: absJoin(base, 'Cover.png'), ar: 1 }];
      }
    } catch {
      coverGalleryArr = [{ src: absJoin(base, 'Cover.png'), ar: 1 }];
    }
    if (!signal?.aborted) {
      coverGalleryIdx = 0;
      setCoverImage(coverGalleryIdx);
    }
  }

  // –°–æ—Ü—Å—Å—ã–ª–∫–∏/—Ç–∏—Ç—É–ª—ã
  try {
    document.getElementById('support-link').href = (config.donateLink || '#');
  } catch {}
  try {
    document.getElementById('album-title-modal').textContent = (config.albumName || '–ê–ª—å–±–æ–º');
  } catch {}
  buildSocials();

  // –°–æ—Ö—Ä–∞–Ω–∏–º –ø–ª–µ–µ—Ä –≤–æ –≤–Ω–µ—à–Ω–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–µ (–∫–∞–∫ –∏ —Ä–∞–Ω—å—à–µ)
  (function preservePlayer() {
    try {
      const lp = document.getElementById('lyricsplayerblock');
      const holder = document.getElementById('now-playing');
      if (lp && holder && !holder.contains(lp)) {
        holder.innerHTML = '';
        holder.appendChild(lp);
      }
    } catch {}
  })();

  // –ü–µ—Ä–µ—Ä–∏—Å–æ–≤–∫–∞ —Å–ø–∏—Å–∫–∞/—Ä–µ–∂–∏–º–æ–≤
  buildTrackList();
  updateAvailableTracks();
  applyMiniModeUI();
  updateNextUpLabel();
  updateMiniNowHeader();
  parseDeepLink();
}

/* –§–æ–Ω–æ–≤—ã–π –ø—Ä–æ–≥—Ä–µ–≤: –∫–æ–Ω—Ñ–∏–≥–∏ + –ø–µ—Ä–≤—ã–µ –æ–±–ª–æ–∂–∫–∏ –æ—Å—Ç–∞–ª—å–Ω—ã—Ö –∞–ª—å–±–æ–º–æ–≤, —á—Ç–æ–±—ã –ø–æ—Å–ª–µ–¥—É—é—â–∏–µ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è –±—ã–ª–∏ –º–≥–Ω–æ–≤–µ–Ω–Ω—ã–º–∏ */
async function warmupOtherAlbums(currentKey) {
  try {
    const rest = (albumsIndex || []).map(a => a.key).filter(k => k && k !== currentKey);
    for (const key of rest) {
      if (albumConfigCache[key]?.config) continue;
      const meta = albumByKey(key);
      if (!meta) continue;
      const base = normalizeBase(meta.base);
      // –ö–æ–Ω—Ñ–∏–≥
      try {
        const r = await fetch(absJoin(base, 'config.json'), { cache: 'force-cache' });
        if (r.ok) {
          const data = await r.json();
          (data.tracks || []).forEach(t => {
            t.audio = absJoin(base, t.audio);
            t.lyrics = absJoin(base, t.lyrics);
            if (t.fulltext) t.fulltext = absJoin(base, t.fulltext);
          });
          albumConfigCache[key] = { base, config: data };
        }
      } catch {}
      // –ü–µ—Ä–≤–∞—è –æ–±–ª–æ–∂–∫–∞ (jpg/png) ‚Äî –ø–æ–ø—Ä–æ—Å–∏–º –±—Ä–∞—É–∑–µ—Ä –∑–∞–∫–µ—à–∏—Ä–æ–≤–∞—Ç—å
      try {
        const jpg = absJoin(base, 'Cover.jpg');
        const png = absJoin(base, 'Cover.png');
        const l1 = document.createElement('link'); l1.rel = 'prefetch'; l1.as = 'image'; l1.href = jpg; document.head.appendChild(l1);
        const l2 = document.createElement('link'); l2.rel = 'prefetch'; l2.as = 'image'; l2.href = png; document.head.appendChild(l2);
      } catch {}
     // –¶–µ–Ω—Ç—Ä–∞–ª—å–Ω–∞—è –ø–µ—Ä–≤–∞—è (–µ—Å–ª–∏ –µ—Å—Ç—å override/–Ω–æ–º–µ—Ä)
     try {
       const cid = centralIdForAlbumKey(key);
       if (cid) {
         const cjpg = `${CENTRAL_GALLERY_BASE}${cid}/${cid}-cover-01.jpg`;
         const cpng = `${CENTRAL_GALLERY_BASE}${cid}/${cid}-cover-01.png`;
         const l3 = document.createElement('link'); l3.rel = 'prefetch'; l3.as = 'image'; l3.href = cjpg; document.head.appendChild(l3);
         const l4 = document.createElement('link'); l4.rel = 'prefetch'; l4.as = 'image'; l4.href = cpng; document.head.appendChild(l4);
       }
     } catch {} 
    }
  } catch {}
}

/* ====== –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è –ø–ª–µ–µ—Ä–∞ (—Å —É—á—ë—Ç–æ–º separate playback) ====== */
const PlayerState = {
  save() {
    try {
      const a = document.getElementById('audio');
      const data = {
        album: playingAlbumKey,
        trackIndex: currentTrack,
        position: a ? a.currentTime : 0,
        volume: a ? a.volume : parseFloat(localStorage.getItem('playerVolume')) || 1,
        ts: Date.now()
      };
      localStorage.setItem('playerState', JSON.stringify(data));
    } catch {}
  },
  restore() {
    try {
      const raw = localStorage.getItem('playerState'); if (!raw) return null;
      const st = JSON.parse(raw);
      if (!st || (Date.now() - (st.ts||0)) > 24*60*60*1000) return null;
      return st;
    } catch { return null; }
  }
};
setInterval(()=> {
  const a = document.getElementById('audio');
  if (a && !a.paused) PlayerState.save();
}, 5000);
window.addEventListener('beforeunload', () => PlayerState.save());
function isMobileUA() {
  try { return /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent); } catch { return false; }
}
function pickLogoUrl() {
  const dpr = window.devicePixelRatio || 1;
  const mobile = isMobileUA() || (Math.min(screen.width, screen.height) <= 820); // –ø–ª–∞–Ω—à–µ—Ç—ã –≤–∫–ª—é—á–∞–µ–º
  if (mobile) {
    return dpr >= 2 ? 'img/mobile/logo@2x.jpg' : 'img/mobile/logo@1x.jpg';
  }
  // desktop/TV
  if (dpr >= 3) return 'img/desktop/logo@3x.png';
  if (dpr >= 2) return 'img/desktop/logo@2x.png';
  return 'img/desktop/logo@1x.png';
}
function applyLogos() {
  try {
    const logoBottom = document.getElementById('logo-bottom');
    if (logoBottom) logoBottom.src = pickLogoUrl();

    const promo = document.getElementById('promo-cover');
    if (promo) promo.src = pickLogoUrl(); // –µ—Å–ª–∏ —Ö–æ—Ç–∏—Ç–µ –∑–¥–µ—Å—å –ø–æ–∫–∞–∑—ã–≤–∞—Ç—å –ª–æ–≥–æ—Ç–∏–ø; –∏–Ω–∞—á–µ –æ—Å—Ç–∞–≤—å—Ç–µ –∫–∞–∫ –µ—Å—Ç—å
  } catch {}
}

/* ====== –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è UI ====== */
async function initializeMainUi() {
  (async () => {
    await loadAlbumsIndex();

    const sel = document.getElementById('album-select');
    const params = new URLSearchParams(location.search);
    const urlAlbum = params.get('album');
    const savedAlbum = localStorage.getItem('currentAlbum');
    const first = albumsIndex[0]?.key || null;

    const toLoad = urlAlbum && albumByKey(urlAlbum) ? urlAlbum
                  : (savedAlbum && albumByKey(savedAlbum) ? savedAlbum : first);

    if (toLoad) sel.value = toLoad;

    // –ö–Ω–æ–ø–∫–∞-–∑–∞–≥–æ–ª–æ–≤–æ–∫ + –º–µ–Ω—é
    // –ù–∞—á–∞–ª—å–Ω—ã–π ¬´–∫–ª—é—á¬ª –¥–ª—è –∑–∞–≥–æ–ª–æ–≤–∫–∞: –µ—Å–ª–∏ deep-link –Ω–∞ –∏–∑–±—Ä–∞–Ω–Ω–æ–µ ‚Äî –æ—Ç—Ä–∞–∑–∏–º —ç—Ç–æ
    const startKey = (params.get('view') === 'favorites') ? SPECIAL_FAVORITES_KEY
                    : (params.get('view') === 'reliz') ? SPECIAL_RELIZ_KEY
                    : (toLoad || first);
    buildAlbumMenu(startKey);

    // —Å—Ä–∞–∑—É –ø–æ–¥—Å–≤–µ—Ç–∏–º –∞–∫—Ç–∏–≤–Ω—É—é –∏–∫–æ–Ω–∫—É –ø–æ–¥ –∑–∞–≥–æ–ª–æ–≤–∫–æ–º
    setActiveAlbumIcon(startKey === SPECIAL_FAVORITES_KEY || startKey === SPECIAL_RELIZ_KEY ? startKey : sel.value);

    sel.onchange = () => {
      viewMode = 'album';
      clearRelizView();
      document.getElementById('track-list').style.display = '';
      document.getElementById('cover-wrap').style.display = '';
      setActiveAlbumIcon(sel.value);
      // –ü—Ä–∏ –≤—ã–±–æ—Ä–µ –Ω–æ–≤–æ–≥–æ –∞–ª—å–±–æ–º–∞ –≥–∞–ª–µ—Ä–µ—è –í–°–ï–ì–î–ê –æ—Ç–∫—Ä—ã—Ç–∞
      __currentGalleryVisible = true;
      setCoverWrapVisible(true);
      loadAlbumByKey(sel.value).then(()=> {
        // –Ω–∏—á–µ–≥–æ –Ω–µ –º–µ–Ω—è–µ–º: –æ—Å—Ç–∞–≤–ª—è–µ–º –∫–∞–∫ –æ—Ç–∫—Ä—ã—Ç–æ
      });
    };

    if (localStorage.getItem('promoPassed') === '1') {
      // –ü–µ—Ä–µ—Ö–æ–¥ –Ω–∞–ø—Ä—è–º—É—é –≤ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –ø—Ä–∏ –ø–æ–≤—Ç–æ—Ä–Ω–æ–º –∑–∞–ø—É—Å–∫–µ
      document.getElementById('promocode-block').classList.add('hidden');
      document.getElementById('main-block').classList.remove('hidden');

      // –°–æ—Å—Ç–æ—è–Ω–∏—è
      try {
        shuffleMode = localStorage.getItem('shuffleMode') === '1';
        repeatMode = localStorage.getItem('repeatMode') === '1';
        favoritesOnlyMode = localStorage.getItem('favoritesOnlyMode') === '1';
        offlineMode = localStorage.getItem('offlineMode') === '1';
        animationEnabled = localStorage.getItem('animationEnabled') === '1';
        bitEnabled = localStorage.getItem('bitEnabled') === '1';
        const savedIntensity = localStorage.getItem('bitIntensity'); if (savedIntensity) bitIntensity = parseInt(savedIntensity);
      } catch {}

      await loadAlbumByKey(sel.value);

      // –§–æ–Ω–æ–≤—ã–π –ø—Ä–æ–≥—Ä–µ–≤ –æ—Å—Ç–∞–ª—å–Ω—ã—Ö –∞–ª—å–±–æ–º–æ–≤ –¥–ª—è –º–≥–Ω–æ–≤–µ–Ω–Ω–æ–≥–æ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è –≤ –±—É–¥—É—â–µ–º
      try { warmupOtherAlbums(sel.value); } catch {}

      const st = PlayerState.restore();
      if (st && st.album && albumByKey(st.album)) {
        // –ï—Å–ª–∏ —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã–π –∞–ª—å–±–æ–º –æ—Ç–ª–∏—á–∞–µ—Ç—Å—è ‚Äî —Ä–µ–∞–ª—å–Ω–æ –∑–∞–≥—Ä—É–∂–∞–µ–º –µ–≥–æ –∫–æ–Ω—Ñ–∏–≥
        if (sel.value !== st.album) {
          sel.value = st.album;
          await loadAlbumByKey(st.album);
        }
      }
      if (st && Number.isInteger(st.trackIndex) && st.trackIndex >= 0 && st.trackIndex < (config.tracks || []).length) {
        showTrack(st.trackIndex, false);
        setTimeout(()=> {
          const a = document.getElementById('audio');
          if (a) {
            a.currentTime = st.position || 0;
            a.volume = (typeof st.volume === 'number') ? st.volume : a.volume;
          }
          applyLyricsViewMode();
          // –°—Ä–∞–∑—É –∑–∞—Ñ–∏–∫—Å–∏—Ä—É–µ–º –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ
          PlayerState.save();
        }, 300);
      }
    }

    // –ì–∞–ª–µ—Ä–µ—è
    document.getElementById('cover-gallery-arrow-left').onclick = () => {
      if (!galleryAllLoaded) return;
      setCoverImage(coverGalleryIdx - 1);
      startCoverAutoPlay();
    };
    document.getElementById('cover-gallery-arrow-right').onclick = () => {
      if (!galleryAllLoaded) return;
      setCoverImage(coverGalleryIdx + 1);
      startCoverAutoPlay();
    };
    let startX = null;
    const el = document.getElementById('cover-wrap');
    el.addEventListener('touchstart', e => { startX = e.touches[0].clientX; });
    el.addEventListener('touchend', e => {
      if (startX === null) return;
      const dx = e.changedTouches[0].clientX - startX;
      if (Math.abs(dx) > 30) {
        if (!galleryAllLoaded) { startX = null; return; }
        if (dx > 0) setCoverImage(coverGalleryIdx - 1); else setCoverImage(coverGalleryIdx + 1);
        startCoverAutoPlay();
      }
      startX = null;
    });
    // –ê–≤—Ç–æ–ø—Ä–æ–∫—Ä—É—Ç–∫–∞ –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ —á–µ—Ä–µ–∑ maybeStartCoverAutoAfterReady()
    // –•–æ—Ç–∫–µ–∏
    if (hasKeyboard()) {
      const hot = document.getElementById('hotkeys-btn');
      if (hot) hot.style.display = 'block';
    }

    // –û–±—Ä–∞—Ç–Ω–∞—è —Å–≤—è–∑—å (–∑–∞–≥–ª—É—à–∫–∞)
    document.getElementById('feedback-link').onclick = openFeedbackModal;
    document.getElementById('modal-feedback').onclick = (e) => { if (e.target === e.currentTarget) closeFeedbackModal(); };

    // PWA install
    window.addEventListener('beforeinstallprompt', (e) => {
      e.preventDefault();
      deferredPrompt = e;
      const btn = document.getElementById('install-pwa-btn');
      if (btn) btn.style.display = '';
    });
    document.getElementById('install-pwa-btn').onclick = async () => {
      if (deferredPrompt) {
        deferredPrompt.prompt();
        deferredPrompt.userChoice.finally(() => {
          document.getElementById('install-pwa-btn').style.display = 'none';
          deferredPrompt = null;
        });
      } else {
        NotificationSystem.info('–í–∞—à –±—Ä–∞—É–∑–µ—Ä –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç —É—Å—Ç–∞–Ω–æ–≤–∫—É PWA');
      }
    };

    detectIOSAndShowInstallGuide();

    // Service Worker
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('./service-worker.js').then(async reg => {
        await navigator.serviceWorker.ready;
        syncOfflineState();
        try { reg.active && reg.active.postMessage({ type: 'REQUEST_OFFLINE_STATE' }); } catch(e){}
        try { reg.update(); } catch(e) {}
        setInterval(async () => {
          try { const r = await navigator.serviceWorker.getRegistration(); if (r) r.update(); } catch(e) {}
        }, 60 * 60 * 1000);
      });

      let __swReloaded = false;
      navigator.serviceWorker.addEventListener('controllerchange', () => {
        if (__swReloaded) return;
        __swReloaded = true;
        NotificationSystem.info('–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø—Ä–∏–º–µ–Ω–µ–Ω–æ, –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∞...');
        setTimeout(() => location.reload(), 300);
      });

      navigator.serviceWorker.addEventListener('message', event => {
        const msg = event.data || {};
        if (msg.type === 'OFFLINE_STATE') {
          offlineMode = !!msg.value;
          setOfflineUIState(offlineMode ? 'offline' : 'online');
        }
      });
    }

    document.addEventListener('visibilitychange', () => { if (!document.hidden) checkSleepTimer(); });
    window.addEventListener('focus', checkSleepTimer);

    window.addEventListener('online', () => NotificationSystem.success('–°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ'));
    window.addEventListener('offline', () => NotificationSystem.offline('–ù–µ—Ç —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è —Å –∏–Ω—Ç–µ—Ä–Ω–µ—Ç–æ–º'));
  })();
}
async function openRelizView(){
  // ¬´–ù–æ–≤–æ—Å—Ç–∏¬ª ‚Äî –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Ü–µ–Ω—Ç—Ä–∞–ª—å–Ω—É—é –≥–∞–ª–µ—Ä–µ—é (–ø–∞–ø–∫–∞ albums/gallery/news),
  // –∞ —Å–ø–∏—Å–æ–∫ —Ç—Ä–µ–∫–æ–≤ —Å–∫—Ä—ã–≤–∞–µ–º.
  viewMode = 'reliz';
  setActiveAlbumIcon(SPECIAL_RELIZ_KEY);

  // UI
  const list = document.getElementById('track-list');
  const cw = document.getElementById('cover-wrap');
  if (list) list.style.display = 'none';
  if (cw) cw.style.display = '';

  // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –≥–∞–ª–µ—Ä–µ–∏ –∏ —Å—Ç—Ä–µ–ª–æ–∫
  markGalleryNotReady();
  __currentGalleryVisible = true;
  setCoverWrapVisible(true);

  // –£–±–∏—Ä–∞–µ–º –≤–æ–∑–º–æ–∂–Ω—ã–π –≤—Å—Ç—Ä–æ–µ–Ω–Ω—ã–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä ¬´—Ä–µ–ª–∏–∑–æ–≤¬ª, –µ—Å–ª–∏ –±—ã–ª
  clearRelizView();

  // –°–±–æ—Ä–∫–∞ —Ü–µ–Ω—Ç—Ä–∞–ª—å–Ω–æ–π –≥–∞–ª–µ—Ä–µ–∏: SPECIAL_RELIZ_KEY => 'news'
  try {
    // –ë—ã—Å—Ç—Ä–æ –ø–æ–¥—Å—Ç–∞–≤–∏–º ¬´–∫–≤–∞–∑–∏-–∫—Ä—ã—à–∫—É¬ª, –µ—Å–ª–∏ –µ—Å—Ç—å –∫–∞—Ä—Ç–∏–Ω–∫–∞:
    // –¥–ª—è news —Å–∫–æ—Ä–µ–µ –≤—Å–µ–≥–æ –ø–µ—Ä–≤—ã–π —ç–ª–µ–º–µ–Ω—Ç ‚Äî HTML –±–∞–Ω–Ω–µ—Ä,
    // –ø–æ—ç—Ç–æ–º—É quick cover –º–æ–∂–µ—Ç –Ω–µ —Å—Ä–∞–±–æ—Ç–∞—Ç—å (—ç—Ç–æ –Ω–æ—Ä–º–∞–ª—å–Ω–æ).
    ensureQuickCoverForAlbum({ key: SPECIAL_RELIZ_KEY, base: location.origin + location.pathname });

    // –°–æ–±–∏—Ä–∞–µ–º —Å–ø–∏—Å–æ–∫ —ç–ª–µ–º–µ–Ω—Ç–æ–≤ –≥–∞–ª–µ—Ä–µ–∏
    const ctrl = new AbortController();
    __albumLoadCtrl = ctrl; // –ø–µ—Ä–µ–∏—Å–ø–æ–ª—å–∑—É–µ–º –æ–±—â–∏–π –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä –æ—Ç–º–µ–Ω—ã
    const signal = ctrl.signal;

    const gal = await buildCoverGalleryList(SPECIAL_RELIZ_KEY, location.origin + location.pathname, signal);

    if (signal.aborted) return;
    if (Array.isArray(gal) && gal.length) {
      coverGalleryArr = gal;
      coverGalleryIdx = 0;
      setCoverImage(coverGalleryIdx);
      await preloadGalleryItems(coverGalleryArr, signal);
      if (signal.aborted) return;
      galleryAllLoaded = true;
      maybeStartCoverAutoAfterReady();
    } else {
      // –ù–µ—Ç —ç–ª–µ–º–µ–Ω—Ç–æ–≤ –≤ –ø–∞–ø–∫–µ ‚Äî –ø–æ—Å—Ç–∞–≤–∏–º –ª–æ–≥–æ—Ç–∏–ø
      coverGalleryArr = [{ type:'img', src: 'img/logo.png', ar: 1 }];
      coverGalleryIdx = 0;
      setCoverImage(0);
      galleryAllLoaded = true;
      maybeStartCoverAutoAfterReady();
    }
  } catch (e) {
    console.error('–ù–æ–≤–æ—Å—Ç–∏: –Ω–µ —É–¥–∞–ª–æ—Å—å —Å–æ–±—Ä–∞—Ç—å –≥–∞–ª–µ—Ä–µ—é', e);
    coverGalleryArr = [{ type:'img', src: 'img/logo.png', ar: 1 }];
    coverGalleryIdx = 0;
    setCoverImage(0);
    galleryAllLoaded = true;
    maybeStartCoverAutoAfterReady();
  }

  // –ú–∏–Ω–∏-—Ä–µ–∂–∏–º ‚Äî –≤–∫–ª—é—á–∏—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏, —Ç–∞–∫ –∫–∞–∫ –º—ã –ø—Ä–æ—Å–º–∞—Ç—Ä–∏–≤–∞–µ–º –ù–ï –∏–≥—Ä–∞—é—â–∏–π –∞–ª—å–±–æ–º/—Ä–µ–∂–∏–º
  applyMiniModeUI();
}

function clearRelizView(){
  const cont = document.getElementById('reliz-container');
  if (cont) cont.remove();
}
function readFavoritesRefs(){
  try { const raw = localStorage.getItem(FAVORITES_REFS_KEY); const arr = raw ? JSON.parse(raw) : []; return Array.isArray(arr)?arr:[]; } catch { return []; }
}
function writeFavoritesRefs(arr){
  try { localStorage.setItem(FAVORITES_REFS_KEY, JSON.stringify(arr)); } catch {}
}
function ensureFavoritesRefsWithLikes(){
  // –î–æ–±–∞–≤–ª—è–µ–º –≤ refs –≤—Å–µ —Ä–µ–∞–ª—å–Ω–æ –ª–∞–π–∫–Ω—É—Ç—ã–µ —Ç—Ä–µ–∫–∏, —Å–æ—Ö—Ä–∞–Ω—è—è —É–Ω–∏–∫–∞–ª—å–Ω–æ—Å—Ç—å
  const refs = readFavoritesRefs();
  const keySet = new Set(refs.map(x=>`${x.a}:${x.t}`));
  for (const alb of albumsIndex) {
    const liked = getLikedForAlbum(alb.key);
    liked.forEach(ti=>{
      const k = `${alb.key}:${ti}`;
      if (!keySet.has(k)) { refs.push({ a: alb.key, t: ti }); keySet.add(k); }
    });
  }
  writeFavoritesRefs(refs);
  return refs;
}
/* –û—Ç—Å–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å refs —Ç–∞–∫ –∂–µ, –∫–∞–∫ –º—ã –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∏—Ö –≤ UI (–ø–æ –ø–æ—Ä—è–¥–∫—É ICON_ALBUMS_ORDER, –∑–∞—Ç–µ–º –ø–æ –∏–Ω–¥–µ–∫—Å—É) */
function getSortedFavoritesRefs() {
  const refs = ensureFavoritesRefsWithLikes().slice();
  const order = ICON_ALBUMS_ORDER.map(x=>x.key).filter(k=>k!==SPECIAL_FAVORITES_KEY && k!==SPECIAL_RELIZ_KEY);
  const orderMap = new Map(order.map((k,i)=>[k,i]));
  refs.sort((r1,r2)=>{
    const o1 = orderMap.has(r1.a) ? orderMap.get(r1.a) : 999;
    const o2 = orderMap.has(r2.a) ? orderMap.get(r2.a) : 999;
    if (o1 !== o2) return o1 - o2;
    return (r1.t - r2.t);
  });
  return refs;
}

/* –ü–æ—Å—Ç—Ä–æ–∏—Ç—å –ø–æ–ª–Ω—É—é –º–æ–¥–µ–ª—å ¬´–ò–ó–ë–†–ê–ù–ù–û–ï¬ª –Ω–∞ –æ—Å–Ω–æ–≤–µ refs:
   –∫–∞–∂–¥–∞—è –∑–∞–ø–∏—Å—å —Å–æ–¥–µ—Ä–∂–∏—Ç: –∞—É–¥–∏–æ/–ª–∏—Ä–∏–∫—É/—Ñ—É–ª–ª—Ç–µ–∫—Å—Ç + –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ + —Ñ–ª–∞–≥ __active (–µ—Å—Ç—å –ª–∏ –∂—ë–ª—Ç–∞—è –∑–≤–µ–∑–¥–∞ —Å–µ–π—á–∞—Å) */
async function buildFavoritesRefsModel() {
  const sortedRefs = getSortedFavoritesRefs();
  const out = [];
  for (const ref of sortedRefs) {
    const cfg = await getAlbumConfigByKey(ref.a);
    const tr = cfg?.tracks?.[ref.t];
    if (!tr) continue;
    const active = getLikedForAlbum(ref.a).includes(ref.t);
    out.push({
      title: tr.title,
      audio: tr.audio,
      lyrics: tr.lyrics,
      fulltext: tr.fulltext || null,
      __a: ref.a,                // –∏—Å—Ö–æ–¥–Ω—ã–π –∞–ª—å–±–æ–º
      __t: ref.t,                // –∏–Ω–¥–µ–∫—Å —Ç—Ä–µ–∫–∞ –≤ –∏—Å—Ö–æ–¥–Ω–æ–º –∞–ª—å–±–æ–º–µ
      __artist: cfg.artist || '–í–∏—Ç—Ä–∏–Ω–∞ –†–∞–∑–±–∏—Ç–∞',
      __album: cfg.albumName || '–ê–ª—å–±–æ–º',
      __active: active           // –µ—Å—Ç—å –ª–∏ –ª–∞–π–∫ (–∂—ë–ª—Ç–∞—è –∑–≤–µ–∑–¥–∞) —Å–µ–π—á–∞—Å
    });
  }
  favoritesRefsModel = out;
  return out;
}

/* –£—Ç–∏–ª–∏—Ç–∞: –æ–±–Ω–æ–≤–∏—Ç—å —Ñ–ª–∞–≥ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ –≤ favoritesRefsModel –¥–ª—è –∑–∞–¥–∞–Ω–Ω–æ–≥–æ ref */
function updateFavoritesRefsModelActiveFlag(albumKey, trackIndex, isActive) {
  if (!Array.isArray(favoritesRefsModel)) return;
  const item = favoritesRefsModel.find(x => x.__a === albumKey && x.__t === trackIndex);
  if (item) item.__active = !!isActive;
}

async function openFavoritesView(){
  viewMode = 'favorites';
  clearRelizView();
  setActiveAlbumIcon(SPECIAL_FAVORITES_KEY);

  // 0) –°–æ—Ö—Ä–∞–Ω–∏–º –ø–ª–µ–µ—Ä: –µ—Å–ª–∏ –æ–Ω –±—ã–ª –ø–æ–¥ —Ç—Ä–µ–∫–æ–º –æ–±—ã—á–Ω–æ–≥–æ –∞–ª—å–±–æ–º–∞, –ø–µ—Ä–µ–Ω–µ—Å—ë–º –≤ now-playing,
  // —á—Ç–æ–±—ã –º—ã –Ω–µ —É–¥–∞–ª–∏–ª–∏ –µ–≥–æ –≤–º–µ—Å—Ç–µ —Å–æ —Å–ø–∏—Å–∫–æ–º.
  try {
    const lp = document.getElementById('lyricsplayerblock');
    const holder = document.getElementById('now-playing');
    if (lp && holder && !holder.contains(lp)) {
      holder.innerHTML = '';
      holder.appendChild(lp);
    }
  } catch {}

  // –í–ê–ñ–ù–û: —Å—Ä–∞–∑—É –ø—Ä–∏–º–µ–Ω–∏–º –º–∏–Ω–∏‚Äë—Ä–µ–∂–∏–º. –ò–≥—Ä–∞–µ—Ç —Ä–µ–∞–ª—å–Ω—ã–π –∞–ª—å–±–æ–º, –∞ –º—ã —Å–º–æ—Ç—Ä–∏–º ¬´–ò–ó–ë–†–ê–ù–ù–û–ï¬ª ‚Äî –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –º–∏–Ω–∏‚Äë—Ä–µ–∂–∏–º.
  applyMiniModeUI();

  // 1) —Å–∫—Ä—ã–≤–∞–µ–º –æ–±–ª–æ–∂–∫—É (—É ¬´–ò–ó–ë–†–ê–ù–ù–û–ì–û¬ª –Ω–µ—Ç —Å–æ–±—Å—Ç–≤–µ–Ω–Ω–æ–π)
  const cw = document.getElementById('cover-wrap'); if (cw) cw.style.display = 'none';

  // 2) –°—Ç—Ä–æ–∏–º –º–æ–¥–µ–ª—å –ò–ó–ë–†–ê–ù–ù–û–ì–û (–≤—Å–µ refs, –≤–∫–ª—é—á–∞—è –Ω–µ–∞–∫—Ç–∏–≤–Ω—ã–µ)
  await buildFavoritesRefsModel();

  // 3) –†–µ–Ω–¥–µ—Ä–∏–º —Å–ø–∏—Å–æ–∫
  const list = document.getElementById('track-list');
  list.style.display = '';
  list.innerHTML = '<div style="text-align:center; opacity:.8; margin:6px 0 8px 0;">–ò–ó–ë–†–ê–ù–ù–´–ï –ü–ï–°–ù–ò</div>';

  (favoritesRefsModel || []).forEach((item, idx) => {
    const n = String(idx + 1).padStart(2,'0');
    const row = document.createElement('div');
    row.className = 'track' + (item.__active ? '' : ' inactive');
    row.id = `fav_${item.__a}_${item.__t}`;
    row.innerHTML = `
      <span class="tnum">${n}.</span>
      <span class="track-title" title="${item.title} ‚Äî ${item.__album}">
        ${item.title} <span style="opacity:.6;font-size:.9em;">‚Äî ${item.__album}</span>
      </span>
      <img src="${item.__active ? 'img/star.png' : 'img/star2.png'}" class="like-star" alt="–∑–≤–µ–∑–¥–∞"
           title="${item.__active ? '–°–Ω—è—Ç—å –∏–∑ –∏–∑–±—Ä–∞–Ω–Ω–æ–≥–æ' : '–í–µ—Ä–Ω—É—Ç—å –≤ –∏–∑–±—Ä–∞–Ω–Ω–æ–µ'}">
    `;

    // –ö–ª–∏–∫ –ø–æ —Å—Ç—Ä–æ–∫–µ
    row.addEventListener('click', async ()=>{
      if (item.__active) {
        ensureFavoritesPlayback(idx);
      } else {
        showFavInactivePrompt({ a: item.__a, t: item.__t, title: item.title, album: item.__album });
      }
    });

    // –ö–ª–∏–∫ –ø–æ –∑–≤–µ–∑–¥–µ ‚Äî –ø–µ—Ä–µ–∫–ª—é—á–∞–µ–º –ª–∞–π–∫ –∏ –∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä—É–µ–º –æ—á–µ—Ä–µ–¥—å –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è
    row.querySelector('.like-star').addEventListener('click', (e)=>{
      e.stopPropagation();
      const wasActive = getLikedForAlbum(item.__a).includes(item.__t);

      toggleLikeForAlbum(item.__a, item.__t, !wasActive);
      updateFavRow({a:item.__a,t:item.__t}, !wasActive);
      updateFavoritesRefsModelActiveFlag(item.__a, item.__t, !wasActive);

      // –ï—Å–ª–∏ —Å–µ–π—á–∞—Å –∏–≥—Ä–∞–µ—Ç –ò–ó–ë–†–ê–ù–ù–û–ï ‚Äî –ø–µ—Ä–µ—Å—Ç—Ä–æ–∏–º –æ—á–µ—Ä–µ–¥—å, –∞ –µ—Å–ª–∏ —Å–Ω—è–ª–∏ –ª–∞–π–∫ —É —Ç–µ–∫—É—â–µ–≥–æ ‚Äî –ø–µ—Ä–µ–π–¥—ë–º –∫ —Å–ª–µ–¥—É—é—â–µ–º—É
      if (playingAlbumKey === SPECIAL_FAVORITES_KEY && Array.isArray(playingTracks)) {
        // –°–Ω—è–ª–∏ –ª–∞–π–∫
        if (wasActive) {
          if (favoritesRefsModel && favoritesRefsModel[playingTrack] &&
              favoritesRefsModel[playingTrack].__a === item.__a &&
              favoritesRefsModel[playingTrack].__t === item.__t) {
            // –°–Ω—è–ª–∏ –ª–∞–π–∫ —É —Ç–µ–∫—É—â–µ–≥–æ —Ç—Ä–µ–∫–∞ ‚Äî –Ω–µ–º–µ–¥–ª–µ–Ω–Ω–æ –ø—Ä–µ—Ä—ã–≤–∞–µ–º –∏ –∏–¥—ë–º –∫ —Å–ª–µ–¥—É—é—â–µ–º—É
            createPlayingShuffledPlaylist();
            nextTrack();
          } else {
            // –°–Ω—è–ª–∏ –ª–∞–π–∫ —É –¥—Ä—É–≥–æ–≥–æ —Ç—Ä–µ–∫–∞ ‚Äî –ø–µ—Ä–µ—Å—Ç—Ä–æ–∏–º –æ—á–µ—Ä–µ–¥—å
            createPlayingShuffledPlaylist();
            updateNextUpLabel();
          }
          NotificationSystem.info('–¢—Ä–µ–∫ —Å–Ω—è—Ç –∏–∑ –∏–∑–±—Ä–∞–Ω–Ω–æ–≥–æ');
        } else {
          // –ü–æ—Å—Ç–∞–≤–∏–ª–∏ –ª–∞–π–∫ ‚Äî –ø–µ—Ä–µ—Å—Ç—Ä–æ–∏–º –æ—á–µ—Ä–µ–¥—å
          createPlayingShuffledPlaylist();
          updateNextUpLabel();
          NotificationSystem.success('–¢—Ä–µ–∫ –≤–æ–∑–≤—Ä–∞—â—ë–Ω –≤ –∏–∑–±—Ä–∞–Ω–Ω–æ–µ');
        }
      } else {
        // –ù–µ –∏–≥—Ä–∞–µ—Ç –ò–ó–ë–†–ê–ù–ù–û–ï ‚Äî –ø—Ä–æ—Å—Ç–æ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
        if (wasActive) NotificationSystem.info('–¢—Ä–µ–∫ —Å–Ω—è—Ç –∏–∑ –∏–∑–±—Ä–∞–Ω–Ω–æ–≥–æ');
        else NotificationSystem.success('–¢—Ä–µ–∫ –≤–æ–∑–≤—Ä–∞—â—ë–Ω –≤ –∏–∑–±—Ä–∞–Ω–Ω–æ–µ');
      }
    });

    list.appendChild(row);
  });

  // 4) –ï—Å–ª–∏ —É–∂–µ –∏–≥—Ä–∞–µ—Ç –ò–ó–ë–†–ê–ù–ù–û–ï ‚Äî –ø–æ–¥—Å–≤–µ—Ç–∏–º —Ç–µ–∫—É—â—É—é —Å—Ç—Ä–æ–∫—É –∏ –ø–µ—Ä–µ–º–µ—Å—Ç–∏–º –ø–ª–µ–µ—Ä –ø–æ–¥ –Ω–µ—ë.
  if (playingAlbumKey === SPECIAL_FAVORITES_KEY && typeof playingTrack === 'number' && playingTrack >= 0) {
    updateFavoritesCurrentRow(playingTrack);
    // –ü–µ—Ä–µ–º–µ—Å—Ç–∏–º #lyricsplayerblock –ø–æ–¥ —Ç–µ–∫—É—â—É—é —Å—Ç—Ä–æ–∫—É
    const listTracks = Array.from(document.querySelectorAll('#track-list .track'));
    const rowUnder = listTracks[playingTrack];
    const lp = document.getElementById('lyricsplayerblock');
    if (rowUnder && lp && rowUnder.parentNode) {
      if (rowUnder.nextSibling) rowUnder.parentNode.insertBefore(lp, rowUnder.nextSibling);
      else rowUnder.parentNode.appendChild(lp);
    }
  }

  // 5) –ü–µ—Ä–µ–≤–æ–¥–∏–º –ø–ª–µ–µ—Ä –≤ (–Ω–µ)–º–∏–Ω–∏‚Äë—Ä–µ–∂–∏–º –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞
  applyMiniModeUI();

  // 6) –§–∏–ª—å—Ç—Ä —Å–ø–∏—Å–∫–∞ ¬´–ø–æ –∑–≤—ë–∑–¥–∞–º¬ª –≤—ã–∫–ª—é—á–∞–µ–º –ø—Ä–∏ –≤—Ö–æ–¥–µ
  list.classList.remove('filtered');
}

async function ensureFavoritesPlayback(startIndex){
  // 1) –°—Ç—Ä–æ–∏–º –º–æ–¥–µ–ª—å –ò–ó–ë–†–ê–ù–ù–û–ì–û (–µ—Å–ª–∏ –µ—â—ë –Ω–µ—Ç)
  if (!Array.isArray(favoritesRefsModel)) await buildFavoritesRefsModel();
  if (!favoritesRefsModel || favoritesRefsModel.length === 0) {
    NotificationSystem.warning('–í –∏–∑–±—Ä–∞–Ω–Ω–æ–º –Ω–µ—Ç —Ç—Ä–µ–∫–æ–≤');
    return;
  }
  const idx = Math.max(0, Math.min(startIndex|0, favoritesRefsModel.length-1));

  // 2) –ó–∞—Ñ–∏–∫—Å–∏—Ä—É–µ–º –∫–æ–Ω—Ç–µ–∫—Å—Ç ¬´–∏–≥—Ä–∞—é—â–µ–≥–æ¬ª –∞–ª—å–±–æ–º–∞ –∫–∞–∫ –ò–ó–ë–†–ê–ù–ù–û–ï (–ø–æ–ª–Ω–æ—Ü–µ–Ω–Ω—ã–π –∞–ª—å–±–æ–º)
  playingAlbumKey = SPECIAL_FAVORITES_KEY;
  playingTracks = favoritesRefsModel;
  playingArtist = '–í–∏—Ç—Ä–∏–Ω–∞ –†–∞–∑–±–∏—Ç–∞';
  playingAlbumName = '–ò–ó–ë–†–ê–ù–ù–û–ï';
  playingCover = 'img/star.png';

  // 3) –¢–µ–∫—É—â–∏–π –∏–Ω–¥–µ–∫—Å
  currentTrack = idx;
  playingTrack = idx;

  // 4) –ü–ª–µ–π–µ—Ä —Ä–∞—Å–ø–æ–ª–∞–≥–∞–µ–º –ø–æ–¥ –≤—ã–±—Ä–∞–Ω–Ω–æ–π —Å—Ç—Ä–æ–∫–æ–π ¬´–ò–ó–ë–†–ê–ù–ù–û–ï¬ª (—Å—Ç—Ä–æ–∫–∏ –∏–º–µ—é—Ç –∫–ª–∞—Å—Å .track; –∑–∞–≥–æ–ª–æ–≤–æ–∫ ‚Äî –±–µ–∑ .track)
  const list = document.getElementById('track-list');
  if (list) {
    // –ø–æ–¥—á—ë—Ä–∫–∏–≤–∞–µ–º —Ç–µ–∫—É—â—É—é —Å—Ç—Ä–æ–∫—É
    updateFavoritesCurrentRow(idx);

    let ph = list.querySelector('#lyricsplayerblock');
    const rows = list.querySelectorAll('.track');
    const row = rows[idx];

    if (!ph) {
      ph = document.createElement('div');
      ph.className = 'lyrics-player-block';
      ph.id = 'lyricsplayerblock';
      if (row && row.nextSibling) row.parentNode.insertBefore(ph, row.nextSibling); else list.appendChild(ph);
    } else {
      // –µ—Å–ª–∏ –ø–ª–µ–π—Å—Ö–æ–ª–¥–µ—Ä –Ω–µ –ø–æ–¥ –Ω—É–∂–Ω–æ–π —Å—Ç—Ä–æ–∫–æ–π ‚Äî –ø–µ—Ä–µ–º–µ—Å—Ç–∏–º
      if (row && row.parentNode && ph.previousElementSibling !== row) {
        if (row.nextSibling) row.parentNode.insertBefore(ph, row.nextSibling); else row.parentNode.appendChild(ph);
      }
    }

    // –ï—Å–ª–∏ –ø–ª–µ–µ—Ä –±—ã–ª –≤ now-playing ‚Äî –ø–µ—Ä–µ–Ω–æ—Å–∏–º
    const holder = document.getElementById('now-playing');
    const lp = holder?.querySelector('#lyricsplayerblock');
    if (lp && ph && lp !== ph) {
      ph.replaceWith(lp);
      holder.innerHTML = '';
    }
  }

  // 5) –ï—Å–ª–∏ –ø–ª–µ–µ—Ä –µ—â—ë –Ω–µ –æ—Ç—Ä–∏—Å–æ–≤–∞–Ω ‚Äî –Ω–∞—Ä–∏—Å—É–µ–º
  if (!document.getElementById('audio')) {
    renderLyricsBlock();
  }

  // 6) –ù–∞—Å—Ç—Ä–æ–∏–º —Ç–µ–∫—É—â–∏–π —Ç—Ä–µ–∫ –∏ –∑–∞–ø—É—Å—Ç–∏–º
  const a = document.getElementById('audio');
  if (!a) return;
  stopAndCleanupAudio(a);
  const tr = favoritesRefsModel[idx];
  a.src = tr.audio;

  loadLyrics(tr.lyrics);
  setupMediaSessionForPlayback();
  prefetchNextTrackAssetsForPlayback();

  a.currentTime = 0;
  a.play().catch(()=>{});

  // –ü–æ–¥—Å—Ç—Ä–∞—Ö–æ–≤–∫–∞ –æ—Ç –≤–æ–∑–º–æ–∂–Ω—ã—Ö –¥—É–±–ª–µ–π –ø–ª–µ–π–µ—Ä–∞
  dedupePlayerBlock();

  // 7) UI
  applyMiniModeUI();
  updateNextUpLabel();
  updateMiniNowHeader();
}

function updateFavoritesCurrentRow(idx) {
  try {
    const rows = document.querySelectorAll('#track-list .track');
    rows.forEach(r => r.classList.remove('current'));
    const row = rows[idx];
    if (row) row.classList.add('current');
  } catch {}
}

function updateFavRow(ref, active){
  const row = document.getElementById(`fav_${ref.a}_${ref.t}`); if (!row) return;
  row.classList.toggle('inactive', !active);
  const star = row.querySelector('.like-star');
  if (star) {
    star.src = active ? 'img/star.png' : 'img/star2.png';
    star.title = active ? '–°–Ω—è—Ç—å –∏–∑ –∏–∑–±—Ä–∞–Ω–Ω–æ–≥–æ' : '–í–µ—Ä–Ω—É—Ç—å –≤ –∏–∑–±—Ä–∞–Ω–Ω–æ–µ';
  }
}

function toggleLikeForAlbum(albumKey, idx, makeLiked){
  const map = getLikedMap();
  const arr = Array.isArray(map[albumKey]) ? map[albumKey] : [];
  const has = arr.includes(idx);
  let next = arr.slice();
  if (makeLiked && !has) next.push(idx);
  if (!makeLiked && has) next = next.filter(x=>x!==idx);
  map[albumKey] = Array.from(new Set(next));
  try { localStorage.setItem(LIKED_STORAGE_KEY_V2, JSON.stringify(map)); } catch {}
}

/* –ö–ª–∏–∫ –ø–æ –Ω–µ–∞–∫—Ç–∏–≤–Ω–æ–π —Å—Ç—Ä–æ–∫–µ –≤ ¬´–ò–ó–ë–†–ê–ù–ù–û–ú¬ª: –¥–∏–∞–ª–æ–≥ —Å ¬´–î–æ–±–∞–≤–∏—Ç—å –≤ ‚≠ê / –£–¥–∞–ª–∏—Ç—å¬ª */
function showFavInactivePrompt(ref){
  const modal = document.createElement('div');
  modal.className = 'modal-bg active';
  modal.innerHTML = `
    <div class="modal-feedback" style="max-width: 380px;">
      <button class="bigclose" onclick="this.closest('.modal-bg').remove()" title="–ó–∞–∫—Ä—ã—Ç—å">
        <svg viewBox="0 0 48 48"><line x1="12" y1="12" x2="36" y2="36" stroke="currentColor" stroke-width="6" stroke-linecap="round"/><line x1="36" y1="12" x2="12" y2="36" stroke="currentColor" stroke-width="6" stroke-linecap="round"/></svg>
      </button>
      <div style="font-weight:700; margin-bottom:10px;">–¢—Ä–µ–∫ –Ω–µ–∞–∫—Ç–∏–≤–µ–Ω</div>
      <div style="opacity:.8; margin-bottom:14px;">
        –ï—Å–ª–∏ —Ö–æ—Ç–∏—Ç–µ —Å–Ω–æ–≤–∞ —Å–ª—É—à–∞—Ç—å —Ç—Ä–µ–∫ –≤ ¬´–ò–ó–ë–†–ê–ù–ù–û–ú¬ª ‚Äî –¥–æ–±–∞–≤—å—Ç–µ –µ–≥–æ –≤ –∏–∑–±—Ä–∞–Ω–Ω–æ–µ.
        –õ–∏–±–æ —É–¥–∞–ª–∏—Ç–µ –∏–∑ —ç—Ç–æ–≥–æ —Å–ø–∏—Å–∫–∞.
      </div>
      <div style="display:flex; gap:10px; justify-content:center; flex-wrap:wrap;">
        <button class="offline-btn online" style="min-width:140px;" id="fav-add-btn">–î–æ–±–∞–≤–∏—Ç—å –≤ ‚≠ê</button>
        <button class="offline-btn" style="min-width:140px;" id="fav-del-btn">–£–¥–∞–ª–∏—Ç—å</button>
      </div>
    </div>`;
  document.body.appendChild(modal);

  modal.querySelector('#fav-add-btn').onclick = ()=>{
    toggleLikeForAlbum(ref.a, ref.t, true);
    updateFavRow(ref, true);
    updateFavoritesRefsModelActiveFlag(ref.a, ref.t, true);
    modal.remove();
    NotificationSystem.success('–î–æ–±–∞–≤–ª–µ–Ω–æ –≤ –∏–∑–±—Ä–∞–Ω–Ω–æ–µ');
  };
  modal.querySelector('#fav-del-btn').onclick = ()=>{
    modal.remove();
    showFavDeleteConfirm(ref);
  };
}

/* –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ —É–¥–∞–ª–µ–Ω–∏—è –∏–∑ ¬´–ò–ó–ë–†–ê–ù–ù–û–ì–û¬ª */
function showFavDeleteConfirm(ref){
  const modal = document.createElement('div');
  modal.className = 'modal-bg active';
  modal.innerHTML = `
    <div class="modal-feedback" style="max-width: 390px;">
      <button class="bigclose" onclick="this.closest('.modal-bg').remove()" title="–ó–∞–∫—Ä—ã—Ç—å">
        <svg viewBox="0 0 48 48"><line x1="12" y1="12" x2="36" y2="36" stroke="currentColor" stroke-width="6" stroke-linecap="round"/><line x1="36" y1="12" x2="12" y2="36" stroke="currentColor" stroke-width="6" stroke-linecap="round"/></svg>
      </button>
      <div style="font-weight:700; margin-bottom:10px;">–£–¥–∞–ª–∏—Ç—å –∏–∑ ¬´–ò–ó–ë–†–ê–ù–ù–û–ì–û¬ª?</div>
      <div style="opacity:.8; margin-bottom:12px;">
        –ï—Å–ª–∏ –≤—ã —É–¥–∞–ª–∏—Ç–µ —Ç—Ä–µ–∫, –æ–Ω –∏—Å—á–µ–∑–Ω–µ—Ç –∏–∑ —Å–ø–∏—Å–∫–∞ ¬´–ò–ó–ë–†–ê–ù–ù–û–ï¬ª, –Ω–æ –≤—ã –≤—Å–µ–≥–¥–∞ —Å–º–æ–∂–µ—Ç–µ –Ω–∞–π—Ç–∏ –µ–≥–æ –≤ –∏—Å—Ö–æ–¥–Ω–æ–º –∞–ª—å–±–æ–º–µ.
      </div>
      <div style="display:flex; gap:10px; justify-content:center;">
        <button class="offline-btn" style="min-width:120px;" id="fav-del-cancel">–û—Ç–º–µ–Ω–∞</button>
        <button class="offline-btn online" style="min-width:120px;" id="fav-del-apply">–£–¥–∞–ª–∏—Ç—å</button>
      </div>
    </div>`;
  document.body.appendChild(modal);

  modal.querySelector('#fav-del-cancel').onclick = ()=> modal.remove();
  modal.querySelector('#fav-del-apply').onclick = ()=>{
    // —É–¥–∞–ª—è–µ–º —Å—Å—ã–ª–∫—É –∏–∑ –ø–µ—Ä—Å–∏—Å—Ç-–ª–∏—Å—Ç–∞
    const refs = readFavoritesRefs().filter(x=> !(x.a===ref.a && x.t===ref.t));
    writeFavoritesRefs(refs);

    // –æ–±–Ω–æ–≤–∏–º –º–æ–¥–µ–ª—å –∏ DOM
    document.getElementById(`fav_${ref.a}_${ref.t}`)?.remove();
    if (Array.isArray(favoritesRefsModel)) {
      favoritesRefsModel = favoritesRefsModel.filter(x => !(x.__a === ref.a && x.__t === ref.t));
      // –ø–µ—Ä–µ–Ω—É–º–µ—Ä–∞—Ü–∏—è –Ω–æ–º–µ—Ä–æ–≤ —Å–ª–µ–≤–∞ (tnum)
      const rows = document.querySelectorAll('#track-list .track');
      rows.forEach((row, i) => {
        const tnum = row.querySelector('.tnum');
        if (tnum) tnum.textContent = `${String(i + 1).padStart(2,'0')}.`;
      });
    }

    modal.remove();
    NotificationSystem.success('–£–¥–∞–ª–µ–Ω–æ –∏–∑ ¬´–ò–ó–ë–†–ê–ù–ù–û–ì–û¬ª');
  };
}

/* ====== –°–æ—Ü—Å–µ—Ç–∏ ====== */
function buildSocials() {
  const linksEl = document.getElementById('social-links');
  if (!config || !config.socials || !linksEl) { linksEl.innerHTML = ''; return; }
  linksEl.innerHTML = (config.socials || []).map(x => `<a href="${x.url}" target="_blank" rel="noopener">${x.title}</a>`).join(" ");
}
function albumMetaByKey(key){ return albumsIndex.find(a => a.key === key) || null; }

function buildAlbumIcons(){
  const box = document.getElementById('album-icons'); 
  if (!box) return;

  // –°–æ–±–∏—Ä–∞–µ–º HTML —Å —Ä–µ–∞–ª—å–Ω—ã–º–∏ –∫–ª—é—á–∞–º–∏ (–¥–ª—è —Å–ø–µ—Ü-–∏–∫–æ–Ω–æ–∫ –∫–ª–∞–¥—ë–º —Å–ø–µ—Ü-–∫–ª—é—á)
  const isMob = isMobileUA();
  const html = ICON_ALBUMS_ORDER.map(it=>{
    let dataKey = it.key;
    if (it.key !== SPECIAL_FAVORITES_KEY && it.key !== SPECIAL_RELIZ_KEY) {
      const real = resolveRealAlbumKey(it.key);
      dataKey = real || '__unknown__';
    }
    const title = it.title || '';

    // –ü—É—Ç—å –∫ –∏–∫–æ–Ω–∫–µ: –¥–ª—è –º–æ–±–∞–π–ª–∞ ‚Äî JPG; –¥–ª—è –¥–µ—Å–∫—Ç–æ–ø–∞ ‚Äî PNG
    // –ò–º–µ–Ω–∞ —Ñ–∞–π–ª–æ–≤ –¥–æ–ª–∂–Ω—ã —Å—É—â–µ—Å—Ç–≤–æ–≤–∞—Ç—å!
    const baseIcon = it.icon || 'img/logo.png';
    // –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º baseIcon 'img/icon_album/icon-album-01.png' –∫ –ø–∞—Ä–∞–º 1x/2x
    const path1x = isMob
      ? baseIcon.replace(/icon_album\/(.+)\.png$/i, 'icon_album/mobile/$1@1x.jpg')
      : baseIcon.replace(/\.png$/i, '@1x.png');

    const path2x = isMob
      ? path1x.replace(/@1x\.jpg$/i, '@2x.jpg')
      : path1x.replace(/@1x\.png$/i, '@2x.png');

    return `<div class="album-icon" data-akey="${dataKey}" data-icon="${it.key}" title="${title}">
      <img src="${path1x}" srcset="${path2x} 2x" alt="${title}" width="60" height="60">
    </div>`;
  }).join('');

  box.innerHTML = html;

  // –ù–∞–≤–µ—à–∏–≤–∞–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏
  box.querySelectorAll('.album-icon').forEach(el=>{
    el.onclick = ()=> onAlbumIconClick(el.getAttribute('data-akey'));
  });

  // –ü–æ–¥—Å–≤–µ—Ç–∫–∞ —Ç–µ–∫—É—â–µ–≥–æ –∞–ª—å–±–æ–º–∞ (–µ—Å–ª–∏ —É–∂–µ –≤—ã–±—Ä–∞–Ω)
  setActiveAlbumIcon(currentAlbumKey || document.getElementById('album-select')?.value || (albumsIndex[0]?.key || ''));
}
/* ====== –ö—Ä—É–ø–Ω—ã–π –≤—ã–ø–∞–¥–∞—é—â–∏–π –∑–∞–≥–æ–ª–æ–≤–æ–∫ (–º–µ–Ω—é –∞–ª—å–±–æ–º–æ–≤) ====== */
function getMenuItemsInOrder() {
  // –ò—Å–ø–æ–ª—å–∑—É–µ–º —É–∂–µ –∑–∞–¥–∞–Ω–Ω—ã–π –ø–æ—Ä—è–¥–æ–∫ ICON_ALBUMS_ORDER
  // –î–ª—è –∫–∞–∂–¥–æ–≥–æ —ç–ª–µ–º–µ–Ω—Ç–∞ –±–µ—Ä—ë–º title –∏–∑ –º–∞—Å—Å–∏–≤–∞
  return ICON_ALBUMS_ORDER.map(it => {
    return { key: it.key, title: it.title };
  });
}
function setAlbumTitleText(title) {
  const btn = document.getElementById('album-title-button');
  if (btn) btn.textContent = title || '‚Äî';
}
function computeTitleFontSize() {
  // –ü–æ–¥–±–∏—Ä–∞–µ–º font-size –∫–Ω–æ–ø–∫–∏ –ø–æ–¥ —Å–∞–º—É—é –¥–ª–∏–Ω–Ω—É—é –Ω–∞–¥–ø–∏—Å—å –∏–∑ —Å–ø–∏—Å–∫–∞,
  // —á—Ç–æ–±—ã –æ–Ω–∞ –≤–ª–µ–∑–∞–ª–∞ –≤ 400px –ø–æ —à–∏—Ä–∏–Ω–µ (–º–∏–Ω—É—Å –Ω–µ–±–æ–ª—å—à–æ–π –∑–∞–ø–∞—Å).
  try {
    const btn = document.getElementById('album-title-button');
    if (!btn) return;
    const items = getMenuItemsInOrder();
    const longest = items.reduce((a, b) => (String(b.title||'').length > String(a||'').length ? b.title : a), '');
    const maxWidth = Math.min(400, btn.clientWidth || 400) - 8; // –∑–∞–ø–∞—Å
    const meas = document.createElement('span');
    meas.style.position = 'absolute';
    meas.style.left = '-999999px';
    meas.style.top = '-999999px';
    meas.style.whiteSpace = 'nowrap';
    meas.style.fontWeight = '900';
    meas.style.letterSpacing = '.01em';
    meas.style.fontFamily = getComputedStyle(btn).fontFamily;
    document.body.appendChild(meas);

    let size = 28; // —Å—Ç–∞—Ä—Ç—É–µ–º —Å –∫—Ä—É–ø–Ω–æ–≥–æ
    meas.style.fontSize = size + 'px';
    meas.textContent = longest || '‚Äî';

    // –ü–æ–Ω–∏–∂–∞–µ–º —Ä–∞–∑–º–µ—Ä, –ø–æ–∫–∞ –Ω–µ –≤–ª–µ–∑–µ—Ç, –¥–æ –º–∏–Ω–∏–º—É–º–∞ 18px
    while (meas.offsetWidth > maxWidth && size > 18) {
      size -= 1;
      meas.style.fontSize = size + 'px';
    }
    document.body.removeChild(meas);
    btn.style.fontSize = size + 'px';
  } catch {}
}
function buildAlbumMenu(initialKey) {
  const menu = document.getElementById('album-menu');
  const btn = document.getElementById('album-title-button');
  if (!menu || !btn) return;

  const items = getMenuItemsInOrder();
  menu.innerHTML = items.map(it => {
    const active = (it.key === initialKey) ? ' active' : '';
    return `<div class="album-menu-item${active}" data-key="${it.key}" role="option" aria-selected="${active ? 'true':'false'}">${it.title}</div>`;
  }).join('');

  // –ó–∞–≥–æ–ª–æ–≤–æ–∫ –ø–æ —Ç–µ–∫—É—â–µ–º—É –≤—ã–±–æ—Ä—É
  const currentTitle = (items.find(x => x.key === initialKey) || items[0] || {}).title || '‚Äî';
  setAlbumTitleText(currentTitle);
  computeTitleFontSize();

  btn.onclick = () => {
    const open = menu.classList.toggle('open');
    btn.setAttribute('aria-expanded', open ? 'true' : 'false');
  };

  // –í—ã–±–æ—Ä –ø—É–Ω–∫—Ç–∞
  menu.querySelectorAll('.album-menu-item').forEach(el => {
    el.onclick = async () => {
      const key = el.getAttribute('data-key');
      if (!key) return;
      menu.querySelectorAll('.album-menu-item').forEach(n => { n.classList.remove('active'); n.setAttribute('aria-selected','false'); });
      el.classList.add('active'); el.setAttribute('aria-selected','true');

      const title = el.textContent.trim();
      setAlbumTitleText(title);
      computeTitleFontSize();

      // –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É–µ–º —Å–∫—Ä—ã—Ç—ã–π select (–Ω–∞ –≤—Å—è–∫–∏–π —Å–ª—É—á–∞–π)
      const sel = document.getElementById('album-select');

      // –ü–µ—Ä–µ—Ö–æ–¥ –ø–æ —Ç–∏–ø—É –∫–ª—é—á–∞
      if (key === SPECIAL_FAVORITES_KEY) {
        if (sel) sel.value = albumsIndex[0]?.key || '';
        await openFavoritesView();
        setActiveAlbumIcon(SPECIAL_FAVORITES_KEY);
      } else if (key === SPECIAL_RELIZ_KEY) {
        if (sel) sel.value = albumsIndex[0]?.key || '';
        await openRelizView();
        setActiveAlbumIcon(SPECIAL_RELIZ_KEY);
      } else {
        // –†–µ–∞–ª—å–Ω—ã–π –∞–ª—å–±–æ–º
        const real = albumByKey(key) ? key : resolveRealAlbumKey(key);
        if (!real || !albumByKey(real)) {
          NotificationSystem.error('–ê–ª—å–±–æ–º –Ω–µ –Ω–∞–π–¥–µ–Ω');
        } else {
          if (sel) sel.value = real;
          // –ü—Ä–∏ –≤—ã–±–æ—Ä–µ –Ω–æ–≤–æ–≥–æ –∞–ª—å–±–æ–º–∞ ‚Äî –≥–∞–ª–µ—Ä–µ—è –≤—Å–µ–≥–¥–∞ –æ—Ç–∫—Ä—ã—Ç–∞
          viewMode = 'album';
          clearRelizView();
          document.getElementById('track-list').style.display = '';
          document.getElementById('cover-wrap').style.display = '';
          __currentGalleryVisible = true;
          setCoverWrapVisible(true);
          await loadAlbumByKey(real);
          setActiveAlbumIcon(real);
        }
      }
      // –ó–∞–∫—Ä—ã–≤–∞–µ–º –º–µ–Ω—é, –¥–≤–∏–≥–∞–µ–º –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å –Ω–∞–∑–∞–¥
      menu.classList.remove('open');
      btn.setAttribute('aria-expanded', 'false');
    };
  });

  // –ü–µ—Ä–µ—Å—á–∏—Ç–∞—Ç—å —Ä–∞–∑–º–µ—Ä –Ω–∞ —Ä–µ—Å–∞–π–∑–µ
  window.addEventListener('resize', () => computeTitleFontSize());
}

function setActiveAlbumIcon(key){
  const box = document.getElementById('album-icons'); 
  if (!box) return;
  box.querySelectorAll('.album-icon').forEach(el=>{
    const k = el.getAttribute('data-akey');
    el.classList.toggle('active', k && key && k === key);
  });
}

function onAlbumIconClick(key){
  // –°–ø–µ—Ü-—Ä–µ–∂–∏–º—ã
  if (key === SPECIAL_FAVORITES_KEY) {
    openFavoritesView();
    setActiveAlbumIcon(key);
    return;
  }
  if (key === SPECIAL_RELIZ_KEY) {
    openRelizView(); // ¬´–ù–û–í–û–°–¢–ò¬ª
    setActiveAlbumIcon(key);
    return;
  }

  // –ù–µ–æ–ø—Ä–µ–¥–µ–ª—ë–Ω–Ω—ã–π –∫–ª—é—á ‚Äî –ø–æ–ø—Ä–æ–±—É–µ–º —Ä–µ–∑–æ–ª–≤–∏—Ç—å
  if (!key || key === '__unknown__') {
    const real = resolveRealAlbumKey(key);
    if (real) key = real;
  }

  // –ï—Å–ª–∏ —ç—Ç–æ —Ç–µ–∫—É—â–∏–π –∞–ª—å–±–æ–º –≤ —Ä–µ–∂–∏–º–µ ¬´album¬ª ‚Äî –ø—Ä–æ—Å—Ç–æ —Ç—É–º–±–ª–µ—Ä –≤–∏–¥–∏–º–æ—Å—Ç–∏ –≥–∞–ª–µ—Ä–µ–∏
  if (viewMode === 'album' && key === currentAlbumKey) {
    __currentGalleryVisible = !__currentGalleryVisible;
    setCoverWrapVisible(__currentGalleryVisible);
    return;
  }

  // –ü–µ—Ä–µ–∫–ª—é—á–∞–µ–º—Å—è –Ω–∞ –¥—Ä—É–≥–æ–π –∞–ª—å–±–æ–º: –≥–∞–ª–µ—Ä–µ—è –î–û–õ–ñ–ù–ê –±—ã—Ç—å –æ—Ç–∫—Ä—ã—Ç–∞
  const meta = albumMetaByKey(key);
  if (!meta) { 
    NotificationSystem.error('–ê–ª—å–±–æ–º –Ω–µ –Ω–∞–π–¥–µ–Ω');
    return;
  }

  viewMode = 'album';
  clearRelizView();
  document.getElementById('track-list').style.display = '';
  document.getElementById('cover-wrap').style.display = '';

  const sel = document.getElementById('album-select');
  if (sel) sel.value = key;

  setActiveAlbumIcon(key);

  // –ü—Ä–∏ –≤—Ö–æ–¥–µ –≤ –Ω–æ–≤—ã–π –∞–ª—å–±–æ–º ‚Äî –æ—Ç–∫—Ä—ã–≤–∞–µ–º –≥–∞–ª–µ—Ä–µ—é –∏ —Å—Ä–∞–∑—É –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –µ—ë
  __currentGalleryVisible = true;
  setCoverWrapVisible(true);

  loadAlbumByKey(key).then(()=>{
    // –æ—Å—Ç–∞–≤–ª—è–µ–º –æ—Ç–∫—Ä—ã—Ç–æ–π
  });
}

function setCoverWrapVisible(visible){
  const cw = document.getElementById('cover-wrap');
  if (cw) cw.style.display = visible ? '' : 'none';
}

function isCoverWrapVisibleFor(key){
  return !coverCollapsedMap[key];
}

/* –î—É–±–ª–∏–∫–∞—Ç —É—Å—Ç–∞—Ä–µ–≤—à–∏—Ö —Ñ—É–Ω–∫—Ü–∏–π –≥–∞–ª–µ—Ä–µ–∏ —É–¥–∞–ª—ë–Ω.
   –ò—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è –≤–µ—Ä—Å–∏–∏ –≤—ã—à–µ: renderCoverItem(), setCoverImage(), startCoverAutoPlay() –¥–ª—è #cover-slot. */

/* ====== –¢–æ—Å—Ç—ã ====== */
class NotificationSystem {
  static queue = []; static isShowing = false;
  static show(message, type = 'info', duration = 3000) { this.queue.push({ message, type, duration }); if (!this.isShowing) this.processQueue(); }
  static async processQueue() {
    if (this.queue.length===0) { this.isShowing=false; return; }
    this.isShowing=true;
    const { message, type, duration } = this.queue.shift();
    const toast = document.createElement('div');
    toast.className = `toast toast-${type}`;
    toast.innerHTML = `<div class="toast-content"><span class="toast-emoji" aria-hidden="true"></span><span class="toast-text">${message}</span></div>`;
    document.body.appendChild(toast);
    await new Promise(r=>setTimeout(r,50));
    toast.classList.add('show');
    await new Promise(r=>setTimeout(r,duration));
    toast.classList.remove('show');
    await new Promise(r=>setTimeout(r,300));
    toast.remove();
    this.processQueue();
  }
  static info(msg){ this.show(msg,'info'); }
  static success(msg){ this.show(msg,'success'); }
  static error(msg){ this.show(msg,'error',5000); }
  static warning(msg){ this.show(msg,'warning',4000); }
  static offline(msg){ this.show(msg,'offline'); }
}

/* ====== –ò–∑–±—Ä–∞–Ω–Ω–æ–µ (–ø–æ–º–µ—Å—è—á–Ω–æ –ø–æ –∞–ª—å–±–æ–º–∞–º, v2) ====== */
const LIKED_STORAGE_KEY_V2 = 'likedTracks:v2';

/* –ü–æ–ª—É—á–∞–µ–º –∫–∞—Ä—Ç—É { albumKey: number[] } */
function getLikedMap() {
  try {
    const raw = localStorage.getItem(LIKED_STORAGE_KEY_V2);
    const map = raw ? JSON.parse(raw) : {};
    return (map && typeof map === 'object') ? map : {};
  } catch {
    return {};
  }
}

/* –ú–∏–≥—Ä–∞—Ü–∏—è —Å–æ —Å—Ç–∞—Ä–æ–≥–æ —Ñ–æ—Ä–º–∞—Ç–∞ (–≥–ª–æ–±–∞–ª—å–Ω—ã–π –º–∞—Å—Å–∏–≤) –≤ –∫–∞—Ä—Ç—É –¥–ª—è —Ç–µ–∫—É—â–µ–≥–æ –∞–ª—å–±–æ–º–∞ */
function migrateLegacyLikedIfNeeded(map) {
  try {
    const legacyRaw = localStorage.getItem('likedTracks');
    if (!legacyRaw) return map;
    const legacy = JSON.parse(legacyRaw);
    if (Array.isArray(legacy) && currentAlbumKey) {
      if (!Array.isArray(map[currentAlbumKey]) || map[currentAlbumKey].length === 0) {
        map[currentAlbumKey] = legacy.slice();
      }
    }
    // –°—Ç–∞—Ä—ã–π –∫–ª—é—á –±–æ–ª—å—à–µ –Ω–µ –Ω—É–∂–µ–Ω
    localStorage.removeItem('likedTracks');
    localStorage.setItem(LIKED_STORAGE_KEY_V2, JSON.stringify(map));
  } catch {}
  return map;
}

/* –°–ø–∏—Å–æ–∫ –∏–∑–±—Ä–∞–Ω–Ω—ã—Ö –ø–æ —Ç–µ–∫—É—â–µ–º—É –∞–ª—å–±–æ–º—É */
function getLikedForAlbum(albumKey) {
  try {
    const raw = localStorage.getItem(LIKED_STORAGE_KEY_V2);
    const map = raw ? JSON.parse(raw) : {};
    const arr = map && typeof map === 'object' ? map[albumKey] : [];
    return Array.isArray(arr) ? arr : [];
  } catch {
    return [];
  }
}

function getLiked() {
  // –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é ‚Äî –¥–ª—è –ø—Ä–æ—Å–º–∞—Ç—Ä–∏–≤–∞–µ–º–æ–≥–æ –∞–ª—å–±–æ–º–∞
  return getLikedForAlbum(currentAlbumKey);
}

/* –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–∑–±—Ä–∞–Ω–Ω—ã–µ –ø–æ —Ç–µ–∫—É—â–µ–º—É –∞–ª—å–±–æ–º—É */
function saveLiked(arr) {
  if (!currentAlbumKey) return;
  const map = getLikedMap();
  map[currentAlbumKey] = Array.from(new Set(arr.filter(n => Number.isInteger(n))));
  localStorage.setItem(LIKED_STORAGE_KEY_V2, JSON.stringify(map));
}

/* –ü—Ä–æ–≤–µ—Ä–∫–∞ ¬´–≤ –∏–∑–±—Ä–∞–Ω–Ω–æ–º¬ª (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é ‚Äî –¥–ª—è –ø—Ä–æ—Å–º–∞—Ç—Ä–∏–≤–∞–µ–º–æ–≥–æ –∞–ª—å–±–æ–º–∞) */
function isLiked(idx, albumKey = currentAlbumKey) {
  return getLikedForAlbum(albumKey).includes(idx);
}

/* ====== –¢—Ä–µ–∫–∏ (—Å–ø–∏—Å–æ–∫) ====== */
function buildTrackList() {
  const list = document.getElementById('track-list');
  if (!config) { list.innerHTML = ''; return; }

  // –ü–ª–µ–µ—Ä —É–∂–µ ¬´—Å–æ—Ö—Ä–∞–Ω—ë–Ω¬ª –≤–æ –≤–Ω–µ—à–Ω–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–µ now-playing?
  const preservedInNowPlaying = !!document.getElementById('now-playing')?.querySelector('#lyricsplayerblock');
  const foreignView = preservedInNowPlaying && isBrowsingOtherAlbum(); // —Å–º–æ—Ç—Ä–∏–º –¥—Ä—É–≥–æ–π –∞–ª—å–±–æ–º, –ø–æ–∫–∞ –∏–≥—Ä–∞–µ—Ç –ø—Ä–µ–∂–Ω–∏–π

  let html = '';
  for (let i = 0; i < config.tracks.length; i++) {
    const t = config.tracks[i];
    const isCur = (!foreignView && i === currentTrack) ? ' current' : '';
    html += `<div class="track${isCur}" id="trk${i}" onclick="pickAndPlayTrack(${i})">
      <span class="tnum">${String(i + 1).padStart(2, '0')}.</span>
      <span class="track-title">${t.title}</span>
      <img src="${isLiked(i) ? 'img/star.png' : 'img/star2.png'}"
           class="like-star"
           alt="–∑–≤–µ–∑–¥–∞"
           title="${isLiked(i) ? '–£–±—Ä–∞—Ç—å –∏–∑ –ø–æ–Ω—Ä–∞–≤–∏–≤—à–∏—Ö—Å—è' : '–î–æ–±–∞–≤–∏—Ç—å –≤ –ø–æ–Ω—Ä–∞–≤–∏–≤—à–∏–µ—Å—è'}"
           onclick="toggleLike(${i}, event)"/>
    </div>`;

    /* –ü–ª–µ–π—Å—Ö–æ–ª–¥–µ—Ä –¥–ª—è –ø–ª–µ–µ—Ä–∞:
       - –µ—Å–ª–∏ –ø–ª–µ–µ—Ä –Ω–µ –≤–æ –≤–Ω–µ—à–Ω–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–µ ‚Äî –∫–∞–∫ —Ä–∞–Ω—å—à–µ
       - –µ—Å–ª–∏ –ø–ª–µ–µ—Ä –≤–æ –≤–Ω–µ—à–Ω–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–µ, –Ω–æ –º—ã –≤–µ—Ä–Ω—É–ª–∏—Å—å –≤ –∏–≥—Ä–∞—é—â–∏–π –∞–ª—å–±–æ–º ‚Äî –≤–µ—Ä–Ω—ë–º –ø–ª–µ–µ—Ä –ø–æ–¥ —Ç–µ–∫—É—â–∏–π —Ç—Ä–µ–∫ */
    if (i === currentTrack && (!preservedInNowPlaying || (currentAlbumKey === playingAlbumKey))) {
      html += `<div class="lyrics-player-block" id="lyricsplayerblock"></div>`;
    }
  }

  list.innerHTML = html;

  // –ü–æ–¥—Å—Ç—Ä–∞—Ö–æ–≤–∫–∞ –æ—Ç –≤–æ–∑–º–æ–∂–Ω—ã—Ö –¥—É–±–ª–µ–π –ø–ª–µ–π–µ—Ä–∞
  dedupePlayerBlock();

  // –ï—Å–ª–∏ –≤–µ—Ä–Ω—É–ª–∏—Å—å –≤ –∏–≥—Ä–∞—é—â–∏–π –∞–ª—å–±–æ–º ‚Äî –ø–µ—Ä–µ–Ω–µ—Å—ë–º —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π –ø–ª–µ–µ—Ä –ø–æ–¥ —Ç–µ–∫—É—â–∏–π —Ç—Ä–µ–∫
  if (preservedInNowPlaying && currentAlbumKey === playingAlbumKey) {
    const holder = document.getElementById('now-playing');
    const lp = holder?.querySelector('#lyricsplayerblock');
    const ph = list.querySelector('#lyricsplayerblock'); // –±–µ—Ä—ë–º –ø–ª–µ–π—Å—Ö–æ–ª–¥–µ—Ä –∏–∑ —Å–ø–∏—Å–∫–∞
    if (lp && ph && lp !== ph) {
      ph.replaceWith(lp);
      holder.innerHTML = ''; // –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä —Ç–µ–ø–µ—Ä—å –ø—É—Å—Ç–æ–π
    }
  }

  // –ï—Å–ª–∏ –ø–ª–µ–µ—Ä –Ω–µ —Å–æ—Ö—Ä–∞–Ω—ë–Ω –≤ now-playing ‚Äî –æ—Ç—Ä–∏—Å–æ–≤—ã–≤–∞–µ–º –±–ª–æ–∫ –∏ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –ø–ª–µ–µ—Ä
  if (!preservedInNowPlaying && currentTrack >= 0) {
    renderLyricsBlock();
  }

  if (favoritesFilterActive) {
    list.classList.add('filtered');
    updateFavoriteClasses();
  }
}

function toggleLike(idx, e) {
  if (e) e.stopPropagation();
  let liked = getLiked();
  const was = liked.includes(idx);
  liked = was ? liked.filter(x=>x!==idx) : [...liked, idx];
  saveLiked(liked);
  const star = e ? e.target : document.querySelector(`#trk${idx} .like-star`);
  if (star){ star.src = was? 'img/star2.png':'img/star.png'; star.title = was?'–î–æ–±–∞–≤–∏—Ç—å –≤ –ø–æ–Ω—Ä–∞–≤–∏–≤—à–∏–µ—Å—è':'–£–±—Ä–∞—Ç—å –∏–∑ –ø–æ–Ω—Ä–∞–≤–∏–≤—à–∏—Ö—Å—è'; star.classList.add('animating'); setTimeout(()=>star.classList.remove('animating'),300); }

  if (favoritesFilterActive) {
    updateFavoriteClasses();
    const count = document.querySelectorAll('.track.is-favorite').length;
    if (count===0) {
      toggleFavoritesFilter();
      NotificationSystem.warning('–í—Å–µ —Ç—Ä–µ–∫–∏ —É–¥–∞–ª–µ–Ω—ã –∏–∑ –∏–∑–±—Ä–∞–Ω–Ω–æ–≥–æ, —Ñ–∏–ª—å—Ç—Ä –æ—Ç–∫–ª—é—á—ë–Ω');
    } else {
      NotificationSystem.info(`‚≠ê –ò–∑–±—Ä–∞–Ω–Ω—ã—Ö —Ç—Ä–µ–∫–æ–≤: ${count}`);
    }
  }

  // –í —Ä–µ–∂–∏–º–µ ¬´–¢–æ–ª—å–∫–æ –∏–∑–±—Ä–∞–Ω–Ω—ã–µ¬ª —Ä–µ–∞–≥–∏—Ä—É–µ–º –Ω–∞ –∞–Ω–ª–∞–π–∫ —Ç–µ–∫—É—â–µ–≥–æ —Ç—Ä–µ–∫–∞
  // –¢–û–õ–¨–ö–û –µ—Å–ª–∏ –ø—Ä–æ—Å–º–∞—Ç—Ä–∏–≤–∞–µ–º —Ç–æ—Ç –∂–µ –∞–ª—å–±–æ–º, —á—Ç–æ –∏ –∏–≥—Ä–∞–µ—Ç.
  if (favoritesOnlyMode && isBrowsingSameAsPlaying()) {
    updateAvailableTracks();
    if (!getLikedForPlayback().includes(playingTrack)) {
      const nextFavorite = getNextFavoriteTrack();
      if (nextFavorite !== -1) {
        setTimeout(() => showTrack(nextFavorite, true), 300);
      } else {
        toggleFavoritesOnly();
        NotificationSystem.warning('–í—Å–µ —Ç—Ä–µ–∫–∏ —É–¥–∞–ª–µ–Ω—ã –∏–∑ –∏–∑–±—Ä–∞–Ω–Ω–æ–≥–æ');
      }
    }
    if (shuffleMode) createShuffledPlaylist();
  }
}

/* –õ–∞–π–∫/–∞–Ω–ª–∞–π–∫ –¥–ª—è —Ç–µ–∫—É—â–µ–≥–æ –ò–ì–†–ê–Æ–©–ï–ì–û —Ç—Ä–µ–∫–∞, –¥–∞–∂–µ –µ—Å–ª–∏ –æ—Ç–∫—Ä—ã—Ç –¥—Ä—É–≥–æ–π –∞–ª—å–±–æ–º */
function toggleLikePlaying() {
  if (!playingTracks || playingTrack < 0) return;

  let albumForLike = playingAlbumKey;
  let indexForLike = playingTrack;

  // –í ¬´–ò–ó–ë–†–ê–ù–ù–û–ú¬ª –ª–∞–π–∫ –æ—Ç–Ω–æ—Å–∏—Ç—Å—è –∫ –∏—Å—Ö–æ–¥–Ω–æ–º—É –∞–ª—å–±–æ–º—É/–∏–Ω–¥–µ–∫—Å—É
  if (playingAlbumKey === SPECIAL_FAVORITES_KEY) {
    const ref = favoritesRefsModel?.[playingTrack];
    if (!ref) return;
    albumForLike = ref.__a;
    indexForLike = ref.__t;
  }

  const map = getLikedMap();
  const arr = Array.isArray(map[albumForLike]) ? map[albumForLike] : [];
  const was = arr.includes(indexForLike); // –±—ã–ª–æ –≤ –∏–∑–±—Ä–∞–Ω–Ω–æ–º?
  const next = was ? arr.filter(x => x !== indexForLike) : [...arr, indexForLike];
  map[albumForLike] = Array.from(new Set(next));
  try { localStorage.setItem(LIKED_STORAGE_KEY_V2, JSON.stringify(map)); } catch {}

  // –û–±–Ω–æ–≤–∏–º UI: –º–∏–Ω–∏-—à–∞–ø–∫–∞
  updateMiniNowHeader();

  if (playingAlbumKey === SPECIAL_FAVORITES_KEY) {
    // –û–±–Ω–æ–≤–∏–º –º–æ–¥–µ–ª—å/—Å—Ç—Ä–æ–∫—É
    updateFavoritesRefsModelActiveFlag(albumForLike, indexForLike, !was);
    const favRow = document.getElementById(`fav_${albumForLike}_${indexForLike}`);
    if (favRow) {
      favRow.classList.toggle('inactive', was);
      const s = favRow.querySelector('.like-star');
      if (s) { s.src = was ? 'img/star2.png' : 'img/star.png'; s.title = was ? '–í–µ—Ä–Ω—É—Ç—å –≤ –∏–∑–±—Ä–∞–Ω–Ω–æ–µ' : '–°–Ω—è—Ç—å –∏–∑ –∏–∑–±—Ä–∞–Ω–Ω–æ–≥–æ'; }
    }

    // –ü–µ—Ä–µ—Å—Ç—Ä–æ–∏–º –æ—á–µ—Ä–µ–¥—å –í–°–ï–ì–î–ê, –≤–Ω–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç favoritesOnlyMode
    createPlayingShuffledPlaylist();
    updateNextUpLabel();

    // –ï—Å–ª–∏ –º—ã —Å–Ω—è–ª–∏ –ª–∞–π–∫ —É —Ç–µ–∫—É—â–µ–≥–æ —Ç—Ä–µ–∫–∞ ‚Äî —Å—Ä–∞–∑—É –ø–µ—Ä–µ–π—Ç–∏ –∫ —Å–ª–µ–¥—É—é—â–µ–º—É
    if (was) {
      nextTrack();
      return;
    }
  } else {
    // –û–±—ã—á–Ω—ã–π –∞–ª—å–±–æ–º: –µ—Å–ª–∏ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∞—è —Å—Ç—Ä–æ–∫–∞ –≤ ¬´–ò–ó–ë–†–ê–ù–ù–û–ú¬ª –æ—Ç–æ–±—Ä–∞–∂–∞–µ—Ç—Å—è ‚Äî —Ç–æ–∂–µ –æ–±–Ω–æ–≤–∏–º
    const favRow = document.getElementById(`fav_${albumForLike}_${indexForLike}`);
    if (favRow) {
      favRow.classList.toggle('inactive', was);
      const s = favRow.querySelector('.like-star');
      if (s) { s.src = was ? 'img/star2.png' : 'img/star.png'; s.title = was ? '–í–µ—Ä–Ω—É—Ç—å –≤ –∏–∑–±—Ä–∞–Ω–Ω–æ–µ' : '–°–Ω—è—Ç—å –∏–∑ –∏–∑–±—Ä–∞–Ω–Ω–æ–≥–æ'; }
    }

    // –ï—Å–ª–∏ —Å–µ–π—á–∞—Å –∏–≥—Ä–∞–µ—Ç –ù–ï ¬´–ò–ó–ë–†–ê–ù–ù–û–ï¬ª, –Ω–æ –≤–∫–ª—é—á–µ–Ω favoritesOnlyMode ‚Äî –¥–µ–π—Å—Ç–≤—É–µ–º –∫–∞–∫ —Ä–∞–Ω—å—à–µ
    if (favoritesOnlyMode && shuffleMode) createPlayingShuffledPlaylist();
    updateNextUpLabel();
  }
}

function updateFavoriteClasses() {
  // –û–±—ã—á–Ω—ã–π –∞–ª—å–±–æ–º
  const liked = getLiked();
  document.querySelectorAll('.track').forEach(tr => tr.classList.remove('is-favorite'));
  liked.forEach(idx => { const el = document.getElementById(`trk${idx}`); if (el) el.classList.add('is-favorite'); });
}

/* –°–ø–µ—Ü–∏–∞–ª—å–Ω–æ –¥–ª—è —Å–ø–∏—Å–∫–∞ ¬´–ò–ó–ë–†–ê–ù–ù–û–ï¬ª: –æ—Ç–º–µ—á–∞–µ–º .is-favorite —Ç–æ–ª—å–∫–æ –∞–∫—Ç–∏–≤–Ω—ã–µ —Å—Ç—Ä–æ–∫–∏ */
function updateFavoriteClassesFavorites() {
  if (!Array.isArray(favoritesRefsModel)) return;
  // —Å–Ω—è—Ç—å –º–µ—Ç–∫–∏
  document.querySelectorAll('#track-list .track').forEach(tr => tr.classList.remove('is-favorite'));
  favoritesRefsModel.forEach((item, i) => {
    if (item.__active) {
      const el = document.getElementById(`fav_${item.__a}_${item.__t}`);
      if (el) el.classList.add('is-favorite');
    }
  });
}

function toggleFavoritesFilter() {
  const btn = document.getElementById('filter-favorites-btn');
  const list = document.getElementById('track-list');

  // –ï—Å–ª–∏ –º—ã –≤ ¬´–ò–ó–ë–†–ê–ù–ù–û–ú¬ª ‚Äî —Ñ–∏–ª—å—Ç—Ä—É–µ–º –ø–æ __active
  if (viewMode === 'favorites') {
    favoritesFilterActive = !favoritesFilterActive;
    if (favoritesFilterActive) {
      // –ü—Ä–æ–≤–µ—Ä–∏–º, –µ—Å—Ç—å –ª–∏ –∞–∫—Ç–∏–≤–Ω—ã–µ
      const anyActive = (favoritesRefsModel || []).some(x => x.__active);
      if (!anyActive) {
        favoritesFilterActive = false;
        NotificationSystem.warning('–ù–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö —Ç—Ä–µ–∫–æ–≤ —Å–æ ‚≠ê!');
        return;
      }
      btn.textContent = '–ü–û–ö–ê–ó–ê–¢–¨ –í–°–ï –ü–ï–°–ù–ò';
      btn.classList.add('filtered');
      list.classList.add('filtered');
      updateFavoriteClassesFavorites();
    } else {
      btn.textContent = '–°–∫—Ä—ã—Ç—å –Ω–µ –æ—Ç–º–µ—á–µ–Ω–Ω—ã–µ ‚≠ê –ø–µ—Å–Ω–∏';
      btn.classList.remove('filtered');
      list.classList.remove('filtered');
    }
    return;
  }

  // –û–±—ã—á–Ω—ã–π –∞–ª—å–±–æ–º
  const liked = getLiked();
  favoritesFilterActive = !favoritesFilterActive;
  if (favoritesFilterActive) {
    if (!liked.length){ NotificationSystem.warning('–ù–µ—Ç –∏–∑–±—Ä–∞–Ω–Ω—ã—Ö —Ç—Ä–µ–∫–æ–≤!'); favoritesFilterActive=false; return; }
    btn.textContent='–ü–û–ö–ê–ó–ê–¢–¨ –í–°–ï –ü–ï–°–ù–ò'; btn.classList.add('filtered'); list.classList.add('filtered'); updateFavoriteClasses();
  } else {
    btn.textContent='–°–∫—Ä—ã—Ç—å –Ω–µ –æ—Ç–º–µ—á–µ–Ω–Ω—ã–µ ‚≠ê –ø–µ—Å–Ω–∏'; btn.classList.remove('filtered'); list.classList.remove('filtered');
  }
}

/* ====== –ü–ª–µ–µ—Ä ====== */
function getCurrentAudio() { return __currentAudio || document.getElementById('audio') || null; }
function stopAndCleanupAudio(a) {
  if (!a) return;
  try { a.pause(); } catch(e) {}
  try { a.currentTime = 0; } catch(e) {}
  try { a.removeAttribute('src'); a.load(); } catch(e) {}
}

// –ü–æ–¥—Å—Ç—Ä–∞—Ö–æ–≤–∫–∞ –æ—Ç –¥—É–±–ª–∏–∫–∞—Ç–æ–≤ #lyricsplayerblock (–Ω–∞–ø—Ä–∏–º–µ—Ä, –µ—Å–ª–∏ –æ–Ω
// —Å–ª—É—á–∞–π–Ω–æ –æ—Ç—Ä–∏—Å–æ–≤–∞–Ω –∏ –≤ —Å–ø–∏—Å–∫–µ, –∏ –≤ now-playing)
function dedupePlayerBlock() {
  try {
    const nodes = Array.from(document.querySelectorAll('#lyricsplayerblock'));
    if (nodes.length <= 1) return;

    // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ç–æ—Ç, –≤–Ω—É—Ç—Ä–∏ –∫–æ—Ç–æ—Ä–æ–≥–æ –µ—Å—Ç—å —Ç–µ–∫—É—â–∏–π audio, –µ—Å–ª–∏ –æ–Ω –µ—Å—Ç—å
    let keep = nodes.find(n => n.querySelector('#audio')) || nodes[0];
    nodes.forEach(n => { if (n !== keep) n.remove(); });
  } catch {}
}

function pickAndPlayTrack(n){ showTrack(n, true); autoPlayEnabled = true; }

function showTrack(n, doPlay) {
  // –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –¢–û–õ–¨–ö–û —Ç–µ–∫—É—â–∏–π audio-—ç–ª–µ–º–µ–Ω—Ç (–µ—Å–ª–∏ –æ–Ω –µ—Å—Ç—å)
  stopAndCleanupAudio(getCurrentAudio());
  __currentAudio = null;

  // –ï—Å–ª–∏ –µ—Å—Ç—å –≤–Ω–µ—à–Ω–∏–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä now-playing ‚Äî –æ—á–∏—â–∞–µ–º –µ–≥–æ (—É—Å—Ç—Ä–∞–Ω—è–µ–º —Å—Ç–∞—Ä—ã–π UI)
  const holder = document.getElementById('now-playing');
  if (holder && holder.firstChild) {
    holder.innerHTML = '';
  }

  // –≠—Ç–æ –∑–∞–ø—É—Å–∫ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è –∏–∑ –ø—Ä–æ—Å–º–∞—Ç—Ä–∏–≤–∞–µ–º–æ–≥–æ –∞–ª—å–±–æ–º–∞ ‚Äî —Ñ–∏–∫—Å–∏—Ä—É–µ–º ¬´–∏–≥—Ä–∞—é—â–∏–π¬ª –∫–æ–Ω—Ç–µ–∫—Å—Ç
  playingAlbumKey = currentAlbumKey;
  playingTracks = (config && Array.isArray(config.tracks)) ? config.tracks : null;
  playingArtist = (config && config.artist) ? config.artist : '';
  playingAlbumName = (config && config.albumName) ? config.albumName : '';
  playingCover = (Array.isArray(coverGalleryArr) && coverGalleryArr[0]) ? coverGalleryArr[0] : 'img/logo.png';
  if (shuffleMode) createPlayingShuffledPlaylist();

  currentTrack = n;
  playingTrack = n;
  buildTrackList();

  const audio = document.getElementById('audio');
  if (!audio) return;

  __currentAudio = audio;

  // –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –≥—Ä–æ–º–∫–æ—Å—Ç–∏
  try {
    audio.muted = false;
    const saved = parseFloat(localStorage.getItem('playerVolume'));
    audio.volume = Number.isFinite(saved) && saved > 0 ? saved : 1;
  } catch {}

  if (doPlay) {
    audio.currentTime = 0;
    const tryPlay = () => {
      const p = audio.play();
      if (p && p.catch) p.catch(()=>{});
    };
    if (isNaN(audio.duration) || !isFinite(audio.duration)) {
      audio.addEventListener('canplay', tryPlay, { once: true });
      setTimeout(tryPlay, 200);
    } else {
      tryPlay();
    }
  }

  applyMiniModeUI();
  updateMiniNowHeader();
  updateNextUpLabel();
}

function renderLyricsBlock() {
  const block = document.getElementById('lyricsplayerblock') || document.getElementById('now-playing');
  if (!block) return;

  // –í–ê–ñ–ù–û: –º–∏–Ω–∏‚Äë—à–∞–ø–∫—É —Ä–µ–Ω–¥–µ—Ä–∏–º –í–°–ï–ì–î–ê, —á—Ç–æ–±—ã –ø—Ä–∏ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–∏ –≤ –º–∏–Ω–∏‚Äë—Ä–µ–∂–∏–º –æ–Ω–∞ —É–∂–µ –±—ã–ª–∞ –≤ DOM.
  // –ï—ë –≤–∏–¥–∏–º–æ—Å—Ç—å —É–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è:
  // - CSS: .mini-mode .mini-now { display:flex } (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é —Å–∫—Ä—ã—Ç–∞)
  // - JS: updateMiniNowHeader() (–¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ –≤—ã—Å—Ç–∞–≤–ª—è–µ—Ç display –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏)
  block.innerHTML = `
    <div class="mini-now" id="mini-now" onclick="openPlayingAlbumFromMini(event)">
      <span class="tnum" id="mini-now-num">--.</span>
      <span class="track-title" id="mini-now-title">‚Äî</span>
      <img src="img/star2.png" class="like-star" id="mini-now-star"
           alt="–∑–≤–µ–∑–¥–∞" title="–î–æ–±–∞–≤–∏—Ç—å –≤ –ø–æ–Ω—Ä–∞–≤–∏–≤—à–∏–µ—Å—è"
           onclick="toggleLikePlayingFromMini(event)"/>
    </div>
    <div id="lyrics-window" class="lyrics-normal">
      <div class="lyrics-animated-bg${animationEnabled ? ' active' : ''}"></div>
      <div class="lyrics-scroll" id="lyrics"></div>
    </div>
    <div class="player-progress-wrapper">
      <div class="player-progress-bar" id="player-progress-bar"><div class="player-progress-fill" id="player-progress-fill"><div class="player-progress-handle"></div></div></div>
    </div>
    <div class="audio-wrapper"><audio id="audio" preload="metadata" playsinline crossorigin="anonymous" aria-hidden="true" tabindex="-1"></audio></div>
    <div class="player-controls" role="group" aria-label="–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ–º">
      <div class="player-controls-row">
        <span class="time-in-controls" id="time-elapsed">00:00</span>
        <button class="player-control-btn" onclick="previousTrack()" title="–ü—Ä–µ–¥—ã–¥—É—â–∏–π —Ç—Ä–µ–∫ (P)" aria-label="–ü—Ä–µ–¥—ã–¥—É—â–∏–π —Ç—Ä–µ–∫"><svg viewBox="0 0 24 24" fill="currentColor"><path d="M11 5L4 12l7 7V5zm9 0v14l-7-7 7-7z"/></svg></button>
        <button class="player-control-btn main" onclick="togglePlayPause()" title="–í–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ/–ü–∞—É–∑–∞ (K/–ü—Ä–æ–±–µ–ª)" aria-label="–í–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ/–ü–∞—É–∑–∞"><svg id="play-pause-icon" viewBox="0 0 24 24" fill="currentColor"><path d="M8 5v14l11-7z"/></svg></button>
        <button class="player-control-btn" onclick="stopPlayback()" title="–°—Ç–æ–ø (X)" aria-label="–°—Ç–æ–ø"><svg viewBox="0 0 24 24" fill="currentColor"><rect x="6" y="6" width="12" height="12"/></svg></button>
        <button class="player-control-btn" onclick="nextTrack()" title="–°–ª–µ–¥—É—é—â–∏–π —Ç—Ä–µ–∫ (N)" aria-label="–°–ª–µ–¥—É—é—â–∏–π —Ç—Ä–µ–∫"><svg viewBox="0 0 24 24" fill="currentColor"><path d="M13 5l7 7-7 7V5zM4 5v14l7-7-7-7z"/></svg></button>
        <span class="time-in-controls" id="time-remaining">--:--</span>
      </div>
      <div class="player-controls-row">
        <button class="player-control-btn" id="mute-btn" onclick="toggleMute()" title="–ë–µ–∑ –∑–≤—É–∫–∞ (M)" aria-label="–ë–µ–∑ –∑–≤—É–∫–∞"><svg viewBox="0 0 24 24" fill="currentColor"><path d="M3 9v6h4l5 5V4L7 9H3zm13.5 3c0-1.77-1.02-3.29-2.5-4.03v8.05c1.48-.73 2.5-2.25 2.5-4.02z"/></svg></button>
        <button class="player-control-btn${shuffleMode?' active':''}" id="shuffle-btn" onclick="toggleShuffle()" title="–°–ª—É—á–∞–π–Ω—ã–π –ø–æ—Ä—è–¥–æ–∫ (U)" aria-label="Shuffle"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 17h2.735a4 4 0 003.43-1.942l3.67-6.116A4 4 0 0116.265 7H21m0 0l-3-3m3 3l-3 3"/><path d="M3 7h2.735a4 4 0 013.43 1.942l3.67 6.116A4 4 0 0016.265 17H21m0 0l-3 3m3-3l-3-3"/></svg></button>
        <button class="player-control-btn animation-btn${animationEnabled?' animation-active':''}" id="animation-btn" onclick="toggleAnimation()" title="–ê–Ω–∏–º–∞—Ü–∏—è –ª–∏—Ä–∏–∫–∏ (A)" aria-label="–ê–Ω–∏–º–∞—Ü–∏—è">A</button>
        <button class="player-control-btn bit-btn${bitEnabled?' bit-active':''}" id="bit-btn" onclick="toggleBit()" title="–ü—É–ª—å—Å–∞—Ü–∏—è –ª–æ–≥–æ—Ç–∏–ø–∞ (B)" aria-label="–ü—É–ª—å—Å–∞—Ü–∏—è">B</button>
        <button class="player-control-btn${repeatMode?' repeat-active':''}" id="repeat-btn" onclick="toggleRepeat()" title="–ü–æ–≤—Ç–æ—Ä —Ç—Ä–µ–∫–∞ (R)" aria-label="–ü–æ–≤—Ç–æ—Ä"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M17 2l4 4-4 4"/><path d="M3 11V9a4 4 0 014-4h14"/><path d="M7 22l-4-4 4-4"/><path d="M21 13v2a4 4 0 01-4 4H3"/><circle cx="12" cy="12" r="1" fill="currentColor"/></svg></button>
        <button class="sleep-timer-btn" id="sleep-timer-btn" onclick="toggleSleepMenu()" title="–¢–∞–π–º–µ—Ä —Å–Ω–∞ (T)" aria-label="–¢–∞–π–º–µ—Ä —Å–Ω–∞">
          <svg viewBox="0 0 24 24" width="24" height="24" aria-hidden="true">
            <circle cx="12" cy="12" r="9" fill="none" stroke="currentColor" stroke-width="2"></circle>
            <path d="M12 7v5l3 3" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"></path>
          </svg>
          <span class="sleep-timer-badge" id="sleep-timer-badge" style="display:none;">0</span>
          <div class="sleep-menu" id="sleep-menu">
            <div class="sleep-menu-item" onclick="setSleepTimer('off')">–í—ã–∫–ª—é—á–∏—Ç—å</div>
            <div class="sleep-menu-item" onclick="setSleepTimer(15)">15 –º–∏–Ω—É—Ç</div>
            <div class="sleep-menu-item" onclick="setSleepTimer(30)">30 –º–∏–Ω—É—Ç</div>
            <div class="sleep-menu-item" onclick="setSleepTimer(60)">60 –º–∏–Ω—É—Ç</div>
            <div class="sleep-menu-item" onclick="showTimePickerForSleep()">–ö –≤—Ä–µ–º–µ–Ω–∏...</div>
          </div>
        </button>
        <button class="player-control-btn${favoritesOnlyMode?' favorites-active':''}" id="favorites-btn" onclick="toggleFavoritesOnly()" title="–¢–æ–ª—å–∫–æ –∏–∑–±—Ä–∞–Ω–Ω—ã–µ (F)" aria-label="–ò–∑–±—Ä–∞–Ω–Ω—ã–µ"><img src="img/${favoritesOnlyMode?'star.png':'star2.png'}" alt="‚òÖ" id="favorites-btn-icon"/></button>
      </div>
    </div>
    <div class="volume-control-wrapper">
      <div class="volume-track"></div><div class="volume-fill" id="volume-fill"></div>
      <input type="range" class="volume-slider" id="volume-slider" min="0" max="100" value="100" aria-label="–ì—Ä–æ–º–∫–æ—Å—Ç—å" aria-valuemin="0" aria-valuemax="100" aria-valuenow="100">
    </div>
    <div class="next-up" id="next-up"><span class="label">–°–ª–µ–¥—É—é—â–∞—è:</span> <span class="title">‚Äî</span></div>
    <div class="player-buttons-wrapper">
      <button class="lyrics-toggle-btn lyrics-normal" onclick="toggleLyricsView()" aria-label="–°–∫—Ä—ã—Ç—å –ª–∏—Ä–∏–∫—É" title="–°–∫—Ä—ã—Ç—å –ª–∏—Ä–∏–∫—É (Y)"><span class="lyrics-toggle-btn-visual">–¢</span></button>
      <button class="karaoke-btn" onclick="openLyricsModal()">–¢–ï–ö–°–¢</button>
      <a class="player-download-btn" href="#" onclick="openDownloadModal(event)">–°–ö–ê–ß–ê–¢–¨ –ü–ï–°–ù–Æ</a>
    </div>
  `;

  const pc = getPlayerConfig();
  const tr = pc?.tracks?.[playingTrack];
  if (!tr) return;

  const audioEl = document.getElementById('audio');
  if (__currentAudio && __currentAudio !== audioEl) stopAndCleanupAudio(__currentAudio);
  __currentAudio = audioEl;
  audioEl.src = tr.audio;

  // –û–±–Ω–æ–≤–ª—è–µ–º playbackState –¥–ª—è Media Session (—ç–∫—Ä–∞–Ω—ã –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏/–≥–∞—Ä–Ω–∏—Ç—É—Ä—ã)
  attachPlaybackStateListeners();

  if (bitEnabled) {
    try { initAudioContext(); startLogoPulsation(); } catch(e) {}
  }

  loadLyrics(tr.lyrics);
  setupMediaSession();
  restorePlayerButtonsState();
  applyLyricsViewMode();
  initializePlayerControls();
  prefetchNextTrackAssets();

  audioEl.addEventListener('loadedmetadata', onAudioMetadataLoaded);
  audioEl.addEventListener('timeupdate', onAudioTimeUpdate);
  audioEl.addEventListener('ended', onAudioEnded);

  applyMiniModeUI();
  updateNextUpLabel();
  updateMiniNowHeader();

  // –ü–æ–¥—Å—Ç—Ä–∞—Ö–æ–≤–∫–∞ –æ—Ç –≤–æ–∑–º–æ–∂–Ω—ã—Ö –¥—É–±–ª–µ–π
  dedupePlayerBlock();
}

/* ====== –õ–∏—Ä–∏–∫–∞ ====== */
let lyricsViewMode = 'normal';
function restoreLyricsViewMode() {
  try {
    const saved = localStorage.getItem('lyricsViewMode');
    if (saved && ['normal','hidden','expanded'].includes(saved)) lyricsViewMode = saved;
  } catch {}
}
function saveLyricsViewMode() { try { localStorage.setItem('lyricsViewMode', lyricsViewMode); } catch {} }
restoreLyricsViewMode();

function renderLyrics(time) {
  if (!currentLyrics || !currentLyrics.length) {
    const el = document.getElementById('lyrics');
    if (el) el.innerHTML = '';
    return;
  }
  // –†–∞–∑–º–µ—Ä –æ–∫–Ω–∞: normal = 5 —Å—Ç—Ä–æ–∫, expanded = 9 —Å—Ç—Ä–æ–∫
  const windowSize = (lyricsViewMode === 'expanded') ? 9 : 5;
  const centerLine = Math.floor(windowSize / 2);

  // –û–ø—Ä–µ–¥–µ–ª—è–µ–º –∞–∫—Ç–∏–≤–Ω—É—é —Å—Ç—Ä–æ–∫—É –ø–æ –≤—Ä–µ–º–µ–Ω–∏
  let active = 0;
  for (let i = 0; i < currentLyrics.length; i++) {
    if (time >= currentLyrics[i].time) active = i;
  }

  const start = Math.max(0, active - centerLine);
  const padTop = Math.max(0, centerLine - active);
  const rows = [];

  // –ü—É—Å—Ç—ã–µ —Å—Ç—Ä–æ–∫–∏ —Å–≤–µ—Ä—Ö—É (–∫–æ–≥–¥–∞ –∞–∫—Ç–∏–≤–Ω–∞—è –±–ª–∏–∑–∫–æ –∫ –Ω–∞—á–∞–ª—É)
  for (let p = 0; p < padTop; ++p) rows.push('<div class="lyrics-window-line"></div>');

  // –û—Å–Ω–æ–≤–Ω—ã–µ —Å—Ç—Ä–æ–∫–∏
  for (let i = start; i < Math.min(currentLyrics.length, start + windowSize - padTop); i++) {
    const cls = (i === active) ? 'lyrics-window-line active' : 'lyrics-window-line';
    rows.push(`<div class="${cls}">${currentLyrics[i] ? currentLyrics[i].line : ''}</div>`);
  }

  // –ü—É—Å—Ç—ã–µ —Å—Ç—Ä–æ–∫–∏ —Å–Ω–∏–∑—É –¥–æ –ø–æ–ª–Ω–æ–≥–æ –æ–∫–Ω–∞
  while (rows.length < windowSize) rows.push('<div class="lyrics-window-line"></div>');

  const lyricsEl = document.getElementById('lyrics');
  if (lyricsEl) lyricsEl.innerHTML = rows.join('');
}
function renderLyricsEnhanced(t){ if (lyricsViewMode==='hidden') return; renderLyrics(t); }
function copyLyrics(){
  const pc = getPlayerConfig();
  const idx = (typeof playingTrack === 'number' && playingTrack >= 0) ? playingTrack : currentTrack;
  if (!pc || !pc.tracks || idx < 0 || !pc.tracks[idx] || !pc.tracks[idx].fulltext) { 
    NotificationSystem.warning('–§–∞–π–ª —Å —Ç–µ–∫—Å—Ç–æ–º –Ω–µ –Ω–∞–π–¥–µ–Ω!');
    return;
  }
  fetch(pc.tracks[idx].fulltext).then(r=>r.text()).then(txt=>{
    if (navigator.clipboard && window.isSecureContext) {
      navigator.clipboard.writeText(txt).then(()=>NotificationSystem.success('–¢–µ–∫—Å—Ç —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω!'),()=>NotificationSystem.error('–ù–µ —É–¥–∞–ª–æ—Å—å —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å'));
    } else {
      const ta=document.createElement('textarea'); ta.value=txt; document.body.appendChild(ta); ta.select();
      try { document.execCommand('copy'); NotificationSystem.success('–¢–µ–∫—Å—Ç —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω!'); } catch { NotificationSystem.error('–ù–µ —É–¥–∞–ª–æ—Å—å —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å'); }
      document.body.removeChild(ta);
    }
  }).catch(()=> NotificationSystem.error('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å —Ç–µ–∫—Å—Ç!'));
}

function toggleLyricsView(){
  const modes=['normal','hidden','expanded'];
  lyricsViewMode = modes[(modes.indexOf(lyricsViewMode)+1)%modes.length];
  applyLyricsViewMode();
  saveLyricsViewMode();
  const msg = {normal:'üìù –û–±—ã—á–Ω—ã–π –≤–∏–¥ –ª–∏—Ä–∏–∫–∏', hidden:'üö´ –õ–∏—Ä–∏–∫–∞ —Å–∫—Ä—ã—Ç–∞', expanded:'üìñ –†–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–π –≤–∏–¥ –ª–∏—Ä–∏–∫–∏'}[lyricsViewMode];
  NotificationSystem.info(msg);
}
function applyLyricsViewMode(){
  const w=document.getElementById('lyrics-window'), btn=document.querySelector('.lyrics-toggle-btn');
  if (!w||!btn) return;
  w.classList.remove('lyrics-normal','lyrics-hidden','lyrics-expanded'); btn.classList.remove('lyrics-normal','lyrics-hidden','lyrics-expanded');
  w.classList.add(`lyrics-${lyricsViewMode}`); btn.classList.add(`lyrics-${lyricsViewMode}`);
}

/* ====== –ö–æ–Ω—Ç—Ä–æ–ª—ã –ø–ª–µ–µ—Ä–∞ ====== */
let lastTimeUpdate = 0, isSeekingProgress=false, isMuted=false, sleepTimerInterval=null, sleepTimerTarget=null;

function initializePlayerControls() {
  const progressBar = document.getElementById('player-progress-bar');
  if (progressBar) {
    progressBar.addEventListener('click', seekToPosition);
    const startDrag = (e)=>{
      isSeekingProgress = true;
      const moveHandler = (e2) => {
        const rect = progressBar.getBoundingClientRect();
        const clientX = e2.touches ? e2.touches[0].clientX : e2.clientX;
        const percent = Math.max(0, Math.min(1, (clientX - rect.left) / rect.width));
        document.getElementById('player-progress-fill').style.width = `${percent*100}%`;
      };
      const endHandler = (e3) => {
        const rect = progressBar.getBoundingClientRect();
        const clientX = e3.changedTouches ? e3.changedTouches[0].clientX : e3.clientX;
        const percent = Math.max(0, Math.min(1, (clientX - rect.left) / rect.width));
        const audio = document.getElementById('audio');
        audio.currentTime = (audio.duration || 0) * percent;
        isSeekingProgress = false;
        document.removeEventListener('mousemove', moveHandler);
        document.removeEventListener('mouseup', endHandler);
        document.removeEventListener('touchmove', moveHandler);
        document.removeEventListener('touchend', endHandler);
      };
      document.addEventListener('mousemove', moveHandler);
      document.addEventListener('mouseup', endHandler);
      document.addEventListener('touchmove', moveHandler, {passive:false});
      document.addEventListener('touchend', endHandler);
      e.preventDefault();
    };
    progressBar.addEventListener('mousedown', startDrag);
    progressBar.addEventListener('touchstart', startDrag, {passive:false});
  }

  const volumeSlider = document.getElementById('volume-slider');
  if (volumeSlider) {
    volumeSlider.addEventListener('input', onVolumeSliderChange);
    const savedVolumeRaw = localStorage.getItem('playerVolume');
    const savedVolume = parseFloat(savedVolumeRaw);
    const volume = Number.isFinite(savedVolume) ? savedVolume : 1;
    volumeSlider.value = Math.round(volume * 100);
    updateVolumeUI(volume);
    const audio = document.getElementById('audio');
    if (audio) audio.volume = volume;
  }
}

function onAudioMetadataLoaded(e) {
  const audio = (e && (e.currentTarget || e.target)) || document.getElementById('audio');
  if (!audio) return;
  const duration = audio.duration || 0;
  const elapsedEl = document.getElementById('time-elapsed');
  const remainingEl = document.getElementById('time-remaining');
  if (elapsedEl) elapsedEl.textContent = '00:00';
  if (remainingEl) remainingEl.textContent = formatTime(duration);
}
function onAudioTimeUpdate(e) {
  const audio = (e && (e.currentTarget || e.target)) || document.getElementById('audio');
  if (!audio) return;
  const currentTime = audio.currentTime || 0;
  const duration = audio.duration || 0;

  if (!isSeekingProgress && duration > 0) {
    const fill = document.getElementById('player-progress-fill');
    if (fill) fill.style.width = `${(currentTime / duration) * 100}%`;
  }
  renderLyricsEnhanced(currentTime);

  const now = Date.now();
  if (now - lastTimeUpdate >= 1000) {
    lastTimeUpdate = now;
    const elapsedEl = document.getElementById('time-elapsed');
    const remainingEl = document.getElementById('time-remaining');
    if (elapsedEl) elapsedEl.textContent = formatTime(currentTime);
    if (remainingEl) remainingEl.textContent = formatTime(Math.max(0, duration - currentTime));
    // –†–∞–∑ –≤ —Å–µ–∫—É–Ω–¥—É —Å–æ—Ö—Ä–∞–Ω—è–µ–º –ø—Ä–æ–≥—Ä–µ—Å—Å –ø—Ä–æ—Å–ª—É—à–∏–≤–∞–Ω–∏—è
    try { PlayerState.save(); } catch {}
  }
  updatePlayPauseIcon();
}
function onAudioEnded(e) {
  const remainingEl = document.getElementById('time-remaining');
  if (remainingEl) remainingEl.textContent = '00:00';
  const audio = (e && (e.currentTarget || e.target)) || document.getElementById('audio');
  if (repeatMode && audio) {
    audio.currentTime = 0;
    const p = audio.play();
    if (p && p.catch) p.catch(()=>{});
  } else {
    nextTrack();
  }
}

function seekToPosition(e) {
  const audio = document.getElementById('audio');
  if (!audio || !isFinite(audio.duration) || audio.duration <= 0) return;
  const rect = e.currentTarget.getBoundingClientRect();
  const clientX = e.clientX ?? (e.touches && e.touches[0] && e.touches[0].clientX);
  if (typeof clientX !== 'number') return;
  const percent = Math.max(0, Math.min(1, (clientX - rect.left) / rect.width));
  audio.currentTime = audio.duration * percent;
}
function onVolumeSliderChange(e) {
  const value = (e && e.target ? e.target.value : 100) / 100;
  const audio = document.getElementById('audio');
  if (audio) audio.volume = value;
  updateVolumeUI(value);
  try { localStorage.setItem('playerVolume', value); } catch {}
}
function updateVolumeUI(volume){
  const percent = Math.max(0, Math.min(100, Math.round(volume * 100)));
  const vf = document.getElementById('volume-fill');
  if (vf) {
    vf.style.width = `${percent}%`;
  }
}
function toggleMute() {
  const audio = document.getElementById('audio');
  if (!audio) return;
  if (isMuted) {
    const saved = parseFloat(localStorage.getItem('playerVolume'));
    audio.volume = Number.isFinite(saved) && saved > 0 ? saved : 1;
    isMuted = false;
  } else {
    try { localStorage.setItem('playerVolume', audio.volume); } catch {}
    audio.volume = 0;
    isMuted = true;
  }
  updateVolumeUI(audio.volume);
}
function togglePlayPause() {
  const a = getCurrentAudio(); if (!a) return;
  if (a.paused) { a.play().catch(()=>{}); } else { a.pause(); }
}
function updatePlayPauseIcon() {
  const a = document.getElementById('audio'), icon = document.getElementById('play-pause-icon'); if (!a || !icon) return;
  icon.innerHTML = a.paused ? '<path d="M8 5v14l11-7z"/>' : '<path d="M6 6h4v12H6zM14 6h4v12h-4z"/>';
}
function stopPlayback(){
  const a = getCurrentAudio(); if (!a) return;
  a.pause(); a.currentTime = 0; updatePlayPauseIcon();
}
function toggleRepeat(){ repeatMode = !repeatMode; const btn=document.getElementById('repeat-btn'); if (repeatMode) btn.classList.add('repeat-active'); else btn.classList.remove('repeat-active'); localStorage.setItem('repeatMode', repeatMode?'1':'0'); }
function toggleShuffle(){
  shuffleMode = !shuffleMode;
  const btn = document.getElementById('shuffle-btn');
  if (shuffleMode) {
    btn && btn.classList.add('active');
    if (isBrowsingOtherAlbum()) createPlayingShuffledPlaylist(); else createShuffledPlaylist();
    NotificationSystem.info('üîÄ –°–ª—É—á–∞–π–Ω—ã–π –ø–æ—Ä—è–¥–æ–∫');
  } else {
    btn && btn.classList.remove('active');
    NotificationSystem.info('–ü–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ');
  }
  localStorage.setItem('shuffleMode', shuffleMode ? '1' : '0');
  updateNextUpLabel();
}

function toggleFavoritesOnly(){
  const btn = document.getElementById('favorites-btn');
  const icon = document.getElementById('favorites-btn-icon');

  favoritesOnlyMode = !favoritesOnlyMode;
  if (favoritesOnlyMode) {
    btn && btn.classList.add('favorites-active');
    if (icon) icon.src = 'img/star.png';
    NotificationSystem.success('‚≠ê –¢–æ–ª—å–∫–æ –∏–∑–±—Ä–∞–Ω–Ω—ã–µ');
  } else {
    btn && btn.classList.remove('favorites-active');
    if (icon) icon.src = 'img/star2.png';
    NotificationSystem.info('–ò–≥—Ä–∞—é—Ç –≤—Å–µ —Ç—Ä–µ–∫–∏');
  }
  localStorage.setItem('favoritesOnlyMode', favoritesOnlyMode ? '1' : '0');

  // –ï—Å–ª–∏ –º—ã –≤ –ò–ó–ë–†–ê–ù–ù–û–ú (–ø—Ä–æ—Å–º–æ—Ç—Ä –∏–ª–∏ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ) ‚Äî —Ñ–∏–ª—å—Ç—Ä —Ä–∞–±–æ—Ç–∞–µ—Ç –¥–ª—è —Å–ø–∏—Å–∫–∞ –∏ –¥–ª—è –¥–æ—Å—Ç—É–ø–Ω—ã—Ö —Ç—Ä–µ–∫–æ–≤
  if (viewMode === 'favorites') {
    const list = document.getElementById('track-list');
    const filterBtn = document.getElementById('filter-favorites-btn');
    favoritesFilterActive = favoritesOnlyMode;
    if (favoritesFilterActive) {
      filterBtn && filterBtn.classList.add('filtered');
      if (filterBtn) filterBtn.textContent = '–ü–û–ö–ê–ó–ê–¢–¨ –í–°–ï –ü–ï–°–ù–ò';
      list && list.classList.add('filtered');
      updateFavoriteClassesFavorites();
    } else {
      filterBtn && filterBtn.classList.remove('filtered');
      if (filterBtn) filterBtn.textContent = '–°–∫—Ä—ã—Ç—å –Ω–µ –æ—Ç–º–µ—á–µ–Ω–Ω—ã–µ ‚≠ê –ø–µ—Å–Ω–∏';
      list && list.classList.remove('filtered');
    }
  }

  // –ü–µ—Ä–µ—Å–æ–±—Ä–∞—Ç—å –¥–æ—Å—Ç—É–ø–Ω—ã–µ —Ç—Ä–µ–∫–∏ –¥–ª—è –∏–≥—Ä–∞—é—â–µ–≥–æ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞
  if (playingAlbumKey) {
    if (isBrowsingOtherAlbum() || playingAlbumKey === SPECIAL_FAVORITES_KEY) {
      if (shuffleMode) createPlayingShuffledPlaylist();
      updateNextUpLabel();
    } else {
      updateAvailableTracks();
      if (shuffleMode) createShuffledPlaylist();
      updateNextUpLabel();
    }
  }
}

function updateAvailableTracks(){
  const pc = getPlayerConfig();
  if (!pc || !Array.isArray(pc.tracks)) { availableTracks = []; return; }

  // –ï—Å–ª–∏ –∏–≥—Ä–∞–µ—Ç ¬´–ò–ó–ë–†–ê–ù–ù–û–ï¬ª ‚Äî –∏—Å–ø–æ–ª—å–∑—É–µ–º —Ç–æ–ª—å–∫–æ –∞–∫—Ç–∏–≤–Ω—ã–µ –∏–Ω–¥–µ–∫—Å—ã
  if (playingAlbumKey === SPECIAL_FAVORITES_KEY && Array.isArray(favoritesRefsModel)) {
    const activeIdx = [];
    favoritesRefsModel.forEach((x, i) => { if (x.__active) activeIdx.push(i); });
    availableTracks = activeIdx;
    return;
  }

  // –û–±—ã—á–Ω—ã–µ –∞–ª—å–±–æ–º—ã
  availableTracks = favoritesOnlyMode
    ? getLikedForPlayback()
    : Array.from({ length: pc.tracks.length }, (_, i) => i);
}

function getNextFavoriteTrack(){
  const liked = getLikedForPlayback();
  if (!liked.length) return -1;
  const pos = liked.indexOf(playingTrack);
  return pos !== -1 && pos < liked.length - 1 ? liked[pos + 1] : liked[0];
}
// –ò—Å–ø–æ–ª—å–∑—É–µ–º –∫–æ–Ω—Ç–µ–∫—Å—Ç —Ä–µ–∞–ª—å–Ω–æ–≥–æ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è, –µ—Å–ª–∏:
// - –∏–≥—Ä–∞–µ—Ç –ò–ó–ë–†–ê–ù–ù–û–ï, –ª–∏–±–æ
// - –º—ã —Å–º–æ—Ç—Ä–∏–º –æ–¥–∏–Ω –∞–ª—å–±–æ–º, –∞ –∏–≥—Ä–∞–µ—Ç –¥—Ä—É–≥–æ–π.
function shouldUsePlaybackContext() {
  return playingAlbumKey === SPECIAL_FAVORITES_KEY || isBrowsingOtherAlbum();
}

function previousTrack(){
  if (repeatMode) {
    const a = document.getElementById('audio');
    if (a) { a.currentTime = 0; a.play().catch(()=>{}); }
    return;
  }

  // –í–ê–ñ–ù–û: –µ—Å–ª–∏ –∏–≥—Ä–∞–µ—Ç –ò–ó–ë–†–ê–ù–ù–û–ï –∏–ª–∏ –º—ã —Å–º–æ—Ç—Ä–∏–º –Ω–µ —Ç–æ—Ç –∞–ª—å–±–æ–º, —á—Ç–æ –∏–≥—Ä–∞–µ—Ç,
  // —Ä–∞–±–æ—Ç–∞–µ–º —Å—Ç—Ä–æ–≥–æ –≤–Ω—É—Ç—Ä–∏ "–∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è"
  if (shouldUsePlaybackContext()) {
    const len = playingTracks ? playingTracks.length : 0;
    const available = getAvailableTracksForAlbum(playingAlbumKey, len);
    if (!available.length) { NotificationSystem.warning('–ù–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã—Ö —Ç—Ä–µ–∫–æ–≤'); return; }

    if (shuffleMode) {
      playingShuffleIndex = Math.max(0, playingShuffleIndex - 1);
      const cand = playingShuffledPlaylist[playingShuffleIndex] ?? available[0];
      playFromPlaybackAlbum(cand, true);
      return;
    }

    if (favoritesOnlyMode) {
      const idx = available.indexOf(playingTrack);
      const prev = idx > 0 ? available[idx - 1] : available[available.length - 1];
      playFromPlaybackAlbum(prev, true);
      return;
    }

    const prev = playingTrack > 0 ? playingTrack - 1 : (len - 1);
    playFromPlaybackAlbum(prev, true);
    return;
  }

  // –û–±—ã—á–Ω—ã–π —Å—Ü–µ–Ω–∞—Ä–∏–π (–∏–≥—Ä–∞–µ—Ç –ø—Ä–æ—Å–º–∞—Ç—Ä–∏–≤–∞–µ–º—ã–π –∞–ª—å–±–æ–º)
  updateAvailableTracks();
  if (!availableTracks.length) { NotificationSystem.warning('–ù–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã—Ö —Ç—Ä–µ–∫–æ–≤'); return; }

  if (shuffleMode) {
    shuffleIndex = Math.max(0, shuffleIndex - 1);
    showTrack(shuffledPlaylist[shuffleIndex] || availableTracks[0], true);
    return;
  }

  if (favoritesOnlyMode) {
    const idx = availableTracks.indexOf(currentTrack);
    const prev = idx > 0 ? availableTracks[idx - 1] : availableTracks[availableTracks.length - 1];
    showTrack(prev, true);
    return;
  }

  const prev = currentTrack > 0 ? currentTrack - 1 : (config.tracks.length - 1);
  showTrack(prev, true);
}

function nextTrack(){
  if (repeatMode) {
    const a = document.getElementById('audio');
    if (a) { a.currentTime = 0; a.play().catch(()=>{}); }
    return;
  }

  // –í–ê–ñ–ù–û: –µ—Å–ª–∏ –∏–≥—Ä–∞–µ—Ç –ò–ó–ë–†–ê–ù–ù–û–ï –∏–ª–∏ –º—ã —Å–º–æ—Ç—Ä–∏–º –Ω–µ —Ç–æ—Ç –∞–ª—å–±–æ–º, —á—Ç–æ –∏–≥—Ä–∞–µ—Ç,
  // —Ä–∞–±–æ—Ç–∞–µ–º —Å—Ç—Ä–æ–≥–æ –≤–Ω—É—Ç—Ä–∏ "–∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è"
  if (shouldUsePlaybackContext()) {
    const len = playingTracks ? playingTracks.length : 0;
    const available = getAvailableTracksForAlbum(playingAlbumKey, len);
    if (!available.length) { NotificationSystem.warning('–ù–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã—Ö —Ç—Ä–µ–∫–æ–≤'); return; }

    if (shuffleMode) {
      if (!Array.isArray(playingShuffledPlaylist) || playingShuffledPlaylist.length === 0) {
        createPlayingShuffledPlaylist();
      }
      playingShuffleIndex++;
      if (playingShuffleIndex >= playingShuffledPlaylist.length) {
        createPlayingShuffledPlaylist();
        playingShuffleIndex = 0;
      }
      let candidate = playingShuffledPlaylist[playingShuffleIndex];
      if (available.length > 1 && candidate === playingTrack) {
        playingShuffleIndex = (playingShuffleIndex + 1) % playingShuffledPlaylist.length;
        candidate = playingShuffledPlaylist[playingShuffleIndex];
      }
      playFromPlaybackAlbum(candidate, true);
      return;
    }

    if (favoritesOnlyMode) {
      const idx = available.indexOf(playingTrack);
      const next = available[(idx + 1) % available.length];
      playFromPlaybackAlbum(next, true);
      return;
    }

    const n = (playingTrack + 1) % len;
    playFromPlaybackAlbum(n, true);
    return;
  }

  // –û–±—ã—á–Ω—ã–π —Å—Ü–µ–Ω–∞—Ä–∏–π (–∏–≥—Ä–∞–µ—Ç –ø—Ä–æ—Å–º–∞—Ç—Ä–∏–≤–∞–µ–º—ã–π –∞–ª—å–±–æ–º)
  updateAvailableTracks();
  if (!availableTracks.length) { NotificationSystem.warning('–ù–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã—Ö —Ç—Ä–µ–∫–æ–≤'); return; }

  if (shuffleMode) {
    if (!Array.isArray(shuffledPlaylist) || shuffledPlaylist.length === 0) createShuffledPlaylist();
    shuffleIndex++;
    if (shuffleIndex >= shuffledPlaylist.length) { createShuffledPlaylist(); shuffleIndex = 0; }
    let candidate = shuffledPlaylist[shuffleIndex];
    if (availableTracks.length > 1 && candidate === currentTrack) {
      shuffleIndex = (shuffleIndex + 1) % shuffledPlaylist.length;
      candidate = shuffledPlaylist[shuffleIndex];
    }
    showTrack(candidate, true);
    return;
  }

  if (favoritesOnlyMode) {
    const idx = availableTracks.indexOf(currentTrack);
    const next = availableTracks[(idx + 1 + availableTracks.length) % availableTracks.length];
    showTrack(next, true);
    return;
  }

  const n = (currentTrack + 1) % config.tracks.length;
  showTrack(n, true);
}

function createShuffledPlaylist(){
  updateAvailableTracks();
  shuffledPlaylist = [...availableTracks];

  const i = shuffledPlaylist.indexOf(currentTrack);
  if (i !== -1) shuffledPlaylist.splice(i, 1);

  for (let j = shuffledPlaylist.length - 1; j > 0; j--) {
    const k = Math.floor(Math.random() * (j + 1));
    [shuffledPlaylist[j], shuffledPlaylist[k]] = [shuffledPlaylist[k], shuffledPlaylist[j]];
  }

  if (availableTracks.includes(currentTrack)) shuffledPlaylist.unshift(currentTrack);
  shuffleIndex = 0;
}

/* ====== –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ ‚Äî –¥–ª—è –∏–≥—Ä–∞—é—â–µ–≥–æ –∞–ª—å–±–æ–º–∞ ====== */
function getAvailableTracksForAlbum(albumKey, tracksLen) {
  if (!tracksLen || tracksLen <= 0) return [];

  if (albumKey === SPECIAL_FAVORITES_KEY) {
    // –í ¬´–ò–ó–ë–†–ê–ù–ù–û–ú¬ª –æ—á–µ—Ä–µ–¥—å –í–°–ï–ì–î–ê —Å–æ—Å—Ç–æ–∏—Ç —Ç–æ–ª—å–∫–æ –∏–∑ –∞–∫—Ç–∏–≤–Ω—ã—Ö (__active)
    if (!Array.isArray(favoritesRefsModel)) return [];
    const activeIdx = [];
    favoritesRefsModel.forEach((x, i) => { if (x.__active) activeIdx.push(i); });
    return activeIdx;
  }

  // –û–±—ã—á–Ω—ã–µ –∞–ª—å–±–æ–º—ã
  if (favoritesOnlyMode) {
    const liked = getLikedForAlbum(albumKey).filter(n => Number.isInteger(n) && n >= 0 && n < tracksLen);
    return liked.length ? liked : Array.from({length: tracksLen}, (_,i)=>i);
  }
  return Array.from({length: tracksLen}, (_,i)=>i);
}

function createPlayingShuffledPlaylist() {
  const len = playingTracks ? playingTracks.length : 0;
  const available = getAvailableTracksForAlbum(playingAlbumKey, len);
  playingShuffledPlaylist = [...available];

  const i = playingShuffledPlaylist.indexOf(playingTrack);
  if (i !== -1) playingShuffledPlaylist.splice(i, 1);

  for (let j = playingShuffledPlaylist.length - 1; j > 0; j--) {
    const k = Math.floor(Math.random() * (j + 1));
    [playingShuffledPlaylist[j], playingShuffledPlaylist[k]] = [playingShuffledPlaylist[k], playingShuffledPlaylist[j]];
  }

  if (available.includes(playingTrack)) playingShuffledPlaylist.unshift(playingTrack);
  playingShuffleIndex = 0;
}

function playFromPlaybackAlbum(idx, doPlay) {
  currentTrack = idx;
  playingTrack = idx;

  // –≥–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ–º –Ω–∞–ª–∏—á–∏–µ –ø–ª–µ–µ—Ä–∞
  if (!document.getElementById('lyricsplayerblock')) {
    const holder = document.getElementById('now-playing');
    if (holder) {
      holder.innerHTML = '<div class="lyrics-player-block" id="lyricsplayerblock"></div>';
      renderLyricsBlock();
    }
  }

  // –ï—Å–ª–∏ –∏–≥—Ä–∞–µ—Ç –ò–ó–ë–†–ê–ù–ù–û–ï –∏ –º—ã —Å–º–æ—Ç—Ä–∏–º —Å–ø–∏—Å–æ–∫ ¬´–ò–ó–ë–†–ê–ù–ù–û–ì–û¬ª ‚Äî –ø–µ—Ä–µ–º–µ—Å—Ç–∏–º –ø–ª–µ–µ—Ä –ø–æ–¥ –Ω—É–∂–Ω—É—é —Å—Ç—Ä–æ–∫—É –∏ –ø–æ–¥—Å–≤–µ—Ç–∏–º –µ—ë
  if (playingAlbumKey === SPECIAL_FAVORITES_KEY && viewMode === 'favorites') {
    updateFavoritesCurrentRow(idx);
    const list = document.getElementById('track-list');
    const lp = document.getElementById('lyricsplayerblock');
    const rows = list ? list.querySelectorAll('.track') : [];
    const row = rows[idx];
    if (list && lp && row) {
      if (row.nextSibling) row.parentNode.insertBefore(lp, row.nextSibling); else row.parentNode.appendChild(lp);
    }
  }

  // –ü–æ–¥—Å—Ç—Ä–∞—Ö–æ–≤–∫–∞ –æ—Ç –≤–æ–∑–º–æ–∂–Ω—ã—Ö –¥—É–±–ª–µ–π –ø–ª–µ–π–µ—Ä–∞
  dedupePlayerBlock();

  const a = document.getElementById('audio');
  if (!a || !playingTracks) return;

  stopAndCleanupAudio(a);
  const tr = playingTracks[idx];
  a.src = tr.audio;

  loadLyrics(tr.lyrics);
  setupMediaSessionForPlayback();
  prefetchNextTrackAssetsForPlayback();

  if (doPlay) {
    a.currentTime = 0;
    a.play().catch(()=>{});
  }

  applyMiniModeUI();
  updateNextUpLabel();
  updateMiniNowHeader();
}

function setupMediaSessionForPlayback() {
  if (!('mediaSession' in navigator) || !playingTracks) return;
  const tr = playingTracks[playingTrack];
  if (!tr) return;

  navigator.mediaSession.metadata = new MediaMetadata({
    title: tr.title,
    artist: playingArtist || '–í–∏—Ç—Ä–∏–Ω–∞ –†–∞–∑–±–∏—Ç–∞',
    album: playingAlbumName || '–ê–ª—å–±–æ–º',
    artwork: [{ src: playingCover || 'img/logo.png', sizes: '512x512', type: 'image/png' }]
  });

  navigator.mediaSession.setActionHandler('play',  ()=>{ const a=document.getElementById('audio'); a&&a.play(); updatePlayPauseIcon(); });
  navigator.mediaSession.setActionHandler('pause', ()=>{ const a=document.getElementById('audio'); a&&a.pause(); updatePlayPauseIcon(); });
  navigator.mediaSession.setActionHandler('previoustrack', previousTrack);
  navigator.mediaSession.setActionHandler('nexttrack', nextTrack);
  navigator.mediaSession.setActionHandler('seekbackward', ()=>{ const a=document.getElementById('audio'); if (a) a.currentTime=Math.max(0,(a.currentTime||0)-10); });
  navigator.mediaSession.setActionHandler('seekforward', ()=>{ const a=document.getElementById('audio'); if (a) a.currentTime=Math.min(a.duration,(a.currentTime||0)+10); });
  navigator.mediaSession.setActionHandler('seekto', (details)=>{ const a=document.getElementById('audio'); if (a && typeof details.seekTime==='number') a.currentTime = details.seekTime; });
}

function computeNextIndexPlayback() {
  const len = playingTracks ? playingTracks.length : 0;
  const available = getAvailableTracksForAlbum(playingAlbumKey, len);
  if (!available.length) return -1;

  if (shuffleMode) {
    if (!Array.isArray(playingShuffledPlaylist) || playingShuffledPlaylist.length === 0) {
      createPlayingShuffledPlaylist();
    }
    const nextPos = Math.min(playingShuffleIndex + 1, Math.max(0, playingShuffledPlaylist.length - 1));
    return playingShuffledPlaylist[nextPos] ?? -1;
  }

  if (favoritesOnlyMode) {
    const i = available.indexOf(playingTrack);
    return available[(i + 1) % available.length];
  }

  return (playingTrack + 1) % len;
}

function updateNextUpLabel() {
  const box = document.getElementById('next-up');
  const lp = document.getElementById('lyricsplayerblock');
  if (!box || !lp) return;
  if (!isBrowsingOtherAlbum() || !playingTracks || !playingTracks.length) {
    box.style.display = 'none';
    return;
  }
  const cand = computeNextIndexPlayback();
  if (cand < 0) { box.style.display = 'none'; return; }
  const title = playingTracks[cand]?.title || '‚Äî';
  box.querySelector('.title').textContent = `${String(cand + 1).padStart(2, '0')}. ${title}`;
  box.querySelector('.title').title = `${String(cand + 1).padStart(2, '0')}. ${title}`;
  box.style.display = ''; // –ø–æ–∫–∞–∂–µ–º (mini-mode —É–ø—Ä–∞–≤–ª—è–µ—Ç —á–µ—Ä–µ–∑ CSS)
}

function applyMiniModeUI() {
  const lp = document.getElementById('lyricsplayerblock');
  if (!lp) return;

  // –ú–∏–Ω–∏-—Ä–µ–∂–∏–º: –∫–æ–≥–¥–∞ –∏–≥—Ä–∞–µ—Ç –æ–¥–∏–Ω –∫–æ–Ω—Ç–µ–∫—Å—Ç, –∞ –ø—Ä–æ—Å–º–∞—Ç—Ä–∏–≤–∞–µ–º –¥—Ä—É–≥–æ–π.
  // –ò—Å–∫–ª—é—á–µ–Ω–∏–µ: –µ—Å–ª–∏ —Å–º–æ—Ç—Ä–∏–º ¬´–ò–ó–ë–†–ê–ù–ù–û–ï¬ª –∏ –∏–≥—Ä–∞–µ—Ç ¬´–ò–ó–ë–†–ê–ù–ù–û–ï¬ª ‚Äî –º–∏–Ω–∏‚Äë—Ä–µ–∂–∏–º –ù–ï –≤–∫–ª—é—á–∞–µ–º.
  const inMini = (function(){
    if (viewMode === 'favorites' && playingAlbumKey === SPECIAL_FAVORITES_KEY) return false;
    return isBrowsingOtherAlbum();
  })();

  // –ü—Ä–∏–º–µ–Ω—è–µ–º/—Å–Ω–∏–º–∞–µ–º CSS‚Äë—Ñ–ª–∞–≥ –º–∏–Ω–∏‚Äë—Ä–µ–∂–∏–º–∞
  if (inMini) lp.classList.add('mini-mode'); else lp.classList.remove('mini-mode');

  // –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ª–∏—Ä–∏–∫–æ–π –∏ –∞–Ω–∏–º–∞—Ü–∏–µ–π –ø—Ä–∏ –≤—Ö–æ–¥–µ/–≤—ã—Ö–æ–¥–µ –∏–∑ –º–∏–Ω–∏‚Äë—Ä–µ–∂–∏–º–∞:
  // - –ø—Ä–∏ –≤—Ö–æ–¥–µ: —Å–ø—Ä—è—Ç–∞—Ç—å –æ–∫–Ω–æ –ª–∏—Ä–∏–∫–∏ (–µ—Å–ª–∏ –±—ã–ª–æ –≤–∏–¥–Ω–æ) –∏ –≤—Ä–µ–º–µ–Ω–Ω–æ –≤—ã–∫–ª—é—á–∏—Ç—å –∞–Ω–∏–º–∞—Ü–∏—é;
  // - –ø—Ä–∏ –≤—ã—Ö–æ–¥–µ: –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –ø—Ä–µ–∂–Ω–∏–π —Ä–µ–∂–∏–º –ª–∏—Ä–∏–∫–∏ –∏ –∞–Ω–∏–º–∞—Ü–∏–∏.
  try {
    // –í–•–û–î –≤ –º–∏–Ω–∏‚Äë—Ä–µ–∂–∏–º
    if (inMini) {
      if (!__wasMini) __wasMini = true;

      // 1) –ï—Å–ª–∏ –ª–∏—Ä–∏–∫–∞ –≤–∏–¥–∏–º–∞ (–Ω–µ hidden) ‚Äî –∑–∞–ø–æ–º–Ω–∏–º —Ä–µ–∂–∏–º –∏ —Å–∫—Ä–æ–µ–º.
      if (__savedLyricsModeForMini === null && lyricsViewMode !== 'hidden') {
        __savedLyricsModeForMini = lyricsViewMode; // 'normal' –∏–ª–∏ 'expanded'
      }
      if (lyricsViewMode !== 'hidden') {
        lyricsViewMode = 'hidden';
        applyLyricsViewMode();
      }

      // 2) –ï—Å–ª–∏ –∞–Ω–∏–º–∞—Ü–∏—è –ª–∏—Ä–∏–∫–∏ –≤–∫–ª—é—á–µ–Ω–∞ ‚Äî –∑–∞–ø–æ–º–Ω–∏–º –∏ –≤—Ä–µ–º–µ–Ω–Ω–æ –≤—ã–∫–ª—é—á–∏–º (–±–µ–∑ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –∏ –±–µ–∑ LocalStorage)
      if (__savedAnimationForMini === null && animationEnabled === true) {
        __savedAnimationForMini = true;
      }
      if (animationEnabled === true) {
        applyAnimationState(false);
      }
    }
    // –í–´–•–û–î –∏–∑ –º–∏–Ω–∏‚Äë—Ä–µ–∂–∏–º–∞
    else {
      if (__wasMini) __wasMini = false;

      // 1) –í–µ—Ä–Ω—ë–º –ø—Ä–µ–∂–Ω–∏–π —Ä–µ–∂–∏–º –ª–∏—Ä–∏–∫–∏ (–µ—Å–ª–∏ –±—ã–ª —Å–æ—Ö—Ä–∞–Ω—ë–Ω)
      if (__savedLyricsModeForMini !== null) {
        lyricsViewMode = __savedLyricsModeForMini; // –≤–µ—Ä–Ω—É—Ç—å 'normal' –∏–ª–∏ 'expanded'
        __savedLyricsModeForMini = null;
        applyLyricsViewMode();
      }

      // 2) –í–µ—Ä–Ω—ë–º –ø—Ä–µ–∂–Ω–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∞–Ω–∏–º–∞—Ü–∏–∏ (–µ—Å–ª–∏ –±—ã–ª–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–æ)
      if (__savedAnimationForMini !== null) {
        applyAnimationState(!!__savedAnimationForMini);
        __savedAnimationForMini = null;
      }
    }
  } catch(e) {
    // –º–æ–ª—á–∞ –∏–≥–Ω–æ—Ä–∏—Ä—É–µ–º, —á—Ç–æ–±—ã –Ω–µ –ª–æ–º–∞—Ç—å UX
  }

  updateMiniNowHeader();
  updateNextUpLabel();
}

function updateMiniNowHeader() {
  const box = document.getElementById('mini-now');
  if (!box) return;

  const show = isBrowsingOtherAlbum() &&
               Array.isArray(playingTracks) && playingTracks.length > 0 &&
               playingTrack >= 0;

  if (!show) {
    box.style.display = 'none'; // –º–æ–∂–Ω–æ '' –µ—Å–ª–∏ —Ö–æ—Ç–∏—Ç–µ –æ—Ç–¥–∞—Ç—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ CSS
    return;
  }

  box.style.display = 'flex';

  const numEl = document.getElementById('mini-now-num');
  const titleEl = document.getElementById('mini-now-title');
  const starEl = document.getElementById('mini-now-star');

  numEl.textContent = `${String(playingTrack + 1).padStart(2, '0')}.`;
  titleEl.textContent = playingTracks[playingTrack]?.title || '‚Äî';

  const liked = isLikedInPlayback(playingTrack);
  if (starEl) {
    starEl.src = liked ? 'img/star.png' : 'img/star2.png';
    starEl.title = liked ? '–£–±—Ä–∞—Ç—å –∏–∑ –ø–æ–Ω—Ä–∞–≤–∏–≤—à–∏—Ö—Å—è' : '–î–æ–±–∞–≤–∏—Ç—å –≤ –ø–æ–Ω—Ä–∞–≤–∏–≤—à–∏–µ—Å—è';
  }
}

function toggleLikePlayingFromMini(e) {
  if (e && e.stopPropagation) e.stopPropagation();
  toggleLikePlaying();
  updateMiniNowHeader();
  updateNextUpLabel();
}
async function openPlayingAlbumFromMini(e) {
  // –ù–µ —Ä–µ–∞–≥–∏—Ä—É–µ–º, –µ—Å–ª–∏ –∫–ª–∏–∫ –ø–æ –∑–≤—ë–∑–¥–æ—á–∫–µ
  if (e && e.target && e.target.id === 'mini-now-star') return;

  // –ï—Å–ª–∏ –∏–≥—Ä–∞–µ—Ç –ò–ó–ë–†–ê–ù–ù–û–ï ‚Äî –æ—Ç–∫—Ä—ã–≤–∞–µ–º –µ–≥–æ —Å–ø–∏—Å–æ–∫
  if (playingAlbumKey === SPECIAL_FAVORITES_KEY) {
    openFavoritesView();
    // –ü—Ä–æ–∫—Ä—É—Ç–∏–º –∫ —Ç–µ–∫—É—â–µ–º—É —Ç—Ä–µ–∫—É
    const cur = favoritesRefsModel?.[playingTrack];
    if (cur) {
      setTimeout(() => {
        document.getElementById(`fav_${cur.__a}_${cur.__t}`)?.scrollIntoView({ behavior: 'smooth', block: 'center' });
      }, 250);
    }
    return;
  }

  // –û–±—ã—á–Ω—ã–π —Å—Ü–µ–Ω–∞—Ä–∏–π: –ø–µ—Ä–µ–π—Ç–∏ –∫ –∏–≥—Ä–∞—é—â–µ–º—É –∞–ª—å–±–æ–º—É
  if (!playingAlbumKey || currentAlbumKey === playingAlbumKey) return;
  const lp = document.getElementById('lyricsplayerblock');
  if (!lp) return;

  try {
    const sel = document.getElementById('album-select');
    if (sel) sel.value = playingAlbumKey;
    await loadAlbumByKey(playingAlbumKey);
    setTimeout(() => {
      document.getElementById(`trk${currentTrack}`)?.scrollIntoView({ behavior: 'smooth', block: 'center' });
    }, 250);
  } catch {}
}

function attachPlaybackStateListeners() {
  const a = document.getElementById('audio');
  if (!a || !('mediaSession' in navigator)) return;
  a.addEventListener('play',  () => { try { navigator.mediaSession.playbackState = 'playing'; } catch {} });
  a.addEventListener('pause', () => { try { navigator.mediaSession.playbackState = 'paused';  } catch {} });
}

/* ====== Prefetch —Å–ª–µ–¥—É—é—â–µ–≥–æ —Ç—Ä–µ–∫–∞ (–∫–∞–∫ –≤ —Å—Ç–∞—Ä–æ–º, –∞–¥–∞–ø—Ç–∏—Ä–æ–≤–∞–Ω–æ) ====== */
function computeNextTrackIndexCandidate() {
  const pc = getPlayerConfig();
  if (!pc || !Array.isArray(pc.tracks) || pc.tracks.length === 0) return -1;
  updateAvailableTracks();
  if (shuffleMode) {
    if (!Array.isArray(shuffledPlaylist) || shuffledPlaylist.length === 0) createShuffledPlaylist();
    const nextIdxInShuffled = Math.min(shuffleIndex + 1, Math.max(0, shuffledPlaylist.length - 1));
    const cand = shuffledPlaylist[nextIdxInShuffled];
    return (typeof cand === 'number') ? cand : -1;
  }
  if (favoritesOnlyMode) {
    if (!Array.isArray(availableTracks) || availableTracks.length === 0) return -1;
    const curPos = availableTracks.indexOf(playingTrack);
    if (curPos === -1) return availableTracks[0] ?? -1;
    const nextPos = (curPos + 1) % availableTracks.length;
    return availableTracks[nextPos] ?? -1;
  }
  return (playingTrack >= 0) ? ((playingTrack + 1) % pc.tracks.length) : 0;
}
function prefetchNextTrackAssets() {
  const pc = getPlayerConfig(); if (!pc) return;
  const cand = computeNextTrackIndexCandidate();
  if (cand < 0 || !pc?.tracks?.[cand]) return;
  const t = pc.tracks[cand];
  prefetchAudioLink(t.audio, 'audio');
  if (t.lyrics) prefetchAudioLink(t.lyrics, 'fetch');
  if (t.fulltext) prefetchAudioLink(t.fulltext, 'fetch');
}
function prefetchNextTrackAssetsForPlayback() {
  const cand = computeNextIndexPlayback();
  if (cand < 0 || !playingTracks?.[cand]) return;
  const t = playingTracks[cand];
  prefetchAudioLink(t.audio, 'audio');
  if (t.lyrics) prefetchAudioLink(t.lyrics, 'fetch');
  if (t.fulltext) prefetchAudioLink(t.fulltext, 'fetch');
}
function prefetchAudioLink(url, asType='audio') {
  if (!url) return;
  try {
    const link = document.createElement('link');
    link.rel = 'prefetch';
    link.as = asType;
    link.href = url;
    link.crossOrigin = 'anonymous';
    document.head.appendChild(link);
    fetch(url).catch(()=>{});
  } catch(e) {}
}

/* ====== –ó–∞–≥—Ä—É–∑–∫–∞ –ª–∏—Ä–∏–∫–∏ ====== */
function loadLyrics(file){ fetch(file).then(r=>r.json()).then(js=>{ currentLyrics=js; renderLyrics(0); }).catch(()=>{ currentLyrics=[]; }); }

/* ====== MediaSession ====== */
function setupMediaSession(){
  if (!('mediaSession' in navigator)) return;
  const pc = getPlayerConfig();
  const tr = pc?.tracks?.[playingTrack];
  if (!tr) return;

  navigator.mediaSession.metadata = new MediaMetadata({
    title: tr.title,
    artist: pc.artist || '–í–∏—Ç—Ä–∏–Ω–∞ –†–∞–∑–±–∏—Ç–∞',
    album: pc.albumName || '–ê–ª—å–±–æ–º',
    artwork: [{ src: (playingCover || 'img/logo.png'), sizes: '512x512', type: 'image/png' }]
  });

  navigator.mediaSession.setActionHandler('play',  ()=>{ const a=document.getElementById('audio'); a&&a.play(); updatePlayPauseIcon(); });
  navigator.mediaSession.setActionHandler('pause', ()=>{ const a=document.getElementById('audio'); a&&a.pause(); updatePlayPauseIcon(); });
  navigator.mediaSession.setActionHandler('previoustrack', previousTrack);
  navigator.mediaSession.setActionHandler('nexttrack', nextTrack);
  navigator.mediaSession.setActionHandler('seekbackward', ()=>{ const a=document.getElementById('audio'); if (a) a.currentTime=Math.max(0,(a.currentTime||0)-10); });
  navigator.mediaSession.setActionHandler('seekforward', ()=>{ const a=document.getElementById('audio'); if (a) a.currentTime=Math.min(a.duration,(a.currentTime||0)+10); });
  navigator.mediaSession.setActionHandler('seekto', (details)=>{ const a=document.getElementById('audio'); if (a && typeof details.seekTime==='number') a.currentTime = details.seekTime; });
}

/* ====== –í—Ä–µ–º—è ====== */
function formatTime(sec){ if (isNaN(sec)||sec<0) return '--:--'; const m=Math.floor(sec/60), s=Math.floor(sec%60); return `${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}`; }

/* ====== –•–æ—Ç–∫–µ–∏ ====== */
window.addEventListener('keydown', function(e){
  if (e.target.tagName==='INPUT' || e.target.tagName==='TEXTAREA') return;
  const hasModal = document.querySelector('.modal-bg.active');
  if (e.key==='Escape' && hasModal){ e.preventDefault(); document.querySelectorAll('.modal-bg.active').forEach(m=>m.classList.remove('active')); return; }
  if (hasModal) return;
  const audio=document.getElementById('audio');
  switch(e.key.toUpperCase()){
    case ' ': case 'K': e.preventDefault(); togglePlayPause(); break;
    case 'X': e.preventDefault(); stopPlayback(); break;
    case 'N': e.preventDefault(); nextTrack(); break;
    case 'P': e.preventDefault(); previousTrack(); break;
    case 'J': e.preventDefault(); if (audio) audio.currentTime=Math.max(0,(audio.currentTime||0)-10); break;
    case 'L': e.preventDefault(); if (audio) audio.currentTime=Math.min(audio.duration,(audio.currentTime||0)+10); break;
    case '+': case '=': e.preventDefault(); const vs1=document.getElementById('volume-slider'); if (vs1){ vs1.value=Math.min(100, parseInt(vs1.value||'100') + 10); vs1.dispatchEvent(new Event('input')); } break;
    case '-': e.preventDefault(); const vs2=document.getElementById('volume-slider'); if (vs2){ vs2.value=Math.max(0, parseInt(vs2.value||'100') - 10); vs2.dispatchEvent(new Event('input')); } break;
    case 'M': case '0': e.preventDefault(); toggleMute(); break;
    case 'R': e.preventDefault(); toggleRepeat(); break;
    case 'U': e.preventDefault(); toggleShuffle(); break;
    case 'F': e.preventDefault(); toggleFavoritesOnly(); break;
    case 'T': e.preventDefault(); toggleSleepMenu(); break;
    case 'A': e.preventDefault(); toggleAnimation(); break;
    case 'B': e.preventDefault(); toggleBit(); break;
    case '1': if (bitEnabled){ bitIntensity=100; localStorage.setItem('bitIntensity','100'); NotificationSystem.info('üíø –ò–Ω—Ç–µ–Ω—Å–∏–≤–Ω–æ—Å—Ç—å: 100%'); } break;
    case '2': if (bitEnabled){ bitIntensity=50; localStorage.setItem('bitIntensity','50'); NotificationSystem.info('üíø –ò–Ω—Ç–µ–Ω—Å–∏–≤–Ω–æ—Å—Ç—å: 50%'); } break;
    case '3': if (bitEnabled){ bitIntensity=15; localStorage.setItem('bitIntensity','15'); NotificationSystem.info('üíø –ò–Ω—Ç–µ–Ω—Å–∏–≤–Ω–æ—Å—Ç—å: 15%'); } break;
    case 'Y': e.preventDefault(); if (currentTrack>=0) toggleLyricsView(); break;
    case 'W': e.preventDefault(); document.getElementById('track-list')?.scrollIntoView({behavior:'smooth'}); break;
    case 'D':
      e.preventDefault();
      if (isBrowsingSameAsPlaying()) {
        if (playingTrack >= 0) toggleLike(playingTrack);
      } else {
        toggleLikePlaying();
      }
      break;
    case '?': e.preventDefault(); showHotkeysModal(); break;
  }
  if (e.key>='1' && e.key<='9' && !e.shiftKey && !e.ctrlKey && !e.altKey){
    const i=parseInt(e.key)-1; if (config && i<config.tracks.length){ e.preventDefault(); showTrack(i,true); }
  }
});
function showHotkeysModal(){ document.getElementById('hotkeys-modal').classList.add('active'); }
function closeHotkeysModal(){ document.getElementById('hotkeys-modal').classList.remove('active'); }

/* ====== –û–±—Ä–∞—Ç–Ω–∞—è —Å–≤—è–∑—å ====== */
function openFeedbackModal(){ document.getElementById('modal-feedback').classList.add('active'); }
function closeFeedbackModal(){ document.getElementById('modal-feedback').classList.remove('active'); }

/* ====== Deep Link ====== */
function parseDeepLink(){
  const params = new URLSearchParams(location.search);
  const view = params.get('view');
  if (view === 'favorites') {
    openFavoritesView();
    return;
  }
  const albumParam = params.get('album');
  if (albumParam && albumByKey(albumParam) && albumParam !== currentAlbumKey) {
    const sel = document.getElementById('album-select');
    sel.value = albumParam;
    loadAlbumByKey(albumParam);
    return; // –¥–æ–∂–¥—ë–º—Å—è –∑–∞–≥—Ä—É–∑–∫–∏; parseDeepLink –≤—ã–∑–æ–≤–µ—Ç—Å—è –∏–∑ loadAlbumConfig –µ—â—ë —Ä–∞–∑
  }
  const t = params.get('track');
  if (t && config){
    const idx=parseInt(t,10);
    if (!isNaN(idx) && idx>=0 && idx<config.tracks.length){
      showTrack(idx,true);
      const timeParam = parseInt(params.get('time')||'0', 10);
      if (!isNaN(timeParam) && timeParam > 0) {
        setTimeout(()=> {
          const a=document.getElementById('audio'); if (a) a.currentTime = timeParam;
        }, 600);
      }
      setTimeout(()=>document.getElementById(`trk${idx}`)?.scrollIntoView({behavior:'smooth',block:'center'}), 300);
    }
  }
}

/* ====== –°–∫–∞—á–∏–≤–∞–Ω–∏—è ====== */
function getTrackFileName(track, idx, artist){ return `${String(idx+1).padStart(2,'0')} - ${track.title} - ${artist}.mp3`.replace(/[\\/:"*?<>|]+/g,'_'); }
function openDownloadModal(e){
  if (e) e.preventDefault();
  const pc = getPlayerConfig(); const tr = pc?.tracks?.[playingTrack];
  if (!tr) return;
  const fn = getTrackFileName(tr, playingTrack, pc.artist || '–í–∏—Ç—Ä–∏–Ω–∞ –†–∞–∑–±–∏—Ç–∞');
  document.getElementById('download-modal-filename').innerHTML=`<b>${fn}</b>`;
  document.getElementById('download-modal').classList.add('active');
}

async function downloadCurrentTrack(){
  const pc = getPlayerConfig(); const tr = pc?.tracks?.[playingTrack];
  if (!tr) return;
  const fn = getTrackFileName(tr, playingTrack, pc.artist || '–í–∏—Ç—Ä–∏–Ω–∞ –†–∞–∑–±–∏—Ç–∞');
  const a=document.createElement('a'); a.href=tr.audio; a.download=fn;
  document.body.appendChild(a); a.click(); setTimeout(()=>{ document.body.removeChild(a); },250);
  closeDownloadModal(); NotificationSystem.success('–§–∞–π–ª –±—É–¥–µ—Ç –∑–∞–≥—Ä—É–∂–µ–Ω!');
}

async function shareCurrentTrack(){
  const pc = getPlayerConfig(); const tr = pc?.tracks?.[playingTrack];
  if (!tr) return;
  const a = document.getElementById('audio');
  const t = a ? Math.floor(a.currentTime || 0) : 0;
  const timeParam = t > 10 ? `&time=${t}` : '';
  const shareUrl = location.origin + location.pathname + `?album=${playingAlbumKey}&track=${playingTrack}${timeParam}`;
  const txt = `üéµ ${tr.title} - ${pc.artist || '–í–∏—Ç—Ä–∏–Ω–∞ –†–∞–∑–±–∏—Ç–∞'}\nüéß –°–ª—É—à–∞–π:`;
  if (navigator.share){
    try { await navigator.share({title: tr.title, text: txt, url: shareUrl}); NotificationSystem.success('–°—Å—ã–ª–∫–∞ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞!'); closeDownloadModal(); } catch {}
  } else {
    await navigator.clipboard.writeText(`${txt}\n${shareUrl}`);
    NotificationSystem.success('–°—Å—ã–ª–∫–∞ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∞!');
  }
}
function copyLinkCurrentTrack(){
  const pc = getPlayerConfig(); const tr = pc?.tracks?.[playingTrack];
  if (!tr) return;
  const directUrl = tr.audio;
  if (navigator.clipboard && window.isSecureContext){
    navigator.clipboard.writeText(directUrl).then(()=>NotificationSystem.success('–ü—Ä—è–º–∞—è —Å—Å—ã–ª–∫–∞ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∞!'),()=>NotificationSystem.error('–ù–µ —É–¥–∞–ª–æ—Å—å —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å'));
  } else {
    const ta=document.createElement('textarea'); ta.value=directUrl; document.body.appendChild(ta); ta.select();
    try{ document.execCommand('copy'); NotificationSystem.success('–ü—Ä—è–º–∞—è —Å—Å—ã–ª–∫–∞ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∞!'); }catch{ NotificationSystem.error('–ù–µ —É–¥–∞–ª–æ—Å—å —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å'); }
    document.body.removeChild(ta);
  }
  closeDownloadModal();
}
function closeDownloadModal(){
  const m = document.getElementById('download-modal');
  if (m) m.classList.remove('active');
}

function openInAppCurrentTrack(){
  const pc = getPlayerConfig();
  const tr = pc?.tracks?.[playingTrack];
  if (!tr) return;
  // –û—Ç–∫—Ä—ã–≤–∞–µ–º –∞—É–¥–∏–æ –≤ –≤–Ω–µ—à–Ω–µ–º –ø–ª–µ–µ—Ä–µ/–≤–∫–ª–∞–¥–∫–µ
  window.open(tr.audio, '_blank', 'noopener');
  closeDownloadModal();
}
/* ===== –£—Å—Ç–æ–π—á–∏–≤–æ–µ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ –≤ –±—É—Ñ–µ—Ä (–º–æ–±–∏–ª–∫–∏/iOS/https/HTTP) ===== */
async function copyTextToClipboard(text) {
  try {
    if (navigator.clipboard && window.isSecureContext) {
      await navigator.clipboard.writeText(text);
      return true;
    }
  } catch {}
  try {
    const ta = document.createElement('textarea');
    ta.value = text;
    ta.style.position = 'fixed';
    ta.style.top = '-1000px';
    ta.style.left = '-1000px';
    ta.setAttribute('readonly', '');
    document.body.appendChild(ta);

    // iOS —Å–ø–µ—Ü–∏—Ñ–∏—á–Ω–æ: –Ω—É–∂–Ω–æ –≤—ã–¥–µ–ª–∏—Ç—å –≤—Ä—É—á–Ω—É—é
    const range = document.createRange();
    range.selectNodeContents(ta);
    const sel = window.getSelection();
    sel.removeAllRanges();
    sel.addRange(range);
    ta.setSelectionRange(0, ta.value.length);

    const ok = document.execCommand('copy');
    document.body.removeChild(ta);
    return !!ok;
  } catch {
    return false;
  }
}

/* ===== –ú–æ–¥–∞–ª–∫–∞ —Ç–µ–∫—Å—Ç–∞ –ø–µ—Å–Ω–∏ ===== */
let __lyricsModalTextCache = ''; // –∫–µ—à –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –∑–∞–≥—Ä—É–∂–µ–Ω–Ω–æ–≥–æ —Ç–µ–∫—Å—Ç–∞ (–¥–ª—è –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è)
/* –ê–≤—Ç–æ–ø–æ–¥–±–æ—Ä —à—Ä–∏—Ñ—Ç–∞ –¥–ª—è –º–æ–¥–∞–ª–∫–∏ ¬´–¢–ï–ö–°–¢¬ª */
let __lyricsBaseFittedFontPx = null;  // –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–æ–¥–æ–±—Ä–∞–Ω–Ω—ã–π –±–∞–∑–æ–≤—ã–π —Ä–∞–∑–º–µ—Ä
let __lyricsCurrFontPx = null;        // —Ç–µ–∫—É—â–∏–π (–º–µ–Ω—è–µ—Ç—Å—è –∫–Ω–æ–ø–∫–∞–º–∏ +/-)
let __lyricsUserZoomed = false;       // –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Ç—Ä–æ–≥–∞–ª +/- –≤ —ç—Ç–æ–º –æ—Ç–∫—Ä—ã—Ç–∏–∏?

function sanitizeFileName(name) {
  return String(name || '')
    .replace(/[\\/:*?"<>|]+/g, '_')
    .replace(/\s+/g, ' ')
    .trim();
}

/* –í—ã—á–∏—Å–ª—è–µ–º –ø–æ–¥—Ö–æ–¥—è—â–∏–π —Ä–∞–∑–º–µ—Ä —à—Ä–∏—Ñ—Ç–∞ —Ç–∞–∫, —á—Ç–æ–±—ã —Å–∞–º–∞—è –¥–ª–∏–Ω–Ω–∞—è —Å—Ç—Ä–æ–∫–∞
   –ø–æ–ª–Ω–æ—Å—Ç—å—é –ø–æ–º–µ—â–∞–ª–∞—Å—å –≤ –¥–æ—Å—Ç—É–ø–Ω—É—é —à–∏—Ä–∏–Ω—É –±–µ–∑ –ø–µ—Ä–µ–Ω–æ—Å–∞ (white-space: pre). */
function autoFitLyricsFont() {
  try {
    const pre = document.getElementById('lyrics-modal-pre');
    const sc  = document.querySelector('#lyrics-text-modal .lyrics-modal-scroll');
    if (!pre || !sc) return;
    const text = pre.textContent || '';
    const lines = text.split(/\r?\n/);

    // –î–æ—Å—Ç—É–ø–Ω–∞—è —à–∏—Ä–∏–Ω–∞ ‚Äî –≤–Ω—É—Ç—Ä–µ–Ω–Ω—è—è —à–∏—Ä–∏–Ω–∞ —Å–∫—Ä–æ–ª–ª-–∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞
    const targetWidth = Math.max(10, sc.clientWidth - 2); // –Ω–µ–±–æ–ª—å—à–æ–π –∑–∞–ø–∞—Å

    // –ü–æ–¥–≥–æ—Ç–æ–≤–∏–º —Å–∫—Ä—ã—Ç—ã–π —ç–ª–µ–º–µ–Ω—Ç-–∑–∞–º–µ—Ä—â–∏–∫ —Å —Ç–µ–º–∏ –∂–µ —à—Ä–∏—Ñ—Ç–∞–º–∏, —á—Ç–æ –∏ –≤ <pre>
    const cs = getComputedStyle(pre);
    const meas = document.createElement('span');
    meas.style.position = 'absolute';
    meas.style.left = '-999999px';
    meas.style.top = '-999999px';
    meas.style.whiteSpace = 'pre';               // –∫–∞–∫ —É pre –Ω–∞ —Å—Ç–∞—Ä—Ç–µ
    meas.style.fontFamily = cs.fontFamily;
    meas.style.fontWeight = cs.fontWeight;
    meas.style.letterSpacing = cs.letterSpacing;
    meas.style.visibility = 'hidden';
    document.body.appendChild(meas);

    // –ú–µ—Ä—è–µ–º –Ω–∞ –±–∞–∑–æ–≤–æ–º —Ä–∞–∑–º–µ—Ä–µ (20px) –∏ –º–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º
    const basePx = 20;
    meas.style.fontSize = basePx + 'px';
    let maxLineWidthAtBase = 0;
    for (const line of lines) {
      meas.textContent = line || '';            // –ø—É—Å—Ç—ã–µ —Å—Ç—Ä–æ–∫–∏ –¥–æ–ø—É—Å—Ç–∏–º—ã
      const w = meas.offsetWidth;
      if (w > maxLineWidthAtBase) maxLineWidthAtBase = w;
    }
    meas.remove();

    if (maxLineWidthAtBase <= 0) return;

    // –ü—Ä—è–º–æ–µ –≤—ã—á–∏—Å–ª–µ–Ω–∏–µ –Ω—É–∂–Ω–æ–≥–æ —Ä–∞–∑–º–µ—Ä–∞ —Å —Ç–æ—á–Ω–æ—Å—Ç—å—é –¥–æ 0.1px
    let fitted = (targetWidth / maxLineWidthAtBase) * basePx;

    // –ê–¥–µ–∫–≤–∞—Ç–Ω—ã–µ –ø—Ä–µ–¥–µ–ª—ã
    const MIN = 10, MAX = 48;
    fitted = Math.max(MIN, Math.min(MAX, fitted));

    // –ß—É—Ç—å-—á—É—Ç—å –∑–∞–ø–∞—Å, —á—Ç–æ–±—ã –ø—Ä–∞–≤–æ/–ª–µ–≤–æ –≤—ã–≥–ª—è–¥–µ–ª–∏ —Ä–æ–≤–Ω–æ
    fitted = Math.max(MIN, Math.min(MAX, fitted * 0.995));

    __lyricsBaseFittedFontPx = parseFloat(fitted.toFixed(1));
    __lyricsCurrFontPx = __lyricsBaseFittedFontPx;
    __lyricsUserZoomed = false;

    // –ü—Ä–∏–º–µ–Ω—è–µ–º –∏ –∑–∞–ø—Ä–µ—â–∞–µ–º –ø–µ—Ä–µ–Ω–æ—Å—ã
    pre.style.fontSize = __lyricsCurrFontPx + 'px';
    pre.style.whiteSpace = 'pre';
  } catch(e) {
    // –º–æ–ª—á–∞
  }
}

/* –ü—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ —Ä–∞–∑–º–µ—Ä–∞ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ (resize/orientation/fullscreen) ‚Äî –µ—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ —Ç—Ä–æ–≥–∞–ª +/-, –ø–µ—Ä–µ—Å—á–∏—Ç–∞—Ç—å */
function refitLyricsFontIfNeeded() {
  const bg = document.getElementById('lyrics-text-modal');
  if (!bg || !bg.classList.contains('active')) return;
  if (!__lyricsUserZoomed) autoFitLyricsFont();
}

/* –ü–æ–ª–Ω–æ—ç–∫—Ä–∞–Ω–Ω—ã–π —Ä–µ–∂–∏–º –ø–∞–Ω–µ–ª–∏ –º–æ–¥–∞–ª–∫–∏ */
function toggleLyricsFullscreen() {
  try {
    const panel = document.querySelector('#lyrics-text-modal .lyrics-modal');
    if (!panel) return;
    if (!document.fullscreenElement) {
      if (panel.requestFullscreen) panel.requestFullscreen();
    } else {
      if (document.exitFullscreen) document.exitFullscreen();
    }
  } catch {}
}

/* –ú–µ–Ω—è–µ–º –ø–æ–¥—Å–∫–∞–∑–∫—É –Ω–∞ –∫–Ω–æ–ø–∫–µ FS */
function updateLyricsFsBtnIcon() {
  const btn = document.getElementById('lyrics-fs-btn');
  if (!btn) return;
  const isFs = !!document.fullscreenElement;
  btn.title = isFs ? '–í—ã–π—Ç–∏ –∏–∑ –ø–æ–ª–Ω–æ—ç–∫—Ä–∞–Ω–Ω–æ–≥–æ —Ä–µ–∂–∏–º–∞' : '–ü–æ–ª–Ω–æ—ç–∫—Ä–∞–Ω–Ω—ã–π —Ä–µ–∂–∏–º';
  btn.setAttribute('aria-label', btn.title);
}

/* –ò–º—è —Ñ–∞–π–ª–∞ –¥–ª—è ¬´–ü–æ–¥–µ–ª–∏—Ç—å—Å—è —Ç–µ–∫—Å—Ç–æ–º¬ª: –ù–∞–∑–≤–∞–Ω–∏–µ_–ø–µ—Å–Ω–∏ - vi3na1bita.txt */
function getLyricsShareFileName() {
  const meta = getCurrentTrackMetaForText();
  const base = meta?.title ? sanitizeFileName(meta.title) : 'lyrics';
  return `${base} - vi3na1bita.txt`;
}

function getCurrentTrackMetaForText() {
  const pc = getPlayerConfig();
  const idx = (typeof playingTrack === 'number' && playingTrack >= 0) ? playingTrack : currentTrack;
  if (!pc || !pc.tracks || idx < 0 || !pc.tracks[idx]) return null;
  return { title: pc.tracks[idx].title, fulltext: pc.tracks[idx].fulltext || null };
}

async function openLyricsModal() {
  const meta = getCurrentTrackMetaForText();
  if (!meta || !meta.fulltext) {
    NotificationSystem.warning('–§–∞–π–ª —Å —Ç–µ–∫—Å—Ç–æ–º –Ω–µ –Ω–∞–π–¥–µ–Ω!');
    return;
  }

  // –ó–∞–≥–æ–ª–æ–≤–æ–∫ ‚Äî —Ç–æ–ª—å–∫–æ –Ω–∞–∑–≤–∞–Ω–∏–µ –∫–æ–º–ø–æ–∑–∏—Ü–∏–∏
  const titleEl = document.getElementById('lyrics-modal-title');
  if (titleEl) titleEl.textContent = meta.title || '–¢–µ–∫—Å—Ç –ø–µ—Å–Ω–∏';

  // –ê–Ω–∏–º–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —Ñ–æ–Ω ‚Äî –ø–æ —Å–æ—Å—Ç–æ—è–Ω–∏—é –∞–Ω–∏–º–∞—Ü–∏–∏ –ª–∏—Ä–∏–∫–∏
  try {
    const bg = document.querySelector('#lyrics-text-modal .lyrics-animated-bg');
    if (bg) {
      if (animationEnabled) bg.classList.add('active');
      else bg.classList.remove('active');
    }
  } catch {}

  // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –º–æ–¥–∞–ª–∫—É —Å—Ä–∞–∑—É
  const modal = document.getElementById('lyrics-text-modal');
  modal.classList.add('active');
  modal.onclick = (e) => { if (e.target === modal) closeLyricsModal(); };

  const pre = document.getElementById('lyrics-modal-pre');
  const sc  = document.querySelector('#lyrics-text-modal .lyrics-modal-scroll');
  if (pre) pre.textContent = '–ó–∞–≥—Ä—É–∑–∫–∞...';

  try {
    const res = await fetch(meta.fulltext, { cache: 'no-cache' });
    const txt = await res.text();
    __lyricsModalTextCache = txt;

    if (pre) {
      pre.textContent = txt;

      // –í—ã—Å—Ç–∞–≤–ª—è–µ–º —à–∏—Ä–∏–Ω—É –º–æ–¥–∞–ª–∫–∏ –∏ –ø–æ–¥–±–∏—Ä–∞–µ–º —à—Ä–∏—Ñ—Ç –ø–æ–¥ —Å–∞–º—É—é –¥–ª–∏–Ω–Ω—É—é —Å—Ç—Ä–æ–∫—É
      requestAnimationFrame(() => {
        sizeLyricsModalToPlayer();
        autoFitLyricsFont();     // –∫–ª—é—á–µ–≤–æ–µ ‚Äî –ø–æ–¥–≥–æ–Ω—è–µ–º —Ä–∞–∑–º–µ—Ä (white-space: pre)
        if (sc) { sc.scrollTop = 0; sc.scrollLeft = 0; }
      });
    }
  } catch {
    if (pre) pre.textContent = '–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å —Ç–µ–∫—Å—Ç :(';
  }
}

function closeLyricsModal() {
  const modal = document.getElementById('lyrics-text-modal');
  if (!modal) return;
  modal.classList.remove('active');
}

async function copyLyricsFromModal() {
  try {
    const ok = await copyTextToClipboard(__lyricsModalTextCache || '');
    if (ok) NotificationSystem.success('–¢–µ–∫—Å—Ç —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω!');
    else NotificationSystem.error('–ù–µ —É–¥–∞–ª–æ—Å—å —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å');
  } catch {
    NotificationSystem.error('–ù–µ —É–¥–∞–ª–æ—Å—å —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å');
  }
}
/* –®–∏—Ä–∏–Ω–∞ –º–æ–¥–∞–ª–∫–∏: desktop ‚Äî —Ä–∞–≤–Ω–∞ —à–∏—Ä–∏–Ω–µ –ø–ª–µ–µ—Ä–∞ (#now-playing –∏–ª–∏ #main-block),
   mobile ‚Äî —Ä–∞–≤–Ω–∞ 100vw. –í—ã—Å—Ç–∞–≤–ª—è–µ–º —á–µ—Ä–µ–∑ CSS‚Äë–ø–µ—Ä–µ–º–µ–Ω–Ω—É—é. */
function sizeLyricsModalToPlayer() {
  const modal = document.querySelector('#lyrics-text-modal .lyrics-modal');
  if (!modal) return;
  const isMob = isMobileUA() || window.innerWidth <= 600;
  let target = 0;

  if (isMob) {
    target = Math.min(window.innerWidth, document.documentElement.clientWidth);
  } else {
    const holder = document.getElementById('now-playing') || document.getElementById('main-block');
    target = holder ? Math.max(320, Math.round(holder.clientWidth || 395)) : 395;
  }
  modal.style.setProperty('--lyrics-modal-width', target + 'px');
}

/* –ü–µ—Ä–µ—Å—á—ë—Ç —à–∏—Ä–∏–Ω—ã –ø–∞–Ω–µ–ª–∏ –∏ —à—Ä–∏—Ñ—Ç–∞ –ø—Ä–∏ —Ä–µ—Å–∞–π–∑–µ/–ø–æ–≤–æ—Ä–æ—Ç–µ, –ø–æ–∫–∞ –º–æ–¥–∞–ª–∫–∞ –æ—Ç–∫—Ä—ã—Ç–∞ */
function __onLyricsResize() {
  const modalBg = document.getElementById('lyrics-text-modal');
  if (!modalBg || !modalBg.classList.contains('active')) return;
  sizeLyricsModalToPlayer();
  // –ï—Å–ª–∏ —é–∑–µ—Ä –Ω–µ —Ç—Ä–æ–≥–∞–ª +/- ‚Äî –ø–æ–¥–≥–æ–Ω—è–µ–º –∑–∞–Ω–æ–≤–æ
  refitLyricsFontIfNeeded();
}
window.addEventListener('resize', __onLyricsResize);
window.addEventListener('orientationchange', __onLyricsResize);

/* –û—Ç—Å–ª–µ–∂–∏–≤–∞–µ–º —Å–º–µ–Ω—É –ø–æ–ª–Ω–æ—ç–∫—Ä–∞–Ω–Ω–æ–≥–æ —Å–æ—Å—Ç–æ—è–Ω–∏—è */
document.addEventListener('fullscreenchange', () => {
  updateLyricsFsBtnIcon();
  // –ü–æ–¥–≥–æ–Ω–∏–º —à–∏—Ä–∏–Ω—É –∏ —à—Ä–∏—Ñ—Ç
  __onLyricsResize();
});

/* –ü–æ–¥–µ–ª–∏—Ç—å—Å—è —Ç–µ–∫—Å—Ç–æ–º: –ø—Ä–æ–±—É–µ–º Web Share Level 2 —Å —Ñ–∞–π–ª–∞–º–∏; –µ—Å–ª–∏ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–æ ‚Äî —Å–∫–∞—á–∏–≤–∞–µ–º .txt */
async function shareLyricsFromModal() {
  try {
    const content = __lyricsModalTextCache || '';
    const fileName = getLyricsShareFileName();
    const blob = new Blob([content], { type: 'text/plain' });
    const file = new File([blob], fileName, { type: 'text/plain' });

    if (navigator.share) {
      if (navigator.canShare && navigator.canShare({ files: [file] })) {
        await navigator.share({
          files: [file],
          title: '–¢–µ–∫—Å—Ç –ø–µ—Å–Ω–∏',
          text: '–¢–µ–∫—Å—Ç –ø–µ—Å–Ω–∏ ‚Äî ¬´–í–∏—Ç—Ä–∏–Ω–∞ –†–∞–∑–±–∏—Ç–∞¬ª'
        });
        return;
      }
      // fallback: –±–µ–∑ —Ñ–∞–π–ª–æ–≤, –ø—Ä–æ—Å—Ç–æ —Ç–µ–∫—Å—Ç
      await navigator.share({ title: '–¢–µ–∫—Å—Ç –ø–µ—Å–Ω–∏', text: content });
      return;
    }

    // –ü–æ–ª–∏—Ñ–∏–ª–ª: —Å–∫–∞—á–∏–≤–∞–µ–º —Ñ–∞–π–ª
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = fileName;
    document.body.appendChild(a);
    a.click();
    setTimeout(() => {
      URL.revokeObjectURL(a.href);
      a.remove();
    }, 800);
  } catch (e) {
    // –ù–∞ –∫—Ä–∞–π–Ω–∏–π —Å–ª—É—á–∞–π ‚Äî –≤ –±—É—Ñ–µ—Ä –æ–±–º–µ–Ω–∞
    copyLyricsFromModal();
  }
}

function zoomLyrics(delta) {
  const pre = document.getElementById('lyrics-modal-pre');
  if (!pre) return;

  // –ï—Å–ª–∏ –µ—â—ë –Ω–µ –±—ã–ª–æ –±–∞–∑–æ–≤–æ–≥–æ —Ä–∞—Å—á—ë—Ç–∞ ‚Äî —Å–¥–µ–ª–∞–µ–º
  if (__lyricsCurrFontPx == null || __lyricsBaseFittedFontPx == null) {
    autoFitLyricsFont();
  }

  const step = 2;            // —à–∞–≥ –≤ px
  const MIN = 10, MAX = 64;  // —á—É—Ç—å –±–æ–ª—å—à–µ –¥–æ–ø—É—Å—Ç–∏–º–æ–≥–æ –≤–µ—Ä—Ö–∞

  if (delta > 0) {
    // –£–≤–µ–ª–∏—á–∏–≤–∞–µ–º –∏ —Ä–∞–∑—Ä–µ—à–∞–µ–º –ø–µ—Ä–µ–Ω–æ—Å—ã —Å—Ç—Ä–æ–∫
    __lyricsCurrFontPx = Math.min(MAX, __lyricsCurrFontPx + step);
    pre.style.whiteSpace = 'pre-wrap';
    pre.style.wordBreak = 'break-word';
    pre.style.overflowWrap = 'anywhere';
    __lyricsUserZoomed = true;
  } else {
    // –£–º–µ–Ω—å—à–∞–µ–º. –ï—Å–ª–∏ –≤–µ—Ä–Ω—É–ª–∏—Å—å –∫ –±–∞–∑–æ–≤–æ–º—É –∑–Ω–∞—á–µ–Ω–∏—é ‚Äî —Å–Ω–æ–≤–∞ –∑–∞–ø—Ä–µ—Ç–∏–º –ø–µ—Ä–µ–Ω–æ—Å—ã
    __lyricsCurrFontPx = Math.max(MIN, __lyricsCurrFontPx - step);
    if (Math.abs(__lyricsCurrFontPx - __lyricsBaseFittedFontPx) < 0.1) {
      pre.style.whiteSpace = 'pre';
      pre.style.wordBreak = 'normal';
      pre.style.overflowWrap = 'normal';
      __lyricsUserZoomed = false;
    } else {
      __lyricsUserZoomed = true;
    }
  }

  pre.style.fontSize = __lyricsCurrFontPx.toFixed(1) + 'px';
}

/* ====== –°–∫–∞—á–∏–≤–∞–Ω–∏–µ –∞–ª—å–±–æ–º–∞ ====== */
function loadJSZip(){ if (window.JSZip) return Promise.resolve(); return new Promise((res,rej)=>{ const s=document.createElement('script'); s.src='https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js'; s.onload=res; s.onerror=rej; document.head.appendChild(s); }); }
function openAlbumDownloadModal(){ document.getElementById('albumDownloadModal').classList.add('active'); checkFavoritesAvailable(); }
function closeAlbumDownloadModal(){ document.getElementById('albumDownloadModal').classList.remove('active'); }
document.getElementById('albumDownloadModal').onclick = function(e){ if (e.target===this) closeAlbumDownloadModal(); };
function checkFavoritesAvailable(){ const favCheckbox=document.getElementById('onlyFavorites'); const liked=getLiked(); favCheckbox.disabled = liked.length===0; favCheckbox.parentElement.style.opacity = liked.length===0 ? '.5' : '1'; }

async function prepareFilesList(){
  filesToDownload=[]; const added = new Set();
  const liked = getLiked();
  let idxs = [];
  const onlyFav = document.getElementById('onlyFavorites').checked;
  const fullAlbum = document.getElementById('fullAlbum').checked;
  if (onlyFav && liked.length>0) idxs = liked;
  else if (fullAlbum) idxs = config.tracks.map((_,i)=>i);

  for (const i of idxs){
    const t=config.tracks[i]; const num=String(i+1).padStart(2,'0'); const name=`${num} - ${t.title} - ${config.artist}.mp3`;
    if (!added.has(name)){ added.add(name); filesToDownload.push({url: t.audio, name, type:'audio'}); }
    if (document.getElementById('includeLyrics').checked && t.fulltext){
      const n2 = `${num} - ${t.title} - ${config.artist}.txt`;
      if (!added.has(n2)){ added.add(n2); try{ const r=await fetch(t.fulltext); const text=await r.text(); filesToDownload.push({content:text, name:n2, type:'text'}); }catch{} }
    }
  }
  if (document.getElementById('includeCovers').checked){
    ['Cover.png','Cover01.png','Cover02.png','Cover03.png'].forEach(c=>{
      const url = absJoin(albumBase, c); const nm = c;
      if (!added.has(nm)){ added.add(nm); filesToDownload.push({url, name:nm, type:'image'}); }
    });
  }
  if (!added.has('logo.png')) filesToDownload.push({url:'img/logo.png', name:'logo.png', type:'image'});
  if (!added.has('social.txt')) filesToDownload.push({content: generateSocialText(), name:'social.txt', type:'text'});
}
function generateSocialText(){
  const s = config.socials||[]; const lines = s.map(one=>`${one.title}: ${one.url}`).join('\n');
  return `‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
       –í–ò–¢–†–ò–ù–ê –†–ê–ó–ë–ò–¢–ê ‚Äî ${config.albumName||'–ê–ª—å–±–æ–º'}
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

–°–ø–∞—Å–∏–±–æ –∑–∞ –∏–Ω—Ç–µ—Ä–µ—Å –∫ –Ω–∞—à–µ–º—É —Ç–≤–æ—Ä—á–µ—Å—Ç–≤—É!
–ü–æ–¥–¥–µ—Ä–∂–∏—Ç–µ –Ω–∞—Å –∏ –ø–æ–¥–ø–∏—à–∏—Ç–µ—Å—å:

${lines}

–° –ª—é–±–æ–≤—å—é, "–í–∏—Ç—Ä–∏–Ω–∞ –†–∞–∑–±–∏—Ç–∞"
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê`;
}
async function prepareDownload(){
  await loadJSZip();
  await prepareFilesList();
  if (!filesToDownload.length) return NotificationSystem.error('–ù–µ—Ç —Ñ–∞–π–ª–æ–≤ –¥–ª—è –∞—Ä—Ö–∏–≤–∞');

  const sizeMB = await calculateArchiveSize();
  document.getElementById('archiveSize').textContent = sizeMB+' –ú–ë';
  document.getElementById('fileCount').textContent = filesToDownload.length;
  closeAlbumDownloadModal();
  document.getElementById('sizeConfirmModal').classList.add('active');
}
function closeSizeConfirmModal(){ document.getElementById('sizeConfirmModal').classList.remove('active'); }
document.getElementById('sizeConfirmModal').onclick = function(e){ if (e.target===this) closeSizeConfirmModal(); };
async function calculateArchiveSize(){
  let total=0; const promises=[];
  for (const f of filesToDownload){
    if (f.url){
      const head = fetch(f.url, {method:'HEAD'}).then(r=>{ const s=r.headers.get('content-length'); return s?parseInt(s):null; }).catch(()=>null);
      const heur = new Promise(r=>setTimeout(()=>r(f.type==='audio'? 5*1024*1024 : f.type==='image'? 500*1024 : 10*1024),500));
      promises.push(Promise.race([head,heur]).then(sz=>{ if (sz) total+=sz; }));
    } else if (f.content){
      total += new Blob([f.content]).size;
    }
  }
  await Promise.allSettled(promises);
  total = Math.ceil(total*1.1);
  return (total/1024/1024).toFixed(1);
}
function startDownload(){ document.getElementById('sizeConfirmModal').classList.remove('active'); createAndDownloadZip(); }
function showProgressModal(){ document.getElementById('downloadProgressModal').classList.add('active'); document.getElementById('progressFill').style.width='0%'; document.getElementById('progressText').textContent = `–ó–∞–≥—Ä—É–∑–∫–∞ —Ñ–∞–π–ª–æ–≤: 0/${filesToDownload.length}`; document.getElementById('errorsList').style.display='none'; }
function updateProgress(done,total){ document.getElementById('progressFill').style.width = `${Math.round(done/total*100)}%`; document.getElementById('progressText').textContent = `–ó–∞–≥—Ä—É–∑–∫–∞ —Ñ–∞–π–ª–æ–≤: ${done}/${total}`; }
function showErrors(errors){ if (errors.length){ document.getElementById('errorsList').style.display='block'; document.getElementById('errorsListContent').innerHTML = errors.map(e=>`<li>${e}</li>`).join(''); } }
async function createAndDownloadZip(){
  await loadJSZip();
  const zip = new JSZip(); const errors=[]; let done=0;
  showProgressModal();
  const BATCH=5;
  for (let i=0;i<filesToDownload.length;i+=BATCH){
    const batch=filesToDownload.slice(i,i+BATCH);
    await Promise.allSettled(batch.map(async f=>{
      try {
        if (f.url){ const r=await fetch(f.url); if (!r.ok) throw new Error(`HTTP ${r.status}`); const b=await r.blob(); zip.file(f.name,b); }
        else zip.file(f.name, f.content);
        done++; updateProgress(done, filesToDownload.length);
      } catch(e){ errors.push(f.name); done++; updateProgress(done, filesToDownload.length); }
    }));
  }
  if (errors.length){ showErrors(errors); await new Promise(r=>setTimeout(r,1500)); }
  document.getElementById('progressText').textContent='–°–æ–∑–¥–∞–Ω–∏–µ –∞—Ä—Ö–∏–≤–∞...';
  const content = await zip.generateAsync({type:'blob', compression:'DEFLATE', compressionOptions:{level:6}}, meta=>{
    document.getElementById('progressText').textContent = `–°–æ–∑–¥–∞–Ω–∏–µ –∞—Ä—Ö–∏–≤–∞: ${meta.percent.toFixed(0)}%`;
    document.getElementById('progressFill').style.width = `${meta.percent.toFixed(0)}%`;
  });
  const a=document.createElement('a'); a.href=URL.createObjectURL(content);
  const date=new Date().toISOString().split('T')[0];
  const albumName = (config?.albumName || 'album').replace(/[\\/:"*?<>|]+/g,'_');
  a.download = `vitrina-razbita-${albumName}-${date}.zip`; a.click();
  setTimeout(()=>{ document.getElementById('downloadProgressModal').classList.remove('active'); URL.revokeObjectURL(a.href); NotificationSystem.success('–ê—Ä—Ö–∏–≤ —Å–∫–∞—á–∞–Ω!'); }, 800);
}

/* ====== Sleep —Ç–∞–π–º–µ—Ä (–¥–æ–±–∞–≤–ª–µ–Ω –≤—ã–±–æ—Ä "–∫ –≤—Ä–µ–º–µ–Ω–∏...") ====== */
function toggleSleepMenu(){ const menu=document.getElementById('sleep-menu'); menu.classList.toggle('active'); if (menu.classList.contains('active')) setTimeout(()=>document.addEventListener('click', closeSleepMenu),100); }
function closeSleepMenu(e){ if (e && e.target.closest('#sleep-timer-btn')) return; document.getElementById('sleep-menu').classList.remove('active'); document.removeEventListener('click', closeSleepMenu); }
function setSleepTimer(minutes){
  closeSleepMenu();
  if (minutes==='off'){ clearSleepTimer(); return; }
  sleepTimerTarget = Date.now() + minutes*60*1000;
  updateSleepTimerUI();
  if (sleepTimerInterval) clearInterval(sleepTimerInterval);
  sleepTimerInterval=setInterval(updateSleepTimerUI,1000);
  NotificationSystem.info(`–¢–∞–π–º–µ—Ä —Å–Ω–∞: ${minutes} –º–∏–Ω`);
}
function showTimePickerForSleep(){
  closeSleepMenu();
  const now = new Date();
  const baseMin = now.getMinutes() + 30;
  const defHour = (now.getHours() + Math.floor(baseMin / 60)) % 24;
  const defMinute = baseMin % 60;
  const modal = document.createElement('div');
  modal.className = 'modal-bg active';
  modal.innerHTML = `
    <div class="modal-feedback" style="max-width: 300px;">
      <button class="bigclose" onclick="this.closest('.modal-bg').remove()" title="–ó–∞–∫—Ä—ã—Ç—å">
        <svg viewBox="0 0 48 48"><line x1="12" y1="12" x2="36" y2="36" stroke="currentColor" stroke-width="6" stroke-linecap="round"/><line x1="36" y1="12" x2="12" y2="36" stroke="currentColor" stroke-width="6" stroke-linecap="round"/></svg>
      </button>
      <h3>–£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Ç–∞–π–º–µ—Ä –¥–æ:</h3>
      <div style="display:flex; gap:10px; justify-content:center; margin:20px 0;">
        <input type="number" id="sleep-hour" min="0" max="23" value="${defHour}" style="width:60px; padding:10px; text-align:center; background: rgba(255,255,255,0.1); border:1px solid var(--border-color); border-radius:8px; color:#fff;">
        <span style="font-size:24px;">:</span>
        <input type="number" id="sleep-minute" min="0" max="59" value="${defMinute}" style="width:60px; padding:10px; text-align:center; background: rgba(255,255,255,0.1); border:1px solid var(--border-color); border-radius:8px; color:#fff;">
      </div>
      <button onclick="setSleepTimerToTime()" class="btn-primary" style="width:100%;">–£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å</button>
    </div>`;
  document.body.appendChild(modal);
}
function setSleepTimerToTime(){
  const hour = parseInt(document.getElementById('sleep-hour').value);
  const minute = parseInt(document.getElementById('sleep-minute').value);
  const now = new Date();
  const target = new Date();
  target.setHours(hour, minute, 0, 0);
  if (target <= now) target.setDate(target.getDate() + 1);
  sleepTimerTarget = target.getTime();
  updateSleepTimerUI();
  const modal = document.querySelector('.modal-bg'); if (modal) modal.remove();
  NotificationSystem.info(`–¢–∞–π–º–µ—Ä —Å–Ω–∞: –¥–æ ${String(hour).padStart(2,'0')}:${String(minute).padStart(2,'0')}`);
  if (sleepTimerInterval) clearInterval(sleepTimerInterval);
  sleepTimerInterval=setInterval(updateSleepTimerUI,1000);
}
function updateSleepTimerUI(){
  if (!sleepTimerTarget) return;
  const rem=sleepTimerTarget-Date.now();
  if (rem<=0){ executeSleepTimer(); return; }
  const m=Math.ceil(rem/60000); const badge=document.getElementById('sleep-timer-badge');
  if (badge){ badge.textContent=String(m); badge.style.display='block'; }
  const btn=document.getElementById('sleep-timer-btn'); if (btn){ btn.classList.add('active'); btn.setAttribute('aria-label',`–¢–∞–π–º–µ—Ä —Å–Ω–∞: –æ—Å—Ç–∞–ª–æ—Å—å ${m} –º–∏–Ω—É—Ç`); }
}
function clearSleepTimer(){
  sleepTimerTarget=null;
  if (sleepTimerInterval) clearInterval(sleepTimerInterval);
  const badge=document.getElementById('sleep-timer-badge'); if (badge) badge.style.display='none';
  const btn=document.getElementById('sleep-timer-btn'); if (btn) btn.classList.remove('active');
  NotificationSystem.info('–¢–∞–π–º–µ—Ä —Å–Ω–∞ –æ—Ç–∫–ª—é—á—ë–Ω');
}
function executeSleepTimer(){
  const a=document.getElementById('audio');
  if (a && !a.paused) a.pause();
  clearSleepTimer();
  showSleepOverlay();
}
function showSleepOverlay(){
  const o=document.createElement('div'); o.className='sleep-overlay active';
  o.innerHTML=`<div class="sleep-content"><div class="sleep-icon">üò¥</div><h2 class="sleep-title">–¢–∞–π–º–µ—Ä —Å–Ω–∞ —Å—Ä–∞–±–æ—Ç–∞–ª</h2><p class="sleep-message">–í–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ</p><div class="sleep-buttons"><button class="sleep-btn sleep-btn-primary" onclick="closeSleepOverlay()">–ì–æ—Ç–æ–≤–æ</button></div></div>`;
  document.body.appendChild(o);
}
function closeSleepOverlay(){ const o=document.querySelector('.sleep-overlay'); if (o){ o.classList.remove('active'); setTimeout(()=>o.remove(),300); } }
function checkSleepTimer() {
  try {
    if (!sleepTimerTarget) return;
    if (Date.now() >= sleepTimerTarget) {
      executeSleepTimer();
    } else {
      updateSleepTimerUI();
    }
  } catch {}
}

/* ====== –ö–Ω–æ–ø–∫–∏ —Å–æ—Å—Ç–æ—è–Ω–∏–π ====== */
function restorePlayerButtonsState() {
  try {
    if (shuffleMode) document.getElementById('shuffle-btn')?.classList.add('active');
    if (repeatMode) document.getElementById('repeat-btn')?.classList.add('repeat-active');
    if (favoritesOnlyMode) {
      document.getElementById('favorites-btn')?.classList.add('favorites-active');
      const icon = document.getElementById('favorites-btn-icon');
      if (icon) icon.src = 'img/star.png';
    }
    if (animationEnabled) document.getElementById('animation-btn')?.classList.add('animation-active');
    if (bitEnabled) document.getElementById('bit-btn')?.classList.add('bit-active');
  } catch {}
}

/* ====== –ê–Ω–∏–º–∞—Ü–∏–∏/–ø—É–ª—å—Å–∞—Ü–∏—è ====== */
// –¢–ò–•–û–ï –ø—Ä–∏–º–µ–Ω–µ–Ω–∏–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è –∞–Ω–∏–º–∞—Ü–∏–∏ –ª–∏—Ä–∏–∫–∏ –±–µ–∑ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –∏ –±–µ–∑ –∑–∞–ø–∏—Å–∏ –≤ localStorage.
// –ù—É–∂–Ω–∞ –¥–ª—è –≤—Ä–µ–º–µ–Ω–Ω–æ–≥–æ –æ—Ç–∫–ª—é—á–µ–Ω–∏—è/–≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è –∞–Ω–∏–º–∞—Ü–∏–∏ –ø—Ä–∏ –º–∏–Ω–∏‚Äë—Ä–µ–∂–∏–º–µ.
function applyAnimationState(enabled) {
  animationEnabled = !!enabled;
  const btn = document.getElementById('animation-btn');
  const bg  = document.querySelector('.lyrics-animated-bg');
  const win = document.getElementById('lyrics-window');

  if (animationEnabled) {
    if (btn) btn.classList.add('animation-active');
    if (bg)  bg.classList.add('active');
    if (win) win.classList.add('animation-active');
  } else {
    if (btn) btn.classList.remove('animation-active');
    if (bg)  bg.classList.remove('active');
    if (win) win.classList.remove('animation-active');
  }
}

function toggleAnimation(){
  animationEnabled=!animationEnabled;
  const btn=document.getElementById('animation-btn'), bg=document.querySelector('.lyrics-animated-bg'), win=document.getElementById('lyrics-window');
  if (animationEnabled){ if (btn) btn.classList.add('animation-active'); if (bg) bg.classList.add('active'); if (win) win.classList.add('animation-active'); NotificationSystem.success('‚ú® –ê–Ω–∏–º–∞—Ü–∏—è –ª–∏—Ä–∏–∫–∏ –≤–∫–ª—é—á–µ–Ω–∞'); }
  else { if (btn) btn.classList.remove('animation-active'); if (bg) bg.classList.remove('active'); if (win) win.classList.remove('animation-active'); NotificationSystem.info('–ê–Ω–∏–º–∞—Ü–∏—è –ª–∏—Ä–∏–∫–∏ –≤—ã–∫–ª—é—á–µ–Ω–∞'); }
  localStorage.setItem('animationEnabled', animationEnabled?'1':'0');
}
function toggleBit(){
  bitEnabled=!bitEnabled;
  const btn=document.getElementById('bit-btn'); if (bitEnabled) btn.classList.add('bit-active'); else btn.classList.remove('bit-active');
  if (bitEnabled){ try{ initAudioContext(); startLogoPulsation(); NotificationSystem.success('üéµ –ü—É–ª—å—Å–∞—Ü–∏—è –≤–∫–ª—é—á–µ–Ω–∞'); }catch{ bitEnabled=false; btn.classList.remove('bit-active'); NotificationSystem.error('–ù–µ —É–¥–∞–ª–æ—Å—å –≤–∫–ª—é—á–∏—Ç—å'); } }
  else { stopLogoPulsation(); try{ if (audioSource) audioSource.disconnect(); if (analyser) analyser.disconnect(); }catch{} analyser=null; audioSource=null; }
  localStorage.setItem('bitEnabled', bitEnabled?'1':'0');
}

function initAudioContext(){
  // 1) –ö–æ–Ω—Ç–µ–∫—Å—Ç
  if (!audioContext) {
    const AC = window.AudioContext || window.webkitAudioContext;
    audioContext = new AC();
  }
  if (audioContext.state === 'suspended') {
    audioContext.resume().catch(()=>{});
  }

  // 2) –ê–Ω–∞–ª–∏–∑–∞—Ç–æ—Ä (—Å–æ–∑–¥–∞—ë–º –æ–¥–∏–Ω —Ä–∞–∑ –∏ –¥–µ—Ä–∂–∏–º)
  if (!analyser) {
    analyser = audioContext.createAnalyser();
    analyser.fftSize = 256;
    analyser.smoothingTimeConstant = 0.8;
  }

  // 3) –ò—Å—Ç–æ—á–Ω–∏–∫ –≤—Å–µ–≥–¥–∞ –ø–µ—Ä–µ–ø—Ä–∏–≤—è–∑—ã–≤–∞–µ–º –∫ —Ç–µ–∫—É—â–µ–º—É audio-—ç–ª–µ–º–µ–Ω—Ç—É
  const a = document.getElementById('audio');
  if (!a) return;

  try { if (audioSource) audioSource.disconnect(); } catch(e) {}
  try { if (analyser) analyser.disconnect(); } catch(e) {}

  audioSource = audioContext.createMediaElementSource(a);
  audioSource.connect(analyser);
  analyser.connect(audioContext.destination);
}
function startLogoPulsation(){
  if (!bitEnabled || !analyser) return; const logo=document.getElementById('logo-bottom'); if (!logo) return;
  logo.classList.add('logo-pulsing'); const dataArray = new Uint8Array(analyser.frequencyBinCount); let lastScale=1;
  (function animate(){
    if (!bitEnabled){ if (lastScale!==1){ logo.style.transform='scale3d(1,1,1)'; lastScale=1; } return; }
    animationFrame = requestAnimationFrame(animate);
    analyser.getByteFrequencyData(dataArray);
    let bass=0; for (let i=0;i<8;i++) bass+=dataArray[i]; bass/=8; let mid=0; for (let i=8;i<32;i++) mid+=dataArray[i]; mid/=24;
    const amplitude = (bass*.7 + mid*.3)/255; const scaled = amplitude*(bitIntensity/100); const scale = 1 + scaled*.3;
    if (Math.abs(scale-lastScale)>0.01){ logo.style.transform=`scale3d(${scale},${scale},1)`; lastScale=scale; }
  })();
}
function stopLogoPulsation(){ const logo=document.getElementById('logo-bottom'); if (logo){ logo.classList.remove('logo-pulsing'); logo.style.transform='scale(1)'; } if (animationFrame){ cancelAnimationFrame(animationFrame); animationFrame=null; } }
function handleLogoClick(){ if (!bitEnabled) return; if (bitIntensity===100) bitIntensity=50; else if (bitIntensity===50) bitIntensity=15; else bitIntensity=100; localStorage.setItem('bitIntensity', String(bitIntensity)); NotificationSystem.info(`üíø –ò–Ω—Ç–µ–Ω—Å–∏–≤–Ω–æ—Å—Ç—å: ${bitIntensity}%`); }

/* ====== PWA/Offline ====== */
function syncOfflineState(){
  offlineMode = localStorage.getItem('offlineMode') === '1';
  if (navigator.serviceWorker && navigator.serviceWorker.controller){
    navigator.serviceWorker.controller.postMessage({ type:'SET_OFFLINE_MODE', value: offlineMode });
  }
}
function setOfflineUIState(state, progress, needMb){
  const btn=document.getElementById('offline-btn');
  if (state==='downloading'){
    btn.disabled=true; btn.className='offline-btn offline'; btn.innerHTML='OFFLINE';
    if (!document.getElementById('offline-progr-div')){
      const div=document.createElement('div'); div.id='offline-progr-div';
      div.innerHTML = `<div class="offline-progress"><div class="offline-progress-bar" id="offline-progress-bar" style="width:0%"></div></div><div class="offline-desc" id="offline-desc"></div>`;
      btn.parentElement.insertBefore(div, btn.nextSibling);
    }
    document.getElementById('offline-progress-bar').style.width = Math.round((progress||0)*100)+'%';
    document.getElementById('offline-desc').innerText = needMb ? `–ó–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è ~${needMb} –ú–ë ...` : '–ó–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è...';
  }
  if (state==='offline'){ btn.disabled=false; btn.className='offline-btn offline'; btn.innerHTML='OFFLINE'; const d=document.getElementById('offline-progr-div'); if (d) d.remove(); }
  if (state==='online'){ btn.disabled=false; btn.className='offline-btn online'; btn.innerHTML='ONLINE'; const d=document.getElementById('offline-progr-div'); if (d) d.remove(); }
}
function offlineUIClick(){
  if (offlineDownloading) return;
  const modal = document.getElementById('modal-offline');
  modal.classList.add('active');
  if (!offlineMode){
    modal.innerHTML = `<div class="modal-feedback" style="max-width:400px;">
      <button class="bigclose" onclick="closeOfflineModal()"><svg viewBox="0 0 48 48"><line x1="12" y1="12" x2="36" y2="36" stroke="currentColor" stroke-width="6" stroke-linecap="round"/><line x1="36" y1="12" x2="12" y2="36" stroke="currentColor" stroke-width="6" stroke-linecap="round"/></svg></button>
      <div style="font-size:1.09em;font-weight:700;margin-bottom:10px;">–û—Ñ—Ñ–ª–∞–π–Ω-—Ä–µ–∂–∏–º</div>
      <div style="margin-bottom:16px;">–°–∫–∞—á–∞–µ–º –º—É–∑—ã–∫—É –Ω–∞ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ.<br>–ù–∞ iOS Safari –æ–±—ä—ë–º –º–æ–∂–µ—Ç –±—ã—Ç—å –æ–≥—Ä–∞–Ω–∏—á–µ–Ω.</div>
      <button class="offline-btn online" style="width:99%;margin-bottom:7px;" onclick="nextOfflineChoice()">–°–æ–≥–ª–∞—Å–µ–Ω</button>
      <button class="offline-btn" style="width:99%;" onclick="closeOfflineModal()">–û—Ç–º–µ–Ω–∞</button>
    </div>`;
  } else {
    modal.innerHTML = `<div class="modal-feedback" style="max-width:400px;">
      <button class="bigclose" onclick="closeOfflineModal()"><svg viewBox="0 0 48 48"><line x1="12" y1="12" x2="36" y2="36" stroke="currentColor" stroke-width="6" stroke-linecap="round"/><line x1="36" y1="12" x2="12" y2="36" stroke="currentColor" stroke-width="6" stroke-linecap="round"/></svg></button>
      <div style="font-size:1.10em;font-weight:700;margin-bottom:15px;">–í–µ—Ä–Ω—É—Ç—å—Å—è ONLINE?</div>
      <div style="margin-bottom:20px;">–í—Å–µ –æ—Ñ–ª–∞–π–Ω‚Äë—Ñ–∞–π–ª—ã –±—É–¥—É—Ç —É–¥–∞–ª–µ–Ω—ã.</div>
      <button class="offline-btn online" style="width:99%;" onclick="confirmGoOnline()">–£–¥–∞–ª–∏—Ç—å —Ñ–∞–π–ª—ã –∏ ONLINE</button>
      <button class="offline-btn" style="width:99%;margin-top:7px;" onclick="closeOfflineModal()">–û—Ç–º–µ–Ω–∞</button>
    </div>`;
  }
}
function closeOfflineModal(){ document.getElementById('modal-offline').classList.remove('active'); }
function nextOfflineChoice(){
  const liked = getLiked();
  const allCount = config.tracks.length, likedCount = liked.length;
  const modal = document.getElementById('modal-offline');
  modal.innerHTML = `<div class="modal-feedback" style="max-width:400px;">
    <button class="bigclose" onclick="closeOfflineModal()"><svg viewBox="0 0 48 48"><line x1="12" y1="12" x2="36" y2="36" stroke="currentColor" stroke-width="6" stroke-linecap="round"/><line x1="36" y1="12" x2="12" y2="36" stroke="currentColor" stroke-width="6" stroke-linecap="round"/></svg></button>
    <div style="font-size:1.10em;font-weight:700;margin-bottom:13px;">–ß—Ç–æ —Å–∫–∞—á–∞—Ç—å?</div>
    <div style="text-align:left;">
      <label style="display:block;margin:8px 0;"><input type="radio" name="offline-mode" value="all" checked> –í–µ—Å—å –∞–ª—å–±–æ–º (${allCount} –ø–µ—Å–µ–Ω)</label>
      <label style="display:block;margin:8px 0;"><input type="radio" name="offline-mode" value="liked"> –¢–æ–ª—å–∫–æ –ø–æ–Ω—Ä–∞–≤–∏–≤—à–∏–µ—Å—è (${likedCount} –ø–µ—Å–µ–Ω)</label>
    </div>
    <button class="offline-btn online" style="width:99%;margin-top:12px;" onclick="startOfflineDownload()">–°–∫–∞—á–∞—Ç—å –≤—ã–±—Ä–∞–Ω–Ω–æ–µ</button>
    <button class="offline-btn" style="width:99%;margin-top:8px;" onclick="closeOfflineModal()">–û—Ç–º–µ–Ω–∞</button>
  </div>`;
}
function getAllAssetsForOffline(mode){
  const files = [ './', './index.html', './manifest.json', './albums.json', 'img/logo.png', 'img/star.png', 'img/star2.png' ];
  ['Cover.png','Cover01.png','Cover02.png','Cover03.png'].forEach(c=> files.push(absJoin(albumBase, c)));
  const liked = getLiked();
  const include = (i)=> mode==='all' || liked.includes(i);
  for (let i=0;i<config.tracks.length;i++){
    if (include(i)){
      const t=config.tracks[i];
      files.push(t.audio); files.push(t.lyrics); if (t.fulltext) files.push(t.fulltext);
    }
  }
  return Array.from(new Set(files));
}
function startOfflineDownload(){
  offlineDownloading=true; closeOfflineModal(); setOfflineUIState('downloading');
  const mode = document.querySelector('input[name="offline-mode"]:checked').value;
  const files = getAllAssetsForOffline(mode);
  navigator.serviceWorker.ready.then(async sw=>{
    sw.active.postMessage({ type:'CACHE_FILES', files, offlineMode:true });
    const max = files.length;
    const timer = setInterval(async ()=>{
      const cache = await caches.open('album-offline-v1'); let ok=0;
      for (const src of files){ const res = await cache.match(src); if (res) ok++; }
      setOfflineUIState('downloading', ok/max, null);
      if (ok>=max){
        clearInterval(timer);
        offlineDownloading=false; offlineMode=true; localStorage.setItem('offlineMode','1'); setOfflineUIState('offline'); syncOfflineState();
        NotificationSystem.success('–í—Å–µ —Ñ–∞–π–ª—ã –¥–æ—Å—Ç—É–ø–Ω—ã –æ—Ñ–ª–∞–π–Ω');
      }
    },400);
  });
}
function confirmGoOnline(){
  offlineMode=false; localStorage.removeItem('offlineMode'); setOfflineUIState('online'); closeOfflineModal();
  navigator.serviceWorker.ready.then(sw=>{ sw.active.postMessage({ type:'CLEAR_CACHE', offlineMode:false }); });
}

/* ====== iOS –ø–æ–¥—Å–∫–∞–∑–∫–∞ —É—Å—Ç–∞–Ω–æ–≤–∫–∏ ====== */
function detectIOSAndShowInstallGuide(){
  const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream;
  const isInStandaloneMode = window.navigator.standalone === true;
  const isInPWA = window.matchMedia('(display-mode: standalone)').matches;
  if (isIOS && !isInStandaloneMode && !isInPWA) {
    if (!localStorage.getItem('ios-install-dismissed')) setTimeout(showIOSInstallPrompt, 2000);
  }
}
function showIOSInstallPrompt() {
  try {
    if (document.querySelector('.ios-install-prompt')) return;
    const wrap = document.createElement('div');
    wrap.className = 'ios-install-prompt';
    wrap.innerHTML = `
      <div class="ios-prompt-content">
        <button class="ios-prompt-close" onclick="dismissIOSPrompt()" aria-label="–ó–∞–∫—Ä—ã—Ç—å">√ó</button>
        <img src="img/logo.png" alt="–í–∏—Ç—Ä–∏–Ω–∞ –†–∞–∑–±–∏—Ç–∞" class="ios-prompt-icon">
        <h3 style="margin:6px 0 10px 0;">–£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ</h3>
        <p style="margin:0 0 8px 0;">–£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ —ç—Ç–æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –Ω–∞ —Å–≤–æ–π iPhone:</p>
        <ol style="text-align:left; margin:10px auto; max-width:280px; line-height:1.55;">
          <li>–ù–∞–∂–º–∏—Ç–µ ¬´–ü–æ–¥–µ–ª–∏—Ç—å—Å—è¬ª –≤–Ω–∏–∑—É —ç–∫—Ä–∞–Ω–∞</li>
          <li>–ü—Ä–æ–∫—Ä—É—Ç–∏—Ç–µ –∏ –≤—ã–±–µ—Ä–∏—Ç–µ ¬´–ù–∞ —ç–∫—Ä–∞–Ω –î–æ–º–æ–π¬ª</li>
          <li>–ù–∞–∂–º–∏—Ç–µ ¬´–î–æ–±–∞–≤–∏—Ç—å¬ª</li>
        </ol>
        <button onclick="dismissIOSPrompt()" class="ios-prompt-button">–ü–æ–Ω—è—Ç–Ω–æ</button>
      </div>`;
    document.body.appendChild(wrap);
    setTimeout(() => wrap.classList.add('show'), 30);
  } catch (e) {}
}
function dismissIOSPrompt() {
  try {
    const el = document.querySelector('.ios-install-prompt');
    if (!el) return;
    el.classList.remove('show');
    setTimeout(() => {
      el.remove();
      try { localStorage.setItem('ios-install-dismissed', String(Date.now())); } catch {}
    }, 300);
  } catch (e) {}
}

/* ====== –°—Ç–∞—Ä—Ç: –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π —ç–∫—Ä–∞–Ω ====== */
(function boot(){
  applyLogos();
  if (localStorage.getItem('promoPassed') === '1') {
    document.getElementById('promocode-block').classList.add('hidden');
    document.getElementById('main-block').classList.remove('hidden');
    initializeMainUi();
  } else {
    loadAlbumsIndex().catch(()=>{});
  }
})();
</script>
</body>
</html>
