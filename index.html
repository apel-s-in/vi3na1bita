<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>Витрина Разбита</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
  <meta name="description" content="Официальные альбомы группы Витрина Разбита. Слушайте онлайн и офлайн.">

  <!-- PWA -->
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#181818">

  <!-- iOS -->
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="Витрина Разбита">
  
  <!-- Preconnect для ускорения загрузки -->
  <link rel="preconnect" href="https://apel-s-in.github.io">
  <link rel="dns-prefetch" href="https://cdnjs.cloudflare.com">

  <!-- FAVICONS -->
  <link rel="icon" href="assets/icons/favicon-32.png" sizes="32x32" type="image/png">
  <link rel="icon" href="assets/icons/favicon-16.png" sizes="16x16" type="image/png">
  <link rel="apple-touch-icon" href="assets/icons/apple-touch-icon.png">

  <style>
    :root {
      --primary-bg: #181818;
      --primary-color: #E80100;
      --secondary-color: #4daaff;
      --text-color: #f2f2f2;
      --modal-bg: #252d39;
      --border-color: #394866;
    }
    
    * { 
      box-sizing: border-box;
    }
    
    html, body { 
      height: 100%;
    }
    
    body {
      min-height: 100vh;
      background: var(--primary-bg);
      color: var(--text-color);
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      margin: 0;
      padding: 0;
      display: flex;
      flex-direction: column;
      min-width: 100vw;
      padding-top: env(safe-area-inset-top);
      
      /* Оптимизация рендеринга */
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }

    /* Промокод */
    #promocode-block {
      position: fixed;
      inset: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      background: var(--primary-bg);
      z-index: 100;
      
      /* Изоляция слоя */
      contain: layout style paint;
    }
    
    .promo-inner {
      display: flex;
      flex-direction: column;
      align-items: center;
      background: rgba(15,18,24,0.98);
      border-radius: 16px;
      box-shadow: 0 6px 24px #0008;
      padding: 36px 26px 32px 26px;
      min-width: 260px;
      min-height: 170px;
    }
    
    .promo-cover {
      width: 256px;
      height: 256px;
      object-fit: cover;
      border-radius: 12px;
      box-shadow: 0 4px 24px #000c;
      margin-bottom: 19px;
      display: block;
      background: var(--primary-bg);
    }
    
    #promo-inp {
      padding: 10px;
      border-radius: 8px;
      border: 1px solid var(--border-color);
      background: rgba(255,255,255,0.1);
      color: var(--text-color);
      margin: 10px 0;
      width: 100%;
      font-size: 16px;
    }
    
    #promo-btn {
      padding: 10px 20px;
      background: var(--primary-color);
      color: white;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-weight: bold;
      transition: opacity 0.2s;
    }
    
    #promo-btn:hover:not(:disabled) {
      opacity: .8;
    }
    
    #promo-btn:disabled {
      opacity: .5;
      cursor: not-allowed;
    }
    
    #promo-error {
      color: #ff6b6b;
      margin-top: 10px;
      font-size: 14px;
    }

    .hidden {
      display: none !important;
    }

    /* Основной блок */
    #main-block {
      max-width: 420px;
      margin: 0 auto;
      flex: 1 0 auto;
      display: flex;
      flex-direction: column;
      align-items: center;
      width: 100%;
      padding: 0 10px;
      
      /* Оптимизация */
      contain: layout style;
    }
    
    header {
      width: 100%;
      text-align: center;
      margin: 0 auto;
    }
    
    /* Заголовок активного раздела */
    .active-album-title {
      width: 100%;
      max-width: 400px;
      margin: 18px auto 6px auto;
      text-align: center;
      color: #eaf2ff;
      font-weight: 900;
      letter-spacing: .01em;
      line-height: 1.15;
      text-shadow: 0 1px 0 rgba(0,0,0,.35);
      font-size: clamp(18px, 4.6vw, 24px);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    
    .active-album-title.fav {
      color: #ffd166;
      letter-spacing: .06em;
    }
    
    .active-album-title.news {
      color: #8ab8fd;
      letter-spacing: .02em;
    }

    /* Обложка/галерея */
    #cover-wrap {
      width: 100%;
      max-width: 400px;
      margin: 14px auto 0 auto;
      aspect-ratio: 1/1;
      display: flex;
      align-items: center;
      justify-content: center;
      position: relative;
      
      /* Оптимизация */
      contain: layout style paint;
      transform: translateZ(0);
    }
    
    .cover-gallery-arrow {
      position: absolute;
      top: 50%;
      transform: translateY(-50%);
      z-index: 2;
      border: none;
      cursor: pointer;
      background: none;
      padding: 0;
      width: 44px;
      height: 44px;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: opacity 0.2s;
      visibility: hidden;
      pointer-events: none;
    }
    
    #cover-wrap.gallery-nav-ready .cover-gallery-arrow {
      visibility: visible;
      pointer-events: auto;
    }
    
    .cover-gallery-arrow:hover {
      opacity: 0.8;
    }
    
    #cover-gallery-arrow-left {
      left: 7px;
    }
    
    #cover-gallery-arrow-right {
      right: 7px;
    }
    
    /* Универсальный слот галереи */
    #cover-slot {
      width: 100%;
      height: 100%;
      border-radius: 12px;
      overflow: hidden;
      background: var(--primary-bg);
      box-shadow: 0 4px 24px rgba(0,0,0,0.3);
      position: relative;
      
      /* Оптимизация */
      contain: layout style paint;
    }
    
    #cover-slot img,
    #cover-slot iframe {
      width: 100%;
      height: 100%;
      display: block;
      border: 0;
      background: transparent;
    }
    
    #cover-slot img {
      object-fit: contain;
      background: transparent;
    }
    
    #cover-slot iframe {
      background: transparent;
    }

    /* Лого */
    .logo-bottom {
      max-width: 112px;
      width: 23vw;
      min-width: 66px;
      height: auto;
      display: block;
      margin: 0 auto 15px auto !important;
      cursor: pointer;
      transition: transform 0.1s ease-out;
      transform: translateZ(0);
      transform-origin: center center;
      isolation: isolate;
      z-index: 10;
      position: relative;
      
      /* GPU ускорение */
      backface-visibility: hidden;
    }

    .socials-under-cover {
      margin: 14px auto 0 auto;
      width: 100%;
      max-width: 398px;
      text-align: center;
      font-size: 1.03em;
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: 12px;
    }
    
    .socials-under-cover a {
      color: var(--secondary-color);
      text-decoration: none;
      transition: color 0.2s;
    }
    
    .socials-under-cover a:hover {
      color: var(--text-color);
    }

    /* Треки */
    .track-list {
      margin: 0 auto;
      max-width: 370px;
      width: 100%;
      font-size: 1.05em;
      color: #eee;
      background: none;
      padding: 0;
      
      /* Оптимизация */
      contain: layout style;
    }
    
    .track-list.filtered .track:not(.is-favorite) {
      display: none !important;
    }
    
    .track {
      display: flex;
      align-items: center;
      padding: 7px 8px;
      border-bottom: 1px solid var(--border-color);
      cursor: pointer;
      transition: background 0.13s;
      background: none;
      
      /* Оптимизация */
      contain: layout style paint;
    }
    
    .track:hover {
      background: rgba(255,255,255,0.05);
    }
    
    .track.current {
      background: #232b38;
    }
    
    .track.inactive {
      opacity: .5;
      filter: grayscale(60%);
    }
    
    .tnum {
      min-width: 27px;
      color: #8ab8fd;
    }
    
    .track-title {
      margin-left: 7px;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
      flex: 1;
    }
    
    .like-star {
      margin-left: auto;
      width: 19px;
      height: 19px;
      cursor: pointer;
      opacity: 0.97;
      border: none;
      background: none;
      padding: 0;
      appearance: none;
      display: inline-block;
      transition: transform 0.2s, filter 0.13s, opacity 0.13s;
    }
    
    .like-star:hover {
      filter: brightness(1.13);
      opacity: 1;
      transform: scale(1.1);
    }
    
    .like-star.animating {
      animation: starPulse 0.3s;
    }
    
    @keyframes starPulse {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.3); }
    }

    /* Лирика + Плеер */
    .lyrics-player-block {
      width: 100%;
      margin: 8px 0 3px 0;
      
      /* Оптимизация */
      contain: layout style;
    }
    
    #lyrics-window {
      width: 100%;
      background: rgba(34,34,34,0.98);
      border-radius: 12px;
      box-shadow: 0 8px 24px #0007;
      overflow: hidden;
      height: 8.5em;
      position: relative;
      display: flex;
      flex-direction: column;
      align-items: stretch;
      justify-content: center;
      margin-bottom: 7px;
      transition: height 0.2s ease, opacity 0.2s ease, margin 0.2s ease;
      
      /* Оптимизация анимаций */
      will-change: height, opacity;
      contain: layout style paint;
    }
    
    #lyrics-window.lyrics-hidden {
      height: 0 !important;
      opacity: 0;
      margin: 0;
      overflow: hidden;
      pointer-events: none;
    }
    
    #lyrics-window.lyrics-normal {
      height: 8.7em;
    }
    
    #lyrics-window.lyrics-expanded {
      height: 15.6em;
    }
    
    .lyrics-scroll {
      position: relative;
      z-index: 1;
    }
    
    .lyrics-window-line {
      opacity: 0.57;
      font-size: 1.13em;
      transition: all 0.2s;
      line-height: 1.7em;
      text-align: center;
      min-height: 1.7em;
      max-width: 97%;
      margin: 0 auto;
      color: #eee;
      white-space: pre-line;
      user-select: none;
      word-break: break-word;
      position: relative;
      z-index: 1;
    }
    
    .lyrics-window-line.active {
      color: var(--primary-color);
      font-weight: bold;
      opacity: 1;
      text-shadow: 0 1px 7px #73161644;
      background: rgba(0,0,0,0.07);
      border-radius: 8px;
      font-size: 1.19em;
    }
    /* Inline плеер */
    .inline-player {
      background: rgba(34,34,34,0.98);
      border-radius: 12px;
      box-shadow: 0 8px 24px #0007;
      padding: 14px 16px;
      margin: 0 0 7px 0;
      width: 100%;
      
      /* Оптимизация */
      contain: layout style paint;
    }
    
    .player-title-row {
      display: flex;
      align-items: center;
      margin-bottom: 10px;
    }
    
    .player-song-title {
      font-size: 1.1em;
      font-weight: 600;
      color: var(--text-color);
      flex: 1;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    
    .lyrics-toggle-btn {
      background: transparent;
      border: 1px solid var(--border-color);
      color: var(--secondary-color);
      padding: 4px 8px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 0.9em;
      margin-left: 10px;
      transition: all 0.2s;
    }
    
    .lyrics-toggle-btn:hover {
      background: rgba(255,255,255,0.1);
      border-color: var(--secondary-color);
    }
    
    .lyrics-toggle-btn.active {
      background: var(--secondary-color);
      color: white;
      border-color: transparent;
    }
    
    .progress-bar-container {
      width: 100%;
      height: 6px;
      background: rgba(255,255,255,0.1);
      border-radius: 3px;
      cursor: pointer;
      position: relative;
      margin: 12px 0;
    }
    
    .progress-bar {
      height: 100%;
      background: linear-gradient(90deg, var(--secondary-color), var(--primary-color));
      border-radius: 3px;
      width: 0;
      transition: width 0.1s linear;
      
      /* GPU ускорение */
      transform: translateZ(0);
      will-change: width;
    }
    
    .time-display {
      display: flex;
      justify-content: space-between;
      font-size: 0.9em;
      color: rgba(255,255,255,0.6);
      margin: 5px 0;
    }
    
    .player-controls {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 15px;
      margin-top: 10px;
    }
    
    .control-btn {
      background: none;
      border: none;
      color: var(--text-color);
      cursor: pointer;
      padding: 8px;
      border-radius: 50%;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    .control-btn:hover {
      background: rgba(255,255,255,0.1);
      transform: scale(1.1);
    }
    
    .control-btn.play-pause {
      background: var(--primary-color);
      width: 48px;
      height: 48px;
    }
    
    .control-btn.play-pause:hover {
      background: var(--primary-color);
      opacity: 0.8;
    }

    /* Мини плеер */
    #mini-player {
      position: fixed;
      bottom: 65px;
      left: 0;
      right: 0;
      background: linear-gradient(to bottom, rgba(30,30,30,0.98), rgba(20,20,20,0.99));
      backdrop-filter: blur(20px);
      -webkit-backdrop-filter: blur(20px);
      box-shadow: 0 -2px 20px rgba(0,0,0,0.5);
      z-index: 50;
      display: none;
      padding: 10px 15px;
      
      /* Оптимизация */
      contain: layout style paint;
      transform: translateZ(0);
    }
    
    #mini-player.visible {
      display: block;
      animation: slideUp 0.3s ease-out;
    }
    
    @keyframes slideUp {
      from {
        transform: translateY(100%);
      }
      to {
        transform: translateY(0);
      }
    }
    
    .mini-player-content {
      display: flex;
      align-items: center;
      gap: 12px;
      max-width: 420px;
      margin: 0 auto;
    }
    
    .mini-album-icon {
      width: 48px;
      height: 48px;
      border-radius: 8px;
      object-fit: cover;
      background: var(--primary-bg);
    }
    
    .mini-track-info {
      flex: 1;
      min-width: 0;
    }
    
    .mini-track-title {
      font-weight: 600;
      font-size: 0.95em;
      color: var(--text-color);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      margin-bottom: 2px;
    }
    
    .mini-album-title {
      font-size: 0.85em;
      color: rgba(255,255,255,0.6);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    
    .mini-controls {
      display: flex;
      gap: 8px;
    }
    
    .mini-control-btn {
      background: none;
      border: none;
      color: var(--text-color);
      padding: 8px;
      cursor: pointer;
      transition: transform 0.2s;
    }
    
    .mini-control-btn:hover {
      transform: scale(1.1);
    }
    
    .mini-control-btn.play-pause {
      color: var(--primary-color);
    }
    
    .mini-progress {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 3px;
      background: rgba(255,255,255,0.1);
    }
    
    .mini-progress-bar {
      height: 100%;
      background: var(--primary-color);
      width: 0;
      transition: width 0.1s linear;
      
      /* GPU ускорение */
      transform: translateZ(0);
      will-change: width;
    }

    /* Навигация */
    .navigation {
      position: sticky;
      bottom: 0;
      background: linear-gradient(to top, rgba(24,24,24,0.99), rgba(24,24,24,0.95));
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      padding: 8px 0 max(8px, env(safe-area-inset-bottom));
      margin-top: auto;
      z-index: 40;
      border-top: 1px solid var(--border-color);
      
      /* Оптимизация */
      contain: layout style paint;
    }
    
    .nav-content {
      display: flex;
      justify-content: space-around;
      max-width: 420px;
      margin: 0 auto;
    }
    
    .nav-tab {
      padding: 8px 16px;
      color: rgba(255,255,255,0.6);
      background: none;
      border: none;
      cursor: pointer;
      transition: color 0.2s;
      font-size: 0.9em;
      position: relative;
    }
    
    .nav-tab:hover {
      color: var(--text-color);
    }
    
    .nav-tab.active {
      color: var(--primary-color);
    }
    
    .nav-tab.active::after {
      content: '';
      position: absolute;
      bottom: -8px;
      left: 50%;
      transform: translateX(-50%);
      width: 30px;
      height: 3px;
      background: var(--primary-color);
      border-radius: 2px;
    }

    /* Модалки */
    #modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.7);
      backdrop-filter: blur(5px);
      -webkit-backdrop-filter: blur(5px);
      z-index: 60;
      display: none;
      
      /* Оптимизация */
      contain: layout style paint;
    }
    
    #modal-overlay.show {
      display: block;
      animation: fadeIn 0.2s;
    }
    
    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }
    
    .modal-window {
      position: fixed;
      background: var(--modal-bg);
      border-radius: 16px;
      box-shadow: 0 10px 40px rgba(0,0,0,0.5);
      z-index: 61;
      padding: 20px;
      max-width: 90%;
      max-height: 80vh;
      overflow-y: auto;
      display: none;
      
      /* Центрирование */
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      
      /* Оптимизация */
      contain: layout style paint;
    }
    
    .modal-window.show {
      display: block;
      animation: slideIn 0.3s ease-out;
    }
    
    @keyframes slideIn {
      from {
        opacity: 0;
        transform: translate(-50%, -45%);
      }
      to {
        opacity: 1;
        transform: translate(-50%, -50%);
      }
    }
    
    .modal-close {
      position: absolute;
      top: 10px;
      right: 10px;
      background: none;
      border: none;
      color: var(--text-color);
      font-size: 24px;
      cursor: pointer;
      padding: 5px;
      opacity: 0.7;
      transition: opacity 0.2s;
    }
    
    .modal-close:hover {
      opacity: 1;
    }

    /* Утилиты */
    .skeleton {
      animation: skeleton-loading 1s linear infinite alternate;
    }
    
    @keyframes skeleton-loading {
      0% { background-color: rgba(255,255,255,0.05); }
      100% { background-color: rgba(255,255,255,0.1); }
    }
    
    .fade-in {
      animation: fadeIn 0.3s ease-out;
    }
    
    /* Оптимизация производительности */
    @media (prefers-reduced-motion: reduce) {
      * {
        animation-duration: 0.01ms !important;
        animation-iteration-count: 1 !important;
        transition-duration: 0.01ms !important;
      }
    }
    
    /* Мобильная адаптация */
    @media (max-width: 390px) {
      .active-album-title {
        font-size: 18px;
      }
      
      .track-list {
        font-size: 0.95em;
      }
      
      .inline-player {
        padding: 10px 12px;
      }
    }
  </style>
</head>
<body>
  <!-- Промокод блок -->
  <div id="promocode-block">
    <div class="promo-inner">
      <img src="assets/img/mobile/logo@2x.jpg" alt="Промокод" class="promo-cover">
      <input type="text" id="promo-inp" placeholder="Введите промокод" maxlength="20" autocomplete="off">
      <button id="promo-btn">Войти</button>
      <div id="promo-error" class="hidden"></div>
    </div>
  </div>

  <!-- Основной контент -->
  <div id="main-block" class="hidden">
    <header>
      <div class="active-album-title" id="album-title">Загрузка...</div>
      
      <!-- Обложка с галереей -->
      <div id="cover-wrap">
        <button class="cover-gallery-arrow" id="cover-gallery-arrow-left" aria-label="Предыдущее изображение">
          <svg width="24" height="24" viewBox="0 0 24 24" fill="none">
            <path d="M15 18L9 12L15 6" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
        </button>
        
        <div id="cover-slot">
          <!-- Сюда загружается контент галереи -->
        </div>
        
        <button class="cover-gallery-arrow" id="cover-gallery-arrow-right" aria-label="Следующее изображение">
          <svg width="24" height="24" viewBox="0 0 24 24" fill="none">
            <path d="M9 18L15 12L9 6" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
        </button>
      </div>
      
      <!-- Социальные сети -->
      <div class="socials-under-cover">
        <a href="https://vk.com/vitrina_razbita" target="_blank" rel="noopener">VK</a>
        <a href="https://t.me/vitrina_razbita" target="_blank" rel="noopener">Telegram</a>
        <a href="https://instagram.com/vitrina_razbita" target="_blank" rel="noopener">Instagram</a>
      </div>
    </header>

    <!-- Список треков -->
    <div class="track-list" id="track-list"></div>

    <!-- Лого внизу -->
    <img src="assets/img/mobile/logo@1x.jpg" 
         srcset="assets/img/mobile/logo@1x.jpg 1x, assets/img/mobile/logo@2x.jpg 2x"
         alt="Витрина Разбита" 
         class="logo-bottom"
         loading="lazy">
  </div>

  <!-- Мини плеер -->
  <div id="mini-player">
    <div class="mini-progress">
      <div class="mini-progress-bar"></div>
    </div>
    <div class="mini-player-content">
      <img class="mini-album-icon" id="mini-album-icon" alt="">
      <div class="mini-track-info">
        <div class="mini-track-title" id="mini-track-title">—</div>
        <div class="mini-album-title" id="mini-album-title">—</div>
      </div>
      <div class="mini-controls">
        <button class="mini-control-btn" id="mini-prev" aria-label="Предыдущий трек">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
            <path d="M6 6h2v12H6zm3.5 6l8.5 6V6z"/>
          </svg>
        </button>
        <button class="mini-control-btn play-pause" id="mini-play-pause" aria-label="Воспроизведение">
          <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
            <path d="M8 5v14l11-7z"/>
          </svg>
        </button>
        <button class="mini-control-btn" id="mini-next" aria-label="Следующий трек">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
            <path d="M18 18h-2V6h2zm-3.5-6L6 18V6z"/>
          </svg>
        </button>
      </div>
    </div>
  </div>

  <!-- Навигация -->
  <nav class="navigation">
    <div class="nav-content">
      <button class="nav-tab" data-tab="albums">Альбомы</button>
      <button class="nav-tab" data-tab="favorites">Избранное</button>
      <button class="nav-tab" data-tab="about">О группе</button>
    </div>
  </nav>

  <!-- Модальные окна -->
  <div id="modal-overlay"></div>
  
  <div class="modal-window" id="albums-modal">
    <button class="modal-close">&times;</button>
    <h2>Альбомы</h2>
    <div id="albums-list"></div>
  </div>
  
  <div class="modal-window" id="about-modal">
    <button class="modal-close">&times;</button>
    <h2>О группе</h2>
    <div id="about-content"></div>
  </div>

  <script>
    'use strict';

    // ===== КОНФИГУРАЦИЯ =====
    const CONFIG = {
      STORAGE_PREFIX: 'vr_',
      GALLERY_SESSION_TTL: 30000, // 30 секунд актуальности сессии галереи
      AUDIO_FADE_DURATION: 300,
      PROGRESS_UPDATE_INTERVAL: 100,
      CACHE_TTL: 3600000, // 1 час
      MAX_RETRIES: 3,
      RETRY_DELAY: 1000,
      DEFAULT_ALBUM: '00'
    };

    // ===== ГЛОБАЛЬНОЕ СОСТОЯНИЕ =====
    const AppState = {
      currentAlbum: null,
      currentTrackIndex: null,
      isPlaying: false,
      currentGallerySession: null,
      galleryItems: [],
      galleryIndex: 0,
      albumsData: null,
      customData: null,
      cache: new Map(),
      pendingRequests: new Map()
    };

    // ===== ЕДИНЫЙ АУДИО КОНТРОЛЛЕР =====
    class AudioController {
      constructor() {
        this.audio = new Audio();
        this.audio.preload = 'metadata';
        this.currentAlbum = null;
        this.currentTrackIndex = null;
        this.fadeInterval = null;
        this.progressInterval = null;
        
        // Обработчики событий
        this.audio.addEventListener('ended', () => this.onTrackEnded());
        this.audio.addEventListener('error', (e) => this.onError(e));
        this.audio.addEventListener('loadedmetadata', () => this.onMetadataLoaded());
        this.audio.addEventListener('timeupdate', () => this.updateProgress());
      }

      play(album, trackIndex) {
        // Отменяем предыдущие операции
        this.stop();
        
        // Сохраняем контекст
        this.currentAlbum = album;
        this.currentTrackIndex = trackIndex;
        
        const track = album.tracks[trackIndex];
        if (!track || !track.url) return;
        
        // Загружаем трек
        this.audio.src = track.url;
        this.audio.load();
        
        // Воспроизводим с fade in
        this.audio.volume = 0;
        this.audio.play().then(() => {
          this.fadeIn();
          this.startProgressUpdate();
          this.updateUI('playing');
          
          // Сохраняем состояние
          this.saveState();
        }).catch(err => {
          console.error('Ошибка воспроизведения:', err);
          this.updateUI('paused');
        });
      }

      pause() {
        if (this.audio.paused) return;
        
        this.fadeOut(() => {
          this.audio.pause();
          this.stopProgressUpdate();
          this.updateUI('paused');
        });
      }

      resume() {
        if (!this.audio.paused) return;
        
        this.audio.volume = 0;
        this.audio.play().then(() => {
          this.fadeIn();
          this.startProgressUpdate();
          this.updateUI('playing');
        });
      }

      stop() {
        this.stopProgressUpdate();
        clearInterval(this.fadeInterval);
        this.audio.pause();
        this.audio.currentTime = 0;
        this.updateUI('stopped');
      }

      next() {
        if (!this.currentAlbum || this.currentTrackIndex === null) return;
        
        const nextIndex = this.currentTrackIndex + 1;
        if (nextIndex < this.currentAlbum.tracks.length) {
          this.play(this.currentAlbum, nextIndex);
        }
      }

      prev() {
        if (!this.currentAlbum || this.currentTrackIndex === null) return;
        
        // Если прошло больше 3 секунд - перематываем на начало
        if (this.audio.currentTime > 3) {
          this.audio.currentTime = 0;
          return;
        }
        
        const prevIndex = this.currentTrackIndex - 1;
        if (prevIndex >= 0) {
          this.play(this.currentAlbum, prevIndex);
        }
      }

      seek(percent) {
        if (!this.audio.duration) return;
        this.audio.currentTime = this.audio.duration * percent;
      }

      fadeIn(callback) {
        clearInterval(this.fadeInterval);
        
        const targetVolume = 1;
        const step = targetVolume / (CONFIG.AUDIO_FADE_DURATION / 20);
        
        this.fadeInterval = setInterval(() => {
          if (this.audio.volume < targetVolume - step) {
            this.audio.volume = Math.min(this.audio.volume + step, targetVolume);
          } else {
            this.audio.volume = targetVolume;
            clearInterval(this.fadeInterval);
            if (callback) callback();
          }
        }, 20);
      }

      fadeOut(callback) {
        clearInterval(this.fadeInterval);
        
        const step = this.audio.volume / (CONFIG.AUDIO_FADE_DURATION / 20);
        
        this.fadeInterval = setInterval(() => {
          if (this.audio.volume > step) {
            this.audio.volume = Math.max(this.audio.volume - step, 0);
          } else {
            this.audio.volume = 0;
            clearInterval(this.fadeInterval);
            if (callback) callback();
          }
        }, 20);
      }

      startProgressUpdate() {
        this.stopProgressUpdate();
        this.progressInterval = setInterval(() => {
          this.updateProgress();
        }, CONFIG.PROGRESS_UPDATE_INTERVAL);
      }

      stopProgressUpdate() {
        if (this.progressInterval) {
          clearInterval(this.progressInterval);
          this.progressInterval = null;
        }
      }

      updateProgress() {
        if (!this.audio.duration) return;
        
        const percent = (this.audio.currentTime / this.audio.duration) * 100;
        
        // Обновляем прогресс бары
        const progressBars = document.querySelectorAll('.progress-bar, .mini-progress-bar');
        progressBars.forEach(bar => {
          bar.style.width = `${percent}%`;
        });
        
        // Обновляем время
        const currentTime = this.formatTime(this.audio.currentTime);
        const duration = this.formatTime(this.audio.duration);
        
        const timeDisplays = document.querySelectorAll('.time-current');
        timeDisplays.forEach(el => el.textContent = currentTime);
        
        const durationDisplays = document.querySelectorAll('.time-total');
        durationDisplays.forEach(el => el.textContent = duration);
      }

      formatTime(seconds) {
        if (!seconds || isNaN(seconds)) return '0:00';
        const mins = Math.floor(seconds / 60);
        const secs = Math.floor(seconds % 60);
        return `${mins}:${secs.toString().padStart(2, '0')}`;
      }

      onTrackEnded() {
        this.next();
      }

      onError(error) {
        console.error('Ошибка аудио:', error);
        this.updateUI('error');
      }

      onMetadataLoaded() {
        // Метаданные загружены
        this.updateProgress();
      }

      updateUI(state) {
        // Обновляем состояние UI
        AppState.isPlaying = (state === 'playing');
        
        // Обновляем кнопки play/pause
        const playBtns = document.querySelectorAll('.play-pause');
        playBtns.forEach(btn => {
          const svg = btn.querySelector('svg');
          if (svg) {
            if (state === 'playing') {
              svg.innerHTML = '<path d="M6 4h4v16H6zM14 4h4v16h-4z"/>';
            } else {
              svg.innerHTML = '<path d="M8 5v14l11-7z"/>';
            }
          }
        });
        
        // Показываем/скрываем плееры
        this.updatePlayerVisibility();
      }

      updatePlayerVisibility() {
        const isCurrentAlbum = this.currentAlbum && 
                              this.currentAlbum.id === AppState.currentAlbum?.id;
        
        // Inline плеер
        const inlinePlayer = document.querySelector('.inline-player');
        if (inlinePlayer) {
          inlinePlayer.style.display = isCurrentAlbum ? 'block' : 'none';
        }
        
        // Mini плеер
        const miniPlayer = document.getElementById('mini-player');
        if (miniPlayer) {
          if (!isCurrentAlbum && this.currentAlbum && AppState.isPlaying) {
            miniPlayer.classList.add('visible');
            this.updateMiniPlayer();
          } else {
            miniPlayer.classList.remove('visible');
          }
        }
      }

      updateMiniPlayer() {
        if (!this.currentAlbum || this.currentTrackIndex === null) return;
        
        const track = this.currentAlbum.tracks[this.currentTrackIndex];
        if (!track) return;
        
        // Обновляем информацию
        const titleEl = document.getElementById('mini-track-title');
        const albumEl = document.getElementById('mini-album-title');
        const iconEl = document.getElementById('mini-album-icon');
        
        if (titleEl) titleEl.textContent = track.title || 'Без названия';
        if (albumEl) albumEl.textContent = this.currentAlbum.title || 'Неизвестный альбом';
        if (iconEl && this.currentAlbum.icon) {
          iconEl.src = this.currentAlbum.icon;
          iconEl.alt = this.currentAlbum.title;
        }
      }

      saveState() {
        if (!this.currentAlbum || this.currentTrackIndex === null) return;
        
        const state = {
          albumId: this.currentAlbum.id,
          trackIndex: this.currentTrackIndex,
          position: this.audio.currentTime,
          timestamp: Date.now()
        };
        
        localStorage.setItem(CONFIG.STORAGE_PREFIX + 'player_state', JSON.stringify(state));
      }

      restoreState() {
        const saved = localStorage.getItem(CONFIG.STORAGE_PREFIX + 'player_state');
        if (!saved) return;
        
        try {
          const state = JSON.parse(saved);
          // Восстанавливаем только если не прошло много времени
          if (Date.now() - state.timestamp < CONFIG.CACHE_TTL) {
            // Будем восстанавливать после загрузки альбома
            return state;
          }
        } catch (e) {
          console.error('Ошибка восстановления состояния плеера:', e);
        }
        
        return null;
      }
    }
    // ===== ИНИЦИАЛИЗАЦИЯ =====
    const audioController = new AudioController();

    // ===== УПРАВЛЕНИЕ ГАЛЕРЕЕЙ =====
    class GalleryManager {
      constructor() {
        this.currentSession = null;
        this.items = [];
        this.currentIndex = 0;
        this.loadingPromise = null;
      }

      async open(albumId) {
        // Создаём новую сессию
        this.currentSession = {
          id: Math.random().toString(36).substr(2, 9),
          albumId: albumId,
          timestamp: Date.now()
        };
        
        // Очищаем предыдущее состояние
        this.clear();
        
        // Загружаем данные галереи
        await this.loadGalleryData(albumId);
        
        // Показываем первый элемент
        if (this.items.length > 0) {
          await this.showItem(0);
          this.enableNavigation();
        }
      }

      async loadGalleryData(albumId) {
        const indexPath = `albums/gallery/${albumId}/index.json`;
        
        try {
          // Проверяем кэш
          const cached = AppState.cache.get(indexPath);
          if (cached && Date.now() - cached.timestamp < CONFIG.CACHE_TTL) {
            this.items = cached.data;
            return;
          }
          
          // Загружаем index.json
          const response = await fetch(indexPath);
          if (!response.ok) throw new Error('Gallery index not found');
          
          const data = await response.json();
          
          // Форматируем данные
          if (Array.isArray(data)) {
            // Простой массив файлов
            this.items = data.map(file => ({
              type: file.endsWith('.html') ? 'html' : 'image',
              url: `albums/gallery/${albumId}/${file}`,
              filename: file
            }));
          } else if (data.items) {
            // Расширенный формат
            this.items = data.items;
          }
          
          // Кэшируем
          AppState.cache.set(indexPath, {
            data: this.items,
            timestamp: Date.now()
          });
          
        } catch (error) {
          console.error('Ошибка загрузки галереи:', error);
          this.items = [];
        }
      }

      async showItem(index) {
        if (index < 0 || index >= this.items.length) return;
        
        // Проверяем актуальность сессии
        if (!this.isSessionValid()) return;
        
        this.currentIndex = index;
        const item = this.items[index];
        const slot = document.getElementById('cover-slot');
        
        if (!slot) return;
        
        // Показываем скелетон
        slot.innerHTML = '<div class="skeleton" style="width:100%;height:100%;"></div>';
        
        try {
          if (item.type === 'html') {
            // HTML контент в iframe
            const iframe = document.createElement('iframe');
            iframe.src = item.url;
            iframe.style.cssText = 'width:100%;height:100%;border:0;';
            iframe.setAttribute('sandbox', 'allow-same-origin allow-scripts');
            
            slot.innerHTML = '';
            slot.appendChild(iframe);
            
          } else {
            // Изображение
            const img = new Image();
            
            await new Promise((resolve, reject) => {
              img.onload = resolve;
              img.onerror = reject;
              img.src = item.url;
            });
            
            // Проверяем актуальность перед вставкой
            if (!this.isSessionValid()) return;
            
            img.style.cssText = 'width:100%;height:100%;object-fit:contain;';
            img.alt = item.filename || '';
            
            slot.innerHTML = '';
            slot.appendChild(img);
          }
          
          // Предзагружаем следующий элемент
          this.preloadNext();
          
        } catch (error) {
          console.error('Ошибка загрузки элемента галереи:', error);
          slot.innerHTML = '<div style="padding:20px;text-align:center;color:#666;">Ошибка загрузки</div>';
        }
      }

      preloadNext() {
        const nextIndex = this.currentIndex + 1;
        if (nextIndex >= this.items.length) return;
        
        const nextItem = this.items[nextIndex];
        if (nextItem.type === 'image') {
          const img = new Image();
          img.src = nextItem.url;
        }
      }

      next() {
        if (this.currentIndex < this.items.length - 1) {
          this.showItem(this.currentIndex + 1);
        }
      }

      prev() {
        if (this.currentIndex > 0) {
          this.showItem(this.currentIndex - 1);
        }
      }

      clear() {
        this.items = [];
        this.currentIndex = 0;
        
        const slot = document.getElementById('cover-slot');
        if (slot) {
          slot.innerHTML = '';
        }
        
        this.disableNavigation();
      }

      enableNavigation() {
        const wrap = document.getElementById('cover-wrap');
        if (wrap && this.items.length > 1) {
          wrap.classList.add('gallery-nav-ready');
        }
      }

      disableNavigation() {
        const wrap = document.getElementById('cover-wrap');
        if (wrap) {
          wrap.classList.remove('gallery-nav-ready');
        }
      }

      isSessionValid() {
        if (!this.currentSession) return false;
        
        // Проверяем таймаут сессии
        if (Date.now() - this.currentSession.timestamp > CONFIG.GALLERY_SESSION_TTL) {
          return false;
        }
        
        // Проверяем соответствие альбома
        return this.currentSession.albumId === AppState.currentAlbum?.id;
      }
    }

    const galleryManager = new GalleryManager();

    // ===== ЗАГРУЗКА ДАННЫХ =====
    async function loadAlbumsData() {
      try {
        // Параллельная загрузка
        const [albumsResponse, customResponse] = await Promise.all([
          fetch('albums.json'),
          fetch('custom.json')
        ]);
        
        if (!albumsResponse.ok || !customResponse.ok) {
          throw new Error('Failed to load data');
        }
        
        AppState.albumsData = await albumsResponse.json();
        AppState.customData = await customResponse.json();
        
        return true;
      } catch (error) {
        console.error('Ошибка загрузки данных:', error);
        return false;
      }
    }

    // ===== РАБОТА С АЛЬБОМАМИ =====
    async function loadAlbum(albumId) {
      if (!AppState.albumsData) return null;
      
      const albumConfig = AppState.albumsData[albumId];
      if (!albumConfig) return null;
      
      // Проверяем кэш
      const cacheKey = `album_${albumId}`;
      const cached = AppState.cache.get(cacheKey);
      if (cached && Date.now() - cached.timestamp < CONFIG.CACHE_TTL) {
        return cached.data;
      }
      
      // Формируем данные альбома
      const album = {
        id: albumId,
        title: albumConfig.title || 'Без названия',
        type: albumConfig.type || 'album',
        icon: `assets/img/icon_album/mobile/icon-album-${albumId}@1x.png`,
        tracks: []
      };
      
      // Загружаем треки
      if (albumConfig.tracks) {
        album.tracks = albumConfig.tracks.map((track, index) => ({
          index: index,
          number: String(index + 1).padStart(2, '0'),
          title: track.title || `Трек ${index + 1}`,
          url: track.url || null,
          lyrics: track.lyrics || null,
          active: track.active !== false
        }));
      }
      
      // Кэшируем
      AppState.cache.set(cacheKey, {
        data: album,
        timestamp: Date.now()
      });
      
      return album;
    }

    async function switchToAlbum(albumId) {
      if (AppState.currentAlbum?.id === albumId) return;
      
      // Загружаем альбом
      const album = await loadAlbum(albumId);
      if (!album) return;
      
      // Сохраняем текущий альбом
      AppState.currentAlbum = album;
      localStorage.setItem(CONFIG.STORAGE_PREFIX + 'current_album', albumId);
      
      // Обновляем UI
      updateAlbumUI(album);
      
      // Открываем галерею
      galleryManager.open(albumId);
      
      // Обновляем видимость плееров
      audioController.updatePlayerVisibility();
    }

    function updateAlbumUI(album) {
      // Заголовок
      const titleEl = document.getElementById('album-title');
      if (titleEl) {
        titleEl.textContent = album.title;
        titleEl.className = 'active-album-title';
        if (album.type === 'favorites') titleEl.classList.add('fav');
        if (album.type === 'news') titleEl.classList.add('news');
      }
      
      // Список треков
      renderTrackList(album);
    }

    function renderTrackList(album) {
      const container = document.getElementById('track-list');
      if (!container) return;
      
      // Используем DocumentFragment для оптимизации
      const fragment = document.createDocumentFragment();
      
      album.tracks.forEach((track, index) => {
        // Контейнер трека
        const trackDiv = document.createElement('div');
        trackDiv.className = 'track';
        trackDiv.dataset.index = index;
        
        if (!track.active) {
          trackDiv.classList.add('inactive');
        }
        
        // Номер
        const numSpan = document.createElement('span');
        numSpan.className = 'tnum';
        numSpan.textContent = track.number;
        trackDiv.appendChild(numSpan);
        
        // Название
        const titleSpan = document.createElement('span');
        titleSpan.className = 'track-title';
        titleSpan.textContent = track.title;
        trackDiv.appendChild(titleSpan);
        
        // Звезда избранного
        const star = document.createElement('button');
        star.className = 'like-star';
        star.innerHTML = getFavoriteSvg(isFavorite(album.id, index));
        star.onclick = (e) => {
          e.stopPropagation();
          toggleFavorite(album.id, index, star);
        };
        trackDiv.appendChild(star);
        
        // Клик по треку
        trackDiv.onclick = () => {
          if (track.active && track.url) {
            showInlinePlayer(album, index);
          }
        };
        
        fragment.appendChild(trackDiv);
        
        // Место для inline плеера
        const playerSlot = document.createElement('div');
        playerSlot.id = `player-slot-${index}`;
        playerSlot.style.display = 'none';
        fragment.appendChild(playerSlot);
      });
      
      // Очищаем и вставляем
      container.innerHTML = '';
      container.appendChild(fragment);
    }

    function showInlinePlayer(album, trackIndex) {
      const track = album.tracks[trackIndex];
      if (!track) return;
      
      // Скрываем все плееры
      document.querySelectorAll('[id^="player-slot-"]').forEach(slot => {
        slot.style.display = 'none';
        slot.innerHTML = '';
      });
      
      // Убираем выделение со всех треков
      document.querySelectorAll('.track').forEach(t => {
        t.classList.remove('current');
      });
      
      // Выделяем текущий трек
      const trackEl = document.querySelector(`.track[data-index="${trackIndex}"]`);
      if (trackEl) {
        trackEl.classList.add('current');
      }
      
      // Показываем плеер под треком
      const slot = document.getElementById(`player-slot-${trackIndex}`);
      if (slot) {
        slot.style.display = 'block';
        slot.innerHTML = createInlinePlayerHTML(track);
        
        // Инициализируем обработчики
        initInlinePlayerHandlers(album, trackIndex);
        
        // Запускаем воспроизведение
        audioController.play(album, trackIndex);
      }
    }

    function createInlinePlayerHTML(track) {
      return `
        <div class="inline-player">
          <div class="player-title-row">
            <div class="player-song-title">${track.title}</div>
            ${track.lyrics ? `
              <button class="lyrics-toggle-btn" onclick="toggleLyrics(this)">
                Текст
              </button>
            ` : ''}
          </div>
          
          ${track.lyrics ? `
            <div id="lyrics-window" class="lyrics-hidden">
              <div class="lyrics-scroll">
                ${track.lyrics.map(line => `
                  <div class="lyrics-window-line">${line.text}</div>
                `).join('')}
              </div>
            </div>
          ` : ''}
          
          <div class="progress-bar-container" onclick="seekAudio(event)">
            <div class="progress-bar"></div>
          </div>
          
          <div class="time-display">
            <span class="time-current">0:00</span>
            <span class="time-total">0:00</span>
          </div>
          
          <div class="player-controls">
            <button class="control-btn" onclick="audioPrev()">
              <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
                <path d="M6 6h2v12H6zm3.5 6l8.5 6V6z"/>
              </svg>
            </button>
            <button class="control-btn play-pause" onclick="audioPlayPause()">
              <svg width="32" height="32" viewBox="0 0 24 24" fill="currentColor">
                <path d="M8 5v14l11-7z"/>
              </svg>
            </button>
            <button class="control-btn" onclick="audioNext()">
              <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
                <path d="M18 18h-2V6h2zm-3.5-6L6 18V6z"/>
              </svg>
            </button>
          </div>
        </div>
      `;
    }

    function initInlinePlayerHandlers(album, trackIndex) {
      // Обработчики уже определены глобально через onclick
    }

    // ===== ГЛОБАЛЬНЫЕ ФУНКЦИИ ДЛЯ ОБРАБОТЧИКОВ =====
    window.audioPlayPause = function() {
      if (AppState.isPlaying) {
        audioController.pause();
      } else {
        audioController.resume();
      }
    };

    window.audioNext = function() {
      audioController.next();
    };

    window.audioPrev = function() {
      audioController.prev();
    };

    window.seekAudio = function(event) {
      const rect = event.currentTarget.getBoundingClientRect();
      const percent = (event.clientX - rect.left) / rect.width;
      audioController.seek(Math.max(0, Math.min(1, percent)));
    };

    window.toggleLyrics = function(button) {
      const lyricsWindow = document.getElementById('lyrics-window');
      if (!lyricsWindow) return;
      
      if (lyricsWindow.classList.contains('lyrics-hidden')) {
        lyricsWindow.classList.remove('lyrics-hidden');
        lyricsWindow.classList.add('lyrics-normal');
        button.classList.add('active');
      } else if (lyricsWindow.classList.contains('lyrics-normal')) {
        lyricsWindow.classList.remove('lyrics-normal');
        lyricsWindow.classList.add('lyrics-expanded');
      } else {
        lyricsWindow.classList.remove('lyrics-expanded');
        lyricsWindow.classList.add('lyrics-hidden');
        button.classList.remove('active');
      }
    };

    // ===== ИЗБРАННОЕ =====
    function getFavorites() {
      const stored = localStorage.getItem(CONFIG.STORAGE_PREFIX + 'favorites');
      return stored ? JSON.parse(stored) : {};
    }

    function saveFavorites(favorites) {
      localStorage.setItem(CONFIG.STORAGE_PREFIX + 'favorites', JSON.stringify(favorites));
    }

    function isFavorite(albumId, trackIndex) {
      const favorites = getFavorites();
      const key = `${albumId}_${trackIndex}`;
      return favorites[key] === true;
    }

    function toggleFavorite(albumId, trackIndex, starElement) {
      const favorites = getFavorites();
      const key = `${albumId}_${trackIndex}`;
      
      favorites[key] = !favorites[key];
      saveFavorites(favorites);
      
      // Анимация
      starElement.classList.add('animating');
      starElement.innerHTML = getFavoriteSvg(favorites[key]);
      
      setTimeout(() => {
        starElement.classList.remove('animating');
      }, 300);
    }

    function getFavoriteSvg(isFilled) {
      if (isFilled) {
        return `<svg viewBox="0 0 24 24" fill="#FFD700">
          <path d="M12 17.27L18.18 21l-1.64-7.03L22 9.24l-7.19-.61L12 2 9.19 8.63 2 9.24l5.46 4.73L5.82 21z"/>
        </svg>`;
      } else {
        return `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M12 17.27L18.18 21l-1.64-7.03L22 9.24l-7.19-.61L12 2 9.19 8.63 2 9.24l5.46 4.73L5.82 21z"/>
        </svg>`;
      }
    }

    // ===== НАВИГАЦИЯ =====
    function initNavigation() {
      // Табы
      document.querySelectorAll('.nav-tab').forEach(tab => {
        tab.addEventListener('click', (e) => {
          const tabName = e.target.dataset.tab;
          handleNavTab(tabName);
        });
      });
      
      // Галерея
      document.getElementById('cover-gallery-arrow-left')?.addEventListener('click', () => {
        galleryManager.prev();
      });
      
      document.getElementById('cover-gallery-arrow-right')?.addEventListener('click', () => {
        galleryManager.next();
      });
      
      // Мини плеер
      document.getElementById('mini-play-pause')?.addEventListener('click', () => {
        audioPlayPause();
      });
      
      document.getElementById('mini-next')?.addEventListener('click', () => {
        audioNext();
      });
      
      document.getElementById('mini-prev')?.addEventListener('click', () => {
        audioPrev();
      });
      
      // Модальные окна
      document.querySelectorAll('.modal-close').forEach(btn => {
        btn.addEventListener('click', closeModals);
      });
      
      document.getElementById('modal-overlay')?.addEventListener('click', closeModals);
    }

    function handleNavTab(tabName) {
      // Убираем активность со всех табов
      document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
      
      switch(tabName) {
        case 'albums':
          showAlbumsModal();
          break;
        case 'favorites':
          showFavorites();
          break;
        case 'about':
          showAboutModal();
          break;
      }
    }

    function showAlbumsModal() {
      if (!AppState.albumsData) return;
      
      const modal = document.getElementById('albums-modal');
      const overlay = document.getElementById('modal-overlay');
      const listEl = document.getElementById('albums-list');
      
      if (!modal || !overlay || !listEl) return;
      
      // Формируем список альбомов
      listEl.innerHTML = '';
      
      Object.keys(AppState.albumsData).forEach(albumId => {
        const album = AppState.albumsData[albumId];
        
        const albumDiv = document.createElement('div');
        albumDiv.style.cssText = 'padding:10px;cursor:pointer;border-bottom:1px solid #333;';
        albumDiv.innerHTML = `
          <img src="assets/img/icon_album/mobile/icon-album-${albumId}@1x.png" 
               style="width:40px;height:40px;vertical-align:middle;margin-right:10px;border-radius:4px;">
          <span>${album.title}</span>
        `;
        
        albumDiv.onclick = () => {
          closeModals();
          switchToAlbum(albumId);
        };
        
        listEl.appendChild(albumDiv);
      });
      
      overlay.classList.add('show');
      modal.classList.add('show');
    }

    function showFavorites() {
      // Переключаем на режим избранного
      const trackList = document.getElementById('track-list');
      if (trackList) {
        trackList.classList.toggle('filtered');
        
        // Обновляем таб
        const favTab = document.querySelector('.nav-tab[data-tab="favorites"]');
        if (favTab) {
          favTab.classList.toggle('active');
        }
      }
    }

    function showAboutModal() {
      const modal = document.getElementById('about-modal');
      const overlay = document.getElementById('modal-overlay');
      const content = document.getElementById('about-content');
      
      if (!modal || !overlay || !content) return;
      
      content.innerHTML = `
        <p>Группа "Витрина Разбита" - это уникальный музыкальный проект.</p>
        <p>Официальный сайт: <a href="https://vitrina-razbita.ru" target="_blank">vitrina-razbita.ru</a></p>
        <div style="margin-top:20px;">
          <h3>Социальные сети:</h3>
          <p><a href="https://vk.com/vitrina_razbita" target="_blank">VKontakte</a></p>
          <p><a href="https://t.me/vitrina_razbita" target="_blank">Telegram</a></p>
          <p><a href="https://instagram.com/vitrina_razbita" target="_blank">Instagram</a></p>
        </div>
      `;
      
      overlay.classList.add('show');
      modal.classList.add('show');
    }

    function closeModals() {
      document.getElementById('modal-overlay')?.classList.remove('show');
      document.querySelectorAll('.modal-window').forEach(modal => {
        modal.classList.remove('show');
      });
    }

    // ===== ПРОМОКОД =====
    function initPromocode() {
      const promoBtn = document.getElementById('promo-btn');
      const promoInput = document.getElementById('promo-inp');
      const promoError = document.getElementById('promo-error');
      
      if (!promoBtn || !promoInput) return;
      
      // Проверяем сохранённый промокод
      const savedPromo = localStorage.getItem(CONFIG.STORAGE_PREFIX + 'promo');
      if (savedPromo === 'vr2024') {
        unlockApp();
        return;
      }
      
      promoBtn.addEventListener('click', () => {
        const code = promoInput.value.trim().toLowerCase();
        
        if (code === 'vr2024' || code === 'витрина') {
          localStorage.setItem(CONFIG.STORAGE_PREFIX + 'promo', 'vr2024');
          unlockApp();
        } else {
          if (promoError) {
            promoError.textContent = 'Неверный промокод';
            promoError.classList.remove('hidden');
          }
          promoInput.value = '';
        }
      });
      
      promoInput.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') {
          promoBtn.click();
        }
      });
    }

    function unlockApp() {
      document.getElementById('promocode-block')?.remove();
      document.getElementById('main-block')?.classList.remove('hidden');
      initApp();
    }

    // ===== ИНИЦИАЛИЗАЦИЯ ПРИЛОЖЕНИЯ =====
    async function initApp() {
      // Загружаем данные
      const loaded = await loadAlbumsData();
      if (!loaded) {
        console.error('Не удалось загрузить данные приложения');
        return;
      }
      
      // Инициализируем навигацию
      initNavigation();
      
      // Восстанавливаем последний альбом
      const lastAlbum = localStorage.getItem(CONFIG.STORAGE_PREFIX + 'current_album') || CONFIG.DEFAULT_ALBUM;
      await switchToAlbum(lastAlbum);
      
      // Восстанавливаем состояние плеера
      const playerState = audioController.restoreState();
      if (playerState && playerState.albumId === lastAlbum) {
        // Можно восстановить позицию воспроизведения
      }
      
      // Регистрируем Service Worker
      if ('serviceWorker' in navigator) {
        navigator.serviceWorker.register('/service-worker.js').catch(err => {
          console.log('SW registration failed:', err);
        });
      }
    }

    // ===== ЗАПУСК =====
    document.addEventListener('DOMContentLoaded', () => {
      initPromocode();
    });

    // Оптимизация для мобильных
    document.addEventListener('touchstart', () => {}, { passive: true });
  </script>
</body>
</html>
